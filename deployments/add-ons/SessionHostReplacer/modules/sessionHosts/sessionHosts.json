{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.28.1.47646",
      "templateHash": "12233142466589664577"
    }
  },
  "parameters": {
    "artifactsContainerUri": {
      "type": "string",
      "metadata": {
        "description": "URI of the storage container holding custom artifacts for session host configuration."
      }
    },
    "artifactsUserAssignedIdentityResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the user-assigned managed identity with access to the artifacts container."
      }
    },
    "availability": {
      "type": "string",
      "metadata": {
        "description": "Availability option for session hosts. Valid values: AvailabilitySets, AvailabilityZones, None."
      }
    },
    "availabilitySetNameConv": {
      "type": "string",
      "metadata": {
        "description": "Naming convention for availability sets when availability is set to AvailabilitySets. Use ## as placeholder for the index."
      }
    },
    "availabilityZones": {
      "type": "array",
      "metadata": {
        "description": "Array of availability zones to distribute session hosts across when availability is set to AvailabilityZones."
      }
    },
    "avdAgentsDSCPackage": {
      "type": "string",
      "metadata": {
        "description": "Name of the DSC package used to register session hosts with the AVD host pool."
      }
    },
    "avdInsightsDataCollectionRulesResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the data collection rule for AVD Insights monitoring."
      }
    },
    "confidentialVMOSDiskEncryption": {
      "type": "bool",
      "metadata": {
        "description": "Enable confidential VM OS disk encryption with VM guest state. Only applicable for confidential VMs."
      }
    },
    "credentialsKeyVaultResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the Key Vault containing credentials for domain join and VM admin accounts."
      }
    },
    "dataCollectionEndpointResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the data collection endpoint for Azure Monitor agent."
      }
    },
    "dedicatedHostGroupResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the dedicated host group for session host placement."
      }
    },
    "dedicatedHostGroupZones": {
      "type": "array",
      "metadata": {
        "description": "Array of availability zones for the dedicated host group."
      }
    },
    "dedicatedHostResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of a specific dedicated host for session host placement."
      }
    },
    "diskEncryptionSetResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the disk encryption set for encrypting managed disks with customer-managed keys."
      }
    },
    "diskSizeGB": {
      "type": "int",
      "metadata": {
        "description": "Size of the OS disk in GB."
      }
    },
    "diskSku": {
      "type": "string",
      "metadata": {
        "description": "SKU for the managed OS disk. Examples: Premium_LRS, StandardSSD_LRS, Standard_LRS."
      }
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "Fully qualified domain name (FQDN) for Active Directory domain join."
      }
    },
    "enableAcceleratedNetworking": {
      "type": "bool",
      "metadata": {
        "description": "Enable accelerated networking on network interfaces for improved network performance."
      }
    },
    "encryptionAtHost": {
      "type": "bool",
      "metadata": {
        "description": "Enable encryption at host for additional data encryption on the VM host."
      }
    },
    "fslogixFileShareNames": {
      "type": "array",
      "metadata": {
        "description": "Array of FSLogix file share names. First element is profile-containers, second (if present) is office-containers."
      }
    },
    "fslogixConfigureSessionHosts": {
      "type": "bool",
      "metadata": {
        "description": "Configure FSLogix on session hosts during deployment."
      }
    },
    "fslogixContainerType": {
      "type": "string",
      "metadata": {
        "description": "Type of FSLogix container. Valid values: ProfileContainer, OfficeContainer, ProfileOfficeContainer."
      }
    },
    "fslogixLocalNetAppVolumeResourceIds": {
      "type": "array",
      "metadata": {
        "description": "Array of resource IDs for local Azure NetApp Files volumes used for FSLogix containers."
      }
    },
    "fslogixLocalStorageAccountResourceIds": {
      "type": "array",
      "metadata": {
        "description": "Array of resource IDs for local storage accounts used for FSLogix containers."
      }
    },
    "fslogixOSSGroups": {
      "type": "array",
      "metadata": {
        "description": "Array of Active Directory security groups for FSLogix Office 365 container redirection."
      }
    },
    "fslogixRemoteNetAppVolumeResourceIds": {
      "type": "array",
      "metadata": {
        "description": "Array of resource IDs for remote Azure NetApp Files volumes used for FSLogix containers in DR scenarios."
      }
    },
    "fslogixRemoteStorageAccountResourceIds": {
      "type": "array",
      "metadata": {
        "description": "Array of resource IDs for remote storage accounts used for FSLogix containers in DR scenarios."
      }
    },
    "fslogixSizeInMBs": {
      "type": "int",
      "metadata": {
        "description": "Size limit in MB for FSLogix containers. 0 = no limit."
      }
    },
    "fslogixStorageService": {
      "type": "string",
      "metadata": {
        "description": "Storage service type for FSLogix. Valid values: AzureFiles, AzureNetAppFiles."
      }
    },
    "hostPoolResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the AVD host pool that session hosts will be registered to."
      }
    },
    "identitySolution": {
      "type": "string",
      "metadata": {
        "description": "Identity solution for session hosts. Valid values: ActiveDirectoryDomainServices, EntraID, EntraIDIntuneEnrollment."
      }
    },
    "imageReference": {
      "type": "object",
      "metadata": {
        "description": "Image reference object containing either marketplace image details or compute gallery image version resource ID."
      }
    },
    "integrityMonitoring": {
      "type": "bool",
      "metadata": {
        "description": "Enable Microsoft Defender for Cloud integrity monitoring on session hosts."
      }
    },
    "intuneEnrollment": {
      "type": "bool",
      "metadata": {
        "description": "Enroll session hosts in Microsoft Intune. Only applicable with EntraIDIntuneEnrollment identity solution."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region where session hosts will be deployed."
      }
    },
    "enableMonitoring": {
      "type": "bool",
      "metadata": {
        "description": "Enable Azure Monitor VM insights on session hosts."
      }
    },
    "networkInterfaceNameConv": {
      "type": "string",
      "metadata": {
        "description": "Naming convention pattern for network interfaces."
      }
    },
    "osDiskNameConv": {
      "type": "string",
      "metadata": {
        "description": "Naming convention pattern for OS managed disks."
      }
    },
    "ouPath": {
      "type": "string",
      "metadata": {
        "description": "Organizational Unit (OU) path in Active Directory for computer objects. Leave empty for default Computers container."
      }
    },
    "secureBootEnabled": {
      "type": "bool",
      "metadata": {
        "description": "Enable secure boot for generation 2 VMs."
      }
    },
    "securityDataCollectionRulesResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the data collection rule for security monitoring with Microsoft Defender for Cloud."
      }
    },
    "securityType": {
      "type": "string",
      "metadata": {
        "description": "Security type for VMs. Valid values: Standard, TrustedLaunch, ConfidentialVM."
      }
    },
    "sessionHostCustomizations": {
      "type": "array",
      "metadata": {
        "description": "Array of custom script extension configurations for additional session host customization."
      }
    },
    "sessionHostNameIndexLength": {
      "type": "int",
      "metadata": {
        "description": "Number of digits used in the session host name index. Determines how many characters from the end represent the VM number."
      }
    },
    "sessionHostNames": {
      "type": "array",
      "metadata": {
        "description": "Array of session host names to deploy. Names should follow the pattern <prefix><index> where index length matches sessionHostNameIndexLength."
      }
    },
    "subnetResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the subnet where session host network interfaces will be placed."
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Tags to apply to deployed resources. Organized by resource type."
      }
    },
    "timeStamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddHHmmss')]",
      "metadata": {
        "description": "DO NOT MODIFY THIS VALUE! The timeStamp is needed to differentiate deployments for certain Azure resources and must be set using a parameter."
      }
    },
    "timeZone": {
      "type": "string",
      "metadata": {
        "description": "Time zone for session hosts. Use Windows time zone format (e.g., Eastern Standard Time, Pacific Standard Time)."
      }
    },
    "virtualMachineNameConv": {
      "type": "string",
      "metadata": {
        "description": "Naming convention pattern for virtual machines."
      }
    },
    "virtualMachineSize": {
      "type": "string",
      "metadata": {
        "description": "Azure VM size for session hosts. Examples: Standard_D4s_v5, Standard_D8s_v5."
      }
    },
    "vTpmEnabled": {
      "type": "bool",
      "metadata": {
        "description": "Enable virtual Trusted Platform Module (vTPM) for generation 2 VMs."
      }
    },
    "vmInsightsDataCollectionRulesResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the data collection rule for VM Insights performance and dependency monitoring."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "vmNumbersForAvSet",
        "count": "[length(parameters('sessionHostNames'))]",
        "input": "[int(substring(parameters('sessionHostNames')[copyIndex('vmNumbersForAvSet')], sub(length(parameters('sessionHostNames')[copyIndex('vmNumbersForAvSet')]), parameters('sessionHostNameIndexLength')), parameters('sessionHostNameIndexLength')))]"
      }
    ],
    "deploymentSuffix": "[if(startsWith(deployment().name, 'Microsoft.Template-'), substring(deployment().name, 19, 14), parameters('timeStamp'))]",
    "sessionHostRegistrationDSCStorageAccount": "[if(startsWith(environment().name, 'USN'), 'wvdexportalcontainer', 'wvdportalstorageblob')]",
    "sessionHostRegistrationDSCUrl": "[if(startsWith(parameters('avdAgentsDSCPackage'), 'https://'), parameters('avdAgentsDSCPackage'), format('https://{0}.blob.{1}/galleryartifacts/{2}', variables('sessionHostRegistrationDSCStorageAccount'), environment().suffixes.storage, parameters('avdAgentsDSCPackage')))]",
    "confidentialVMOSDiskEncryptionType": "[if(parameters('confidentialVMOSDiskEncryption'), 'DiskWithVMGuestState', 'VMGuestStateOnly')]",
    "maxVMsPerDeployment": 40,
    "totalVMCount": "[length(parameters('sessionHostNames'))]",
    "divisionValue": "[div(variables('totalVMCount'), variables('maxVMsPerDeployment'))]",
    "divisionRemainderValue": "[mod(variables('totalVMCount'), variables('maxVMsPerDeployment'))]",
    "sessionHostBatchCount": "[if(greater(variables('divisionRemainderValue'), 0), add(variables('divisionValue'), 1), variables('divisionValue'))]",
    "minVmNumber": "[min(variables('vmNumbersForAvSet'))]",
    "maxVmNumber": "[max(variables('vmNumbersForAvSet'))]",
    "maxAvSetMembers": 200,
    "beginAvSetRange": "[div(variables('minVmNumber'), variables('maxAvSetMembers'))]",
    "endAvSetRange": "[div(variables('maxVmNumber'), variables('maxAvSetMembers'))]",
    "calculatedAvailabilitySetsCount": "[add(sub(variables('endAvSetRange'), variables('beginAvSetRange')), 1)]",
    "calculatedAvailabilitySetsIndex": "[variables('beginAvSetRange')]",
    "localNetAppProfileContainerVolumeResourceIds": "[if(not(empty(parameters('fslogixLocalNetAppVolumeResourceIds'))), filter(parameters('fslogixLocalNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0]))), createArray())]",
    "localNetAppOfficeContainerVolumeResourceIds": "[if(and(not(empty(parameters('fslogixLocalNetAppVolumeResourceIds'))), greater(length(parameters('fslogixFileShareNames')), 1)), filter(parameters('fslogixLocalNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[1]))), createArray())]",
    "sortedLocalNetAppResourceIds": "[union(variables('localNetAppProfileContainerVolumeResourceIds'), variables('localNetAppOfficeContainerVolumeResourceIds'))]",
    "remoteNetAppProfileContainerVolumeResourceIds": "[if(not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds'))), filter(parameters('fslogixRemoteNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0]))), createArray())]",
    "remoteNetAppOfficeContainerVolumeResourceIds": "[if(and(not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds'))), greater(length(parameters('fslogixFileShareNames')), 1)), filter(parameters('fslogixRemoteNetAppVolumeResourceIds'), lambda('id', not(contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0])))), createArray())]",
    "sortedRemoteNetAppResourceIds": "[union(variables('remoteNetAppProfileContainerVolumeResourceIds'), variables('remoteNetAppOfficeContainerVolumeResourceIds'))]"
  },
  "resources": [
    {
      "condition": "[not(empty(parameters('artifactsUserAssignedIdentityResourceId')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('ArtifactsUserAssignedIdentity-{0}', variables('deploymentSuffix'))]",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userAssignedIdentityResourceId": {
            "value": "[parameters('artifactsUserAssignedIdentityResourceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "15935386815955387717"
            }
          },
          "parameters": {
            "userAssignedIdentityResourceId": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "clientId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(parameters('userAssignedIdentityResourceId'), '/'))), '2018-11-30').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(parameters('userAssignedIdentityResourceId'), '/'))), '2018-11-30').principalId]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "availabilitySets",
        "count": "[length(range(0, variables('calculatedAvailabilitySetsCount')))]"
      },
      "condition": "[equals(parameters('availability'), 'AvailabilitySets')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}', replace(parameters('availabilitySetNameConv'), '##', padLeft(add(add(range(0, variables('calculatedAvailabilitySetsCount'))[copyIndex()], variables('calculatedAvailabilitySetsIndex')), 1), 2, '0')), variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[replace(parameters('availabilitySetNameConv'), '##', padLeft(add(add(range(0, variables('calculatedAvailabilitySetsCount'))[copyIndex()], variables('calculatedAvailabilitySetsIndex')), 1), 2, '0'))]"
          },
          "platformFaultDomainCount": {
            "value": 2
          },
          "platformUpdateDomainCount": {
            "value": 5
          },
          "proximityPlacementGroupResourceId": {
            "value": ""
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "skuName": {
            "value": "Aligned"
          },
          "tags": {
            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/availabilitySets'), createObject()))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "3864705076509973391"
            },
            "name": "Availability Sets",
            "description": "This module deploys an Availability Set.",
            "owner": "Azure/module-maintainers"
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the availability set that is being created."
              }
            },
            "platformFaultDomainCount": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Optional. The number of fault domains to use."
              }
            },
            "platformUpdateDomainCount": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Optional. The number of update domains to use."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Aligned",
              "metadata": {
                "description": "Optional. SKU of the availability set.</p>- Use 'Aligned' for virtual machines with managed disks.</p>- Use 'Classic' for virtual machines with unmanaged disks."
              }
            },
            "proximityPlacementGroupResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Resource ID of a proximity placement group."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. Resource location."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Tags of the availability set resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2022-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "platformFaultDomainCount": "[parameters('platformFaultDomainCount')]",
                "platformUpdateDomainCount": "[parameters('platformUpdateDomainCount')]",
                "proximityPlacementGroup": "[if(not(empty(parameters('proximityPlacementGroupResourceId'))), createObject('id', parameters('proximityPlacementGroupResourceId')), null())]"
              },
              "sku": {
                "name": "[parameters('skuName')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set."
              },
              "value": "[parameters('name')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the availability set."
              },
              "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the availability set was deployed into."
              },
              "value": "[resourceGroup().name]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location the resource was deployed into."
              },
              "value": "[reference(resourceId('Microsoft.Compute/availabilitySets', parameters('name')), '2022-11-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "localNetAppVolumes",
        "count": "[length(range(0, length(variables('sortedLocalNetAppResourceIds'))))]"
      },
      "condition": "[not(empty(variables('sortedLocalNetAppResourceIds')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('LocalNetAppVolumes-{0}-{1}', range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()], variables('deploymentSuffix'))]",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "netAppVolumeResourceId": {
            "value": "[variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "13474053505875353861"
            }
          },
          "parameters": {
            "netAppVolumeResourceId": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "smbServerFqdn": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('netAppVolumeResourceId'), '/')[2], split(parameters('netAppVolumeResourceId'), '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(parameters('netAppVolumeResourceId'), '/')[8], split(parameters('netAppVolumeResourceId'), '/')[10], last(split(parameters('netAppVolumeResourceId'), '/'))), '2023-11-01').mountTargets[0].smbServerFqdn]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "remoteNetAppVolumes",
        "count": "[length(range(0, length(variables('sortedRemoteNetAppResourceIds'))))]"
      },
      "condition": "[not(empty(variables('sortedRemoteNetAppResourceIds')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('RemoteNetAppVolumes-{0}-{1}', range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()], variables('deploymentSuffix'))]",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "netAppVolumeResourceId": {
            "value": "[variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "13474053505875353861"
            }
          },
          "parameters": {
            "netAppVolumeResourceId": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "smbServerFqdn": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('netAppVolumeResourceId'), '/')[2], split(parameters('netAppVolumeResourceId'), '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(parameters('netAppVolumeResourceId'), '/')[8], split(parameters('netAppVolumeResourceId'), '/')[10], last(split(parameters('netAppVolumeResourceId'), '/'))), '2023-11-01').mountTargets[0].smbServerFqdn]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "virtualMachines",
        "count": "[length(range(1, variables('sessionHostBatchCount')))]",
        "mode": "serial",
        "batchSize": 5
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('VMs-Batch-{0}-{1}', sub(range(1, variables('sessionHostBatchCount'))[copyIndex()], 1), variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsContainerUri": {
            "value": "[parameters('artifactsContainerUri')]"
          },
          "artifactsUserAssignedIdentityResourceId": {
            "value": "[parameters('artifactsUserAssignedIdentityResourceId')]"
          },
          "artifactsUserAssignedIdentityClientId": "[if(empty(parameters('artifactsUserAssignedIdentityResourceId')), createObject('value', ''), createObject('value', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ArtifactsUserAssignedIdentity-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.clientId.value))]",
          "availability": {
            "value": "[parameters('availability')]"
          },
          "availabilityZones": {
            "value": "[parameters('availabilityZones')]"
          },
          "availabilitySetNameConv": {
            "value": "[parameters('availabilitySetNameConv')]"
          },
          "avdInsightsDataCollectionRulesResourceId": {
            "value": "[parameters('avdInsightsDataCollectionRulesResourceId')]"
          },
          "confidentialVMOSDiskEncryptionType": {
            "value": "[variables('confidentialVMOSDiskEncryptionType')]"
          },
          "dataCollectionEndpointResourceId": {
            "value": "[parameters('dataCollectionEndpointResourceId')]"
          },
          "dedicatedHostGroupResourceId": {
            "value": "[parameters('dedicatedHostGroupResourceId')]"
          },
          "dedicatedHostGroupZones": {
            "value": "[parameters('dedicatedHostGroupZones')]"
          },
          "dedicatedHostResourceId": {
            "value": "[parameters('dedicatedHostResourceId')]"
          },
          "deploymentSuffix": {
            "value": "[variables('deploymentSuffix')]"
          },
          "diskEncryptionSetResourceId": {
            "value": "[parameters('diskEncryptionSetResourceId')]"
          },
          "diskSizeGB": {
            "value": "[parameters('diskSizeGB')]"
          },
          "diskSku": {
            "value": "[parameters('diskSku')]"
          },
          "domainJoinUserPassword": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('credentialsKeyVaultResourceId'), '/')[2], split(parameters('credentialsKeyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('credentialsKeyVaultResourceId'), '/')))]"
              },
              "secretName": "DomainJoinUserPassword"
            }
          },
          "domainJoinUserPrincipalName": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('credentialsKeyVaultResourceId'), '/')[2], split(parameters('credentialsKeyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('credentialsKeyVaultResourceId'), '/')))]"
              },
              "secretName": "DomainJoinUserPrincipalName"
            }
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "enableAcceleratedNetworking": {
            "value": "[parameters('enableAcceleratedNetworking')]"
          },
          "enableMonitoring": {
            "value": "[parameters('enableMonitoring')]"
          },
          "encryptionAtHost": {
            "value": "[parameters('encryptionAtHost')]"
          },
          "fslogixConfigureSessionHosts": {
            "value": "[parameters('fslogixConfigureSessionHosts')]"
          },
          "fslogixContainerType": {
            "value": "[parameters('fslogixContainerType')]"
          },
          "fslogixFileShareNames": {
            "value": "[parameters('fslogixFileShareNames')]"
          },
          "fslogixOSSGroups": {
            "value": "[parameters('fslogixOSSGroups')]"
          },
          "fslogixLocalNetAppServerFqdns": {
            "copy": [
              {
                "name": "value",
                "count": "[length(range(0, length(variables('sortedLocalNetAppResourceIds'))))]",
                "input": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('LocalNetAppVolumes-{0}-{1}', range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex('value')]], variables('deploymentSuffix'))), '2022-09-01').outputs.smbServerFqdn.value]"
              }
            ]
          },
          "fslogixLocalStorageAccountResourceIds": {
            "value": "[parameters('fslogixLocalStorageAccountResourceIds')]"
          },
          "fslogixRemoteNetAppServerFqdns": {
            "copy": [
              {
                "name": "value",
                "count": "[length(range(0, length(variables('sortedRemoteNetAppResourceIds'))))]",
                "input": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('RemoteNetAppVolumes-{0}-{1}', range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex('value')]], variables('deploymentSuffix'))), '2022-09-01').outputs.smbServerFqdn.value]"
              }
            ]
          },
          "fslogixRemoteStorageAccountResourceIds": {
            "value": "[parameters('fslogixRemoteStorageAccountResourceIds')]"
          },
          "fslogixSizeInMBs": {
            "value": "[parameters('fslogixSizeInMBs')]"
          },
          "fslogixStorageService": {
            "value": "[parameters('fslogixStorageService')]"
          },
          "hostPoolResourceId": {
            "value": "[parameters('hostPoolResourceId')]"
          },
          "identitySolution": {
            "value": "[parameters('identitySolution')]"
          },
          "imageReference": {
            "value": "[parameters('imageReference')]"
          },
          "integrityMonitoring": {
            "value": "[parameters('integrityMonitoring')]"
          },
          "intuneEnrollment": {
            "value": "[parameters('intuneEnrollment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "networkInterfaceNameConv": {
            "value": "[parameters('networkInterfaceNameConv')]"
          },
          "osDiskNameConv": {
            "value": "[parameters('osDiskNameConv')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "sessionHostCustomizations": {
            "value": "[parameters('sessionHostCustomizations')]"
          },
          "securityDataCollectionRulesResourceId": {
            "value": "[parameters('securityDataCollectionRulesResourceId')]"
          },
          "secureBootEnabled": {
            "value": "[parameters('secureBootEnabled')]"
          },
          "securityType": {
            "value": "[parameters('securityType')]"
          },
          "sessionHostNameIndexLength": {
            "value": "[parameters('sessionHostNameIndexLength')]"
          },
          "sessionHostNames": "[if(and(equals(range(1, variables('sessionHostBatchCount'))[copyIndex()], variables('sessionHostBatchCount')), greater(variables('divisionRemainderValue'), 0)), createObject('value', take(skip(parameters('sessionHostNames'), mul(sub(range(1, variables('sessionHostBatchCount'))[copyIndex()], 1), variables('maxVMsPerDeployment'))), variables('divisionRemainderValue'))), createObject('value', take(skip(parameters('sessionHostNames'), mul(sub(range(1, variables('sessionHostBatchCount'))[copyIndex()], 1), variables('maxVMsPerDeployment'))), variables('maxVMsPerDeployment'))))]",
          "sessionHostRegistrationDSCUrl": {
            "value": "[variables('sessionHostRegistrationDSCUrl')]"
          },
          "subnetResourceId": {
            "value": "[parameters('subnetResourceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "timeZone": {
            "value": "[parameters('timeZone')]"
          },
          "virtualMachineAdminPassword": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('credentialsKeyVaultResourceId'), '/')[2], split(parameters('credentialsKeyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('credentialsKeyVaultResourceId'), '/')))]"
              },
              "secretName": "VirtualMachineAdminPassword"
            }
          },
          "virtualMachineAdminUserName": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('credentialsKeyVaultResourceId'), '/')[2], split(parameters('credentialsKeyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('credentialsKeyVaultResourceId'), '/')))]"
              },
              "secretName": "VirtualMachineAdminUserName"
            }
          },
          "virtualMachineNameConv": {
            "value": "[parameters('virtualMachineNameConv')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('virtualMachineSize')]"
          },
          "vmInsightsDataCollectionRulesResourceId": {
            "value": "[parameters('vmInsightsDataCollectionRulesResourceId')]"
          },
          "vTpmEnabled": {
            "value": "[parameters('vTpmEnabled')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.28.1.47646",
              "templateHash": "10802583208881608842"
            }
          },
          "parameters": {
            "artifactsContainerUri": {
              "type": "string"
            },
            "artifactsUserAssignedIdentityClientId": {
              "type": "string"
            },
            "artifactsUserAssignedIdentityResourceId": {
              "type": "string"
            },
            "availability": {
              "type": "string"
            },
            "availabilitySetNameConv": {
              "type": "string"
            },
            "availabilityZones": {
              "type": "array"
            },
            "avdInsightsDataCollectionRulesResourceId": {
              "type": "string"
            },
            "confidentialVMOSDiskEncryptionType": {
              "type": "string"
            },
            "dataCollectionEndpointResourceId": {
              "type": "string"
            },
            "dedicatedHostGroupResourceId": {
              "type": "string"
            },
            "dedicatedHostGroupZones": {
              "type": "array"
            },
            "dedicatedHostResourceId": {
              "type": "string"
            },
            "diskEncryptionSetResourceId": {
              "type": "string"
            },
            "diskSizeGB": {
              "type": "int"
            },
            "diskSku": {
              "type": "string"
            },
            "domainJoinUserPassword": {
              "type": "securestring"
            },
            "domainJoinUserPrincipalName": {
              "type": "securestring"
            },
            "domainName": {
              "type": "string"
            },
            "enableAcceleratedNetworking": {
              "type": "bool"
            },
            "enableMonitoring": {
              "type": "bool"
            },
            "encryptionAtHost": {
              "type": "bool"
            },
            "fslogixConfigureSessionHosts": {
              "type": "bool"
            },
            "fslogixContainerType": {
              "type": "string"
            },
            "fslogixFileShareNames": {
              "type": "array"
            },
            "fslogixLocalNetAppServerFqdns": {
              "type": "array"
            },
            "fslogixLocalStorageAccountResourceIds": {
              "type": "array"
            },
            "fslogixOSSGroups": {
              "type": "array"
            },
            "fslogixRemoteNetAppServerFqdns": {
              "type": "array"
            },
            "fslogixRemoteStorageAccountResourceIds": {
              "type": "array"
            },
            "fslogixSizeInMBs": {
              "type": "int"
            },
            "fslogixStorageService": {
              "type": "string"
            },
            "hostPoolResourceId": {
              "type": "string"
            },
            "identitySolution": {
              "type": "string"
            },
            "imageReference": {
              "type": "object"
            },
            "integrityMonitoring": {
              "type": "bool"
            },
            "intuneEnrollment": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "networkInterfaceNameConv": {
              "type": "string"
            },
            "osDiskNameConv": {
              "type": "string"
            },
            "ouPath": {
              "type": "string"
            },
            "sessionHostCustomizations": {
              "type": "array"
            },
            "sessionHostNameIndexLength": {
              "type": "int"
            },
            "sessionHostNames": {
              "type": "array"
            },
            "sessionHostRegistrationDSCUrl": {
              "type": "string"
            },
            "securityDataCollectionRulesResourceId": {
              "type": "string"
            },
            "securityType": {
              "type": "string"
            },
            "secureBootEnabled": {
              "type": "bool"
            },
            "subnetResourceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "deploymentSuffix": {
              "type": "string"
            },
            "timeZone": {
              "type": "string"
            },
            "virtualMachineAdminPassword": {
              "type": "securestring"
            },
            "virtualMachineAdminUserName": {
              "type": "securestring"
            },
            "virtualMachineNameConv": {
              "type": "string"
            },
            "virtualMachineSize": {
              "type": "string"
            },
            "vmInsightsDataCollectionRulesResourceId": {
              "type": "string"
            },
            "vTpmEnabled": {
              "type": "bool"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "vmNumbers",
                "count": "[length(parameters('sessionHostNames'))]",
                "input": "[int(substring(parameters('sessionHostNames')[copyIndex('vmNumbers')], sub(length(parameters('sessionHostNames')[copyIndex('vmNumbers')]), parameters('sessionHostNameIndexLength')), parameters('sessionHostNameIndexLength')))]"
              },
              {
                "name": "vmIndexStrings",
                "count": "[length(parameters('sessionHostNames'))]",
                "input": "[substring(parameters('sessionHostNames')[copyIndex('vmIndexStrings')], sub(length(parameters('sessionHostNames')[copyIndex('vmIndexStrings')]), parameters('sessionHostNameIndexLength')), parameters('sessionHostNameIndexLength'))]"
              },
              {
                "name": "vmPrefixStrings",
                "count": "[length(parameters('sessionHostNames'))]",
                "input": "[substring(parameters('sessionHostNames')[copyIndex('vmPrefixStrings')], 0, sub(length(parameters('sessionHostNames')[copyIndex('vmPrefixStrings')]), parameters('sessionHostNameIndexLength')))]"
              },
              {
                "name": "fslogixLocalStorageAccountNames",
                "count": "[length(parameters('fslogixLocalStorageAccountResourceIds'))]",
                "input": "[last(split(parameters('fslogixLocalStorageAccountResourceIds')[copyIndex('fslogixLocalStorageAccountNames')], '/'))]"
              },
              {
                "name": "fslogixRemoteStorageAccountNames",
                "count": "[length(parameters('fslogixRemoteStorageAccountResourceIds'))]",
                "input": "[last(split(parameters('fslogixRemoteStorageAccountResourceIds')[copyIndex('fslogixRemoteStorageAccountNames')], '/'))]"
              },
              {
                "name": "fslogixLocalSANameMinus2",
                "count": "[length(variables('fslogixLocalStorageAccountNames'))]",
                "input": "[take(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')], sub(length(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')]), 2))]"
              },
              {
                "name": "fslogixRemoteSANameMinus2",
                "count": "[length(variables('fslogixRemoteStorageAccountNames'))]",
                "input": "[take(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')], sub(length(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')]), 2))]"
              },
              {
                "name": "fslogixExclusionsOfficeArray",
                "count": "[length(variables('fslogixOfficeVHDXs'))]",
                "input": "[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')])]"
              },
              {
                "name": "fslogixExclusionProfileArray",
                "count": "[length(variables('fslogixProfileVHDXs'))]",
                "input": "[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')])]"
              }
            ],
            "$fxv#0": "[CmdletBinding(SupportsShouldProcess = $true)]\r\nparam (\r\n    [string]$AmdVmSize,\r\n    [string]$NvidiaVmSize,\r\n    [string]$DisableUpdates,\r\n    [string]$ConfigureFSLogix,\r\n    [string]$CloudCache = 'false',\r\n    [string]$IdentitySolution,\r\n    [string]$LocalNetAppServers,\r\n    [string]$LocalStorageAccountNames,\r\n    [string]$LocalStorageAccountKeys,\r\n    [string]$OSSGroups,\r\n    [string]$RemoteNetAppServers,\r\n    [string]$RemoteStorageAccountNames,\r\n    [string]$RemoteStorageAccountKeys,\r\n    [string]$Shares,\r\n    [string]$SizeInMBs,\r\n    [string]$StorageAccountDNSSuffix,\r\n    [string]$StorageService,\r\n    [string]$TimeZone\r\n)\r\n\r\n#region Functions\r\n\r\nfunction New-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $true, Position = 0)]\r\n        [string] $Path\r\n    )\r\n\r\n    $date = Get-Date -UFormat \"%Y-%m-%d %H-%M-%S\"\r\n    Set-Variable logFile -Scope Script\r\n    $script:logFile = \"$Script:Name-$date.log\"\r\n\r\n    if ((Test-Path $path ) -eq $false) {\r\n        $null = New-Item -Path $path -type directory\r\n    }\r\n\r\n    $script:Log = Join-Path $path $logfile\r\n\r\n    Add-Content $script:Log \"Date`t`t`tCategory`t`tDetails\"\r\n}\r\n\r\nfunction Write-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $false, Position = 0)]\r\n        [ValidateSet(\"Info\", \"Warning\", \"Error\")]\r\n        $Category = 'Info',\r\n        [Parameter(Mandatory = $true, Position = 1)]\r\n        $Message\r\n    )\r\n\r\n    $Date = get-date\r\n    $Content = \"[$Date]`t$Category`t`t$Message`n\" \r\n    Add-Content $Script:Log $content -ErrorAction Stop\r\n    If ($Verbose) {\r\n        Write-Verbose $Content\r\n    }\r\n    Else {\r\n        Switch ($Category) {\r\n            'Info' { Write-Host $content }\r\n            'Error' { Write-Error $Content }\r\n            'Warning' { Write-Warning $Content }\r\n        }\r\n    }\r\n}\r\n\r\nFunction ConvertFrom-JsonString {\r\n    [CmdletBinding()]\r\n    param (\r\n        [string]$JsonString,\r\n        [string]$Name,\r\n        [switch]$SensitiveValues      \r\n    )\r\n    If ($JsonString -ne '[]' -and $JsonString -ne $null) {\r\n        [array]$Array = $JsonString.replace('\\', '') | ConvertFrom-Json\r\n        If ($Array.Length -gt 0) {\r\n            If ($SensitiveValues) { Write-Log -message \"Array '$Name' has $($Array.Length) members\" } Else { Write-Log -message \"$($Name): '$($Array -join \"', '\")'\" }\r\n            Return $Array\r\n        }\r\n        Else {\r\n            Return $null\r\n        }            \r\n    }\r\n    Else {\r\n        Return $null\r\n    }    \r\n}\r\n\r\nFunction Convert-GroupToSID {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$DomainName,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$GroupName\r\n    )\r\n    Begin {\r\n        [string]$groupSID = ''\r\n    }\r\n    Process {\r\n        Try {\r\n            $groupSID = (New-Object System.Security.Principal.NTAccount(\"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n        }\r\n        Catch {\r\n            Try {\r\n                $groupSID = (New-Object System.Security.Principal.NTAccount($DomainName, \"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n            }\r\n            Catch {\r\n                Write-Error -Message \"Failed to convert group name '$GroupName' to SID.\"\r\n            }\r\n        }\r\n        Write-Output -InputObject $groupSID\r\n    }\r\n}\r\n\r\nFunction Get-InstalledApplication {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string[]]$Name,\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string]$ProductCode\r\n    )\r\n\r\n    Begin {\r\n        [string[]]$regKeyApplications = 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall', 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall'\r\n    }\r\n    Process { \r\n        ## Enumerate the installed applications from the registry for applications that have the \"DisplayName\" property\r\n        [psobject[]]$regKeyApplication = @()\r\n        ForEach ($regKey in $regKeyApplications) {\r\n            If (Test-Path -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath') {\r\n                [psobject[]]$UninstallKeyApps = Get-ChildItem -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath'\r\n                ForEach ($UninstallKeyApp in $UninstallKeyApps) {\r\n                    Try {\r\n                        [psobject]$regKeyApplicationProps = Get-ItemProperty -LiteralPath $UninstallKeyApp.PSPath -ErrorAction 'Stop'\r\n                        If ($regKeyApplicationProps.DisplayName) { [psobject[]]$regKeyApplication += $regKeyApplicationProps }\r\n                    }\r\n                    Catch {\r\n                        Continue\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ## Create a custom object with the desired properties for the installed applications and sanitize property details\r\n        [psobject[]]$installedApplication = @()\r\n        ForEach ($regKeyApp in $regKeyApplication) {\r\n            Try {\r\n                [string]$appDisplayName = ''\r\n                [string]$appDisplayVersion = ''\r\n                [string]$appPublisher = ''\r\n\r\n                ## Bypass any updates or hotfixes\r\n                If (($regKeyApp.DisplayName -match '(?i)kb\\d+') -or ($regKeyApp.DisplayName -match 'Cumulative Update') -or ($regKeyApp.DisplayName -match 'Security Update') -or ($regKeyApp.DisplayName -match 'Hotfix')) {\r\n                    Continue\r\n                }\r\n\r\n                ## Remove any control characters which may interfere with logging and creating file path names from these variables\r\n                $appDisplayName = $regKeyApp.DisplayName -replace '[^\\u001F-\\u007F]', ''\r\n                $appDisplayVersion = $regKeyApp.DisplayVersion -replace '[^\\u001F-\\u007F]', ''\r\n                $appPublisher = $regKeyApp.Publisher -replace '[^\\u001F-\\u007F]', ''\r\n\r\n                ## Determine if application is a 64-bit application\r\n                [boolean]$Is64BitApp = If (($is64Bit) -and ($regKeyApp.PSPath -notmatch '^Microsoft\\.PowerShell\\.Core\\\\Registry::HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Wow6432Node')) { $true } Else { $false }\r\n\r\n                If ($ProductCode) {\r\n                    ## Verify if there is a match with the product code passed to the script\r\n                    If ($regKeyApp.PSChildName -match [regex]::Escape($productCode)) {\r\n                        $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                            UninstallSubkey    = $regKeyApp.PSChildName\r\n                            ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                            DisplayName        = $appDisplayName\r\n                            DisplayVersion     = $appDisplayVersion\r\n                            UninstallString    = $regKeyApp.UninstallString\r\n                            InstallSource      = $regKeyApp.InstallSource\r\n                            InstallLocation    = $regKeyApp.InstallLocation\r\n                            InstallDate        = $regKeyApp.InstallDate\r\n                            Publisher          = $appPublisher\r\n                            Is64BitApplication = $Is64BitApp\r\n                        }\r\n                    }\r\n                }\r\n\r\n                If ($name) {\r\n                    ## Verify if there is a match with the application name(s) passed to the script\r\n                    ForEach ($application in $Name) {\r\n                        $applicationMatched = $false\r\n                        #  Check for a contains application name match\r\n                        If ($regKeyApp.DisplayName -match [regex]::Escape($application)) {\r\n                            $applicationMatched = $true\r\n                        }\r\n\r\n                        If ($applicationMatched) {\r\n                            $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                                UninstallSubkey    = $regKeyApp.PSChildName\r\n                                ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                                DisplayName        = $appDisplayName\r\n                                DisplayVersion     = $appDisplayVersion\r\n                                UninstallString    = $regKeyApp.UninstallString\r\n                                InstallSource      = $regKeyApp.InstallSource\r\n                                InstallLocation    = $regKeyApp.InstallLocation\r\n                                InstallDate        = $regKeyApp.InstallDate\r\n                                Publisher          = $appPublisher\r\n                                Is64BitApplication = $Is64BitApp\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Catch {\r\n                Continue\r\n            }\r\n        }\r\n        Write-Output -InputObject $installedApplication\r\n    }\r\n}\r\n\r\nFunction Set-RegistryValue {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string]\r\n        $Name,\r\n        [Parameter()]\r\n        [string]\r\n        $Path,\r\n        [Parameter()]\r\n        [string]$PropertyType,\r\n        [Parameter()]\r\n        $Value\r\n    )\r\n    Begin {\r\n        Write-Log -message \"[Set-RegistryValue]: Setting Registry Value: $Name\"\r\n    }\r\n    Process {\r\n        # Create the registry Key(s) if necessary.\r\n        If (!(Test-Path -Path $Path)) {\r\n            Write-Log -message \"[Set-RegistryValue]: Creating Registry Key: $Path\"\r\n            New-Item -Path $Path -Force | Out-Null\r\n        }\r\n        # Check for existing registry setting\r\n        $RemoteValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue\r\n        If ($RemoteValue) {\r\n            # Get current Value\r\n            $CurrentValue = Get-ItemPropertyValue -Path $Path -Name $Name\r\n            Write-Log -message \"[Set-RegistryValue]: Current Value of $($Path)\\$($Name) : $CurrentValue\"\r\n            If ($Value -ne $CurrentValue) {\r\n                Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n                Set-ItemProperty -Path $Path -Name $Name -Value $Value -Force | Out-Null\r\n            }\r\n            Else {\r\n                Write-Log -message \"[Set-RegistryValue]: Value of $($Path)\\$($Name) is already set to $Value\"\r\n            }           \r\n        }\r\n        Else {\r\n            Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n            New-ItemProperty -Path $Path -Name $Name -PropertyType $PropertyType -Value $Value -Force | Out-Null\r\n        }\r\n        Start-Sleep -Milliseconds 500\r\n    }\r\n    End {\r\n    }\r\n}\r\n\r\n#endregion Functions\r\n$Script:Name = 'Set-SessionHostConfiguration'\r\n# from https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#recommended-for-exclusion\r\n# only specifying the folders that do not affect performance per article\r\n$redirectionsXMLStart = @'\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<FrxProfileFolderRedirection ExcludeCommonFolders=\"0\">\r\n<Excludes>\r\n'@\r\n$redirectionsXMLExcludesTeams = @'\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\Logs</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\PerfLog</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\EBWebView\\WV2Profile_tfw\\GPUCache</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\Microsoft.Windows.StartMenuExperienceHost_cw5n1h2txyewy\\TempState</Exclude>\r\n'@\r\n$redirectionsXMLExcludesAzCLI = @'\r\n<Exclude Copy=\"0\">.Azure</Exclude>\r\n'@\r\n$redirectionsXMLEnd = @'\r\n</Excludes>\r\n<Includes>\r\n</Includes>\r\n</FrxProfileFolderRedirection>\r\n'@\r\n\r\nNew-Log -Path (Join-Path -Path $env:SystemRoot -ChildPath 'Logs')\r\nwrite-log -message \"*** Parameter Values ***\"\r\nWrite-Log -message \"AmdVmSize: $AmdVmSize\"\r\nWrite-Log -message \"NvidiaVmSize: $NvidiaVmSize\"\r\nWrite-Log -message \"DisableUpdates: $DisableUpdates\"\r\n[bool]$ConfigureFSLogix = [System.Convert]::ToBoolean($ConfigureFSLogix)\r\nWrite-Log -message \"ConfigureFSLogix: $ConfigureFSLogix\"\r\nif ($ConfigureFSLogix) {\r\n    #Convert CloudCache to Boolean\r\n    $CloudCache = [System.Convert]::ToBoolean($CloudCache)\r\n    Write-Log -message \"CloudCache: $CloudCache\"\r\n    #Convert Shares to Array\r\n    [array]$Shares = ConvertFrom-JsonString -JsonString $Shares -Name 'Shares'\r\n    $ProfileShareName = $Shares[0]\r\n    if ($Shares.Count -gt 1) {\r\n        $OfficeShareName = $Shares[1]\r\n    }\r\n    Else {\r\n        $OfficeShareName = $null\r\n    }\r\n\r\n    Write-Log -message \"ProfileShareName: $ProfileShareName\"\r\n    Write-Log -message \"OfficeShareName: $OfficeShareName\"\r\n    Write-Log -message \"StorageService: $StorageService\"\r\n    if ($SizeInMBs -ne '' -and $null -ne $SizeInMBs) {\r\n        [int]$SizeInMBs = $SizeInMBs\r\n        Write-Log -message \"SizeInMBs: $SizeInMBs\"\r\n    }\r\n    Else {\r\n        [int]$SizeInMBs = 30000\r\n        Write-Log -message \"SizeInMBs not specified. Defaulting to: $SizeInMBs\"\r\n    }\r\n    $IdentitySolution = ConvertFrom-JsonString -JsonString $IdentitySolution -Name 'IdentitySolution'  \r\n}\r\n\r\nWrite-Log -message \"TimeZone: $TimeZone\"\r\n\r\nWrite-Log -message \"Configuring Time Zone to: $TimeZone\"\r\nSet-TimeZone -Id \"$TimeZone\"\r\n\r\nWrite-Log -message \"*** Building Array of Registry Settings ***\"\r\n$RegSettings = New-Object System.Collections.ArrayList\r\nIf ($DisableUpdates -eq 'true') {\r\n    # Disable Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-automatic-updates\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU'; Name = 'NoAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Disable Edge Updates : https://learn.microsoft.com/en-us/deployedge/microsoft-edge-update-policies#updatedefault\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\EdgeUpdate'; Name = 'UpdateDefault'; PropertyType = 'DWORD'; Value = 0 })\r\n    # Set the OneDrive Update Ring to Deferred: https://learn.microsoft.com/en-us/sharepoint/use-group-policy#set-the-sync-app-update-ring\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\OneDrive'; Name = 'GPOSetUpdateRing'; PropertyType = 'DWORD'; Value = 0 })\r\n    If (Get-InstalledApplication -Name 'Microsoft 365 Apps') {\r\n        # Disable Office Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-office-automatic-updates\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideupdatenotifications'; PropertyType = 'DWORD'; Value = 1 })\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideenabledisableupdates'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n    If ($TeamsInstalled) {\r\n        # Disable Teams Auto-Update: https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#disable-new-teams-autoupdate-in-non-persistent-vdi\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Microsoft\\Teams'; Name = 'disableAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n}\r\n# Enable Time Zone Redirection: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#set-up-time-zone-redirection\r\n$RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'fEnableTimeZoneRedirection'; PropertyType = 'DWORD'; Value = 1 })\r\n\r\n##############################################################\r\n#  Add GPU Settings\r\n##############################################################\r\n# This setting applies to the VM Size's recommended for AVD with a GPU\r\nif ($AmdVmSize -eq 'true' -or $NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding GPU Settings\"\r\n    # Configure GPU-accelerated app rendering: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-app-rendering\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'bEnumerateHWBeforeSW'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Configure fullscreen video encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-fullscreen-video-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVC444ModePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\n# This setting applies only to VM Size's recommended for AVD with a Nvidia GPU\r\nif ($NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding Nvidia GPU Settings\"\r\n    # Configure GPU-accelerated frame encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-frame-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVChardwareEncodePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\nIf ($ConfigureFSLogix) {\r\n    $AzCLIInstalled = Get-InstalledApplication -Name 'Azure CLI'\r\n    $TeamsInstalled = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -eq 'MSTeams' }\r\n    # Create Array Lists so it is easy to add them\r\n    [System.Collections.ArrayList]$LocalProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheOfficeContainerPaths = @()\r\n\r\n    switch ($StorageService) {\r\n        'AzureFiles' {\r\n            Write-Log -message \"Gathering Azure Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$OSSGroups = ConvertFrom-JsonString -JsonString $OSSGroups -Name 'OSSGroups'\r\n            [array]$LocalStorageAccountNames = ConvertFrom-JsonString -JsonString $LocalStorageAccountNames -Name 'LocalStorageAccountNames'\r\n            [array]$LocalStorageAccountKeys = ConvertFrom-JsonString -JsonString $LocalStorageAccountKeys -Name 'LocalStorageAccountKeys' -SensitiveValues\r\n            [array]$RemoteStorageAccountNames = ConvertFrom-JsonString -JsonString $RemoteStorageAccountNames -Name 'RemoteStorageAccountNames'\r\n            [array]$RemoteStorageAccountKeys = ConvertFrom-JsonString -JsonString $RemoteStorageAccountKeys -Name 'RemoteStorageAccountKeys' -SensitiveValues\r\n            \r\n            Write-Log -message \"*** Begin Processing Storage Accounts ***\"\r\n            # Local Storage Accounts\r\n            Write-Log -message \"Processing Local Storage Accounts\"\r\n            For ($i = 0; $i -lt $LocalStorageAccountNames.Count; $i++) {\r\n                $SAFQDN = \"$($LocalStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                Write-Log -message \"LocalStorageAccountFQDN: '$SAFQDN'\"\r\n                If ($LocalStorageAccountKeys.Count -gt 0) {\r\n                    If ($LocalStorageAccountKeys[$i]) {\r\n                        Write-Log -message \"Adding Local Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                        Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$SAFQDN /user:localhost\\$($LocalStorageAccountNames[$i]) /pass:$($LocalStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                    }\r\n                }\r\n                If ($OfficeShareName) {\r\n                    $LocalOfficeContainerPaths.Add(\"\\\\$SAFQDN\\$OfficeShareName\")\r\n                    Write-Log -message \"LocalOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"                \r\n                    $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                    Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                }\r\n                $LocalProfileContainerPaths.Add(\"\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalProfileContainerPath: \\\\$($SAFQDN)\\$($ProfileShareName)\"\r\n                $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n            }\r\n            # Remote / Existing Storage Accounts\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                Write-Log Info \"Processing Remote Storage Accounts\"\r\n                For ($i = 0; $i -lt $RemoteStorageAccountNames.Count; $i++) {\r\n                    $SAFQDN = \"$($RemoteStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                    Write-Log -message \"RemoteStorageAccountFQDN: '$SAFQDN'\"\r\n                    If ($RemoteStorageAccountKeys.Count -gt 0) {\r\n                        If ($RemoteStorageAccountKeys[$i]) {\r\n                            Write-Log -message \"Adding Remote Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                            Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$($SAFQDN) /user:localhost\\$($RemoteStorageAccountNames[$i]) /pass:$($RemoteStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                        }\r\n                    }\r\n                    If ($OfficeShareName) {\r\n                        $RemoteOfficeContainerPaths.Add(\"\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                        $RemoteCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\"\r\n                    }\r\n                    $RemoteProfileContainerPaths.Add(\"\\\\$(SAFQDN)\\$(ProfileShareName)\")\r\n                    Write-Log -message \"RemoteProfileContainerPath: '\\\\$($SAFQDN)\\$(ProfileShareName)'\"\r\n                    $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n                }\r\n            }\r\n            Write-Log -message \"Done Adding UNC Paths to arrays.\"\r\n        }\r\n        'AzureNetAppFiles' {\r\n            Write-Log -message \"Gathering Azure NetApp Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$LocalNetAppServers = ConvertFrom-JsonString -JsonString $LocalNetAppServers -Name 'LocalNetAppServers'\r\n            [array]$RemoteNetAppServers = ConvertFrom-JsonString -JsonString $RemoteNetAppServers -Name 'RemoteNetAppServers' \r\n            Write-Log -message \"Processing Local Azure NetApp Servers\"        \r\n            $LocalProfileContainerPaths.Add(\"\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalProfileContainerPath: '\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            If ($LocalNetAppServers.Length -gt 1 -and $OfficeShareName) {            \r\n                $LocalOfficeContainerPaths.Add(\"\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalOfficeContainerPath: \\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\"\r\n                $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)'\"\r\n            }\r\n            \r\n            If ($RemoteNetAppServers.Count -gt 0) {\r\n                Write-Log -message \"Processing Remote Azure NetApp Servers\"\r\n                $RemoteProfileContainerPaths.Add(\"\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteProfileContainerPath: '\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)'\"\r\n                $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\"\r\n                If ($RemoteNetAppShares.Length -gt 1 -and $OfficeShareName) {\r\n                    $RemoteOfficeContainerPaths.Add(\"\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                    $RemoteCloudCacheOfficeContainers.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                }        \r\n            }\r\n        }\r\n    }\r\n\r\n    Write-Log -message \"Adding Common FSLogix Settings\"\r\n    # Cleans up an invalid sessions to enable a successful sign-in: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#cleanupinvalidsessions\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'CleanupInvalidSessions'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Apps'; PropertyType = 'DWord'; Value = 1 })\r\n    # Enables Fslogix profile containers: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#enabled\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Fslogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Deletes a local profile if it exists and matches the profile being loaded from VHD: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#deletelocalprofilewhenvhdshouldapply\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'DeleteLocalProfileWhenVHDShouldApply'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#flipflopprofiledirectoryname\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithfailure\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a temporary profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithtempprofile\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachintervalseconds\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 15 })\r\n    # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachretrycount\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 3 })\r\n    # Specifies the maximum size of the user's container in megabytes. Newly created VHD(x) containers are of this size: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#sizeinmbs\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n    # Specifies the file extension for the profile containers: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#volumetype\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'String'; Value = 'VHDX' })\r\n\r\n    If ($LocalStorageAccountKeys.Count -gt 0) {\r\n        Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n        # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#accessnetworkascomputerobject\r\n        $RegSettings.Add([PSCustomObject]@{Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    if ($CloudCache -eq $True) {\r\n        Write-Log -message \"Adding Cloud Cache Settings\"\r\n        # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n        Write-Log -message \"Adding Office Container Settings\"    \r\n        # Enables Fslogix office containers: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#enabled-1   \r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })   \r\n        # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#flipflopprofiledirectoryname-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Specifies the number of retries attempted when a VHD(x) file is locked: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the number of seconds to wait between retries: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretryinterval\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryInterval'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithfailure-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Prevent Login with Temporary Profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithtempprofile-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })    \r\n        # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachintervalseconds\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the maximum size of the user's container in megabytes: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#sizeinmbs\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n        # Specifies the type of container: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#volumetype\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'String'; Value = 'VHDX' })\r\n        If ($LocalStorageAccountKeys.Count -gt 0) {\r\n            Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n            # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#accessnetworkascomputerobject-1\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Settings\"\r\n            # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }   \r\n    }\r\n\r\n    If ($OSSGroups.Count -gt 0) {\r\n        Write-Log -message \"Adding Object Specific Settings\"\r\n        # Object Specific Settings\r\n        $DomainName = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object -ExpandProperty Domain\r\n        Write-Log -message \"DomainName: $DomainName\"\r\n        For ($i = 0; $i -lt $OSSGroups.Count; $i++) {\r\n            # Get Domain information\r\n            Write-Log -message \"Getting SID for $($OSSGroups[$i])\"        \r\n            $OSSGroupSID = Convert-GroupToSID -DomainName $DomainName -GroupName $OSSGroups[$i]\r\n            [string]$LocalProfileContainerPath = $LocalProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalProfileContainerPath: '$LocalProfileContainerPath'\"\r\n            [string]$LocalCloudCacheProfileContainerPath = $LocalCloudCacheProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: '$LocalCloudCacheProfileContainerPath'\"\r\n\r\n            If ($RemoteStorageAccountNames) {\r\n                [string]$RemoteProfileContainerPath = $RemoteProfileContainerPaths[$i]\r\n                Write-Log -message \"RemoteProfileContainerPath: '$RemoteProfileContainerPath'\"\r\n                [string]$RemoteCloudCacheProfileContainerPath = $RemoteCloudCacheProfilePaths[$i]\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: '$RemoteCloudCacheProfileContainerPath'\"\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath + $RemoteProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath + $RemoteCloudCacheProfileContainerPath)\r\n            }\r\n            Else {\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath)\r\n            }\r\n\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Profile Container Settings: $OSSGroupSID : '$($CloudCacheProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Profile Container Settings: $OSSGroupSID : '$($ProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n            }   \r\n\r\n            If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n                [string]$LocalOfficeContainerPath = $LocalOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalOfficeContainerPath: '$LocalOfficeContainerPath'\"\r\n                [string]$LocalCloudCacheOfficeContainerPath = $LocalCloudCacheOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: '$LocalCloudCacheOfficeContainerPath'\"\r\n                If ($RemoteStorageAccountNames) {\r\n                    [string]$RemoteOfficeContainerPath = $RemoteOfficeContainerPaths[$i]\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '$RemoteOfficeContainerPath'\"\r\n                    [string]$RemoteCloudCacheOfficeContainerPath = $RemoteCloudCacheOfficePaths[$i]\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: '$RemoteCloudCacheOfficeContainerPath'\"\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath + $RemoteOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath + $RemoteCloudCacheOfficeContainerPath)\r\n                }\r\n                Else {\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath)\r\n                }\r\n                If ($CloudCache -eq $True) {\r\n                    Write-Log -message \"Adding Cloud Cache Office Container Settings: $OSSGroupSID : '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n                }\r\n                Else {\r\n                    Write-Log -message \"Adding Office Container Settings: $OSSGroupSID : '$($OfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n                }\r\n            }  \r\n        }          \r\n    }\r\n    Else {\r\n        If ($RemoteStorageAccountNames.Count -gt 0) {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths + $RemoteProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths + $RemoteCloudCacheProfileContainerPaths\r\n        }\r\n        Else {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Profile Container Settings: '$($CloudCacheProfileContainerPaths -join \"', '\")'\"   \r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations \r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })             \r\n        }\r\n        Else {\r\n            Write-Log -message \"Adding Profile Container Settings: '$($ProfileContainerPaths -join \"', '\")'\"\r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n        }\r\n        If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths + $RemoteOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths + $RemoteCloudCacheOfficeContainerPaths\r\n            }\r\n            Else {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths\r\n            }\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Office Container Settings: '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Office Container Settings: '$($OfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n            }\r\n        }    \r\n    }\r\n    If ($TeamsInstalled -or $AzCLIInstalled) {\r\n        $customRedirFolder = \"$env:ProgramData\\FSLogix_CustomRedirections\"\r\n        Write-Log -message \"Creating custom redirections.xml file in $customRedirFolder\"\r\n        If (-not (Test-Path $customRedirFolder )) {\r\n            New-Item -Path $customRedirFolder -ItemType Directory -Force\r\n        }\r\n        $customRedirFilePath = \"$customRedirFolder\\redirections.xml\"\r\n        $redirectionsXMLContent = $redirectionsXMLStart\r\n        if ($AzCLIInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesAzCLI\r\n        }\r\n        if ($TeamsInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesTeams\r\n        }\r\n        $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLEnd\r\n        $redirectionsXMLContent | Out-File -FilePath $customRedirFilePath -Encoding unicode\r\n        # Path where FSLogix looks for the redirections.xml file to copy from and into the user's profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#redirxmlsourcefolder\r\n        \r\n        $RegSettings.Add(\r\n            [PSCustomObject]@{\r\n                Name         = 'RedirXMLSourceFolder'\r\n                Path         = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'\r\n                PropertyType = 'String'\r\n                Value        = $customRedirFolder\r\n            }\r\n        )\r\n    }\r\n    If ($IdentitySolution -match 'EntraKerberos') {\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'CloudKerberosTicketRetrievalEnabled'; Path = 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Kerberos\\Parameters'; PropertyType = 'DWord'; Value = 1})\r\n    }\r\n\r\n    $LocalAdministrator = (Get-LocalUser | Where-Object { $_.SID -like '*-500' }).Name\r\n    $LocalGroups = 'FSLogix Profile Exclude List', 'FSLogix ODFC Exclude List'\r\n    ForEach ($Group in $LocalGroups) {\r\n        If (-not (Get-LocalGroupMember -Group $Group | Where-Object { $_.Name -like \"*$LocalAdministrator\" })) {\r\n            Add-LocalGroupMember -Group $Group -Member $LocalAdministrator\r\n        }\r\n    }\r\n}\r\n\r\nWrite-Log -message \"*** Setting Registry Values ***\"\r\nForEach ($Setting in $RegSettings) {\r\n    Set-RegistryValue -Name $Setting.Name -Path $Setting.Path -PropertyType $Setting.PropertyType -Value $Setting.Value -Verbose\r\n}\r\n\r\n# Resize OS Disk\r\nWrite-Log -message \"Resizing OS Disk\"\r\n$driveLetter = $env:SystemDrive.Substring(0, 1)\r\n$size = Get-PartitionSupportedSize -DriveLetter $driveLetter\r\nResize-Partition -DriveLetter $driveLetter -Size $size.SizeMax\r\nWrite-Log -message \"OS Disk Resized\"\r\nClear-EventLog \"Windows PowerShell\" -ErrorAction SilentlyContinue\r\nWrite-Log -message \"Done\"",
            "storageSuffix": "[environment().suffixes.storage]",
            "amdVmSize": "[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), 'as_v4'), endsWith(parameters('virtualMachineSize'), '_V710_v5')))]",
            "nvidiaVmSize": "[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), '_v3'), endsWith(parameters('virtualMachineSize'), '_A10_v5')))]",
            "sessionHostCount": "[length(parameters('sessionHostNames'))]",
            "profileShareName": "[parameters('fslogixFileShareNames')[0]]",
            "officeShareName": "[if(greater(length(parameters('fslogixFileShareNames')), 1), parameters('fslogixFileShareNames')[1], '')]",
            "fslogixLocalNetAppProfileShare": "[if(not(empty(parameters('fslogixLocalNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[0], variables('profileShareName')), '')]",
            "fslogixLocalNetAppOfficeShare": "[if(greater(length(parameters('fslogixLocalNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[1], variables('officeShareName')), '')]",
            "fslogixRemoteNetAppProfileShare": "[if(not(empty(parameters('fslogixRemoteNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[0], variables('profileShareName')), '')]",
            "fslogixRemoteNetAppOfficeShare": "[if(greater(length(parameters('fslogixRemoteNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[1], variables('officeShareName')), '')]",
            "vhdxPath": "\\*\\*.VHDX",
            "fslogixExclusionsCloudCache": "[if(contains(parameters('fslogixContainerType'), 'CloudCache'), '%ProgramData%\\FSLogix\\Cache\\*;%ProgramData%\\FSLogix\\Proxy\\*', '')]",
            "fslogixLocalDedupedSANames": "[union(variables('fslogixLocalSANameMinus2'), variables('fslogixLocalSANameMinus2'))]",
            "fslogixLocalMatchPrefix": "[if(equals(length(variables('fslogixLocalDedupedSANames')), 1), true(), false())]",
            "fslogixLocalOfficeSharesPrefixMatch": "[if(and(not(empty(variables('fslogixLocalDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], variables('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixLocalProfileSharesPrefixMatch": "[if(not(empty(variables('fslogixLocalDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], variables('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixLocalOfficeSharesNoMatch": "[if(not(empty(variables('officeShareName'))), map(variables('fslogixLocalStorageAccountNames'), lambda('name', createArray(format('\\\\{0}??.file.{1}\\{2}{3}', lambdaVariables('name'), variables('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))))), createArray())]",
            "fslogixLocalProfileSharesNoMatch": "[map(variables('fslogixLocalStorageAccountNames'), lambda('name', createArray(format('\\\\{0}.file.{1}}}\\{2}{3}', lambdaVariables('name'), variables('storageSuffix'), variables('profileShareName'), variables('vhdxPath')))))]",
            "fslogixLocalOfficeVHDXs": "[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalOfficeSharesPrefixMatch'), variables('fslogixLocalOfficeSharesNoMatch'))]",
            "fslogixLocalProfileVHDXs": "[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalProfileSharesPrefixMatch'), variables('fslogixLocalProfileSharesNoMatch'))]",
            "fslogixRemoteDedupedSANames": "[union(variables('fslogixRemoteSANameMinus2'), variables('fslogixRemoteSANameMinus2'))]",
            "fslogixRemoteMatchPrefix": "[if(equals(length(variables('fslogixRemoteDedupedSANames')), 1), true(), false())]",
            "fslogixRemoteOfficeSharesPrefixMatch": "[if(and(not(empty(variables('fslogixRemoteDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], variables('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixRemoteProfileSharesPrefixMatch": "[if(not(empty(variables('fslogixRemoteDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], variables('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixRemoteOfficeSharesNoMatch": "[if(and(not(empty(variables('fslogixRemoteStorageAccountNames'))), not(empty(variables('officeShareName')))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', createArray(format('\\\\{0}??.file.{1}\\{2}{3}', lambdaVariables('name'), variables('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))))), createArray())]",
            "fslogixRemoteProfileSharesNoMatch": "[if(not(empty(variables('fslogixRemoteStorageAccountNames'))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', createArray(format('\\\\{0}.file.{1}}}\\{2}{3}', lambdaVariables('name'), variables('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))))), createArray())]",
            "fslogixRemoteOfficeVHDXs": "[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteOfficeSharesPrefixMatch'), variables('fslogixRemoteOfficeSharesNoMatch'))]",
            "fslogixRemoteProfileVHDXs": "[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteProfileSharesPrefixMatch'), variables('fslogixRemoteProfileSharesNoMatch'))]",
            "fslogixOfficeVHDXs": "[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalOfficeVHDXs'), variables('fslogixRemoteOfficeVHDXs')), if(empty(variables('fslogixLocalNetAppOfficeShare')), createArray(), if(empty(variables('fslogixRemoteNetAppOfficeShare')), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppOfficeShare'), variables('vhdxPath'))))))]",
            "fslogixProfileVHDXs": "[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalProfileVHDXs'), variables('fslogixRemoteProfileVHDXs')), if(empty(variables('fslogixLocalNetAppProfileShare')), createArray(), if(empty(variables('fslogixRemoteNetAppProfileShare')), createArray(format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppProfileShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))))))]",
            "fslogixExclusionsOfficeString": "[if(contains(parameters('fslogixContainerType'), 'Office'), join(variables('fslogixExclusionsOfficeArray'), ';'), '')]",
            "fslogixExclusionsProfileString": "[join(variables('fslogixExclusionProfileArray'), ';')]",
            "fslogixExclusionsArray": [
              "[format('$TEMP%{0}', variables('vhdxPath'))]",
              "[format('%WinDir%\\TEMP{0}', variables('vhdxPath'))]",
              "[variables('fslogixExclusionsCloudCache')]",
              "[variables('fslogixExclusionsProfileString')]",
              "[variables('fslogixExclusionsOfficeString')]"
            ],
            "fslogixPathExclusions": "[join(filter(variables('fslogixExclusionsArray'), lambda('exclusion', not(empty(lambdaVariables('exclusion'))))), ';')]",
            "identityType": "[if(if(or(not(contains(parameters('identitySolution'), 'DomainServices')), parameters('enableMonitoring')), true(), false()), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'SystemAssigned, UserAssigned', 'SystemAssigned'), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'UserAssigned', 'None'))]",
            "userAssignedIdentities": "[if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), createObject(format('{0}', parameters('artifactsUserAssignedIdentityResourceId')), createObject()), createObject())]",
            "identity": "[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(variables('userAssignedIdentities'))), variables('userAssignedIdentities'), null())), null())]"
          },
          "resources": [
            {
              "copy": {
                "name": "networkInterface",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2020-05-01",
              "name": "[replace(replace(parameters('networkInterfaceNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[copyIndex()]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[copyIndex()]])]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()))]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "primary": true,
                      "privateIPAddressVersion": "IPv4"
                    }
                  }
                ],
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "enableIPForwarding": false
              }
            },
            {
              "copy": {
                "name": "virtualMachine",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2022-11-01",
              "name": "[replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[copyIndex()]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[copyIndex()]])]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()))]",
              "zones": "[if(or(not(empty(parameters('dedicatedHostResourceId'))), not(empty(parameters('dedicatedHostGroupResourceId')))), parameters('dedicatedHostGroupZones'), if(and(equals(parameters('availability'), 'AvailabilityZones'), not(empty(parameters('availabilityZones')))), createArray(parameters('availabilityZones')[mod(sub(variables('vmNumbers')[range(0, variables('sessionHostCount'))[copyIndex()]], 1), length(parameters('availabilityZones')))]), null()))]",
              "identity": "[variables('identity')]",
              "properties": {
                "availabilitySet": "[if(equals(parameters('availability'), 'AvailabilitySets'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', replace(parameters('availabilitySetNameConv'), '##', padLeft(add(div(sub(variables('vmNumbers')[range(0, variables('sessionHostCount'))[copyIndex()]], 1), 200), 1), 2, '0')))), null())]",
                "hardwareProfile": {
                  "vmSize": "[parameters('virtualMachineSize')]"
                },
                "host": "[if(not(empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostResourceId')), null())]",
                "hostGroup": "[if(and(not(empty(parameters('dedicatedHostGroupResourceId'))), empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostGroupResourceId')), null())]",
                "storageProfile": {
                  "imageReference": "[parameters('imageReference')]",
                  "osDisk": {
                    "diskSizeGB": "[if(not(equals(parameters('diskSizeGB'), 0)), parameters('diskSizeGB'), null())]",
                    "name": "[replace(replace(parameters('osDiskNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[copyIndex()]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[copyIndex()]])]",
                    "osType": "Windows",
                    "createOption": "FromImage",
                    "caching": "ReadWrite",
                    "deleteOption": "Delete",
                    "managedDisk": {
                      "diskEncryptionSet": "[if(and(not(equals(parameters('securityType'), 'ConfidentialVM')), not(empty(parameters('diskEncryptionSetResourceId')))), createObject('id', parameters('diskEncryptionSetResourceId')), null())]",
                      "securityProfile": "[if(equals(parameters('securityType'), 'ConfidentialVM'), createObject('diskEncryptionSet', if(not(empty(parameters('diskEncryptionSetResourceId'))), createObject('id', parameters('diskEncryptionSetResourceId')), null()), 'securityEncryptionType', parameters('confidentialVMOSDiskEncryptionType')), null())]",
                      "storageAccountType": "[parameters('diskSku')]"
                    }
                  },
                  "dataDisks": []
                },
                "osProfile": {
                  "computerName": "[parameters('sessionHostNames')[range(0, variables('sessionHostCount'))[copyIndex()]]]",
                  "adminUsername": "[parameters('virtualMachineAdminUserName')]",
                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": false
                  },
                  "secrets": [],
                  "allowExtensionOperations": true
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(replace(parameters('networkInterfaceNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "securityProfile": {
                  "encryptionAtHost": "[if(parameters('encryptionAtHost'), true(), null())]",
                  "securityType": "[if(not(equals(parameters('securityType'), 'Standard')), parameters('securityType'), null())]",
                  "uefiSettings": "[if(not(equals(parameters('securityType'), 'Standard')), createObject('secureBootEnabled', parameters('secureBootEnabled'), 'vTpmEnabled', parameters('vTpmEnabled')), null())]"
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "[if(or(not(empty(tryGet(parameters('imageReference'), 'id'))), equals(tryGet(parameters('imageReference'), 'publisher'), 'MicrosoftWindowsDesktop')), 'Windows_Client', 'Windows_Server')]"
              },
              "dependsOn": [
                "networkInterface"
              ]
            },
            {
              "copy": {
                "name": "extension_JsonADDomainExtension",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[contains(parameters('identitySolution'), 'DomainServices')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'JsonADDomainExtension')]",
              "location": "[parameters('location')]",
              "properties": {
                "forceUpdateTag": "[parameters('deploymentSuffix')]",
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "Name": "[parameters('domainName')]",
                  "User": "[parameters('domainJoinUserPrincipalName')]",
                  "Restart": "true",
                  "Options": "3",
                  "OUPath": "[parameters('ouPath')]"
                },
                "protectedSettings": {
                  "Password": "[parameters('domainJoinUserPassword')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AADLoginForWindows",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[or(startsWith(parameters('identitySolution'), 'EntraKerberos'), equals(parameters('identitySolution'), 'EntraId'))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'AADLoginForWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": "[if(parameters('intuneEnrollment'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_IaasAntimalware",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[not(startsWith(environment().name, 'USN'))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'IaaSAntimalware')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Security",
                "type": "IaaSAntimalware",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "AntimalwareEnabled": true,
                  "RealtimeProtectionEnabled": "true",
                  "ScheduledScanSettings": {
                    "isEnabled": "true",
                    "day": "7",
                    "time": "120",
                    "scanType": "Quick"
                  },
                  "Exclusions": {
                    "Paths": "[variables('fslogixPathExclusions')]"
                  }
                }
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AzureMonitorWindowsAgent",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[parameters('enableMonitoring')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'AzureMonitorAgent')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Monitor",
                "type": "AzureMonitorWindowsAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "dataCollectionEndpointAssociation",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionEndpointResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "name": "configurationAccessEndpoint",
              "properties": {
                "dataCollectionEndpointId": "[parameters('dataCollectionEndpointResourceId')]",
                "description": "Data Collection Endpoint Association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "avdInsightsDataCollectionRuleAssociation",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('avdInsightsDataCollectionRulesResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "name": "[format('{0}-avdInsights-data-coll-rule-assoc', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('avdInsightsDataCollectionRulesResourceId')]",
                "description": "AVD Insights data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "vmInsightsDataCollectionRuleAssociation",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('vmInsightsDataCollectionRulesResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "name": "[format('{0}-vmInsights-data-coll-rule-assoc', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('vmInsightsDataCollectionRulesResourceId')]",
                "description": "VM Insights data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "securityDataCollectionRuleAssociation",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[not(empty(parameters('securityDataCollectionRulesResourceId')))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "name": "[format('{0}-security-data-coll-rule-assoc', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('securityDataCollectionRulesResourceId')]",
                "description": "Security Events data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_GuestAttestation",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[parameters('integrityMonitoring')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'GuestAttestation')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Security.WindowsAttestation",
                "type": "GuestAttestation",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "AttestationConfig": {
                    "MaaSettings": {
                      "maaEndpoint": "",
                      "maaTenantName": "GuestAttestation"
                    },
                    "AscSettings": {
                      "ascReportingEndpoint": "",
                      "ascReportingFrequency": ""
                    },
                    "useCustomToken": "false",
                    "disableAlerts": "false"
                  }
                }
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AmdGpuDriverWindows",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[variables('amdVmSize')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'AmdGpuDriverWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.HpcCompute",
                "type": "AmdGpuDriverWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {}
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_NvidiaGpuDriverWindows",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[variables('nvidiaVmSize')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'NvidiaGpuDriverWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.HpcCompute",
                "type": "NvidiaGpuDriverWindows",
                "typeHandlerVersion": "1.2",
                "autoUpgradeMinorVersion": true,
                "settings": {}
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "runCommand_ConfigureSessionHost",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'configureSessionHost')]",
              "location": "[parameters('location')]",
              "properties": {
                "parameters": [
                  {
                    "name": "AmdVmSize",
                    "value": "[if(variables('amdVmSize'), 'true', 'false')]"
                  },
                  {
                    "name": "NvidiaVmSize",
                    "value": "[if(variables('nvidiaVmSize'), 'true', 'false')]"
                  },
                  {
                    "name": "DisableUpdates",
                    "value": "false"
                  },
                  {
                    "name": "ConfigureFSLogix",
                    "value": "[if(parameters('fslogixConfigureSessionHosts'), 'true', 'false')]"
                  },
                  {
                    "name": "CloudCache",
                    "value": "[if(contains(parameters('fslogixContainerType'), 'CloudCache'), 'true', 'false')]"
                  },
                  {
                    "name": "IdentitySolution",
                    "value": "[parameters('identitySolution')]"
                  },
                  {
                    "name": "LocalNetAppServers",
                    "value": "[string(parameters('fslogixLocalNetAppServerFqdns'))]"
                  },
                  {
                    "name": "LocalStorageAccountNames",
                    "value": "[string(variables('fslogixLocalStorageAccountNames'))]"
                  },
                  {
                    "name": "OSSGroups",
                    "value": "[string(parameters('fslogixOSSGroups'))]"
                  },
                  {
                    "name": "RemoteNetAppServers",
                    "value": "[string(parameters('fslogixRemoteNetAppServerFqdns'))]"
                  },
                  {
                    "name": "RemoteStorageAccountNames",
                    "value": "[string(variables('fslogixRemoteStorageAccountNames'))]"
                  },
                  {
                    "name": "Shares",
                    "value": "[string(parameters('fslogixFileShareNames'))]"
                  },
                  {
                    "name": "SizeInMBs",
                    "value": "[string(parameters('fslogixSizeInMBs'))]"
                  },
                  {
                    "name": "StorageAccountDNSSuffix",
                    "value": "[variables('storageSuffix')]"
                  },
                  {
                    "name": "StorageService",
                    "value": "[parameters('fslogixStorageService')]"
                  },
                  {
                    "name": "TimeZone",
                    "value": "[parameters('timeZone')]"
                  }
                ],
                "protectedParameters": "[if(parameters('fslogixConfigureSessionHosts'), createArray(createObject('name', 'LocalStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixLocalStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixLocalStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray())))), createObject('name', 'RemoteStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixRemoteStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixRemoteStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray()))))), null())]",
                "source": {
                  "script": "[variables('$fxv#0')]"
                },
                "treatFailureAsDeploymentFailure": true,
                "timeoutInSeconds": 600
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AmdGpuDriverWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_GuestAttestation",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "extension_NvidiaGpuDriverWindows",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "extension_DSC_installAvdAgents",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'AVDAgentInstallandConfig')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('sessionHostRegistrationDSCUrl')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[last(split(parameters('hostPoolResourceId'), '/'))]",
                    "registrationInfoTokenCredential": {
                      "UserName": "PLACEHOLDER_DO_NOT_USE",
                      "Password": "PrivateSettingsRef:RegistrationInfoToken"
                    },
                    "aadJoin": "[not(contains(parameters('identitySolution'), 'DomainServices'))]",
                    "UseAgentDownloadEndpoint": false,
                    "mdmId": "[if(parameters('intuneEnrollment'), '0000000a-0000-0000-c000-000000000000', '')]"
                  }
                },
                "protectedSettings": {
                  "Items": {
                    "RegistrationInfoToken": "[listRegistrationTokens(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').value[0].token]"
                  }
                }
              },
              "dependsOn": [
                "postDeploymentScripts",
                "runCommand_ConfigureSessionHost",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "postDeploymentScripts",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "condition": "[not(empty(parameters('sessionHostCustomizations')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-Customizations-{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "artifactsContainerUri": {
                    "value": "[parameters('artifactsContainerUri')]"
                  },
                  "customizations": {
                    "value": "[parameters('sessionHostCustomizations')]"
                  },
                  "userAssignedIdentityClientId": {
                    "value": "[parameters('artifactsUserAssignedIdentityClientId')]"
                  },
                  "virtualMachineName": {
                    "value": "[replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.28.1.47646",
                      "templateHash": "5405530354186949607"
                    }
                  },
                  "parameters": {
                    "artifactsContainerUri": {
                      "type": "string"
                    },
                    "customizations": {
                      "type": "array"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "userAssignedIdentityClientId": {
                      "type": "string"
                    },
                    "virtualMachineName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "customizers",
                        "count": "[length(parameters('customizations'))]",
                        "input": {
                          "name": "[replace(parameters('customizations')[copyIndex('customizers')].name, ' ', '-')]",
                          "uri": "[if(or(startsWith(parameters('customizations')[copyIndex('customizers')].blobNameOrUri, 'https://'), startsWith(parameters('customizations')[copyIndex('customizers')].blobNameorUri, 'http://')), parameters('customizations')[copyIndex('customizers')].blobNameOrUri, format('{0}/{1}', parameters('artifactsContainerUri'), parameters('customizations')[copyIndex('customizers')].blobNameOrUri))]",
                          "arguments": "[coalesce(tryGet(parameters('customizations')[copyIndex('customizers')], 'arguments'), '')]"
                        }
                      }
                    ],
                    "$fxv#0": "param(\r\n  [string]$APIVersion,\r\n  [string]$Arguments='',\r\n  [string]$BlobStorageSuffix,\r\n  [string]$BuildDir='',\r\n  [string]$Name,\r\n  [string]$Uri,\r\n  [string]$UserAssignedIdentityClientId\r\n)\r\n\r\nfunction Write-OutputWithTimeStamp {\r\n  param(\r\n      [string]$Message\r\n  )    \r\n  $Timestamp = Get-Date -Format 'MM/dd/yyyy HH:mm:ss'\r\n  $Entry = '[' + $Timestamp + '] ' + $Message\r\n  Write-Output $Entry\r\n}\r\n\r\nFunction Split-ArgumentString {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @()\r\n    }\r\n\r\n    # For PowerShell execution with &, we want individual arguments, not combined ones\r\n    $arguments = @()\r\n    $currentArg = \"\"\r\n    $inQuotes = $false\r\n    \r\n    for ($i = 0; $i -lt $ArgumentString.Length; $i++) {\r\n        $char = $ArgumentString[$i]\r\n        \r\n        if ($char -eq '\"' -and ($i -eq 0 -or $ArgumentString[$i-1] -ne '\\')) {\r\n            $inQuotes = !$inQuotes\r\n            $currentArg += $char\r\n        }\r\n        elseif ($char -eq ' ' -and !$inQuotes) {\r\n            if ($currentArg.Length -gt 0) {\r\n                # Handle boolean conversion\r\n                $value = $currentArg.Trim('\"')\r\n                if ($value -eq 'true') {\r\n                    $arguments += '$true'\r\n                }\r\n                elseif ($value -eq 'false') {\r\n                    $arguments += '$false'\r\n                }\r\n                else {\r\n                    $arguments += $value\r\n                }\r\n                $currentArg = \"\"\r\n            }\r\n        }\r\n        else {\r\n            $currentArg += $char\r\n        }\r\n    }\r\n    \r\n    # Add the last argument\r\n    if ($currentArg.Length -gt 0) {\r\n        $value = $currentArg.Trim('\"')\r\n        if ($value -eq 'true') {\r\n            $arguments += '$true'\r\n        }\r\n        elseif ($value -eq 'false') {\r\n            $arguments += '$false'\r\n        }\r\n        else {\r\n            $arguments += $value\r\n        }\r\n    }\r\n    \r\n    return $arguments\r\n}\r\n\r\nFunction ConvertTo-ParametersSplat {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @{}\r\n    }\r\n\r\n    $tokens = Split-ArgumentString -ArgumentString $ArgumentString\r\n    $parameters = @{}\r\n    \r\n    $i = 0\r\n    while ($i -lt $tokens.Count) {\r\n        $token = $tokens[$i]\r\n        \r\n        # If this is a parameter (starts with -)\r\n        if ($token -match '^-(\\w+)$') {\r\n            $paramName = $matches[1]  # Remove the dash\r\n            \r\n            # Check if there's a value following this parameter\r\n            if (($i + 1) -lt $tokens.Count -and $tokens[$i + 1] -notmatch '^-\\w+$') {\r\n                # Parameter with value\r\n                $i++  # Move to the value\r\n                $value = $tokens[$i]\r\n                \r\n                # Handle PowerShell booleans\r\n                if ($value -eq '$true') {\r\n                    $parameters[$paramName] = $true\r\n                }\r\n                elseif ($value -eq '$false') {\r\n                    $parameters[$paramName] = $false\r\n                }\r\n                else {\r\n                    # Remove quotes if present\r\n                    $cleanValue = $value.Trim('\"')\r\n                    $parameters[$paramName] = $cleanValue\r\n                }\r\n            }\r\n            else {\r\n                # This is a switch parameter (no value)\r\n                $parameters[$paramName] = $true\r\n            }\r\n        }\r\n        else {\r\n            # Handle positional arguments (rare in this context)\r\n            # You could add logic here if needed\r\n        }\r\n        \r\n        $i++\r\n    }\r\n    \r\n    return $parameters\r\n}\r\n\r\nStart-Transcript -Path \"$env:SystemRoot\\Logs\\$Name.log\" -Force\r\nWrite-OutputWithTimeStamp \"Starting '$Name' script with the following parameters.\"\r\nWrite-Output ( $PSBoundParameters | Format-Table -AutoSize )\r\nIf ($Arguments -eq '') { $Arguments = $null }\r\nIf ($BuildDir -ne '') {\r\n  $TempDir = Join-Path $BuildDir -ChildPath $Name\r\n} Else {\r\n  $TempDir = Join-Path $Env:TEMP -ChildPath $Name\r\n}\r\nNew-Item -Path $TempDir -ItemType Directory -Force | Out-Null\r\n$WebClient = New-Object System.Net.WebClient\r\nIf ($Uri -match $BlobStorageSuffix -and $UserAssignedIdentityClientId -ne '') {\r\n  Write-OutputWithTimeStamp \"Getting access token for '$Uri' using User Assigned Identity.\"\r\n  $StorageEndpoint = ($Uri -split \"://\")[0] + \"://\" + ($Uri -split \"/\")[2] + \"/\"\r\n  $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=$APIVersion&resource=$StorageEndpoint&client_id=$UserAssignedIdentityClientId\"\r\n  $AccessToken = ((Invoke-WebRequest -Headers @{Metadata = $true } -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n  $WebClient.Headers.Add('x-ms-version', '2017-11-09')\r\n  $webClient.Headers.Add(\"Authorization\", \"Bearer $AccessToken\")\r\n}\r\n$SourceFileName = ($Uri -Split \"/\")[-1]\r\nWrite-OutputWithTimeStamp \"Downloading '$Uri' to '$TempDir'.\"\r\n$DestFile = Join-Path -Path $TempDir -ChildPath $SourceFileName\r\n$webClient.DownloadFile(\"$Uri\", \"$DestFile\")\r\nStart-Sleep -Seconds 10\r\nIf (!(Test-Path -Path $DestFile)) { Write-Error \"Failed to download $SourceFileName\"; Exit 1 }\r\nWrite-OutputWithTimeStamp 'Finished downloading'\r\nSet-Location -Path $TempDir\r\n$Ext = [System.IO.Path]::GetExtension($DestFile).ToLower().Replace('.','')\r\nswitch ($Ext) {\r\n  'exe' {\r\n      If ($Arguments) {\r\n        Write-OutputWithTimeStamp \"Executing '`\"$DestFile`\" $Arguments'\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -ArgumentList (Split-ArgumentString -ArgumentString $Arguments) -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }\r\n      Else {\r\n        Write-OutputWithTimeStamp \"Executing `\"$DestFile`\"\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }      \r\n    }\r\n  'msi' {\r\n    If ($Arguments) {\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $InstallArg = \"/i $DestFile\"\r\n        $Arguments = @($InstallArg) + $Arguments\r\n      }\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe $Arguments'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList $Arguments -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe /i $DestFile /qn'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList \"/i $DestFile /qn\" -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }    \r\n  }\r\n  'bat' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\" $Arguments'\"\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $Arguments = @(\"$DestFile\") + $Arguments\r\n      }\r\n      Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\"'\"\r\n      Start-Process -FilePath cmd.exe -ArgumentList \"`\"$DestFile`\"\" -Wait\r\n    }\r\n  }\r\n  'ps1' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $DestFile @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile'\"\r\n      & $DestFile\r\n    }\r\n  }\r\n  'zip' {\r\n    $DestinationPath = Join-Path -Path \"$TempDir\" -ChildPath $([System.IO.Path]::GetFileNameWithoutExtension($SourceFileName))\r\n    Write-OutputWithTimeStamp \"Extracting '$DestFile' to '$DestinationPath'.\"\r\n    Expand-Archive -Path $DestFile -DestinationPath $DestinationPath -Force\r\n    Write-OutputWithTimeStamp \"Finding PowerShell script in root of '$DestinationPath'.\"\r\n    $PSScript = (Get-ChildItem -Path $DestinationPath -filter '*.ps1').FullName\r\n    If ($PSScript.count -gt 1) { $PSScript = $PSScript[0] }\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $PSScript @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$PSScript'\"         \r\n      & $PSScript\r\n    }\r\n  }\r\n}\r\nIf ((Split-Path $TempDir -Parent) -eq $Env:Temp) {Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue}\r\nStop-Transcript",
                    "apiVersion": "[if(startsWith(environment().name, 'USN'), '2017-08-01', '2018-02-01')]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "runCommands",
                        "count": "[length(variables('customizers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), variables('customizers')[copyIndex()].name)]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "APIVersion",
                            "value": "[variables('apiVersion')]"
                          },
                          {
                            "name": "BlobStorageSuffix",
                            "value": "[format('blob.{0}', environment().suffixes.storage)]"
                          },
                          {
                            "name": "UserAssignedIdentityClientId",
                            "value": "[parameters('userAssignedIdentityClientId')]"
                          },
                          {
                            "name": "Name",
                            "value": "[variables('customizers')[copyIndex()].name]"
                          },
                          {
                            "name": "Uri",
                            "value": "[variables('customizers')[copyIndex()].uri]"
                          },
                          {
                            "name": "Arguments",
                            "value": "[variables('customizers')[copyIndex()].arguments]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#0')]"
                        },
                        "treatFailureAsDeploymentFailure": true
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "runCommand_ConfigureSessionHost",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            },
            {
              "copy": {
                "name": "updateOSDiskNetworkAccess",
                "count": "[length(range(0, variables('sessionHostCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-disable-osDisk-PublicAccess-{1}', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "diskAccessId": {
                    "value": ""
                  },
                  "diskName": {
                    "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]])), '2022-11-01').storageProfile.osDisk.name]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "deploymentSuffix": {
                    "value": "[parameters('deploymentSuffix')]"
                  },
                  "vmName": {
                    "value": "[replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.28.1.47646",
                      "templateHash": "7755680603214976461"
                    }
                  },
                  "parameters": {
                    "diskAccessId": {
                      "type": "string"
                    },
                    "diskName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "deploymentSuffix": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('Update-OSDisk-{0}-Stage2-{1}', parameters('vmName'), parameters('deploymentSuffix'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diskName": {
                            "value": "[parameters('diskName')]"
                          },
                          "creationData": {
                            "value": "[reference(resourceId('Microsoft.Compute/disks', parameters('diskName')), '2023-10-02').creationData]"
                          },
                          "diskAccessId": {
                            "value": "[parameters('diskAccessId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.28.1.47646",
                              "templateHash": "17108881076493352492"
                            }
                          },
                          "parameters": {
                            "creationData": {
                              "type": "object"
                            },
                            "diskName": {
                              "type": "string"
                            },
                            "diskAccessId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/disks",
                              "apiVersion": "2023-10-02",
                              "name": "[parameters('diskName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "diskAccessId": "[if(empty(parameters('diskAccessId')), null(), parameters('diskAccessId'))]",
                                "creationData": "[parameters('creationData')]",
                                "networkAccessPolicy": "[if(empty(parameters('diskAccessId')), 'DenyAll', 'AllowPrivate')]",
                                "publicNetworkAccess": "Disabled"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(replace(parameters('virtualMachineNameConv'), '###', variables('vmIndexStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]), 'VMNAMEPREFIX', variables('vmPrefixStrings')[range(0, variables('sessionHostCount'))[range(0, variables('sessionHostCount'))[copyIndex()]]]))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('ArtifactsUserAssignedIdentity-{0}', variables('deploymentSuffix')))]",
        "availabilitySets",
        "localNetAppVolumes",
        "remoteNetAppVolumes"
      ]
    }
  ]
}