{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## AVD Session Host Replacer - Enterprise Dashboard\n\nThis dashboard provides real-time visibility across all Session Host Replacer deployments in your subscription, including replacement status, deployment progress, and host pool consistency.\n\n---"
      },
      "name": "title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "f1e2d3c4-5b6a-7h8i-9j0k-1l2m3n4o5p6q",
            "version": "KqlParameterItem/1.0",
            "name": "ApplicationInsights",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\n| where type == 'microsoft.insights/components'\n| where name contains 'sessionhostreplacer'\n| order by name asc\n| project value = id, label = name, selected = true",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ],
            "label": "Application Insights"
          },
          {
            "id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
            "version": "KqlParameterItem/1.0",
            "name": "HostPool",
            "type": 2,
            "isRequired": true,
            "query": "traces\n| where timestamp > ago(30d)\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where HostPoolName !in ('bool', 'string', 'int', 'object', 'array')\n| distinct HostPoolName\n| order by HostPoolName asc\n| project value = HostPoolName, label = HostPoolName, selected = false\n| union (datatable(value:string, label:string, selected:bool) [\n    \"*\", \"All Host Pools\", true\n])",
            "crossComponentResources": [
              "{ApplicationInsights}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 0,
            "resourceType": "microsoft.insights/components",
            "value": "*",
            "label": "Host Pool"
          },
          {
            "id": "b8f9c5e7-6f88-4c5a-a7c3-5e8d9f0c1a2b",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "label": "Time Range"
          }
        ],
        "style": "pills",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "### ‚öôÔ∏è Configuration Settings"
      },
      "name": "config-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"SETTINGS |\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend ReplacementMode = extract(@\"ReplacementMode: ([A-Za-z]+)\", 1, message)\n| extend MinimumDrainMinutes = extract(@\"MinimumDrainMinutes: (\\d+)\", 1, message)\n| extend DrainGracePeriodHours = extract(@\"DrainGracePeriodHours: (\\d+)\", 1, message)\n| extend MinimumCapacityPercent = extract(@\"MinimumCapacityPercent: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend MaxDeletionsPerCycle = extract(@\"MaxDeletionsPerCycle: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend EnableProgressiveScaleUp = extract(@\"EnableProgressiveScaleUp: ([A-Za-z]+)\", 1, message)\n| extend InitialDeploymentPercent = extract(@\"InitialDeploymentPercent: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend ScaleUpIncrementPercent = extract(@\"ScaleUpIncrementPercent: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend SuccessfulRunsBeforeScaleUp = extract(@\"SuccessfulRunsBeforeScaleUp: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend MaxDeploymentBatchSize = extract(@\"MaxDeploymentBatchSize: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend MinimumHostIndex = extract(@\"MinimumHostIndex: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend EnableShutdownRetention = extract(@\"EnableShutdownRetention: ([A-Za-z\\/]+)\", 1, message)\n| extend ShutdownRetentionDays = extract(@\"ShutdownRetentionDays: ([\\d\\/A-Za-z]+)\", 1, message)\n| extend TargetSessionHostCount = extract(@\"TargetSessionHostCount: ([\\d\\/A-Za-z]+)\", 1, message)\n| summarize arg_max(timestamp, *) by HostPoolName\n| project \n    ['Host Pool'] = HostPoolName,\n    ['Replacement Mode'] = ReplacementMode,\n    ['Min Drain (min)'] = MinimumDrainMinutes,\n    ['Grace Period (hrs)'] = DrainGracePeriodHours,\n    ['Target Count'] = case(TargetSessionHostCount == \"0\" or TargetSessionHostCount == \"Auto\", \"Auto-Detect\", TargetSessionHostCount),\n    ['Progressive Scale-Up'] = case(EnableProgressiveScaleUp == \"True\", strcat(\"‚úÖ Enabled (\", InitialDeploymentPercent, \"% ‚Üí +\", ScaleUpIncrementPercent, \"% every \", SuccessfulRunsBeforeScaleUp, \" success)\"), \"‚ùå Disabled\"),\n    ['Min Capacity %'] = case(ReplacementMode == \"DeleteFirst\", strcat(MinimumCapacityPercent, \"%\"), \"N/A\"),\n    ['Max Deletions/Cycle'] = case(ReplacementMode == \"DeleteFirst\", MaxDeletionsPerCycle, \"N/A\"),\n    ['Max Batch Size'] = case(ReplacementMode == \"SideBySide\", MaxDeploymentBatchSize, \"N/A\"),\n    ['Min Host Index'] = case(ReplacementMode == \"SideBySide\", MinimumHostIndex, \"N/A\"),\n    ['Shutdown Retention'] = case(ReplacementMode == \"SideBySide\" and EnableShutdownRetention == \"True\", strcat(\"‚úÖ Enabled (\", ShutdownRetentionDays, \" days)\"), ReplacementMode == \"SideBySide\" and EnableShutdownRetention != \"True\", \"‚ùå Disabled\", \"N/A\")",
        "size": 3,
        "title": "Function App Settings",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": [
          "{ApplicationInsights}"
        ],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Replacement Mode",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "DeleteFirst",
                    "representation": "blue",
                    "text": "üîÑ DeleteFirst"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "SideBySide",
                    "representation": "green",
                    "text": "‚ûï SideBySide"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "gray",
                    "text": "{0}"
                  }
                ]
              }
            },
            {
              "columnMatch": "Progressive Scale-Up",
              "formatter": 0
            },
            {
              "columnMatch": "Min Capacity %",
              "formatter": 0
            },
            {
              "columnMatch": "Max Deletions/Cycle",
              "formatter": 0
            },
            {
              "columnMatch": "Max Batch Size",
              "formatter": 0
            },
            {
              "columnMatch": "Min Host Index",
              "formatter": 0
            },
            {
              "columnMatch": "Shutdown Retention",
              "formatter": 0
            }
          ],
          "labelSettings": []
        }
      },
      "customWidth": "100",
      "name": "config-table"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n### üìä Key Performance Indicators"
      },
      "name": "kpi-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"METRICS\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend Total = toint(extract(@\"Total:\\s*(\\d+)\", 1, message))\n| extend Enabled = toint(extract(@\"Enabled:\\s*(\\d+)\", 1, message))\n| extend Target = toint(extract(@\"Target:\\s*(\\d+)\", 1, message))\n| extend ToReplace = toint(extract(@\"ToReplace:\\s*(\\d+)\", 1, message))\n| extend InDrain = toint(extract(@\"InDrain:\\s*(\\d+)\", 1, message))\n| extend ToDeployNow = toint(extract(@\"ToDeployNow:\\s*(\\d+)\", 1, message))\n| where isnotempty(Total)\n| summarize arg_max(timestamp, *) by HostPoolName\n| project \n    Column1 = 'Total Hosts', Value1 = Total,\n    Column2 = 'Enabled', Value2 = Enabled,\n    Column3 = 'Target', Value3 = Target,\n    Column4 = 'To Replace', Value4 = ToReplace,\n    Column5 = 'In Drain', Value5 = InDrain,\n    Column6 = 'To Deploy', Value6 = ToDeployNow\n| mv-expand Column = pack_array(Column1, Column2, Column3, Column4, Column5, Column6), Value = pack_array(Value1, Value2, Value3, Value4, Value5, Value6)\n| project Column = tostring(Column), Value = toint(Value)",
        "size": 4,
        "title": "Current Status",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": [
          "{ApplicationInsights}"
        ],        
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": false,
                "maximumFractionDigits": 2,
                "maximumSignificantDigits": 3
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "100",
      "name": "kpi-tiles"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet deployingFromRunning = toscalar(\n    traces\n    | where timestamp {TimeRange}\n    | extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n    | where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n    | where message contains \"running deployments\" and message contains \"Found\"\n    | extend RunningCount = toint(extract(@\"Found (\\d+) running deployments\", 1, message))\n    | where isnotempty(RunningCount)\n    | summarize arg_max(timestamp, *) by HostPoolName\n    | summarize sum(RunningCount)\n);\nlet deployingFromSubmitted = toscalar(\n    traces\n    | where timestamp > ago(2h)\n    | extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n    | where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n    | where message contains \"Deployment submitted:\"\n    | extend VMCount = toint(extract(@\"Deployment submitted: (\\d+) VMs\", 1, message))\n    | where isnotempty(VMCount)\n    | summarize arg_max(timestamp, *)\n    | project VMCount\n);\nprint Column = 'Currently Deploying', Value = toint(coalesce(deployingFromRunning, 0) + coalesce(deployingFromSubmitted, 0))",
        "size": 4,
        "title": "üöÄ Active Deployments",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "blue"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": false
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "25",
      "name": "deploying-tile"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet failedCount = toscalar(\n    traces\n    | where timestamp {TimeRange}\n    | extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n    | where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n    | where message contains \"failed deployments\" and message contains \"Found\"\n    | extend FailedCount = toint(extract(@\"Found (\\d+) failed deployments\", 1, message))\n    | where isnotempty(FailedCount)\n    | summarize arg_max(timestamp, *) by HostPoolName\n    | summarize sum(FailedCount)\n);\nprint Column = 'Failed Deployments', Value = toint(failedCount)",
        "size": 4,
        "title": "‚ö†Ô∏è Deployment Health",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "redBright"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": false
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "25",
      "name": "failed-deployments-tile"
    },
    {
      "type": 1,
      "content": {
        "json": "### ‚è∞ Schedule Information"
      },
      "name": "schedule-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = traces\n| where timestamp > ago(7d)\n| where message contains \"SCHEDULE\" and message contains \"completed\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| summarize LastRun = max(timestamp) by HostPoolName\n| extend MinutesSinceLastRun = datetime_diff('minute', now(), LastRun)\n| extend Status = case(\n    MinutesSinceLastRun > 45, \"‚ö†Ô∏è Delayed\",\n    MinutesSinceLastRun > 35, \"üü° Due Soon\",\n    \"üü¢ On Schedule\"\n)\n| project HostPool = HostPoolName, ['Last Execution'] = LastRun, ['Minutes Ago'] = MinutesSinceLastRun, Status;\nresults\n| union (datatable(HostPool:string, ['Last Execution']:datetime, ['Minutes Ago']:long, Status:string) ['No Data', datetime(null), 0, '‚ÑπÔ∏è No Data'])\n| where HostPool != 'No Data' or toscalar(results | count) == 0\n| order by HostPool asc",
        "size": 0,
        "title": "Recent Execution History",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Last Execution",
              "formatter": 6
            },
            {
              "columnMatch": "Minutes Ago",
              "formatter": 1
            },
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "Delayed",
                    "representation": "warning",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "Due",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "schedule-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### üñºÔ∏è Image Information"
      },
      "name": "image-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = traces\n| where timestamp {TimeRange}\n| where message contains \"IMAGE_INFO\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend ImageType = extract(@\"Type:\\s*([^\\|]+)\", 1, message)\n| extend Publisher = extract(@\"Publisher:\\s*([^\\|]+)\", 1, message)\n| extend Offer = extract(@\"Offer:\\s*([^\\|]+)\", 1, message)\n| extend Sku = extract(@\"Sku:\\s*([^\\|]+)\", 1, message)\n| extend Gallery = extract(@\"Gallery:\\s*([^\\|]+)\", 1, message)\n| extend ImageDefinition = extract(@\"ImageDefinition:\\s*([^\\|]+)\", 1, message)\n| extend Version = extract(@\"Version:\\s*([^\\s]+)\", 1, message)\n| where isnotempty(ImageType)\n| summarize arg_max(timestamp, *) by HostPoolName\n| project \n    HostPool = HostPoolName,\n    ['Image Type'] = trim_end(@\"\\s\", ImageType),\n    ['Image Details'] = case(\n        trim_end(@\"\\s\", ImageType) == \"Marketplace\", strcat(trim_end(@\"\\s\", Publisher), \"/\", trim_end(@\"\\s\", Offer), \"/\", trim_end(@\"\\s\", Sku)),\n        trim_end(@\"\\s\", ImageType) == \"Gallery\", strcat(trim_end(@\"\\s\", Gallery), \"/\", trim_end(@\"\\s\", ImageDefinition)),\n        \"Unknown\"\n    ),\n    Version = trim_end(@\"\\s\", Version),\n    ['Last Updated'] = timestamp;\nresults\n| union (datatable(HostPool:string, ['Image Type']:string, ['Image Details']:string, Version:string, ['Last Updated']:datetime) ['No Data', 'N/A', 'N/A', 'N/A', datetime(null)])\n| where HostPool != 'No Data' or toscalar(results | count) == 0\n| order by HostPool asc",
        "size": 0,
        "title": "Current Image Configuration",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Image Type",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Marketplace",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Gallery",
                    "representation": "info",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "unknown",
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "Last Updated",
              "formatter": 6
            }
          ]
        }
      },
      "name": "image-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### üéØ Host Pool Consistency"
      },
      "name": "consistency-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"METRICS\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend Total = toint(extract(@\"Total:\\s*(\\d+)\", 1, message))\n| extend ToReplace = toint(extract(@\"ToReplace:\\s*(\\d+)\", 1, message))\n| where isnotempty(Total)\n| summarize arg_max(timestamp, *) by HostPoolName\n| extend OnLatestImage = Total - ToReplace, NeedsReplacement = ToReplace\n| project Status = pack_array(\"On Latest Image\", \"Needs Replacement\"), Count = pack_array(OnLatestImage, NeedsReplacement)\n| mv-expand Status, Count\n| project Status = tostring(Status), Count = toint(Count)\n| render piechart",
        "size": 0,
        "title": "Image Version Compliance",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "HostCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "consistency-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where (message contains \"Previous deployment\" and (message contains \"succeeded\" or message contains \"failed\")) or (message contains \"Deployment submitted successfully\")\n| extend Status = case(\n    message contains \"succeeded\" or message contains \"submitted successfully\", \"Success\",\n    message contains \"failed\", \"Failed\",\n    \"Unknown\")\n| summarize Count = count() by Status\n| render piechart",
        "size": 0,
        "title": "Deployment Success Rate",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "consistency-pie"
    },
    {
      "type": 1,
      "content": {
        "json": "### üîÑ Deployment Progress"
      },
      "name": "deployment-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where (message contains \"Previous deployment\" and message contains \"succeeded\") or (message contains \"Previous deployment\" and message contains \"failed\")\n| summarize Count = count() by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Deployment Activity Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "deployment-timeline"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = traces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"ConsecutiveSuccesses\"\n| extend ConsecutiveSuccesses = toint(extract(@\"ConsecutiveSuccesses: (\\d+)\", 1, message))\n| where isnotempty(ConsecutiveSuccesses)\n| summarize arg_max(timestamp, *) by HostPoolName\n| extend Status = case(\n    ConsecutiveSuccesses == 0, \"üî¥ Starting\",\n    ConsecutiveSuccesses < 3, \"üü° In Progress\",\n    \"üü¢ Stable\"\n)\n| project HostPool = HostPoolName, ['Consecutive Successes'] = ConsecutiveSuccesses, Status, ['Last Updated'] = timestamp;\nresults\n| union (datatable(HostPool:string, ['Consecutive Successes']:int, Status:string, ['Last Updated']:datetime) ['No Data', 0, '‚ÑπÔ∏è No deployment activity', datetime(null)])\n| where HostPool != 'No Data' or toscalar(results | count) == 0\n| order by HostPool asc",
        "size": 0,
        "title": "Progressive Scale-Up Status",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Consecutive Successes",
              "formatter": 4,
              "formatOptions": {
                "palette": "green"
              }
            },
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "Starting",
                    "representation": "failed",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "Progress",
                    "representation": "warning",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "Last Updated",
              "formatter": 6
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "scaleup-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### ‚è±Ô∏è Session Drain Status"
      },
      "name": "drain-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = traces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"is in drain mode\" or (message contains \"drain\" and message contains \"sessions\" and message contains \"timestamp\")\n| project timestamp, message\n| top 20 by timestamp desc;\nresults\n| union (print timestamp = now(), message = '‚úÖ No hosts currently in drain mode')\n| where message != '‚úÖ No hosts currently in drain mode' or toscalar(results | count) == 0\n| top 20 by timestamp desc",
        "size": 0,
        "title": "Hosts Currently in Drain Mode",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "SessionCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "LastCheck",
              "formatter": 6
            }
          ]
        }
      },
      "name": "drain-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### ÔøΩ Failed Deployment Cleanup"
      },
      "name": "failed-deployment-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"failed deployment\" or message contains \"Failed deployment\"\n| project timestamp, HostPoolName, Message = message\n| order by timestamp desc\n| take 20\n| union (print timestamp = now(), HostPoolName = 'N/A', Message = '‚úÖ No failed deployments in selected time range')\n| order by timestamp desc\n| take 20",
        "size": 0,
        "title": "Recent Failed Deployment Activity",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "timestamp",
              "formatter": 6
            },
            {
              "columnMatch": "Message",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "GenericDetails"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "failed-deployment-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = traces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"session hosts from failed deployments\" or message contains \"Marking session host\" and message contains \"failed deployment\"\n| extend VmCount = case(\n    message contains \"Found\", toint(extract(@\"Found (\\d+) session hosts\", 1, message)),\n    1\n)\n| summarize HostsMarkedForCleanup = sum(VmCount) by bin(timestamp, 1h);\nresults\n| union (print timestamp = now(), HostsMarkedForCleanup = 0)\n| where HostsMarkedForCleanup > 0 or toscalar(results | count) == 0\n| render timechart",
        "size": 0,
        "title": "VMs Marked for Cleanup from Failed Deployments",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "failed-deployment-cleanup-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "### ÔøΩüóëÔ∏è Deletion Activity"
      },
      "name": "deletion-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"Deleting session host\"\n| summarize Count = count() by bin(timestamp, 1h)\n| render areachart",
        "size": 0,
        "title": "Deletion Operations Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "deletion-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "### ‚ö†Ô∏è Errors and Warnings"
      },
      "name": "errors-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nunion traces, exceptions\n| where severityLevel >= 2\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, coalesce(message, outerMessage, ''))\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| project timestamp, message = coalesce(message, outerMessage), severityLevel\n| extend Severity = case(\n    severityLevel == 4, \"‚ùå Critical\",\n    severityLevel == 3, \"üî¥ Error\",\n    severityLevel == 2, \"‚ö†Ô∏è Warning\",\n    \"‚ÑπÔ∏è Info\")\n| summarize Count = count() by Severity, bin(timestamp, 1h)\n| render barchart",
        "size": 0,
        "title": "Errors and Warnings Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "errors-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nlet results = union traces, exceptions\n| where severityLevel >= 3\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, coalesce(message, outerMessage, ''))\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| project timestamp, message = coalesce(message, outerMessage), severityLevel\n| where message !contains \"The listener for function\"\n| top 20 by timestamp desc\n| project Timestamp = timestamp, Message = substring(message, 0, 200);\nresults\n| union (datatable(Timestamp:datetime, Message:string) [datetime(null), '‚úÖ No errors in selected time range'])\n| where Message != '‚úÖ No errors in selected time range' or toscalar(results | count) == 0\n| take 20",
        "size": 0,
        "title": "Recent Errors (Top 20)",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Timestamp",
              "formatter": 6
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "errors-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### üìà Historical Trends"
      },
      "name": "trends-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"SessionHostReplacer function started\"\n| summarize Executions = count() by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Function Execution Frequency",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "frequency-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"METRICS\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend Total = toint(extract(@\"Total:\\s*(\\d+)\", 1, message))\n| where isnotempty(Total)\n| summarize arg_max(timestamp, *) by HostPoolName, bin(timestamp, 1h)\n| summarize avg(Total) by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Average Host Pool Size Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "pool-size-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n\nüí° **Tip:** Use the time range selector at the top to adjust the dashboard view. For more detailed analysis, click on any chart to explore the underlying data in Application Insights."
      },
      "name": "footer"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/placeholder/providers/Microsoft.Insights/components/placeholder"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}