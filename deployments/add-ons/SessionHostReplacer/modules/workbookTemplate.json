{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## AVD Session Host Replacer - Enterprise Dashboard\n\nThis dashboard provides real-time visibility across all Session Host Replacer deployments in your subscription, including replacement status, deployment progress, and host pool consistency.\n\n---"
      },
      "name": "title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "f1e2d3c4-5b6a-7h8i-9j0k-1l2m3n4o5p6q",
            "version": "KqlParameterItem/1.0",
            "name": "ApplicationInsights",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\n| where type == 'microsoft.insights/components'\n| where name contains 'sessionhostreplacer'\n| order by name asc\n| project value = id, label = name, selected = true",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ],
            "label": "Application Insights"
          },
          {
            "id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
            "version": "KqlParameterItem/1.0",
            "name": "HostPool",
            "type": 2,
            "isRequired": true,
            "query": "traces\n| where timestamp > ago(30d)\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| distinct HostPoolName\n| order by HostPoolName asc\n| project value = HostPoolName, label = HostPoolName, selected = false\n| union (datatable(value:string, label:string, selected:bool) [\n    \"*\", \"All Host Pools\", true\n])",
            "crossComponentResources": [
              "{ApplicationInsights}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 0,
            "resourceType": "microsoft.insights/components",
            "value": "*",
            "label": "Host Pool"
          },
          {
            "id": "b8f9c5e7-6f88-4c5a-a7c3-5e8d9f0c1a2b",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "label": "Time Range"
          }
        ],
        "style": "pills",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "### ðŸ“Š Key Performance Indicators"
      },
      "name": "kpi-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"METRICS\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend Total = toint(extract(@\"Total:\\s*(\\d+)\", 1, message))\n| extend Enabled = toint(extract(@\"Enabled:\\s*(\\d+)\", 1, message))\n| extend Target = toint(extract(@\"Target:\\s*(\\d+)\", 1, message))\n| extend ToReplace = toint(extract(@\"ToReplace:\\s*(\\d+)\", 1, message))\n| extend InDrain = toint(extract(@\"InDrain:\\s*(\\d+)\", 1, message))\n| extend ToDeployNow = toint(extract(@\"ToDeployNow:\\s*(\\d+)\", 1, message))\n| where isnotempty(Total)\n| summarize arg_max(timestamp, *) by HostPoolName\n| project \n    Column1 = 'Total Hosts', Value1 = Total,\n    Column2 = 'Enabled', Value2 = Enabled,\n    Column3 = 'Target', Value3 = Target,\n    Column4 = 'To Replace', Value4 = ToReplace,\n    Column5 = 'In Drain', Value5 = InDrain,\n    Column6 = 'To Deploy', Value6 = ToDeployNow\n| mv-expand Column = pack_array(Column1, Column2, Column3, Column4, Column5, Column6), Value = pack_array(Value1, Value2, Value3, Value4, Value5, Value6)\n| project Column = tostring(Column), Value = toint(Value)",
        "size": 4,
        "title": "Current Status",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": [
          "{ApplicationInsights}"
        ],
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": false,
                "maximumFractionDigits": 2,
                "maximumSignificantDigits": 3
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "100",
      "name": "kpi-tiles"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"failed deployments\" and message contains \"Found\"\n| extend FailedCount = toint(extract(@\"Found (\\d+) failed deployments\", 1, message))\n| where isnotempty(FailedCount)\n| summarize arg_max(timestamp, *) by HostPoolName\n| summarize TotalFailed = sum(FailedCount)\n| project Column = 'Failed Deployments', Value = TotalFailed",
        "size": 4,
        "title": "âš ï¸ Deployment Health",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "redBright"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": false
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "25",
      "conditionalVisibility": {
        "parameterName": "alwaysShow",
        "comparison": "isNotEqualTo"
      },
      "name": "failed-deployments-tile"
    },
    {
      "type": 1,
      "content": {
        "json": "### ðŸŽ¯ Host Pool Consistency"
      },
      "name": "consistency-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| where message contains \"METRICS\"\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where isnotempty(HostPoolName)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| extend Total = toint(extract(@\"Total:\\s*(\\d+)\", 1, message))\n| extend ToReplace = toint(extract(@\"ToReplace:\\s*(\\d+)\", 1, message))\n| where isnotempty(Total)\n| summarize arg_max(timestamp, *) by HostPoolName\n| extend OnLatestImage = Total - ToReplace, NeedsReplacement = ToReplace\n| project Status = pack_array(\"On Latest Image\", \"Needs Replacement\"), Count = pack_array(OnLatestImage, NeedsReplacement)\n| mv-expand Status, Count\n| project Status = tostring(Status), Count = toint(Count)\n| render piechart",
        "size": 0,
        "title": "Image Version Compliance",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "HostCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "consistency-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where (message contains \"Previous deployment\" and (message contains \"succeeded\" or message contains \"failed\")) or (message contains \"Deployment submitted successfully\")\n| extend Status = case(\n    message contains \"succeeded\" or message contains \"submitted successfully\", \"Success\",\n    message contains \"failed\", \"Failed\",\n    \"Unknown\")\n| summarize Count = count() by Status\n| render piechart",
        "size": 0,
        "title": "Deployment Success Rate",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "consistency-pie"
    },
    {
      "type": 1,
      "content": {
        "json": "### ðŸ”„ Deployment Progress"
      },
      "name": "deployment-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"deployment\" or message contains \"Deploying\" or message contains \"Template\"\n| summarize Count = count() by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Deployment Activity Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "deployment-timeline"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"Checking status of previous deployment\" or message contains \"ConsecutiveSuccesses\"\n| project timestamp, message\n| top 10 by timestamp desc",
        "size": 0,
        "title": "Progressive Scale-Up Status",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table"
      },
      "customWidth": "50",
      "name": "scaleup-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### â±ï¸ Session Drain Status"
      },
      "name": "drain-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"decommission\"\n| project timestamp, message\n| top 20 by timestamp desc",
        "size": 0,
        "title": "Hosts Currently in Drain Mode",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "SessionCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "LastCheck",
              "formatter": 6
            }
          ]
        }
      },
      "name": "drain-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### ï¿½ Failed Deployment Cleanup"
      },
      "name": "failed-deployment-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"failed deployment\" or message contains \"Failed deployment\"\n| project timestamp, HostPoolName, Message = message\n| order by timestamp desc\n| take 20",
        "size": 0,
        "title": "Recent Failed Deployment Activity",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "timestamp",
              "formatter": 6
            },
            {
              "columnMatch": "Message",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "GenericDetails"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "failed-deployment-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"session hosts from failed deployments\" or message contains \"Marking session host\" and message contains \"failed deployment\"\n| extend VmCount = case(\n    message contains \"Found\", toint(extract(@\"Found (\\d+) session hosts\", 1, message)),\n    1\n)\n| summarize HostsMarkedForCleanup = sum(VmCount) by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "VMs Marked for Cleanup from Failed Deployments",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "failed-deployment-cleanup-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "### ï¿½ðŸ—‘ï¸ Deletion Activity"
      },
      "name": "deletion-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"Deleting\" or message contains \"Removed\" or message contains \"device\"\n| summarize Count = count() by bin(timestamp, 1h)\n| render areachart",
        "size": 0,
        "title": "Deletion Operations Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "deletion-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "### âš ï¸ Errors and Warnings"
      },
      "name": "errors-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nunion traces, exceptions\n| where severityLevel >= 2\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, coalesce(message, outerMessage, ''))\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| project timestamp, message = coalesce(message, outerMessage), severityLevel\n| extend Severity = case(\n    severityLevel == 4, \"âŒ Critical\",\n    severityLevel == 3, \"ðŸ”´ Error\",\n    severityLevel == 2, \"âš ï¸ Warning\",\n    \"â„¹ï¸ Info\")\n| summarize Count = count() by Severity, bin(timestamp, 1h)\n| render barchart",
        "size": 0,
        "title": "Errors and Warnings Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "errors-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\nunion traces, exceptions\n| where severityLevel >= 3\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, coalesce(message, outerMessage, ''))\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| project timestamp, message = coalesce(message, outerMessage), severityLevel\n| where message !contains \"The listener for function\"\n| top 20 by timestamp desc\n| project Timestamp = format_datetime(timestamp, 'yyyy-MM-dd HH:mm:ss'), Message = substring(message, 0, 200)",
        "size": 0,
        "title": "Recent Errors (Top 20)",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table"
      },
      "customWidth": "50",
      "name": "errors-table"
    },
    {
      "type": 1,
      "content": {
        "json": "### ðŸ“ˆ Historical Trends"
      },
      "name": "trends-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"SessionHostReplacer function started\"\n| summarize Executions = count() by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Function Execution Frequency",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "frequency-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let hostPoolFilter = '{HostPool}';\ntraces\n| where timestamp {TimeRange}\n| extend HostPoolName = extract(@\"\\[([a-z0-9\\-]+)\\]\", 1, message)\n| where hostPoolFilter == '*' or HostPoolName == hostPoolFilter\n| where message contains \"Found\" and message contains \"session hosts\"\n| extend totalHosts = toint(extract(\"Found (\\\\d+) session hosts\", 1, message))\n| where isnotempty(totalHosts)\n| summarize avg(totalHosts) by bin(timestamp, 1h)\n| render timechart",
        "size": 0,
        "title": "Average Host Pool Size Over Time",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "crossComponentResources": ["{ApplicationInsights}"],
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "pool-size-chart"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n\nðŸ’¡ **Tip:** Use the time range selector at the top to adjust the dashboard view. For more detailed analysis, click on any chart to explore the underlying data in Application Insights."
      },
      "name": "footer"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/placeholder/providers/Microsoft.Insights/components/placeholder"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
