{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "17913414287509201833"
    },
    "name": "AVD Session Host Replacer Add-On",
    "description": "Deploys automated session host lifecycle management for Azure Virtual Desktop",
    "owner": "FederalAVD"
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. The location for all resources. Defaults to deployment location."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Tags for all resources."
      }
    },
    "sessionHostReplacerUserAssignedIdentityResourceId": {
      "type": "string",
      "metadata": {
        "description": "Required. The resource ID of the User-Assigned Managed Identity with Microsoft Graph API permissions (Device.ReadWrite.All, DeviceManagementManagedDevices.ReadWrite.All)."
      }
    },
    "appServicePlanResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource ID of an existing App Service Plan for the function app. If not provided, a new plan will be deployed."
      }
    },
    "zoneRedundant": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Whether to deploy the App Service Plan with zone redundancy. Only applies if appServicePlanResourceId is not provided. Default is false."
      }
    },
    "privateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enable private endpoints for function app and storage. Default is false."
      }
    },
    "privateEndpointSubnetResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The subnet resource ID for private endpoints. Required if privateEndpoint is true."
      }
    },
    "functionAppDelegatedSubnetResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The subnet resource ID for the function app VNet integration. Required if privateEndpoint is true."
      }
    },
    "azureBlobPrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Private DNS Zone resource IDs. Required if privateEndpoint is true."
      }
    },
    "azureFilePrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "azureFunctionAppPrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "azureQueuePrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "azureTablePrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "encryptionKeyVaultResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource ID of the Key Vault for encryption. Required if keyManagementStorageAccounts is set to Customer."
      }
    },
    "keyManagementStorageAccounts": {
      "type": "string",
      "defaultValue": "MicrosoftManaged",
      "allowedValues": [
        "MicrosoftManaged",
        "CustomerManaged",
        "CustomerManagedHSM"
      ],
      "metadata": {
        "description": "Optional. Key management solution for storage accounts. Options: Platform, Customer."
      }
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Log Analytics Workspace resource ID for Application Insights."
      }
    },
    "privateLinkScopeResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Private Link Scope resource ID for Application Insights."
      }
    },
    "credentialsKeyVaultResourceId": {
      "type": "string",
      "metadata": {
        "description": "Required. The resource ID of the Key Vault containing session host credential secrets (VirtualMachineAdminPassword, VirtualMachineAdminUserName, DomainJoinUserPassword, DomainJoinUserPrincipalName)."
      }
    },
    "sessionHostTemplateSpecVersionResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource ID of the Template Spec version for session host deployments. If not provided, a new template spec will be created."
      }
    },
    "templateSpecName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The name of the Template Spec to create. Defaults to hostpool-based naming."
      }
    },
    "templateSpecVersion": {
      "type": "string",
      "defaultValue": "1.0.0",
      "metadata": {
        "description": "Optional. The version of the Template Spec. Default is 1.0.0."
      }
    },
    "timerSchedule": {
      "type": "string",
      "defaultValue": "0 0 * * * *",
      "metadata": {
        "description": "Optional. Timer schedule for the function app (cron expression). Default is every hour."
      }
    },
    "targetVMAgeDays": {
      "type": "int",
      "defaultValue": 45,
      "minValue": 1,
      "maxValue": 365,
      "metadata": {
        "description": "Optional. The target age in days for session hosts before replacement. Default is 45 days."
      }
    },
    "drainGracePeriodHours": {
      "type": "int",
      "defaultValue": 24,
      "minValue": 1,
      "maxValue": 168,
      "metadata": {
        "description": "Optional. The grace period in hours after draining before deleting session hosts. Default is 24 hours."
      }
    },
    "fixSessionHostTags": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Whether to fix session host tags during execution. Default is true."
      }
    },
    "includePreExistingSessionHosts": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Whether to include pre-existing session hosts in automation. Default is true."
      }
    },
    "tagIncludeInAutomation": {
      "type": "string",
      "defaultValue": "IncludeInAutoReplace",
      "metadata": {
        "description": "Optional. Tag name to identify session hosts included in automation. Default is IncludeInAutoReplace."
      }
    },
    "tagDeployTimestamp": {
      "type": "string",
      "defaultValue": "AutoReplaceDeployTimestamp",
      "metadata": {
        "description": "Optional. Tag name for deploy timestamp. Default is AutoReplaceDeployTimestamp."
      }
    },
    "tagPendingDrainTimestamp": {
      "type": "string",
      "defaultValue": "AutoReplacePendingDrainTimestamp",
      "metadata": {
        "description": "Optional. Tag name for pending drain timestamp. Default is AutoReplacePendingDrainTimestamp."
      }
    },
    "tagScalingPlanExclusionTag": {
      "type": "string",
      "defaultValue": "ScalingPlanExclusion",
      "metadata": {
        "description": "Optional. Tag name for scaling plan exclusion. Default is ScalingPlanExclusion."
      }
    },
    "removeEntraDevice": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Whether to remove Entra ID device records when deleting session hosts. Default is true."
      }
    },
    "removeIntuneDevice": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Whether to remove Intune device records when deleting session hosts. Default is true."
      }
    },
    "enableProgressiveScaleUp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enable progressive scale-up with percentage-based batching for deployments. When enabled, the function will start with a small percentage of needed hosts and gradually increase. Default is false."
      }
    },
    "initialDeploymentPercentage": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 100,
      "metadata": {
        "description": "Optional. Initial deployment size as percentage of total needed hosts. Used when progressive scale-up is enabled. Default is 10%."
      }
    },
    "scaleUpIncrementPercentage": {
      "type": "int",
      "defaultValue": 20,
      "minValue": 5,
      "maxValue": 50,
      "metadata": {
        "description": "Optional. Percentage increment added after each successful deployment run. Used when progressive scale-up is enabled. Default is 20%."
      }
    },
    "maxDeploymentBatchSize": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 50,
      "metadata": {
        "description": "Optional. Maximum number of hosts to deploy per run (ceiling constraint). Prevents deploying more than this number even if percentage calculation is higher. Default is 10."
      }
    },
    "successfulRunsBeforeScaleUp": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 5,
      "metadata": {
        "description": "Optional. Number of consecutive successful deployment runs required before increasing the deployment percentage. Default is 1."
      }
    },
    "virtualMachinesResourceGroupId": {
      "type": "string",
      "metadata": {
        "description": "Required. The resource ID of the resource group where virtual machines are deployed."
      }
    },
    "hostPoolResourceId": {
      "type": "string",
      "metadata": {
        "description": "Required. The resource ID of the AVD Host Pool where session hosts will be registered."
      }
    },
    "virtualMachineNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Required. The VM name prefix used for session hosts."
      }
    },
    "vmNameIndexLength": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "Optional. VM name index length for padding."
      }
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsDesktop",
      "metadata": {
        "description": "Optional. Publisher of the marketplace image. Default is MicrosoftWindowsDesktop."
      }
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "windows-11",
      "metadata": {
        "description": "Optional. Offer of the marketplace image. Default is windows-11."
      }
    },
    "imageSku": {
      "type": "string",
      "defaultValue": "win11-25h2-avd",
      "metadata": {
        "description": "Optional. SKU of the marketplace image. Default is win11-25h2-avd."
      }
    },
    "customImageResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource ID of a custom image to use for session hosts. If provided, imagePublisher, imageOffer, and imageSku are ignored."
      }
    },
    "virtualMachineSize": {
      "type": "string",
      "defaultValue": "Standard_D4ads_v5",
      "metadata": {
        "description": "Optional. The VM size for session hosts."
      }
    },
    "virtualMachineSubnetResourceId": {
      "type": "string",
      "metadata": {
        "description": "Required. The subnet resource ID for session host NICs."
      }
    },
    "identitySolution": {
      "type": "string",
      "defaultValue": "ActiveDirectoryDomainServices",
      "allowedValues": [
        "ActiveDirectoryDomainServices",
        "EntraDomainServices",
        "EntraKerberos-Hybrid",
        "EntraKerberos-CloudOnly",
        "EntraId"
      ],
      "metadata": {
        "description": "Optional. The identity solution for session hosts."
      }
    },
    "domainName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The domain name for domain join."
      }
    },
    "ouPath": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The OU path for domain join."
      }
    },
    "intuneEnrollment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enable Intune enrollment for Entra joined VMs."
      }
    },
    "timeZone": {
      "type": "string",
      "defaultValue": "Eastern Standard Time",
      "metadata": {
        "description": "Optional. The time zone for session hosts."
      }
    },
    "availability": {
      "type": "string",
      "defaultValue": "AvailabilityZones",
      "allowedValues": [
        "AvailabilityZones",
        "AvailabilitySets",
        "None"
      ],
      "metadata": {
        "description": "Optional. Availability configuration."
      }
    },
    "availabilityZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Availability zones for session hosts."
      }
    },
    "securityType": {
      "type": "string",
      "defaultValue": "TrustedLaunch",
      "allowedValues": [
        "Standard",
        "TrustedLaunch",
        "ConfidentialVM"
      ],
      "metadata": {
        "description": "Optional. Security type for session hosts."
      }
    },
    "secureBootEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable secure boot."
      }
    },
    "vTpmEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable vTPM."
      }
    },
    "integrityMonitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable integrity monitoring."
      }
    },
    "encryptionAtHost": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable encryption at host."
      }
    },
    "confidentialVMOSDiskEncryption": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enable confidential VM OS disk encryption."
      }
    },
    "diskSizeGB": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Optional. OS disk size in GB. 0 uses image default."
      }
    },
    "diskSku": {
      "type": "string",
      "defaultValue": "Premium_LRS",
      "allowedValues": [
        "Premium_LRS",
        "StandardSSD_LRS",
        "Standard_LRS"
      ],
      "metadata": {
        "description": "Optional. OS disk SKU."
      }
    },
    "enableAcceleratedNetworking": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable accelerated networking."
      }
    },
    "enableMonitoring": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enable monitoring with Azure Monitor Agent."
      }
    },
    "dedicatedHostResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Dedicated host resource ID."
      }
    },
    "dedicatedHostGroupResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Dedicated host group resource ID."
      }
    },
    "dedicatedHostGroupZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Dedicated host group zones."
      }
    },
    "existingDiskEncryptionSetResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Existing disk encryption set resource ID."
      }
    },
    "existingDiskAccessResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Existing disk access resource ID."
      }
    },
    "avdInsightsDataCollectionRulesResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. AVD Insights data collection rules resource ID."
      }
    },
    "vmInsightsDataCollectionRulesResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. VM Insights data collection rules resource ID."
      }
    },
    "securityDataCollectionRulesResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Security data collection rules resource ID."
      }
    },
    "dataCollectionEndpointResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Data collection endpoint resource ID."
      }
    },
    "fslogixConfigureSessionHosts": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. FSLogix configuration - enable session host configuration."
      }
    },
    "fslogixContainerType": {
      "type": "string",
      "defaultValue": "ProfileContainer",
      "allowedValues": [
        "ProfileContainer",
        "OfficeContainer",
        "ProfileContainer OfficeContainer",
        "ProfileContainer CloudCache",
        "OfficeContainer CloudCache",
        "ProfileContainer OfficeContainer CloudCache"
      ],
      "metadata": {
        "description": "Optional. FSLogix container type."
      }
    },
    "fslogixFileShareNames": {
      "type": "array",
      "defaultValue": [
        "profile-containers"
      ],
      "metadata": {
        "description": "Optional. FSLogix file share names."
      }
    },
    "fslogixSizeInMBs": {
      "type": "int",
      "defaultValue": 30000,
      "metadata": {
        "description": "Optional. FSLogix container size in MBs."
      }
    },
    "fslogixStorageService": {
      "type": "string",
      "defaultValue": "AzureFiles",
      "allowedValues": [
        "AzureFiles",
        "AzureNetAppFiles"
      ],
      "metadata": {
        "description": "Optional. FSLogix storage service."
      }
    },
    "fslogixLocalStorageAccountResourceIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. FSLogix local storage account resource IDs."
      }
    },
    "fslogixRemoteStorageAccountResourceIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. FSLogix remote storage account resource IDs."
      }
    },
    "fslogixLocalNetAppVolumeResourceIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. FSLogix local NetApp volume resource IDs."
      }
    },
    "fslogixRemoteNetAppVolumeResourceIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. FSLogix remote NetApp volume resource IDs."
      }
    },
    "fslogixOSSGroups": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. FSLogix OSS groups for sharding."
      }
    },
    "avdAgentsDSCPackage": {
      "type": "string",
      "defaultValue": "Configuration_1.0.03211.1002.zip",
      "metadata": {
        "description": "Optional. AVD Agents DSC package name or URL."
      }
    },
    "artifactsContainerUri": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Artifacts container URI for custom scripts."
      }
    },
    "artifactsUserAssignedIdentityResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Artifacts user assigned identity resource ID."
      }
    },
    "sessionHostCustomizations": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Session host customizations array."
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "AzureCloud": {
        "australiacentral": {
          "abbreviation": "auc",
          "recoveryServicesGeo": "acl"
        },
        "australiacentral2": {
          "abbreviation": "auc2",
          "recoveryServicesGeo": "acl2"
        },
        "australiaeast": {
          "abbreviation": "aue",
          "recoveryServicesGeo": "ae"
        },
        "australiasoutheast": {
          "abbreviation": "ause",
          "recoveryServicesGeo": "ase"
        },
        "brazilsouth": {
          "abbreviation": "brs",
          "recoveryServicesGeo": "brs"
        },
        "brazilsoutheast": {
          "abbreviation": "brse",
          "recoveryServicesGeo": "bse"
        },
        "canadacentral": {
          "abbreviation": "cac",
          "recoveryServicesGeo": "cnc"
        },
        "canadaeast": {
          "abbreviation": "cae",
          "recoveryServicesGeo": "cne"
        },
        "centralindia": {
          "abbreviation": "inc",
          "recoveryServicesGeo": "inc"
        },
        "centralus": {
          "abbreviation": "usc",
          "recoveryServicesGeo": "cus"
        },
        "eastasia": {
          "abbreviation": "ase",
          "recoveryServicesGeo": "ea"
        },
        "eastus": {
          "abbreviation": "use",
          "recoveryServicesGeo": "eus"
        },
        "eastus2": {
          "abbreviation": "use2",
          "recoveryServicesGeo": "eus2"
        },
        "francecentral": {
          "abbreviation": "frc",
          "recoveryServicesGeo": "frc"
        },
        "francesouth": {
          "abbreviation": "frs",
          "recoveryServicesGeo": "frs"
        },
        "germanynorth": {
          "abbreviation": "den",
          "recoveryServicesGeo": "gn"
        },
        "germanywestcentral": {
          "abbreviation": "dewc",
          "recoveryServicesGeo": "gwc"
        },
        "israelcentral": {
          "abbreviation": "ilc",
          "recoveryServicesGeo": "ilc"
        },
        "italynorth": {
          "abbreviation": "itn",
          "recoveryServicesGeo": "itn"
        },
        "japaneast": {
          "abbreviation": "jpe",
          "recoveryServicesGeo": "jpe"
        },
        "japanwest": {
          "abbreviation": "jpw",
          "recoveryServicesGeo": "jpw"
        },
        "jioindiacentral": {
          "abbreviation": "injc",
          "recoveryServicesGeo": "jic"
        },
        "jioindiawest": {
          "abbreviation": "injw",
          "recoveryServicesGeo": "jiw"
        },
        "koreacentral": {
          "abbreviation": "krc",
          "recoveryServicesGeo": "krc"
        },
        "koreasouth": {
          "abbreviation": "krs",
          "recoveryServicesGeo": "krs"
        },
        "northcentralus": {
          "abbreviation": "usnc",
          "recoveryServicesGeo": "ncus"
        },
        "northeurope": {
          "abbreviation": "eun",
          "recoveryServicesGeo": "ne"
        },
        "norwayeast": {
          "abbreviation": "noe",
          "recoveryServicesGeo": "nwe"
        },
        "norwaywest": {
          "abbreviation": "now",
          "recoveryServicesGeo": "nww"
        },
        "polandcentral": {
          "abbreviation": "plc",
          "recoveryServicesGeo": "plc"
        },
        "qatarcentral": {
          "abbreviation": "qac",
          "recoveryServicesGeo": "qac"
        },
        "southafricanorth": {
          "abbreviation": "zan",
          "recoveryServicesGeo": "san"
        },
        "southafricawest": {
          "abbreviation": "zaw",
          "recoveryServicesGeo": "saw"
        },
        "southcentralus": {
          "abbreviation": "ussc",
          "recoveryServicesGeo": "scus"
        },
        "southeastasia": {
          "abbreviation": "asse",
          "recoveryServicesGeo": "sea"
        },
        "southindia": {
          "abbreviation": "ins",
          "recoveryServicesGeo": "ins"
        },
        "swedencentral": {
          "abbreviation": "sec",
          "recoveryServicesGeo": "sdc"
        },
        "switzerlandnorth": {
          "abbreviation": "chn",
          "recoveryServicesGeo": "szn"
        },
        "switzerlandwest": {
          "abbreviation": "chw",
          "recoveryServicesGeo": "szw"
        },
        "uaecentral": {
          "abbreviation": "aec",
          "recoveryServicesGeo": "uac"
        },
        "uaenorth": {
          "abbreviation": "aen",
          "recoveryServicesGeo": "uan"
        },
        "uksouth": {
          "abbreviation": "uks",
          "recoveryServicesGeo": "uks"
        },
        "ukwest": {
          "abbreviation": "ukw",
          "recoveryServicesGeo": "ukw"
        },
        "westcentralus": {
          "abbreviation": "uswc",
          "recoveryServicesGeo": "wcus"
        },
        "westeurope": {
          "abbreviation": "euw",
          "recoveryServicesGeo": "we"
        },
        "westindia": {
          "abbreviation": "inw",
          "recoveryServicesGeo": "inw"
        },
        "westus": {
          "abbreviation": "usw",
          "recoveryServicesGeo": "wus"
        },
        "westus2": {
          "abbreviation": "usw2",
          "recoveryServicesGeo": "wus2"
        },
        "westus3": {
          "abbreviation": "usw3",
          "recoveryServicesGeo": "wus3"
        }
      },
      "AzureUSGovernment": {
        "usdodcentral": {
          "abbreviation": "dodc",
          "recoveryServicesGeo": "udc"
        },
        "usdodeast": {
          "abbreviation": "dode",
          "recoveryServicesGeo": "ude"
        },
        "usgovarizona": {
          "abbreviation": "az",
          "recoveryServicesGeo": "uga"
        },
        "usgovtexas": {
          "abbreviation": "tx",
          "recoveryServicesGeo": "ugt"
        },
        "usgovvirginia": {
          "abbreviation": "va",
          "recoveryServicesGeo": "ugv"
        }
      },
      "other": {
        "north": {
          "abbreviation": "no"
        },
        "east": {
          "abbreviation": "ea"
        },
        "south": {
          "abbreviation": "so"
        },
        "west": {
          "abbreviation": "we"
        },
        "central": {
          "abbreviation": "ce"
        },
        "northcentral": {
          "abbreviation": "noce"
        },
        "eastcentral": {
          "abbreviation": "wece"
        },
        "southcentral": {
          "abbreviation": "soce"
        },
        "westcentral": {
          "abbreviation": "wece"
        }
      }
    },
    "$fxv#1": {
      "applicationInsights": "appi",
      "appServicePlans": "asp",
      "availabilitySets": "as",
      "computeGalleries": "gal",
      "dataCollectionEndpoints": "dce",
      "dataCollectionRules": "dcr",
      "desktopApplicationGroups": "vddag",
      "diskAccesses": "da",
      "remoteApplicationGroups": "vdrag",
      "diskEncryptionSets": "des",
      "functionApps": "fa",
      "hostPools": "vdpool",
      "keyVaults": "kv",
      "logAnalyticsWorkspaces": "law",
      "natGateways": "ng",
      "netAppAccounts": "naa",
      "netAppCapacityPools": "nacp",
      "networkInterfaces": "nic",
      "networkSecurityGroups": "nsg",
      "osdisks": "osdisk",
      "privateEndpoints": "pe",
      "privateLinkScopes": "pls",
      "publicIPAddresses": "pip",
      "recoveryServicesVaults": "rsv",
      "resourceGroups": "rg",
      "routeTables": "rt",
      "scalingPlans": "vdscaling",
      "storageAccounts": "sa",
      "templateSpecs": "ts",
      "userAssignedIdentities": "uai",
      "virtualMachines": "vm",
      "workspaces": "vdws",
      "imageDefinitions": "vmid"
    },
    "$fxv#2": "# This file enables modules to be automatically managed by the Functions service.\r\n# See https://aka.ms/functionsmanageddependency for additional information.\r\n#\r\n@{\r\n    # Uncomment the next line to enable the Az module for Azure PowerShell functions.\r\n    'AzureFunctionConfiguration' = '1.*'\r\n}\r\n",
    "$fxv#3": "# Input bindings are passed in via param block.\r\nparam($Timer)\r\n\r\n# Get the current universal time in the default string format\r\n$currentUTCtime = (Get-Date).ToUniversalTime()\r\n\r\n# The 'IsPastDue' property is 'true' when the current function invocation is later than scheduled.\r\nif ($Timer.IsPastDue) {\r\n    Write-Host \"PowerShell timer is running late!\"\r\n}\r\n\r\n# Initialize environment-agnostic variables from Function App Configuration\r\n$SubscriptionId = $env:SubscriptionId\r\n$HostPoolSubscriptionId = Read-FunctionAppSetting HostPoolSubscriptionId\r\n$VirtualMachinesSubscriptionId = Read-FunctionAppSetting VirtualMachinesSubscriptionId\r\n$ARMToken = Get-AccessToken -ResourceUrl $env:ResourceManagerUrl -ClientId $env:UserAssignedIdentityClientId\r\nWrite-HostDetailed -Message \"ResourceManagerUrl: {0}\" -StringValues $env:ResourceManagerUrl -Level Host\r\nWrite-HostDetailed -Message \"Acquired ARM access token: {0}\" -StringValues ($ARMToken.Substring(0, 20) + '...') -Level Verbose\r\n\r\n# Acquire Graph token if device cleanup is enabled\r\nif ([bool]::Parse((Read-FunctionAppSetting 'RemoveEntraDevice')) -or [bool]::Parse((Read-FunctionAppSetting 'RemoveIntuneDevice'))) {\r\n    $GraphToken = Get-AccessToken -ResourceUrl $env:GraphEndpoint -ClientId $env:UserAssignedIdentityClientId\r\n    Write-HostDetailed -Message \"GraphEndpoint: {0}\" -StringValues $env:GraphEndpoint -Level Host\r\n    Write-HostDetailed -Message \"Acquired Graph access token: {0}\" -StringValues ($GraphToken.Substring(0, 20) + '...') -Level Verbose\r\n}\r\nWrite-HostDetailed -Message \"Function App SubscriptionId: {0}\" -StringValues $SubscriptionId -Level Host\r\nWrite-HostDetailed -Message \"Host Pool SubscriptionId: {0}\" -StringValues $HostPoolSubscriptionId -Level Host\r\nWrite-HostDetailed -Message \"Virtual Machines SubscriptionId: {0}\" -StringValues $VirtualMachinesSubscriptionId -Level Host\r\n\r\n# Decide which Resource group to use for Session Hosts\r\n$HostPoolResourceGroupName = Read-FunctionAppSetting HostPoolResourceGroupName\r\nif ([string]::IsNullOrEmpty((Read-FunctionAppSetting VirtualMachinesResourceGroupName))) {\r\n    $VirtualMachinesResourceGroupName = $HostPoolResourceGroupName\r\n}\r\nelse {\r\n    $VirtualMachinesResourceGroupName = Read-FunctionAppSetting VirtualMachinesResourceGroupName\r\n}\r\nWrite-HostDetailed -Message \"Using resource group {0} for session hosts\" -StringValues $VirtualMachinesResourceGroupName -Level Host\r\n\r\n# Get session hosts and update tags if needed.\r\n$sessionHosts = Get-SessionHosts -FixSessionHostTags (Read-FunctionAppSetting FixSessionHostTags)\r\nWrite-HostDetailed -Message \"Found {0} session hosts\" -StringValues $sessionHosts.Count -Level Host\r\n\r\n# Filter to Session hosts that are included in auto replace\r\n$sessionHostsFiltered = $sessionHosts | Where-Object { $_.IncludeInAutomation }\r\nWrite-HostDetailed -Message \"Filtered to {0} session hosts enabled for automatic replacement: {1}\" -StringValues $sessionHostsFiltered.Count, ($sessionHostsFiltered.SessionHostName -join ',') -Level Host\r\n\r\n# Get running deployments, if any\r\n$runningDeployments = Get-RunningDeployments -SubscriptionId $VirtualMachinesSubscriptionId -ResourceGroupName $VirtualMachinesResourceGroupName\r\nWrite-HostDetailed -Message \"Found {0} running deployments\" -StringValues $runningDeployments.Count -Level Host\r\n\r\n# Load session host parameters\r\n$sessionHostParameters = [hashtable]::new([System.StringComparer]::InvariantCultureIgnoreCase)\r\n$sessionHostParameters += (Read-FunctionAppSetting SessionHostParameters)\r\n\r\n# Get latest version of session host image\r\nWrite-HostDetailed -Message \"Getting latest image version using Image Reference: {0}\" -StringValues ($sessionHostParameters.ImageReference | Out-String) -Level Host\r\n$latestImageVersion = Get-LatestImageVersion -ResourceManagerUrl $env:ResourceManagerUrl -SubscriptionId $VirtualMachinesSubscriptionId -ImageReference $sessionHostParameters.ImageReference -Location $sessionHostParameters.Location\r\n\r\n# Get number session hosts to deploy\r\n$hostPoolDecisions = Get-HostPoolDecisions -SessionHosts $sessionHostsFiltered -RunningDeployments $runningDeployments -LatestImageVersion $latestImageVersion\r\n\r\n# Deploy new session hosts\r\n$deploymentResult = $null\r\nif ($hostPoolDecisions.PossibleDeploymentsCount -gt 0) {\r\n    Write-HostDetailed -Message \"We will deploy {0} session hosts\" -StringValues $hostPoolDecisions.PossibleDeploymentsCount -Level Host\r\n    # Deploy session hosts - use SessionHostName (hostname from FQDN) not VMName (Azure VM resource name)\r\n    $existingSessionHostNames = (@($sessionHosts.SessionHostName) + @($hostPoolDecisions.ExistingSessionHostNames)) | Sort-Object | Select-Object -Unique\r\n    \r\n    try {\r\n        $deploymentResult = Deploy-SessionHosts -VirtualMachinesSubscriptionId $VirtualMachinesSubscriptionId -VirtualMachinesResourceGroupName $VirtualMachinesResourceGroupName -NewSessionHostsCount $hostPoolDecisions.PossibleDeploymentsCount -ExistingSessionHostNames $existingSessionHostNames\r\n        \r\n        # Update deployment state for progressive scale-up tracking\r\n        if ([bool]::Parse((Read-FunctionAppSetting EnableProgressiveScaleUp))) {\r\n            $deploymentState = Get-DeploymentState\r\n            \r\n            if ($deploymentResult.Succeeded) {\r\n                # Increment consecutive successes\r\n                $deploymentState.ConsecutiveSuccesses++\r\n                $deploymentState.LastStatus = 'Success'\r\n                \r\n                # Calculate next percentage\r\n                $successfulRunsBeforeScaleUp = [int]::Parse((Read-FunctionAppSetting SuccessfulRunsBeforeScaleUp))\r\n                $scaleUpIncrementPercentage = [int]::Parse((Read-FunctionAppSetting ScaleUpIncrementPercentage))\r\n                $initialDeploymentPercentage = [int]::Parse((Read-FunctionAppSetting InitialDeploymentPercentage))\r\n                \r\n                $scaleUpMultiplier = [Math]::Floor($deploymentState.ConsecutiveSuccesses / $successfulRunsBeforeScaleUp)\r\n                $deploymentState.CurrentPercentage = [Math]::Min(\r\n                    $initialDeploymentPercentage + ($scaleUpMultiplier * $scaleUpIncrementPercentage),\r\n                    100\r\n                )\r\n                \r\n                Write-HostDetailed \"Deployment succeeded. ConsecutiveSuccesses: $($deploymentState.ConsecutiveSuccesses), NextPercentage: $($deploymentState.CurrentPercentage)%\"\r\n            }\r\n            else {\r\n                # Reset on failure\r\n                $deploymentState.ConsecutiveSuccesses = 0\r\n                $deploymentState.CurrentPercentage = $initialDeploymentPercentage\r\n                $deploymentState.LastStatus = 'Failed'\r\n                \r\n                Write-HostDetailed \"Deployment failed. Resetting consecutive successes to 0\"\r\n            }\r\n            \r\n            # Update deployment tracking info\r\n            $deploymentState.LastDeploymentCount = $deploymentResult.SessionHostCount\r\n            $deploymentState.LastDeploymentNeeded = $hostPoolDecisions.PossibleDeploymentsCount\r\n            $deploymentState.LastDeploymentPercentage = if ($hostPoolDecisions.PossibleDeploymentsCount -gt 0) {\r\n                [Math]::Round(($deploymentResult.SessionHostCount / $hostPoolDecisions.PossibleDeploymentsCount) * 100)\r\n            } else { 0 }\r\n            $deploymentState.LastTimestamp = Get-Date -AsUTC -Format 'o'\r\n            \r\n            # Save state\r\n            Save-DeploymentState -DeploymentState $deploymentState\r\n        }\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Err \"Deployment failed with error: $_\"\r\n        \r\n        # Update state to reflect failure if progressive scale-up is enabled\r\n        if ([bool]::Parse((Read-FunctionAppSetting EnableProgressiveScaleUp))) {\r\n            $deploymentState = Get-DeploymentState\r\n            $deploymentState.ConsecutiveSuccesses = 0\r\n            $deploymentState.CurrentPercentage = [int]::Parse((Read-FunctionAppSetting InitialDeploymentPercentage))\r\n            $deploymentState.LastStatus = 'Failed'\r\n            $deploymentState.LastTimestamp = Get-Date -AsUTC -Format 'o'\r\n            Save-DeploymentState -DeploymentState $deploymentState\r\n        }\r\n        \r\n        throw\r\n    }\r\n}\r\n\r\n# Delete session hosts\r\nif ($hostPoolDecisions.PossibleSessionHostDeleteCount -gt 0 -and $hostPoolDecisions.SessionHostsPendingDelete.Count -gt 0) {\r\n    Write-HostDetailed -Message \"We will decommission {0} session hosts from this list: {1}\" -StringValues $hostPoolDecisions.SessionHostsPendingDelete.Count, ($hostPoolDecisions.SessionHostsPendingDelete.SessionHostName -join ',') -Level Host\r\n    # Decommission session hosts\r\n    $removeEntraDevice = Read-FunctionAppSetting RemoveEntraDevice\r\n    $removeIntuneDevice = Read-FunctionAppSetting RemoveIntuneDevice\r\n    Remove-SessionHosts -SessionHostsPendingDelete $hostPoolDecisions.SessionHostsPendingDelete -RemoveEntraDevice $removeEntraDevice -RemoveIntuneDevice $removeIntuneDevice\r\n}\r\n\r\n# Write an information log with the current time.\r\nWrite-Host \"PowerShell timer trigger function finished! TIME: $currentUTCtime\"\r\n\r\n",
    "$fxv#4": "<#\r\n.SYNOPSIS\r\n    Azure Function Profile for AVD Session Host Replacer\r\n\r\n.DESCRIPTION\r\n    This profile contains all functions required for automated Azure Virtual Desktop (AVD) session host\r\n    lifecycle management. It handles deployment, monitoring, and removal of session hosts based on age\r\n    and image version criteria using native Azure REST APIs and Microsoft Graph APIs.\r\n\r\n.NOTES\r\n    File Name      : profile.ps1\r\n    Author         : FederalAVD Team\r\n    Prerequisite   : Azure Function App with Managed Identity\r\n    Required Permissions:\r\n        Azure RBAC:\r\n            - Desktop Virtualization Contributor (Host Pool RG)\r\n            - Virtual Machine Contributor (Session Host RG)\r\n            - Tag Contributor (Session Host RG)\r\n            - Reader (Template Spec RG)\r\n        Microsoft Graph API:\r\n            - Device.ReadWrite.All\r\n            - DeviceManagementManagedDevices.ReadWrite.All\r\n\r\n.LINK\r\n    https://github.com/Azure/FederalAVD\r\n\r\n.EXAMPLE\r\n    # This file is loaded automatically by Azure Function App\r\n    # Functions are called from TimerTrigger/run.ps1\r\n#>\r\n\r\n#Region Token Cache Variables\r\n\r\n# Global token cache to reduce token acquisition calls\r\n$Script:AccessTokenCache = @{\r\n    Token     = $null\r\n    ExpiresOn = [DateTime]::MinValue\r\n}\r\n\r\n$Script:GraphTokenCache = @{\r\n    Token     = $null\r\n    ExpiresOn = [DateTime]::MinValue\r\n}\r\n\r\n#EndRegion Token Cache Variables\r\n\r\n#Region Authentication Functions\r\n\r\nfunction Get-AccessToken {\r\n    <#\r\n    .SYNOPSIS\r\n        Retrieves Azure Resource Manager access token using Managed Identity.\r\n    .DESCRIPTION\r\n        Acquires an access token from the Azure Instance Metadata Service (IMDS) using\r\n        the function app's managed identity for authenticating ARM API calls.\r\n    .PARAMETER ResourceUrl\r\n        The Azure Resource Manager endpoint URL (e.g., https://management.azure.com/).\r\n    .PARAMETER ClientId\r\n        Optional. The client ID of the user-assigned managed identity. If not specified, uses system-assigned identity.\r\n    .EXAMPLE\r\n        $token = Get-AccessToken -ResourceManagerUrl 'https://management.azure.com/'\r\n    .EXAMPLE\r\n        $token = Get-AccessToken -ResourceManagerUrl 'https://management.azure.com/' -ClientId 'abc123...'\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [parameter(Mandatory = $true)]\r\n        [string]$ResourceUrl,\r\n        \r\n        [parameter(Mandatory = $false)]\r\n        [string]$ClientId\r\n    )\r\n    \r\n    $TokenAuthURI = $env:IDENTITY_ENDPOINT + '?resource=' + $ResourceUrl + '&api-version=2019-08-01'\r\n    \r\n    # Add client_id parameter if using user-assigned identity\r\n    if ($ClientId) {\r\n        $TokenAuthURI += \"&client_id=$ClientId\"\r\n    }\r\n    \r\n    $TokenResponse = Invoke-RestMethod -Method Get -Headers @{\"X-IDENTITY-HEADER\" = \"$env:IDENTITY_HEADER\" } -Uri $TokenAuthURI\r\n    $ARMToken = $TokenResponse.access_token\r\n    Return $ARMToken\r\n}\r\n\r\n#EndRegion Authentication Functions\r\n\r\n#Region Configuration Functions\r\n\r\nfunction Read-FunctionAppSetting {\r\n    <#\r\n    .SYNOPSIS\r\n        Retrieves configuration values from Azure Function App Settings (environment variables).\r\n    .DESCRIPTION\r\n        Reads configuration values from environment variables set in the Azure Function App Settings.\r\n        This is the local implementation matching the AzureFunctionConfiguration module behavior.\r\n    .PARAMETER ConfigKey\r\n        The name of the configuration key to retrieve from environment variables.\r\n    .EXAMPLE\r\n        $hostPoolName = Read-FunctionAppSetting HostPoolName\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true, Position = 0)]\r\n        [string] $ConfigKey\r\n    )\r\n    \r\n    # Get the value from environment variable\r\n    $value = [System.Environment]::GetEnvironmentVariable($ConfigKey)\r\n    \r\n    # Convert JSON strings to hashtables for complex configurations\r\n    if ($value -and $value.StartsWith('{')) {\r\n        try {\r\n            $value = $value | ConvertFrom-Json -AsHashtable -Depth 99\r\n        }\r\n        catch {\r\n            # If JSON conversion fails, return the raw string\r\n            Write-HostDetailed -Message \"Warning: Could not convert $ConfigKey to JSON object\" -Level Warning\r\n        }\r\n    }\r\n    \r\n    # Convert boolean strings to actual boolean values\r\n    if ($value -eq 'true' -or $value -eq 'True') {\r\n        $value = $true\r\n    }\r\n    elseif ($value -eq 'false' -or $value -eq 'False') {\r\n        $value = $false\r\n    }\r\n    \r\n    # Convert numeric strings to integers where appropriate\r\n    if ($value -match '^\\d+$') {\r\n        $value = [int]$value\r\n    }\r\n    \r\n    return $value\r\n}\r\n\r\n#EndRegion Configuration Functions\r\n\r\n#Region Logging and Error Handling\r\n\r\nfunction Write-HostDetailed {\r\n    <#\r\n    .SYNOPSIS\r\n        Enhanced logging function with timestamp and level support.\r\n    .DESCRIPTION\r\n        Writes detailed log messages with timestamps and severity levels.\r\n    .PARAMETER Message\r\n        The message to log.\r\n    .PARAMETER Level\r\n        The severity level (Information, Warning, Error, Host).\r\n    .PARAMETER StringValues\r\n        Array of values to format into the message using -f operator.\r\n    .EXAMPLE\r\n        Write-HostDetailed -Message \"Processing {0} items\" -StringValues 10 -Level Host\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true, Position = 0)]\r\n        [string] $Message,\r\n        \r\n        [Parameter()]\r\n        [ValidateSet('Information', 'Warning', 'Error', 'Host', 'Verbose')]\r\n        [string] $Level = 'Information',\r\n        \r\n        [Parameter()]\r\n        [string[]] $StringValues\r\n    )\r\n    \r\n    # Format message with string values if provided\r\n    if ($StringValues -and $StringValues.Count -gt 0) {\r\n        try {\r\n            $formattedMessage = $Message -f $StringValues\r\n        }\r\n        catch {\r\n            $formattedMessage = $Message\r\n            Write-Warning \"Failed to format message with provided string values\"\r\n        }\r\n    }\r\n    else {\r\n        $formattedMessage = $Message\r\n    }\r\n    \r\n    # Add timestamp\r\n    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'\r\n    $output = \"[$timestamp] [$Level] $formattedMessage\"\r\n    \r\n    # Output based on level\r\n    switch ($Level) {\r\n        'Error' {\r\n            Write-Error $output\r\n        }\r\n        'Warning' {\r\n            Write-Warning $output\r\n        }\r\n        'Host' {\r\n            Write-Host $output -ForegroundColor Cyan\r\n        }\r\n        'Verbose' {\r\n            Write-Verbose $output\r\n        }\r\n        default {\r\n            Write-Information $output -InformationAction Continue\r\n        }\r\n    }\r\n}\r\n\r\nfunction Invoke-AzureRestMethodWithRetry {\r\n    <#\r\n    .SYNOPSIS\r\n        Invokes Azure REST API with automatic retry logic for transient failures.\r\n    .DESCRIPTION\r\n        Wraps Invoke-AzureRestMethod with exponential backoff retry for 429 and 5xx errors.\r\n    .PARAMETER AccessToken\r\n        Azure access token for authentication.\r\n    .PARAMETER Method\r\n        HTTP method (GET, POST, PUT, PATCH, DELETE).\r\n    .PARAMETER Uri\r\n        The REST API endpoint URI.\r\n    .PARAMETER Body\r\n        Optional request body.\r\n    .PARAMETER MaxRetries\r\n        Maximum number of retry attempts (default: 3).\r\n    .PARAMETER RetryDelaySeconds\r\n        Initial retry delay in seconds (default: 5).\r\n    .EXAMPLE\r\n        Invoke-AzureRestMethodWithRetry -ARMToken $token -Method Get -Uri $uri -MaxRetries 5\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $ARMToken,\r\n        \r\n        [Parameter(Mandatory = $true)]\r\n        [ValidateSet('Get', 'Post', 'Put', 'Patch', 'Delete')]\r\n        [string] $Method,\r\n        \r\n        [Parameter(Mandatory = $true)]\r\n        [string] $Uri,\r\n        \r\n        [Parameter()]\r\n        [string] $Body,\r\n        \r\n        [Parameter()]\r\n        [int] $MaxRetries = 3,\r\n        \r\n        [Parameter()]\r\n        [int] $RetryDelaySeconds = 5\r\n    )\r\n    \r\n    $attempt = 0\r\n    $success = $false\r\n    $result = $null\r\n    \r\n    while (-not $success -and $attempt -lt $MaxRetries) {\r\n        $attempt++\r\n        try {\r\n            $params = @{\r\n                ARMToken = $ARMToken\r\n                Method      = $Method\r\n                Uri         = $Uri\r\n            }\r\n            \r\n            if ($Body) {\r\n                $params['Body'] = $Body\r\n            }\r\n            \r\n            $result = Invoke-AzureRestMethod @params\r\n            $success = $true\r\n        }\r\n        catch {\r\n            $statusCode = $null\r\n            if ($_.Exception.Response) {\r\n                $statusCode = $_.Exception.Response.StatusCode.value__\r\n            }\r\n            \r\n            # Retry on transient errors (429 Too Many Requests, 5xx Server Errors)\r\n            if ($statusCode -eq 429 -or ($statusCode -ge 500 -and $statusCode -lt 600)) {\r\n                if ($attempt -lt $MaxRetries) {\r\n                    # Exponential backoff with jitter\r\n                    $delay = $RetryDelaySeconds * [Math]::Pow(2, $attempt - 1)\r\n                    $jitter = Get-Random -Minimum 0 -Maximum 2\r\n                    $totalDelay = $delay + $jitter\r\n                    \r\n                    Write-HostDetailed -Message \"Request failed with status $statusCode. Retrying in $totalDelay seconds... (Attempt $attempt/$MaxRetries)\" -Level Warning\r\n                    Start-Sleep -Seconds $totalDelay\r\n                }\r\n                else {\r\n                    Write-HostDetailed -Message \"Request failed after $MaxRetries attempts: $_\" -Level Error\r\n                    throw\r\n                }\r\n            }\r\n            else {\r\n                # Don't retry on client errors (4xx except 429) or unknown errors\r\n                Write-HostDetailed -Message \"Request failed with non-retryable error (Status: $statusCode): $_\" -Level Error\r\n                throw\r\n            }\r\n        }\r\n    }\r\n    \r\n    return $result\r\n}\r\n\r\n#EndRegion Logging and Error Handling\r\n\r\n#Region Core Helper Functions\r\n\r\nfunction Invoke-GraphApiWithRetry {\r\n    <#\r\n    .SYNOPSIS\r\n        Invokes Microsoft Graph API with automatic retry for DoD endpoint if GCCH fails.\r\n    .DESCRIPTION\r\n        Attempts to call the Graph API with the provided endpoint. If the call fails with\r\n        authentication/forbidden errors, automatically retries with the DoD Graph endpoint.\r\n    .PARAMETER GraphEndpoint\r\n        The initial Graph endpoint to try (e.g., https://graph.microsoft.us).\r\n    .PARAMETER AccessToken\r\n        Bearer token for authentication.\r\n    .PARAMETER Method\r\n        HTTP method (GET, POST, PATCH, DELETE).\r\n    .PARAMETER Uri\r\n        The relative URI path (e.g., /v1.0/devices). Will be appended to GraphEndpoint.\r\n    .PARAMETER Body\r\n        Optional request body for POST/PATCH operations.\r\n    .PARAMETER Headers\r\n        Optional custom headers. Authorization header will be added automatically.\r\n    .EXAMPLE\r\n        Invoke-GraphApiWithRetry -GraphEndpoint $env:GraphEndpoint -ARMToken $token -Method Get -Uri \"/v1.0/devices?`$filter=displayName eq 'VM01'\"\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $GraphEndpoint,\r\n        \r\n        [Parameter(Mandatory = $true)]\r\n        [string] $ARMToken,\r\n        \r\n        [Parameter(Mandatory = $true)]\r\n        [ValidateSet('Get', 'Post', 'Patch', 'Delete', 'Put')]\r\n        [string] $Method,\r\n        \r\n        [Parameter(Mandatory = $true)]\r\n        [string] $Uri,\r\n        \r\n        [Parameter()]\r\n        [string] $Body,\r\n        \r\n        [Parameter()]\r\n        [hashtable] $Headers = @{}\r\n    )\r\n    \r\n    # Ensure GraphEndpoint doesn't have trailing slash\r\n    $graphBase = if ($GraphEndpoint[-1] -eq '/') { \r\n        $GraphEndpoint.Substring(0, $GraphEndpoint.Length - 1) \r\n    } else { \r\n        $GraphEndpoint \r\n    }\r\n    \r\n    # Ensure Uri has leading slash\r\n    $uriPath = if ($Uri[0] -ne '/') { \"/$Uri\" } else { $Uri }\r\n    \r\n    # Build full URI\r\n    $fullUri = \"$graphBase$uriPath\"\r\n    \r\n    # Setup headers\r\n    $requestHeaders = $Headers.Clone()\r\n    $requestHeaders['Authorization'] = \"Bearer $ARMToken\"\r\n    if (-not $requestHeaders.ContainsKey('Content-Type')) {\r\n        $requestHeaders['Content-Type'] = 'application/json'\r\n    }\r\n    \r\n    # List of endpoints to try\r\n    $endpointsToTry = @($graphBase)\r\n    \r\n    # If we're using GCCH endpoint, also try DoD\r\n    if ($graphBase -eq 'https://graph.microsoft.us') {\r\n        $endpointsToTry += 'https://dod-graph.microsoft.us'\r\n    }\r\n    \r\n    $lastError = $null\r\n    foreach ($endpoint in $endpointsToTry) {\r\n        try {\r\n            $attemptUri = \"$endpoint$uriPath\"\r\n            Write-HostDetailed -Message \"Attempting Graph API call to: $attemptUri\" -Level Verbose\r\n            \r\n            $params = @{\r\n                Uri     = $attemptUri\r\n                Method  = $Method\r\n                Headers = $requestHeaders\r\n            }\r\n            \r\n            if ($Body -and $Method -in @('Post', 'Patch', 'Put')) {\r\n                $params['Body'] = $Body\r\n            }\r\n            \r\n            $result = Invoke-RestMethod @params\r\n            \r\n            # If we succeeded with a different endpoint than the one provided, log it\r\n            if ($endpoint -ne $graphBase) {\r\n                Write-HostDetailed -Message \"Graph API call succeeded with alternate endpoint: $endpoint\" -Level Warning\r\n                Write-HostDetailed -Message \"Consider updating GraphEndpoint configuration to: $endpoint\" -Level Warning\r\n            }\r\n            \r\n            return $result\r\n        }\r\n        catch {\r\n            $lastError = $_\r\n            $statusCode = $null\r\n            \r\n            if ($_.Exception.Response) {\r\n                $statusCode = [int]$_.Exception.Response.StatusCode\r\n            }\r\n            \r\n            # Retry on authentication/authorization errors (401, 403) or if endpoint not found (404 on base endpoint)\r\n            if ($statusCode -in @(401, 403, 404) -and $endpoint -ne $endpointsToTry[-1]) {\r\n                Write-HostDetailed -Message \"Graph API call to $endpoint failed with status $statusCode. Trying alternate endpoint...\" -Level Warning\r\n                continue\r\n            }\r\n            else {\r\n                # Don't retry - either not an auth error or we've tried all endpoints\r\n                Write-HostDetailed -Message \"Graph API call failed with status $statusCode : $($_.Exception.Message)\" -Level Error\r\n                throw\r\n            }\r\n        }\r\n    }\r\n    \r\n    # If we get here, all endpoints failed\r\n    Write-HostDetailed -Message \"All Graph API endpoints failed. Last error: $($lastError.Exception.Message)\" -Level Error\r\n    throw $lastError\r\n}\r\n\r\nfunction Invoke-AzureRestMethod {\r\n    <#\r\n        .SYNOPSIS\r\n            Run an Azure REST call with paging support.           \r\n        .PARAMETER AccessToken\r\n            An access token generated by Connect-DCMsGraphAsDelegated or Connect-DCMsGraphAsApplication (depending on what permissions you use in Graph).\r\n        .PARAMETER Method\r\n            The HTTP method for the Graph call, like GET, POST, PUT, PATCH, DELETE. Default is GET.\r\n        .PARAMETER Uri\r\n            The Microsoft Graph URI for the query. Example: https://graph.microsoft.com/v1.0/users/\r\n        .PARAMETER Body\r\n            The request body of the Graph call. This is often used with methids like POST, PUT and PATCH. It is not used with GET.\r\n        .EXAMPLE\r\n            Invoke-AzureRestMethod -ARMToken $ARMToken -Method 'GET' -Uri 'https://graph.microsoft.com/v1.0/users/'\r\n    #>\r\n\r\n    param (\r\n        [parameter(Mandatory = $true)]\r\n        [string]$ARMToken,\r\n\r\n        [parameter(Mandatory = $false)]\r\n        [string]$Method = 'GET',\r\n\r\n        [parameter(Mandatory = $true)]\r\n        [string]$Uri,\r\n\r\n        [parameter(Mandatory = $false)]\r\n        [string]$Body = '',\r\n\r\n        [parameter(Mandatory = $false)]\r\n        [hashtable]$AdditionalHeaders\r\n    )\r\n\r\n    # Check if authentication was successfull.\r\n    if ($ARMToken) {\r\n        # Format headers.\r\n        $HeaderParams = @{\r\n            'Content-Type'  = \"application\\json\"\r\n            'Authorization' = \"Bearer $ARMToken\"\r\n        }\r\n        If ($AdditionalHeaders) {\r\n            $HeaderParams += $AdditionalHeaders\r\n        }\r\n\r\n        # Create an empty array to store the result.\r\n        $QueryRequest = @()\r\n        $dataToUpload = @()\r\n\r\n        # Run the first query.\r\n        if ($Method -eq 'GET') {\r\n            $QueryRequest = Invoke-RestMethod -Headers $HeaderParams -Uri $Uri -UseBasicParsing -Method $Method -ContentType \"application/json\" -Verbose:$false\r\n        }\r\n        else {\r\n            $QueryRequest = Invoke-RestMethod -Headers $HeaderParams -Uri $Uri -UseBasicParsing -Method $Method -ContentType \"application/json\" -Body $Body -Verbose:$false\r\n        }\r\n        if ($QueryRequest.value) {\r\n            $dataToUpload += $QueryRequest.value\r\n        }\r\n        else {\r\n            $dataToUpload += $QueryRequest\r\n        }\r\n\r\n        # Invoke REST methods and fetch data until there are no pages left.\r\n        if ($Uri -notlike \"*`$top*\") {\r\n            while ($QueryRequest.'@odata.nextLink' -and $QueryRequest.'@odata.nextLink' -is [string]) {\r\n                $QueryRequest = Invoke-RestMethod -Headers $HeaderParams -Uri $QueryRequest.'@odata.nextLink' -UseBasicParsing -Method $Method -ContentType \"application/json\" -Verbose:$false\r\n                $dataToUpload += $QueryRequest.value\r\n            }\r\n            While ($QueryRequest.nextLink -and $QueryRequest.nextLink -is [string]) {\r\n                $QueryRequest = Invoke-RestMethod -Headers $HeaderParams -Uri $QueryRequest.'nextLink' -UseBasicParsing -Method $Method -ContentType \"application/json\" -Verbose:$false #4>$null\r\n                $dataToUpload += $QueryRequest.value\r\n            }\r\n            While ($QueryRequest.'$skipToken' -and $QueryRequest.'$skipToken' -is [string] -and $Body -ne '') {\r\n                $tempBody = $Body | ConvertFrom-Json -AsHashtable\r\n                $tempBody.'$skipToken' = $QueryRequest.'$skipToken'\r\n                $Body = $tempBody | ConvertTo-Json -Depth 99\r\n                $QueryRequest = Invoke-RestMethod -Headers $HeaderParams -Uri $Uri -UseBasicParsing -Method $Method -ContentType \"application/json\" -Body $Body -Verbose:$false #4>$null\r\n                $dataToUpload += $QueryRequest.data\r\n            }\r\n        }\r\n        $dataToUpload\r\n    }\r\n    else {\r\n        Write-Error \"No Access Token\"\r\n    }\r\n}\r\n\r\n#EndRegion Configuration and Utility Functions\r\n\r\n#Region Progressive Scale-Up State Management\r\n\r\nfunction Get-DeploymentState {\r\n    <#\r\n    .SYNOPSIS\r\n        Retrieves the deployment state from Azure Table Storage for progressive scale-up tracking.\r\n    .DESCRIPTION\r\n        Reads deployment history from the function app's storage account table to track\r\n        consecutive successful deployments and current scale-up percentage.\r\n    .PARAMETER HostPoolName\r\n        Name of the host pool to retrieve state for.\r\n    .PARAMETER StorageAccountName\r\n        Name of the storage account containing the state table.\r\n    .EXAMPLE\r\n        $state = Get-DeploymentState -HostPoolName 'hp-prod-001'\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n        \r\n        [Parameter()]\r\n        [string] $StorageAccountName = $env:AzureWebJobsStorage.Split(';')[1].Split('=')[1]\r\n    )\r\n    \r\n    try {\r\n        $tableName = 'sessionHostDeploymentState'\r\n        $partitionKey = $HostPoolName\r\n        $rowKey = 'DeploymentState'\r\n        \r\n        # Get storage account context\r\n        $storageContext = New-AzStorageContext -StorageAccountName $StorageAccountName -UseConnectedAccount -ErrorAction Stop\r\n        \r\n        # Get or create table\r\n        $table = Get-AzStorageTable -Name $tableName -Context $storageContext -ErrorAction SilentlyContinue\r\n        if (-not $table) {\r\n            Write-HostDetailed \"Creating deployment state table '$tableName'\"\r\n            $table = New-AzStorageTable -Name $tableName -Context $storageContext\r\n        }\r\n        \r\n        # Get entity\r\n        $cloudTable = $table.CloudTable\r\n        $entity = Get-AzTableRow -Table $cloudTable -PartitionKey $partitionKey -RowKey $rowKey -ErrorAction SilentlyContinue\r\n        \r\n        if ($entity) {\r\n            Write-HostDetailed \"Retrieved deployment state: ConsecutiveSuccesses=$($entity.ConsecutiveSuccesses), CurrentPercentage=$($entity.CurrentPercentage)%\"\r\n            return [PSCustomObject]@{\r\n                LastDeploymentCount     = [int]$entity.LastDeploymentCount\r\n                LastDeploymentNeeded    = [int]$entity.LastDeploymentNeeded\r\n                LastDeploymentPercentage = [int]$entity.LastDeploymentPercentage\r\n                LastStatus              = $entity.LastStatus\r\n                LastTimestamp           = $entity.LastTimestamp\r\n                ConsecutiveSuccesses    = [int]$entity.ConsecutiveSuccesses\r\n                CurrentPercentage       = [int]$entity.CurrentPercentage\r\n            }\r\n        }\r\n        else {\r\n            Write-HostDetailed \"No deployment state found, initializing new state\"\r\n            return [PSCustomObject]@{\r\n                LastDeploymentCount     = 0\r\n                LastDeploymentNeeded    = 0\r\n                LastDeploymentPercentage = 0\r\n                LastStatus              = 'None'\r\n                LastTimestamp           = (Get-Date -AsUTC -Format 'o')\r\n                ConsecutiveSuccesses    = 0\r\n                CurrentPercentage       = (Read-FunctionAppSetting InitialDeploymentPercentage)\r\n            }\r\n        }\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Err \"Failed to retrieve deployment state: $_\"\r\n        # Return default state on error\r\n        return [PSCustomObject]@{\r\n            LastDeploymentCount     = 0\r\n            LastDeploymentNeeded    = 0\r\n            LastDeploymentPercentage = 0\r\n            LastStatus              = 'Error'\r\n            LastTimestamp           = (Get-Date -AsUTC -Format 'o')\r\n            ConsecutiveSuccesses    = 0\r\n            CurrentPercentage       = (Read-FunctionAppSetting InitialDeploymentPercentage)\r\n        }\r\n    }\r\n}\r\n\r\nfunction Save-DeploymentState {\r\n    <#\r\n    .SYNOPSIS\r\n        Saves the deployment state to Azure Table Storage for progressive scale-up tracking.\r\n    .DESCRIPTION\r\n        Writes deployment history to the function app's storage account table to track\r\n        consecutive successful deployments and update scale-up percentage.\r\n    .PARAMETER DeploymentState\r\n        The deployment state object to save.\r\n    .PARAMETER HostPoolName\r\n        Name of the host pool.\r\n    .PARAMETER StorageAccountName\r\n        Name of the storage account.\r\n    .EXAMPLE\r\n        Save-DeploymentState -DeploymentState $state -HostPoolName 'hp-prod-001'\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [PSCustomObject] $DeploymentState,\r\n        \r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n        \r\n        [Parameter()]\r\n        [string] $StorageAccountName = $env:AzureWebJobsStorage.Split(';')[1].Split('=')[1]\r\n    )\r\n    \r\n    try {\r\n        $tableName = 'sessionHostDeploymentState'\r\n        $partitionKey = $HostPoolName\r\n        $rowKey = 'DeploymentState'\r\n        \r\n        # Get storage account context\r\n        $storageContext = New-AzStorageContext -StorageAccountName $StorageAccountName -UseConnectedAccount -ErrorAction Stop\r\n        \r\n        # Get or create table\r\n        $table = Get-AzStorageTable -Name $tableName -Context $storageContext -ErrorAction SilentlyContinue\r\n        if (-not $table) {\r\n            Write-HostDetailed \"Creating deployment state table '$tableName'\"\r\n            $table = New-AzStorageTable -Name $tableName -Context $storageContext\r\n        }\r\n        \r\n        # Prepare entity\r\n        $cloudTable = $table.CloudTable\r\n        $entity = Get-AzTableRow -Table $cloudTable -PartitionKey $partitionKey -RowKey $rowKey -ErrorAction SilentlyContinue\r\n        \r\n        if ($entity) {\r\n            # Update existing entity\r\n            $entity.LastDeploymentCount = $DeploymentState.LastDeploymentCount\r\n            $entity.LastDeploymentNeeded = $DeploymentState.LastDeploymentNeeded\r\n            $entity.LastDeploymentPercentage = $DeploymentState.LastDeploymentPercentage\r\n            $entity.LastStatus = $DeploymentState.LastStatus\r\n            $entity.LastTimestamp = $DeploymentState.LastTimestamp\r\n            $entity.ConsecutiveSuccesses = $DeploymentState.ConsecutiveSuccesses\r\n            $entity.CurrentPercentage = $DeploymentState.CurrentPercentage\r\n            $entity | Update-AzTableRow -Table $cloudTable | Out-Null\r\n        }\r\n        else {\r\n            # Create new entity\r\n            Add-AzTableRow -Table $cloudTable -PartitionKey $partitionKey -RowKey $rowKey -Property @{\r\n                LastDeploymentCount     = $DeploymentState.LastDeploymentCount\r\n                LastDeploymentNeeded    = $DeploymentState.LastDeploymentNeeded\r\n                LastDeploymentPercentage = $DeploymentState.LastDeploymentPercentage\r\n                LastStatus              = $DeploymentState.LastStatus\r\n                LastTimestamp           = $DeploymentState.LastTimestamp\r\n                ConsecutiveSuccesses    = $DeploymentState.ConsecutiveSuccesses\r\n                CurrentPercentage       = $DeploymentState.CurrentPercentage\r\n            } | Out-Null\r\n        }\r\n        \r\n        Write-HostDetailed \"Saved deployment state: Status=$($DeploymentState.LastStatus), ConsecutiveSuccesses=$($DeploymentState.ConsecutiveSuccesses), NextPercentage=$($DeploymentState.CurrentPercentage)%\"\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Err \"Failed to save deployment state: $_\"\r\n    }\r\n}\r\n\r\n#EndRegion Progressive Scale-Up State Management\r\n\r\n#Region Session Host Lifecycle Functions\r\n\r\nfunction Deploy-SessionHosts {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string[]] $ExistingSessionHostNames = @(),\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [int] $NewSessionHostsCount,\r\n\r\n        [Parameter(Mandatory = $false)]\r\n        [string] $HostPoolResourceGroupName = (Read-FunctionAppSetting HostPoolResourceGroupName),\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $VirtualMachinesSubscriptionId,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $VirtualMachinesResourceGroupName,\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n\r\n        [Parameter()]\r\n        [string] $SessionHostNamePrefix = (Read-FunctionAppSetting SessionHostNamePrefix),\r\n\r\n        [Parameter()]\r\n        [int] $SessionHostInstanceNumberPadding = (Read-FunctionAppSetting SessionHostInstanceNumberPadding),\r\n\r\n        [Parameter()]\r\n        [string] $DeploymentPrefix = (Read-FunctionAppSetting SHRDeploymentPrefix),\r\n\r\n        [Parameter()]\r\n        [hashtable] $SessionHostParameters = (Read-FunctionAppSetting SessionHostParameters | ConvertTo-CaseInsensitiveHashtable),\r\n\r\n        [Parameter()]\r\n        [string] $SessionHostTemplate = (Read-FunctionAppSetting SessionHostTemplate),\r\n\r\n        [Parameter()]\r\n        [string] $TagIncludeInAutomation = (Read-FunctionAppSetting Tag_IncludeInAutomation),\r\n\r\n        [Parameter()]\r\n        [string] $TagDeployTimestamp = (Read-FunctionAppSetting Tag_DeployTimestamp)\r\n    )\r\n\r\n    Write-HostDetailed -Message \"Generating new token for the host pool $HostPoolName in Resource Group $HostPoolResourceGroupName\"\r\n    $Body = @{\r\n        properties = @{\r\n            registrationInfo = @{\r\n                expirationTime             = (Get-Date).AddHours(8)\r\n                registrationTokenOperation = 'Update'\r\n            }\r\n        }\r\n    }\r\n    Invoke-AzureRestMethod `\r\n        -ARMToken $ARMToken `\r\n        -Body ($Body | ConvertTo-Json -depth 10) `\r\n        -Method Patch `\r\n        -Uri ($ResourceManagerUrl + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $HostPoolResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '?api-version=2024-04-03') | Out-Null\r\n    \r\n    # Calculate Session Host Names\r\n    Write-HostDetailed -Level Host -Message \"Existing session host VM names: {0}\" -StringValues ($ExistingSessionHostNames -join ',')\r\n    [array] $sessionHostNames = for ($i = 0; $i -lt $NewSessionHostsCount; $i++) {\r\n        $shNumber = 1\r\n        While ((\"$SessionHostNamePrefix{0:d$SessionHostInstanceNumberPadding}\" -f $shNumber) -in $ExistingSessionHostNames) {\r\n            $shNumber++\r\n        }\r\n        $shName = \"$SessionHostNamePrefix{0:d$SessionHostInstanceNumberPadding}\" -f $shNumber\r\n        $ExistingSessionHostNames += $shName\r\n        $shName\r\n    }\r\n    Write-HostDetailed -Message \"Creating session host(s) \" + ($sessionHostNames -join ', ')\r\n\r\n    # Update Session Host Parameters\r\n    $sessionHostParameters['sessionHostNames'] = $sessionHostNames\r\n    $sessionHostParameters['Tags'][$TagIncludeInAutomation] = $true\r\n    $sessionHostParameters['Tags'][$TagDeployTimestamp] = (Get-Date -AsUTC -Format 'o')\r\n    $deploymentTimestamp = Get-Date -AsUTC -Format 'FileDateTime'\r\n    $deploymentName = \"{0}_{1}_Count_{2}_VMs\" -f $DeploymentPrefix, $deploymentTimestamp, $sessionHostNames.count\r\n    \r\n    Write-HostDetailed -Message \"Deployment name: $deploymentName\"\r\n    Write-HostDetailed -Message \"Deploying using Template Spec: $sessionHostTemplate\"\r\n    $templateSpecVersionResourceId = Get-TemplateSpecVersionResourceId -ResourceId $SessionHostTemplate\r\n\r\n    Write-HostDetailed -Message \"Deploying $NewSessionHostCount session host(s) to resource group $VirtualMachinesResourceGroupName\" \r\n    \r\n    $Body = @{\r\n        properties = @{\r\n            parameters   = $sessionHostParameters\r\n            templateLink = @{\r\n                id = $templateSpecVersionResourceId\r\n            }\r\n        }\r\n    }\r\n    $Uri = $ResourceManagerUrl + '/subscriptions/' + $VirtualMachinesSubscriptionId + '/resourceGroups/' + $VirtualMachinesResourceGroupName + '/providers/Microsoft.Resources/deployments/' + $deploymentName + '?api-version=2021-04-01'\r\n    $DeploymentJob = Invoke-AzureRestMethod `\r\n        -ARMToken $ARMToken `\r\n        -Body ($Body | ConvertTo-Json -depth 20) `\r\n        -Method Put `\r\n        -Uri $Uri\r\n    #TODO: Add logic to test if deployment is running (aka template is accepted) then finish running the function and let the deployment run in the background.\r\n    Write-HostDetailed -Message 'Pausing for 30 seconds to allow deployment to start'\r\n    Start-Sleep -Seconds 30\r\n    \r\n    # Check deployment status\r\n    $deploymentSucceeded = $true\r\n    if ($deploymentJob.Error) {\r\n        Write-HostDetailed \"DeploymentFailed: $($deploymentJob.Error)\"\r\n        $deploymentSucceeded = $false\r\n        throw $deploymentJob.Error\r\n    }\r\n    \r\n    # Return deployment information for state tracking\r\n    return [PSCustomObject]@{\r\n        DeploymentName  = $deploymentName\r\n        SessionHostCount = $NewSessionHostsCount\r\n        Succeeded       = $deploymentSucceeded\r\n        Timestamp       = $deploymentTimestamp\r\n    }\r\n}\r\n\r\nfunction Get-LatestImageVersion {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $ResourceManagerUrl,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $SubscriptionId,\r\n\r\n        # An Image reference object. Can be from Marketplace or Shared Image Gallery.\r\n        [Parameter()]\r\n        [hashtable] $ImageReference,\r\n\r\n        [Parameter()]\r\n        [string] $Location\r\n    )\r\n\r\n    # Marketplace image\r\n    if ($ImageReference.publisher) {\r\n        #TODO Do we need to change location here?\r\n        if ($ImageReference.version -ne 'latest') {\r\n            Write-HostDetailed  \"Image version is not set to latest. Returning version '$($ImageReference.version)'\"\r\n            $azImageVersion = $ImageReference.version\r\n        }\r\n        else {\r\n            # Get the Images and select the latest version.           \r\n            Write-HostDetailed \"Getting latest version of image publisher: $($ImageReference.publisher), offer: $($ImageReference.offer), sku: $($ImageReference.sku) in region: $($Location)\"\r\n                      \r\n            $Uri = $ResourceManagerUrl + \"/subscriptions/$SubscriptionId/providers/Microsoft.Compute/locations/$Location/publishers/$($ImageReference.publisher)/artifacttypes/vmimage/offers/$($ImageReference.offer)/skus/$($ImageReference.sku)/versions?api-version=2024-07-01\"\r\n            \r\n            $Versions = Invoke-AzureRestMethod -ARMToken $ARMToken -Uri $Uri -Method Get\r\n\r\n            $azImageVersion = ($Versions | Sort-Object -Property { [version] $_.Name } -Descending | Select-Object -First 1).Name\r\n            Write-HostDetailed  \"Latest version of image is $azImageVersion\"\r\n\r\n            if ($azImageVersion -match \"\\d+\\.\\d+\\.(?<Year>\\d{2})(?<Month>\\d{2})(?<Day>\\d{2})\") {\r\n                $azImageDate = Get-Date -Date (\"20{0}-{1}-{2}\" -f $Matches.Year, $Matches.Month, $Matches.Day)\r\n                Write-HostDetailed  \"Image date is $azImageDate\"\r\n            }\r\n            else {\r\n                throw \"Image version does not match expected format. Could not extract image date.\"\r\n            }\r\n        }\r\n    }\r\n    elseif ($ImageReference.Id) {\r\n        # Shared Image Gallery\r\n        Write-HostDetailed \"Image is from Shared Image Gallery: $($ImageReference.Id)\"\r\n        $imageDefinitionResourceIdPattern = '^\\/subscriptions\\/(?<subscription>[a-z0-9\\-]+)\\/resourceGroups\\/(?<resourceGroup>[^\\/]+)\\/providers\\/Microsoft\\.Compute\\/galleries\\/(?<gallery>[^\\/]+)\\/images\\/(?<image>[^\\/]+)$'\r\n        $imageVersionResourceIdPattern = '^\\/subscriptions\\/(?<subscription>[a-z0-9\\-]+)\\/resourceGroups\\/(?<resourceGroup>[^\\/]+)\\/providers\\/Microsoft\\.Compute\\/galleries\\/(?<gallery>[^\\/]+)\\/images\\/(?<image>[^\\/]+)\\/versions\\/(?<version>[^\\/]+)$'\r\n        if ($ImageReference.Id -match $imageDefinitionResourceIdPattern) {\r\n            Write-HostDetailed 'Image reference is an Image Definition resource.'\r\n            $imageSubscriptionId = $Matches.subscription\r\n            $imageResourceGroup = $Matches.resourceGroup\r\n            $imageGalleryName = $Matches.gallery\r\n            $imageDefinitionName = $Matches.image\r\n\r\n            # Get the latest version of the image\r\n            $Uri = $ResourceManagerUri + \"/subscriptions/$imageSubscriptionId/resourceGroups/$imageResourceGroup/providers/Microsoft.Compute/galleries/$imageGalleryName/images/$imageDefinitionName/versions?api-version=2023-07-03\"\r\n            $latestImageVersion = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri |\r\n            Where-Object { $_.PublishingProfile.ExcludeFromLatest -eq $false } |\r\n            Sort-Object -Property { $_.PublishingProfile.PublishedDate } -Descending |\r\n            Select-Object -First 1\r\n            if (-not $latestImageVersion) {\r\n                throw \"No available image versions found.\"\r\n            }\r\n            Write-HostDetailed \"Selected image version with resource Id {0}\" -StringValues $latestImageVersion.Id\r\n            $azImageVersion = $latestImageVersion.Name\r\n            $azImageDate = $latestImageVersion.PublishingProfile.PublishedDate\r\n            Write-HostDetailed \"Image version is {0} and date is {1}\" -StringValues $azImageVersion, $azImageDate.ToString('o')\r\n        }\r\n        elseif ($ImageReference.Id -match $imageVersionResourceIdPattern ) {\r\n            Write-HostDetailed 'Image reference is an Image Version resource.'\r\n            $Uri = $ResourceManagerUri + \"$($ImageReference.Id)?api-version=2023-07-03\"\r\n            $azImageVersion = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri\r\n            $azImageVersion = $imageVersion.Name\r\n            $azImageDate = $imageVersion.PublishingProfile.PublishedDate\r\n            Write-HostDetailed \"Image version is {0} and date is {1}\" -StringValues $azImageVersion, $azImageDate.ToString('o')\r\n        }\r\n        else {\r\n            throw \"Image reference Id does not match expected format for an Image Definition resource.\"\r\n        }\r\n    }\r\n    else {\r\n        throw \"Image reference does not contain a publisher or Id property. ImageReference, publisher, and Id are case sensitive!!\"\r\n    }\r\n    #return output\r\n    [PSCustomObject]@{\r\n        Version = $azImageVersion\r\n        Date    = $azImageDate\r\n    }\r\n}\r\n\r\nfunction Get-HostPoolDecisions {\r\n    <#\r\n    .SYNOPSIS\r\n        This function will decide how many session hosts to deploy and if we should decommission any session hosts.\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        # Session hosts to consider\r\n        [Parameter()]\r\n        [array] $SessionHosts = @(),\r\n\r\n        # Running deployments\r\n        [Parameter()]\r\n        $RunningDeployments,\r\n\r\n        # Target age of session hosts in days - after this many days we consider a session host for replacement.\r\n        [Parameter()]\r\n        [int] $TargetVMAgeDays = (Read-FunctionAppSetting TargetVMAgeDays),\r\n\r\n        # Target number of session hosts in the host pool. If we have more than or equal to this number of session hosts we will decommission some.\r\n        [Parameter()]\r\n        [int] $TargetSessionHostCount = (Read-FunctionAppSetting TargetSessionHostCount),\r\n\r\n        [Parameter()]\r\n        [int] $TargetSessionHostBuffer = (Read-FunctionAppSetting TargetSessionHostBuffer),\r\n\r\n        # Latest image version\r\n        [Parameter()]\r\n        [PSCustomObject] $LatestImageVersion,\r\n\r\n        # Should we replace session hosts on new image version\r\n        [Parameter()]\r\n        [bool] $ReplaceSessionHostOnNewImageVersion = (Read-FunctionAppSetting ReplaceSessionHostOnNewImageVersion),\r\n\r\n        # Delay days before replacing session hosts on new image version\r\n        [Parameter()]\r\n        [int] $ReplaceSessionHostOnNewImageVersionDelayDays = (Read-FunctionAppSetting ReplaceSessionHostOnNewImageVersionDelayDays),\r\n        \r\n        # Progressive scale-up parameters\r\n        [Parameter()]\r\n        [bool] $EnableProgressiveScaleUp = [bool]::Parse((Read-FunctionAppSetting EnableProgressiveScaleUp)),\r\n        \r\n        [Parameter()]\r\n        [int] $InitialDeploymentPercentage = [int]::Parse((Read-FunctionAppSetting InitialDeploymentPercentage)),\r\n        \r\n        [Parameter()]\r\n        [int] $ScaleUpIncrementPercentage = [int]::Parse((Read-FunctionAppSetting ScaleUpIncrementPercentage)),\r\n        \r\n        [Parameter()]\r\n        [int] $MaxDeploymentBatchSize = [int]::Parse((Read-FunctionAppSetting MaxDeploymentBatchSize)),\r\n        \r\n        [Parameter()]\r\n        [int] $SuccessfulRunsBeforeScaleUp = [int]::Parse((Read-FunctionAppSetting SuccessfulRunsBeforeScaleUp))\r\n    )\r\n    # Basic Info\r\n    Write-HostDetailed \"We have $($SessionHosts.Count) session hosts (included in Automation)\"\r\n    # Identify Session hosts that should be replaced\r\n    if ($TargetVMAgeDays -gt 0) {\r\n        $targetReplacementDate = (Get-Date).AddDays(-$TargetVMAgeDays)\r\n        [array] $sessionHostsOldAge = $SessionHosts | Where-Object { $_.DeployTimestamp -lt $targetReplacementDate }\r\n        Write-HostDetailed \"Found $($sessionHostsOldAge.Count) hosts to replace due to old age. $($($sessionHostsOldAge.SessionHostName) -join ',')\"\r\n\r\n    }\r\n\r\n    if ($ReplaceSessionHostOnNewImageVersion) {\r\n        $latestImageAge = (New-TimeSpan -Start $LatestImageVersion.Date -End (Get-Date -AsUTC)).TotalDays\r\n        Write-HostDetailed \"Latest Image $($LatestImageVersion.Version) is $latestImageAge days old.\"\r\n        if ($latestImageAge -ge $ReplaceSessionHostOnNewImageVersionDelayDays) {\r\n            Write-HostDetailed \"Latest Image age is older than (or equal) New Image Delay value $ReplaceSessionHostOnNewImageVersionDelayDays\"\r\n            [array] $sessionHostsOldVersion = $sessionHosts | Where-Object { $_.ImageVersion -ne $LatestImageVersion.Version }\r\n            Write-HostDetailed \"Found $($sessionHostsOldVersion.Count) session hosts to replace due to new image version. $($($sessionHostsOldVersion.SessionHostName) -Join ',')\"\r\n        }\r\n    }\r\n\r\n    [array] $sessionHostsToReplace = ($sessionHostsOldAge + $sessionHostsOldVersion) | Select-Object -Property * -Unique\r\n    Write-HostDetailed \"Found $($sessionHostsToReplace.Count) session hosts to replace in total. $($($sessionHostsToReplace.SessionHostName) -join ',')\"\r\n\r\n    # Good Session Hosts\r\n    $goodSessionHosts = $SessionHosts | Where-Object { $_.SessionHostName -notin $sessionHostsToReplace.SessionHostName }\r\n    $sessionHostsCurrentTotal = ([array]$goodSessionHosts.SessionHostName + [array]$runningDeployments.SessionHostNames ) | Select-Object -Unique\r\n    Write-HostDetailed \"We have $($sessionHostsCurrentTotal.Count) good session hosts including $($runningDeployments.SessionHostName.Count) session hosts being deployed\"\r\n    Write-HostDetailed \"We target having $TargetSessionHostCount session hosts in good shape\"\r\n    Write-HostDetailed \"We have a buffer of $TargetSessionHostBuffer session hosts more than the target.\"\r\n    $weCanDeployUpTo = $TargetSessionHostCount + $TargetSessionHostBuffer - $SessionHosts.count - $RunningDeployments.SessionHostNames.Count\r\n    if ($weCanDeployUpTo -ge 0) {\r\n        Write-HostDetailed \"We can deploy up to $weCanDeployUpTo session hosts\" \r\n\r\n        $weNeedToDeploy = $TargetSessionHostCount - $sessionHostsCurrentTotal.Count\r\n        if ($weNeedToDeploy -gt 0) {\r\n            Write-HostDetailed \"We need to deploy $weNeedToDeploy new session hosts\"\r\n            $weCanDeploy = if ($weNeedToDeploy -gt $weCanDeployUpTo) { $weCanDeployUpTo } else { $weNeedToDeploy } # If we need to deploy 10 machines, and we can deploy 5, we should only deploy 5.\r\n            Write-HostDetailed \"Buffer allows deploying $weCanDeploy session hosts\"\r\n            \r\n            # Apply progressive scale-up if enabled\r\n            if ($EnableProgressiveScaleUp -and $weCanDeploy -gt 0) {\r\n                Write-HostDetailed \"Progressive scale-up is enabled\"\r\n                \r\n                # Get deployment state\r\n                $deploymentState = Get-DeploymentState\r\n                \r\n                # Calculate current deployment percentage based on consecutive successes\r\n                $currentPercentage = $InitialDeploymentPercentage\r\n                if ($deploymentState.ConsecutiveSuccesses -ge $SuccessfulRunsBeforeScaleUp) {\r\n                    $scaleUpMultiplier = [Math]::Floor($deploymentState.ConsecutiveSuccesses / $SuccessfulRunsBeforeScaleUp)\r\n                    $currentPercentage = $InitialDeploymentPercentage + ($scaleUpMultiplier * $ScaleUpIncrementPercentage)\r\n                }\r\n                \r\n                # Cap at 100%\r\n                $currentPercentage = [Math]::Min($currentPercentage, 100)\r\n                \r\n                # Calculate percentage-based deployment size\r\n                $percentageBasedCount = [Math]::Ceiling($weCanDeploy * ($currentPercentage / 100.0))\r\n                \r\n                # Apply ceiling constraint and ensure we don't exceed what we can deploy\r\n                $actualDeployCount = [Math]::Min($percentageBasedCount, $MaxDeploymentBatchSize)\r\n                $actualDeployCount = [Math]::Min($actualDeployCount, $weCanDeploy)\r\n                \r\n                Write-HostDetailed \"Progressive scale-up: Using $currentPercentage% of $weCanDeploy needed = $actualDeployCount hosts (ConsecutiveSuccesses: $($deploymentState.ConsecutiveSuccesses), Max: $MaxDeploymentBatchSize)\"\r\n                \r\n                $weCanDeploy = $actualDeployCount\r\n            }\r\n        }\r\n        else {\r\n            $weCanDeploy = 0\r\n            Write-HostDetailed \"We have enough session hosts in good shape.\"\r\n        }\r\n    }\r\n    else {\r\n        Write-HostDetailed \"Buffer is full. We can not deploy more session hosts\"\r\n        $weCanDeploy = 0\r\n    }\r\n    $weCanDelete = $SessionHosts.Count - $TargetSessionHostCount\r\n    if ($weCanDelete -gt 0) {\r\n        Write-HostDetailed \"We need to delete $weCanDelete session hosts\"\r\n        if ($weCanDelete -gt $sessionHostsToReplace.Count) {\r\n            Write-HostDetailed \"Host pool is over populated\"\r\n\r\n            $goodSessionHostsToDeleteCount = $weCanDelete - $sessionHostsToReplace.Count\r\n            Write-HostDetailed \"We will delete $goodSessionHostsToDeleteCount good session hosts\"\r\n\r\n            $selectedGoodHostsTotDelete = [array] ($goodSessionHosts | Sort-Object -Property Session | Select-Object -First $goodSessionHostsToDeleteCount)\r\n            Write-HostDetailed \"Selected the following good session hosts to delete: $($($selectedGoodHostsTotDelete.VMName) -join ',')\"\r\n        }\r\n        else {\r\n            $selectedGoodHostsTotDelete = @()\r\n            Write-HostDetailed \"Host pool is not over populated\"\r\n        }\r\n        $sessionHostsPendingDelete = ($sessionHostsToReplace + $selectedGoodHostsTotDelete) | Select-Object -First $weCanDelete\r\n        \r\n        # Apply progressive scale-up to deletions if enabled\r\n        if ($EnableProgressiveScaleUp -and $sessionHostsPendingDelete.Count -gt 0) {\r\n            Write-HostDetailed \"Progressive scale-up is enabled for deletions\"\r\n            \r\n            # Get deployment state (reuse same state as deployments for consistent batching)\r\n            $deploymentState = Get-DeploymentState\r\n            \r\n            # Calculate current deletion percentage based on consecutive successes\r\n            $currentPercentage = $InitialDeploymentPercentage\r\n            if ($deploymentState.ConsecutiveSuccesses -ge $SuccessfulRunsBeforeScaleUp) {\r\n                $scaleUpMultiplier = [Math]::Floor($deploymentState.ConsecutiveSuccesses / $SuccessfulRunsBeforeScaleUp)\r\n                $currentPercentage = $InitialDeploymentPercentage + ($scaleUpMultiplier * $ScaleUpIncrementPercentage)\r\n            }\r\n            \r\n            # Cap at 100%\r\n            $currentPercentage = [Math]::Min($currentPercentage, 100)\r\n            \r\n            # Calculate percentage-based deletion size\r\n            $percentageBasedCount = [Math]::Ceiling($sessionHostsPendingDelete.Count * ($currentPercentage / 100.0))\r\n            \r\n            # Apply ceiling constraint and ensure we don't exceed pending deletions\r\n            $actualDeleteCount = [Math]::Min($percentageBasedCount, $MaxDeploymentBatchSize)\r\n            $actualDeleteCount = [Math]::Min($actualDeleteCount, $sessionHostsPendingDelete.Count)\r\n            \r\n            Write-HostDetailed \"Progressive scale-up for deletions: Using $currentPercentage% of $($sessionHostsPendingDelete.Count) pending = $actualDeleteCount hosts (ConsecutiveSuccesses: $($deploymentState.ConsecutiveSuccesses), Max: $MaxDeploymentBatchSize)\"\r\n            \r\n            $sessionHostsPendingDelete = $sessionHostsPendingDelete | Select-Object -First $actualDeleteCount\r\n        }\r\n        \r\n        Write-HostDetailed \"The following Session Hosts are now pending delete: $($($SessionHostsPendingDelete.SessionHostName) -join ',')\"\r\n    }\r\n    elseif ($sessionHostsToReplace.Count -gt 0) {\r\n        Write-HostDetailed \"We need to delete $($sessionHostsToReplace.Count) session hosts but we don't have enough session hosts in the host pool.\"\r\n    }\r\n    else { Write-HostDetailed \"We do not need to delete any session hosts\" }\r\n\r\n    [PSCustomObject]@{\r\n        PossibleDeploymentsCount       = $weCanDeploy\r\n        PossibleSessionHostDeleteCount = $weCanDelete\r\n        SessionHostsPendingDelete      = $sessionHostsPendingDelete\r\n        ExistingSessionHostNames       = ([array]$SessionHosts.SessionHostName + [array]$runningDeployments.SessionHostNames) | Select-Object -Unique\r\n    }\r\n}\r\n\r\nfunction Get-RunningDeployments {\r\n    <#\r\n    .SYNOPSIS\r\n        This function gets status of all AVD Session Host Replacer deployments in the target resource group.\r\n    .DESCRIPTION\r\n        The function will fail if there are any failed deployments. These should be cleaned up before automation can resume.\r\n        This behavior is to avoid compounding issues due to failing deployments.\r\n        Ideally, the AVD administrator should setup a notification (alert action) when there are failing deployments. # TODO: Add alert setup.\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $SubscriptionId,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $ResourceGroupName,\r\n\r\n        [Parameter()]\r\n        [string] $DeploymentPrefix = (Read-FunctionAppSetting SHRDeploymentPrefix)\r\n    )\r\n\r\n    Write-HostDetailed -Message \"Getting deployments for resource group '$ResourceGroupName'\"\r\n    $Uri = $ResourceManagerUri + \"/subscriptions/\" + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Resources/deployments/?api-version=2021-04-01'\r\n    $deployments = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri\r\n    $deployments = Get-AzResourceGroupDeployment -ResourceGroupName $ResourceGroupName -ErrorAction Stop\r\n    $deployments = $deployments | Where-Object { $_.DeploymentName -like \"$DeploymentPrefix*\" }\r\n    Write-HostDetailed -Message \"Found $($deployments.Count) deployments marked with $DeploymentPrefix.\"\r\n    # Check for failed deployments\r\n    $failedDeployments = $deployments | Where-Object { $_.ProvisioningState -eq 'Failed' }\r\n    # Terminate if there are any failed deployments\r\n    if ($failedDeployments) {\r\n        Write-HostDetailed -Err -Message \"Found $($failedDeployments.Count) failed deployments. These should be cleaned up before automation can resume.\"\r\n        throw \"Found {0} failed deployments. These should be cleaned up before automation can resume.\" -f $failedDeployments.Count\r\n    }\r\n    # Check for running deployments\r\n    $runningDeployments = $deployments | Where-Object { $_.ProvisioningState -eq 'Running' }\r\n    Write-HostDetailed -Message \"Found $($runningDeployments.Count) running deployments.\"\r\n    # Check for long running deployments\r\n    $warningThreshold = (Get-Date -AsUTC).AddHours(-2)\r\n    $longRunningDeployments = $runningDeployments | Where-Object { $_.Timestamp -lt $warningThreshold }\r\n    if ($longRunningDeployments) {\r\n        Write-HostDetailed -Warn -Message \"Found $($longRunningDeployments.Count) deployments that have been running for more than 2 hours. This could block future deployments\"\r\n    }\r\n\r\n    # Parse deployment names to get VM name\r\n    $output = foreach ($deployment in $runningDeployments) {\r\n        $parameters = $deployment.Parameters | ConvertTo-CaseInsensitiveHashtable\r\n        Write-HostDetailed -Message \"Deployment $($deployment.DeploymentName) is running and deploying: $(($parameters['sessionHostNames'].Value -join ','))\"\r\n        [PSCustomObject]@{\r\n            DeploymentName   = $deployment.DeploymentName\r\n            SessionHostNames = $parameters['sessionHostNames'].Value\r\n            Timestamp        = $deployment.Timestamp\r\n            Status           = $deployment.ProvisioningState\r\n        }\r\n    }\r\n    $output\r\n}\r\n\r\nfunction Get-SessionHosts {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string] $HostPoolSubscriptionId = (Read-FunctionAppSetting HostPoolSubscriptionId),\r\n\r\n        [Parameter()]\r\n        [string] $ResourceGroupName = (Read-FunctionAppSetting HostPoolResourceGroupName),\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n\r\n        [Parameter()]\r\n        [string] $TagIncludeInAutomation = (Read-FunctionAppSetting Tag_IncludeInAutomation),\r\n\r\n        [Parameter()]\r\n        [string] $TagDeployTimestamp = (Read-FunctionAppSetting Tag_DeployTimestamp),\r\n        \r\n        [Parameter()]\r\n        [string] $TagPendingDrainTimeStamp = (Read-FunctionAppSetting Tag_PendingDrainTimestamp),\r\n        \r\n        [Parameter()]\r\n        [switch] $FixSessionHostTags,\r\n        \r\n        [Parameter()]\r\n        [bool] $IncludePreExistingSessionHosts = (Read-FunctionAppSetting IncludePreExistingSessionHosts)\r\n    )\r\n    \r\n    # Get current session hosts\r\n    Write-HostDetailed -Message \"Getting current session hosts in host pool $HostPoolName\"\r\n    $Uri = $ResourceManagerUri + '/subscriptions/' + $HostPoolSubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '/sessionHosts?api-version=2024-04-03'\r\n    $sessionHosts = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri | Select-Object Name, ResourceId, Session, AllowNewSession, Status\r\n    Write-HostDetailed -Message \"Found $($sessionHosts.Count) session hosts\"\r\n    # For each session host, get the VM details\r\n    $result = foreach ($sh in $sessionHosts) {\r\n        Write-HostDetailed -Message \"Getting VM details for $($sh.Name)\"\r\n        $Uri = $ResourceManagerUri + $sh.ResourceId + '?api-version=2024-03-01'\r\n        $vm = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri | Select-Object Name, TimeCreated, StorageProfile\r\n        Write-HostDetailed -Message \"VM was created on $($vm.TimeCreated)\"\r\n        Write-HostDetailed -Message \"VM exact version is $($vm.StorageProfile.ImageReference.ExactVersion)\"\r\n        Write-HostDetailed -Message 'Getting VM tags'\r\n        $Uri = $ResourceManagerUri + $sh.ResourceId + '/providers/Microsoft.Resources/tags/default?api-version=2021-04-01'\r\n        $vmTags = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri\r\n        $vmDeployTimeStamp = $vmTags.Properties.TagsProperty[$TagDeployTimestamp]\r\n        try {\r\n            $vmDeployTimeStamp = [DateTime]::Parse($vmDeployTimeStamp)\r\n            Write-HostDetailed -Message \"VM has a tag $TagDeployTimestamp with value $vmDeployTimeStamp\"\r\n        }\r\n        catch {\r\n            $value = if ($null -eq $vmDeployTimeStamp) { 'null' } else { $vmDeployTimeStamp }\r\n            Write-HostDetailed -Message \"VM tag $TagDeployTimestamp with value $value is not a valid date\"\r\n            if ($FixSessionHostTags) {\r\n                Write-HostDetailed -Message \"Copying VM CreateTime to tag $TagDeployTimestamp with value $($vm.TimeCreated.ToString('o'))\"\r\n                $Body = @{\r\n                    operation  = 'Merge'\r\n                    properties = @{\r\n                        $TagDeployTimestamp = $vm.TimeCreated.ToString('o')\r\n                    }\r\n                }\r\n                Invoke-AzureRestMethod -ARMToken $ARMToken -Body ($Body | ConvertTo-Json -Depth 10) -Method PATCH -Uri $Uri\r\n            }\r\n            $vmDeployTimeStamp = $vm.TimeCreated\r\n        }\r\n        $vmIncludeInAutomation = $vmTags.Properties.TagsProperty[$TagIncludeInAutomation]\r\n        if ($vmIncludeInAutomation -eq \"True\") {\r\n            Write-HostDetailed -Message \"VM has a tag $TagIncludeInAutomation with value $vmIncludeInAutomation\" \r\n            $vmIncludeInAutomation = $true\r\n        }\r\n        elseif ($vmIncludeInAutomation -eq \"False\") {\r\n            Write-HostDetailed -Message \"VM has a tag $TagIncludeInAutomation with value $vmIncludeInAutomation\"\r\n            $vmIncludeInAutomation = $false\r\n        }\r\n        else {\r\n            $value = if ($null -eq $vmIncludeInAutomation) { 'null' } else { $vmIncludeInAutomation }\r\n            Write-HostDetailed -Message \"VM tag with $TagIncludeInAutomation value $value is not set to True/False\"\r\n            if ($FixSessionHostTags) {\r\n                Write-HostDetailed -Message \"Setting tag $TagIncludeInAutomation to $IncludePreExistingSessionHosts\"\r\n                $Body = @{\r\n                    operation  = 'Merge'\r\n                    properties = @{\r\n                        $TagIncludeInAutomation = $IncludePreExistingSessionHosts\r\n                    }\r\n                }\r\n                Invoke-AzureRestMethod -ARMToken $ARMToken -Body ($Body | ConvertTo-Json -Depth 10) -Method PATCH -Uri $Uri\r\n            }\r\n            $vmIncludeInAutomation = $IncludePreExistingSessionHosts\r\n        }\r\n        $vmPendingDrainTimeStamp = $vmTags.Properties.TagsProperty[$TagPendingDrainTimeStamp]\r\n        try {\r\n            $vmPendingDrainTimeStamp = [DateTime]::Parse($vmPendingDrainTimeStamp)\r\n            Write-OutputDetailed -Message \"VM has a tag $TagPendingDrainTimeStamp with value $vmPendingDrainTimeStamp\" \r\n        }\r\n        catch {\r\n            Write-OutputDetailed -Message \"VM tag $TagPendingDrainTimeStamp is not set.\" \r\n            $vmPendingDrainTimeStamp = $null\r\n        }\r\n\r\n        # Extract FQDN and session host name (hostname without domain)\r\n        $fqdn = $sh.Name -replace \".+\\/(.+)\", '$1'\r\n        $sessionHostName = $fqdn -replace '\\..*$', ''  # Remove domain, keep only hostname\r\n        \r\n        $hostOutput = @{ # We are combining the VM details and SessionHost objects into a single PS Custom Object\r\n            VMName                = $vm.Name\r\n            SessionHostName       = $sessionHostName\r\n            FQDN                  = $fqdn\r\n            DeployTimestamp       = $vmDeployTimeStamp\r\n            IncludeInAutomation   = $vmIncludeInAutomation\r\n            PendingDrainTimeStamp = $vmPendingDrainTimeStamp\r\n            ImageVersion          = $vm.StorageProfile.ImageReference.ExactVersion\r\n        }\r\n        $sh.PSObject.Properties.ForEach{ $hostOutput[$_.Name] = $_.Value }\r\n        [PSCustomObject]$hostOutput\r\n    }\r\n    $result\r\n}\r\n\r\n#EndRegion Session Host Lifecycle Functions\r\n\r\n#Region Session Host Helper Functions\r\n\r\nfunction Get-SessionHostParameters {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string] $SessionHostParameters = (Read-FunctionAppSetting SessionHostParameters)\r\n    )\r\n    $paramsHash = ConvertFrom-Json $SessionHostParameters -Depth 99 -AsHashtable\r\n    Write-HostDetailed -Message \"Session host parameters: $($paramsHash | Out-String)\"\r\n    $paramsHash\r\n}\r\n\r\nfunction Get-TemplateSpecVersionResourceId {\r\n    param(\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$ResourceId\r\n    )\r\n    $Uri = $ResourceManagerUri + $ResourceId + '?api-version=2021-04-01'    \r\n    $azResourceType = (Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri).ResourceType\r\n    Write-HostDetailed -Message \"Resource type: $azResourceType\"\r\n    switch ($azResourceType) {\r\n        'Microsoft.Resources/templateSpecs' {\r\n            # Get resource Id of the latest version of the template spec\r\n            $Uri = $ResourceManagerUri + $ResourceId + '?$expand=versions&api-version=2021-05-01'\r\n            $templateSpecVersions = (Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $Uri).Versions\r\n            Write-HostDetailed -Message \"Template Spec has $($templateSpecVersions.count) versions\"\r\n            $latestVersion = $templateSpecVersions | Sort-Object -Property CreationTime -Descending -Top 1\r\n            Write-HostDetailed -Message \"Latest version: $($latestVersion.Name) Created at $($latestVersion.CreationTime.ToString('o')) - Returning Resource Id $($latestVersion.Id)\"\r\n            $latestVersion.Id\r\n        }\r\n        'Microsoft.Resources/templateSpecs/versions' {\r\n            # Return the resource Id as is, since supplied value is already a version.\r\n            $ResourceId\r\n        }\r\n        Default {\r\n            throw (\"Supplied value has type '{0}' is not a valid Template Spec or Template Spec version resource Id.\" -f $azResourceType)\r\n        }\r\n    }\r\n}\r\n\r\n#EndRegion Session Host Helper Functions\r\n\r\n#Region Session Host Removal Functions\r\n\r\nfunction Remove-SessionHosts {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        $SessionHostsPendingDelete,\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolSubscriptionId = (Read-FunctionAppSetting HostPoolSubscriptionId),\r\n\r\n        [Parameter()]\r\n        [string] $ResourceGroupName = (Read-FunctionAppSetting HostPoolResourceGroupName),\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n\r\n        [Parameter()]\r\n        [int] $DrainGracePeriodHours = (Read-FunctionAppSetting DrainGracePeriodHours),\r\n\r\n        [Parameter()]\r\n        [string] $TagPendingDrainTimeStamp = (Read-FunctionAppSetting Tag_PendingDrainTimestamp),\r\n\r\n        [Parameter()]\r\n        [string] $TagScalingPlanExclusionTag = (Read-FunctionAppSetting Tag_ScalingPlanExclusionTag),\r\n\r\n        [Parameter()]\r\n        [bool] $RemoveEntraDevice,\r\n\r\n        [Parameter()]\r\n        [bool] $RemoveIntuneDevice\r\n    )\r\n\r\n    foreach ($sessionHost in $SessionHostsPendingDelete) {\r\n        # Does the session host currently have sessions?\r\n        # No sessions => Delete + Remove from host pool\r\n        # Is the session host in drain mode?\r\n        # Yes => Is the drain grace period tag old? => Delete + Remove from host pool\r\n        # NO => Set drain mode + Message users + Set tag\r\n\r\n        $drainSessionHost = $false\r\n        $deleteSessionHost = $false\r\n\r\n        if ($sessionHost.Session -eq 0) {\r\n            #Does the session host currently have sessions?\r\n            # No sessions => Delete + Remove from host pool\r\n            Write-HostDetailed -Message \"Session host $($sessionHost.FQDN) has no sessions.\" \r\n            $deleteSessionHost = $true\r\n        }\r\n        else {\r\n            Write-HostDetailed -Message \"Session host $($sessionHost.FQDN) has $($sessionHost.Session) sessions.\" \r\n            if (-Not $sessionHost.AllowNewSession) {\r\n                # Is the session host in drain mode?\r\n                Write-HostDetailed -Message \"Session host $($sessionHost.FQDN) is in drain mode.\"\r\n                if ($sessionHost.PendingDrainTimeStamp) {\r\n                    #Session host has a drain timestamp\r\n                    Write-HostDetailed -Message \"Session Host $($sessionHost.FQDN) drain timestamp is $($sessionHost.PendingDrainTimeStamp)\"\r\n                    $maxDrainGracePeriodDate = $sessionHost.PendingDrainTimeStamp.AddHours($DrainGracePeriodHours)\r\n                    Write-HostDetailed -Message \"Session Host $($sessionHost.FQDN) can stay in grace period until $($maxDrainGracePeriodDate.ToUniversalTime().ToString('o'))\" \r\n                    if ($maxDrainGracePeriodDate -lt (Get-Date)) {\r\n                        Write-HostDetailed -Message \"Session Host $($sessionHost.FQDN) has exceeded the drain grace period.\"\r\n                        $deleteSessionHost = $true\r\n                    }\r\n                    else {\r\n                        Write-HostDetailed -Message \"Session Host $($sessionHost.FQDN) has not exceeded the drain grace period.\"\r\n                    }\r\n                }\r\n                else {\r\n                    Write-HostDetailed -Message \"Session Host $($sessionHost.FQDN) does not have a drain timestamp.\"\r\n                    $drainSessionHost = $true\r\n                }\r\n            }\r\n            else {\r\n                Write-HostDetailed -Message \"Session host $($sessionHost.Name) in not in drain mode. Turning on drain mode.\" \r\n                $drainSessionHost = $true\r\n            }\r\n        }\r\n\r\n        if ($drainSessionHost) {\r\n            Write-HostDetailed -Message 'Turning on drain mode.'\r\n            $Uri = $ResourceManagerUri + '/subscriptions/' + $HostPoolSubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '/sessionHosts/' + $sessionHost.FQDN + '?api-version=2024-04-03'\r\n            Invoke-AzureRestMethod `\r\n                -ARMToken $ARMToken `\r\n                -Body (@{properties = @{allowNewSession = $false } } | ConvertTo-Json) `\r\n                -Method 'PATCH' `\r\n                -Uri $Uri\r\n            $drainTimestamp = (Get-Date).ToUniversalTime().ToString('o')\r\n            Write-HostDetailed -Message \"Setting drain timestamp on tag $TagPendingDrainTimeStamp to $drainTimestamp.\"\r\n            $Uri = $ResourceManagerUri + $sessionHost.ResourceId + '/providers/Microsoft.Resources/tags/default?api-version=2021-04-01'\r\n            $Body = @{\r\n                operation  = 'Merge'\r\n                properties = @{\r\n                    $TagPendingDrainTimeStamp = $drainTimestamp\r\n                }\r\n            }\r\n            Invoke-AzureRestMethod -ARMToken $ARMToken -Body ($Body | ConvertTo-Json -Depth 5) -Method PATCH -Uri $Uri\r\n            \r\n            if ($TagScalingPlanExclusionTag -ne ' ') {\r\n                # This is string with a single space.\r\n                Write-HostDetailed -Message \"Setting scaling plan exclusion tag $TagScalingPlanExclusionTag to $true.\"\r\n                $Body = @{\r\n                    operation  = 'Merge'\r\n                    properties = @{\r\n                        $TagScalingPlanExclusionTag = $true\r\n                    }\r\n                }\r\n                Invoke-AzureRestMethod -ARMToken $ARMToken -Body ($Body | ConvertTo-Json -Depth 5) -Method PATCH -Uri $Uri\r\n            }\r\n\r\n            Write-HostDetailed -Message 'Notifying Users'\r\n            Send-DrainNotification -SessionHostName ($sessionHost.FQDN)\r\n        }\r\n\r\n        if ($deleteSessionHost) {\r\n            Write-HostDetailed -Message \"Deleting session host $($SessionHost.SessionHostName)...\"\r\n            if ($RemoveEntraDevice) {\r\n                Write-HostDetailed -Message 'Deleting device from Entra ID'\r\n                Remove-EntraDevice -GraphToken $Script:GraphToken -Name $sessionHost.SessionHostName\r\n            }\r\n            if ($RemoveIntuneDevice) {\r\n                Write-HostDetailed -Message 'Deleting device from Intune'\r\n                Remove-IntuneDevice -GraphToken $Script:GraphToken -Name $sessionHost.SessionHostName\r\n            }\r\n            Write-HostDetailed -Message \"Removing Session Host from Host Pool $HostPoolName\"\r\n            $Uri = $ResourceManagerUri + '/subscriptions/' + $HostPoolSubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '/sessionHosts/' + $sessionHost.FQDN + '?api-version=2024-04-03'\r\n            Invoke-AzureRestMethod -ARMToken $ARMToken -Method DELETE -Uri $Uri            \r\n            Write-HostDetailed -Message \"Deleting VM: $($sessionHost.ResourceId)...\"\r\n            $Uri = $ResourceManagerUri + $sessionHost.ResourceId + '?forceDeletion=true&api-version=2024-07-01'\r\n            Invoke-AzureRestMethod -ARMToken $ARMToken -Method 'DELETE' -Uri $Uri\r\n            # We are not deleting Disk and NIC as the template should mark the delete option for these resources.\r\n        }\r\n    }\r\n}\r\n\r\nfunction Remove-EntraDevice {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $false)]\r\n        $GraphEndpoint = $env:GraphEndpoint,\r\n        [Parameter(Mandatory = $true)]\r\n        $GraphToken,\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $Name\r\n    )\r\n    \r\n    try {\r\n        $Device = Invoke-GraphApiWithRetry `\r\n            -GraphEndpoint $GraphEndpoint `\r\n            -ARMToken $GraphToken `\r\n            -Method Get `\r\n            -Uri \"/v1.0/devices?`$filter=displayName eq '$Name'\"\r\n        \r\n        If ($Device.value -and $Device.value.Count -gt 0) {\r\n            $Id = $Device.value[0].id\r\n            Write-HostDetailed -Message \"Removing session host $Name from Entra ID (Device ID: $Id)\"\r\n            \r\n            Invoke-GraphApiWithRetry `\r\n                -GraphEndpoint $GraphEndpoint `\r\n                -ARMToken $GraphToken `\r\n                -Method Delete `\r\n                -Uri \"/v1.0/devices/$Id\"\r\n            \r\n            Write-HostDetailed -Message \"Successfully removed device $Name from Entra ID\"\r\n        }\r\n        else {\r\n            Write-HostDetailed -Message \"Device $Name not found in Entra ID\" -Level Warning\r\n        }\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Message \"Failed to remove Entra device $Name : $($_.Exception.Message)\" -Level Error\r\n        throw\r\n    }\r\n}\r\n\r\nfunction Remove-IntuneDevice {\r\n    [CmdletBinding()]\r\n    param(\r\n        [Parameter(Mandatory = $false)]\r\n        $GraphEndpoint = $env:GraphEndpoint,\r\n        [Parameter(Mandatory = $true)]\r\n        $GraphToken,\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $Name\r\n    )\r\n    \r\n    try {\r\n        $Device = Invoke-GraphApiWithRetry `\r\n            -GraphEndpoint $GraphEndpoint `\r\n            -ARMToken $GraphToken `\r\n            -Method Get `\r\n            -Uri \"/v1.0/deviceManagement/managedDevices?`$filter=deviceName eq '$Name'\"\r\n        \r\n        If ($Device.value -and $Device.value.Count -gt 0) {\r\n            $Id = $Device.value[0].id\r\n            Write-HostDetailed -Message \"Removing session host '$Name' device from Intune (Device ID: $Id)\"\r\n            \r\n            Invoke-GraphApiWithRetry `\r\n                -GraphEndpoint $GraphEndpoint `\r\n                -ARMToken $GraphToken `\r\n                -Method Delete `\r\n                -Uri \"/v1.0/deviceManagement/managedDevices/$Id\"\r\n            \r\n            Write-HostDetailed -Message \"Successfully removed device $Name from Intune\"\r\n        }\r\n        else {\r\n            Write-HostDetailed -Message \"Device $Name not found in Intune\" -Level Warning\r\n        }\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Message \"Failed to remove Intune device $Name : $($_.Exception.Message)\" -Level Error\r\n        throw\r\n    }\r\n}\r\n\r\n#EndRegion Session Host Removal Functions\r\n\r\nfunction ConvertTo-CaseInsensitiveHashtable {\r\n    <#\r\n    .SYNOPSIS\r\n        Converts objects to case-insensitive hashtables.\r\n    .DESCRIPTION\r\n        Converts hashtables, PSCustomObjects, OrderedDictionaries, and JSON strings to case-insensitive hashtables.\r\n    .PARAMETER InputObject\r\n        The object to convert.\r\n    .EXAMPLE\r\n        $params = @{Name='Test'; Value='123'} | ConvertTo-CaseInsensitiveHashtable\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]\r\n        $InputObject\r\n    )\r\n    \r\n    process {\r\n        if ($null -eq $InputObject) {\r\n            return $null\r\n        }\r\n        \r\n        # If already a hashtable, convert to case-insensitive\r\n        if ($InputObject -is [hashtable]) {\r\n            $ciHashtable = New-Object 'System.Collections.Hashtable' -ArgumentList ([System.StringComparer]::OrdinalIgnoreCase)\r\n            foreach ($key in $InputObject.Keys) {\r\n                $value = $InputObject[$key]\r\n                # Recursively convert nested hashtables\r\n                if ($value -is [hashtable] -or $value -is [PSCustomObject]) {\r\n                    $ciHashtable[$key] = ConvertTo-CaseInsensitiveHashtable -InputObject $value\r\n                }\r\n                else {\r\n                    $ciHashtable[$key] = $value\r\n                }\r\n            }\r\n            return $ciHashtable\r\n        }\r\n        \r\n        # If PSCustomObject or OrderedDictionary, convert to case-insensitive hashtable\r\n        if ($InputObject -is [PSCustomObject] -or $InputObject -is [System.Collections.Specialized.OrderedDictionary]) {\r\n            $ciHashtable = New-Object 'System.Collections.Hashtable' -ArgumentList ([System.StringComparer]::OrdinalIgnoreCase)\r\n            foreach ($property in $InputObject.PSObject.Properties) {\r\n                $value = $property.Value\r\n                # Recursively convert nested objects\r\n                if ($value -is [hashtable] -or $value -is [PSCustomObject]) {\r\n                    $ciHashtable[$property.Name] = ConvertTo-CaseInsensitiveHashtable -InputObject $value\r\n                }\r\n                else {\r\n                    $ciHashtable[$property.Name] = $value\r\n                }\r\n            }\r\n            return $ciHashtable\r\n        }\r\n        \r\n        # If JSON string, parse and convert\r\n        if ($InputObject -is [string]) {\r\n            try {\r\n                $parsed = $InputObject | ConvertFrom-Json\r\n                return ConvertTo-CaseInsensitiveHashtable -InputObject $parsed\r\n            }\r\n            catch {\r\n                Write-Error \"Unable to parse string as JSON: $_\"\r\n                return $null\r\n            }\r\n        }\r\n        \r\n        # Return as-is if cannot convert\r\n        Write-Warning \"InputObject type [$($InputObject.GetType().Name)] cannot be converted to case-insensitive hashtable\"\r\n        return $InputObject\r\n    }\r\n}\r\n\r\n#Region Notification Functions\r\n\r\nfunction Send-DrainNotification {\r\n    <#\r\n    .SYNOPSIS\r\n        Sends drain notifications to users on a session host pending deletion.\r\n    .DESCRIPTION\r\n        Retrieves all user sessions on the specified session host and sends a message\r\n        notifying them of the pending maintenance and replacement.\r\n    .PARAMETER SessionHostName\r\n        The FQDN of the session host (e.g., hostpool/vmname.domain.com).\r\n    .PARAMETER HostPoolName\r\n        Name of the host pool.\r\n    .PARAMETER ResourceGroupName\r\n        Name of the resource group containing the host pool.\r\n    .PARAMETER DrainGracePeriodHours\r\n        Number of hours before the session host will be forcefully disconnected.\r\n    .PARAMETER MessageTitle\r\n        Title of the notification message.\r\n    .PARAMETER MessageBody\r\n        Body of the notification message. Use {0} for session host name and {1} for hours.\r\n    .EXAMPLE\r\n        Send-DrainNotification -SessionHostName 'hostpool/vm001.contoso.com'\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string] $SessionHostName,\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolSubscriptionId = (Read-FunctionAppSetting HostPoolSubscriptionId),\r\n\r\n        [Parameter()]\r\n        [string] $HostPoolName = (Read-FunctionAppSetting HostPoolName),\r\n\r\n        [Parameter()]\r\n        [string] $ResourceGroupName = (Read-FunctionAppSetting HostPoolResourceGroupName),\r\n\r\n        [Parameter()]\r\n        [int] $DrainGracePeriodHours = (Read-FunctionAppSetting DrainGracePeriodHours),\r\n\r\n        [Parameter()]\r\n        [string] $MessageTitle = \"Automatic Session Host Maintenance\",\r\n\r\n        [Parameter()]\r\n        [string] $MessageBody = \"Your session host {0} is being replaced. Please save your work and log off. You will be disconnected in {1} hours.\"\r\n    )\r\n    \r\n    try {\r\n        $ARMToken = Get-AccessToken\r\n        $ResourceManagerUri = (Get-AzContext).Environment.ResourceManagerUrl\r\n        \r\n        # Get all user sessions on the session host\r\n        Write-HostDetailed -Message \"Getting user sessions for session host $SessionHostName\"\r\n        $SessionsUri = $ResourceManagerUri + '/subscriptions/' + $HostPoolSubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '/sessionHosts/' + $SessionHostName + '/userSessions?api-version=2024-04-03'\r\n        \r\n        $sessions = Invoke-AzureRestMethod -ARMToken $ARMToken -Method Get -Uri $SessionsUri\r\n        \r\n        if ($null -eq $sessions -or $sessions.Count -eq 0) {\r\n            Write-HostDetailed -Message \"No active sessions found on session host $SessionHostName\"\r\n            return\r\n        }\r\n        \r\n        # Send message to each user session\r\n        foreach ($session in $sessions) {\r\n            $sessionId = $session.Name -replace '.+\\/.+\\/(.+)', '$1'\r\n            $userPrincipalName = $session.Properties.UserPrincipalName\r\n            \r\n            if ([string]::IsNullOrWhiteSpace($sessionId)) {\r\n                Write-HostDetailed -Message \"Skipping session with invalid ID\" -Level Warning\r\n                continue\r\n            }\r\n            \r\n            $formattedMessageBody = $MessageBody -f $SessionHostName, $DrainGracePeriodHours\r\n            \r\n            Write-HostDetailed -Message \"Sending drain notification to user $userPrincipalName on session $sessionId\"\r\n            \r\n            $MessageUri = $ResourceManagerUri + '/subscriptions/' + $HostPoolSubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.DesktopVirtualization/hostPools/' + $HostPoolName + '/sessionHosts/' + $SessionHostName + '/userSessions/' + $sessionId + '/sendMessage?api-version=2024-04-03'\r\n            \r\n            $MessagePayload = @{\r\n                messageTitle = $MessageTitle\r\n                messageBody  = $formattedMessageBody\r\n            } | ConvertTo-Json -Depth 10\r\n            \r\n            try {\r\n                Invoke-AzureRestMethod -ARMToken $ARMToken -Method Post -Uri $MessageUri -Body $MessagePayload | Out-Null\r\n                Write-HostDetailed -Message \"Successfully sent message to user $userPrincipalName\"\r\n            }\r\n            catch {\r\n                Write-HostDetailed -Message \"Failed to send message to user $userPrincipalName : $_\" -Level Warning\r\n            }\r\n        }\r\n    }\r\n    catch {\r\n        Write-HostDetailed -Message \"Error in Send-DrainNotification: $_\" -Level Error\r\n    }\r\n}\r\n\r\n#EndRegion Session Host Removal Functions\r\n\r\n#Region Optional Enhanced Functions (Token Caching)\r\n\r\nfunction Get-GraphTokenCached {\r\n    <#\r\n    .SYNOPSIS\r\n        Gets Microsoft Graph access token with caching.\r\n    .DESCRIPTION\r\n        Retrieves Graph token from cache if valid, otherwise acquires new token.\r\n    .PARAMETER TenantId\r\n        Azure AD tenant ID.\r\n    .PARAMETER ClientId\r\n        Service principal client ID.\r\n    .PARAMETER ForceRefresh\r\n        Forces token refresh even if cached token is valid.\r\n    .EXAMPLE\r\n        $graphToken = Get-GraphTokenCached -TenantId $tenantId -ClientId $clientId\r\n    #>\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string] $TenantId,\r\n        \r\n        [Parameter()]\r\n        [string] $ClientId,\r\n        \r\n        [Parameter()]\r\n        [switch] $ForceRefresh\r\n    )\r\n    \r\n    # Check if cached token is still valid (with 5 minute buffer)\r\n    if (-not $ForceRefresh -and \r\n        $Script:GraphTokenCache.Token -and \r\n        $Script:GraphTokenCache.ExpiresOn -gt (Get-Date).AddMinutes(5)) {\r\n        Write-Verbose \"Using cached Graph token (expires: $($Script:GraphTokenCache.ExpiresOn))\"\r\n        return $Script:GraphTokenCache.Token\r\n    }\r\n    \r\n    # Get configuration if not provided\r\n    if ([string]::IsNullOrEmpty($TenantId)) {\r\n        $TenantId = Read-FunctionAppSetting TenantId\r\n    }\r\n    if ([string]::IsNullOrEmpty($ClientId)) {\r\n        $ClientId = Read-FunctionAppSetting UserAssignedIdentityClientId\r\n    }\r\n    \r\n    # Get environment-specific Graph URL from configuration\r\n    $graphUrl = Read-FunctionAppSetting GraphEndpoint\r\n    if ([string]::IsNullOrEmpty($graphUrl)) {\r\n        throw \"GraphEndpoint configuration is required but not set in Function App Settings\"\r\n    }\r\n    \r\n    Write-Verbose \"Using Graph URL: $graphUrl\"\r\n    \r\n    # Get access token for Resource Manager to exchange for Graph token\r\n    $resourceManagerUrl = Read-FunctionAppSetting ResourceManagerUrl\r\n    $ARMToken = Get-AccessToken -Resource $resourceManagerUrl -ClientId $ClientId\r\n    \r\n    $headers = @{\r\n        'Authorization' = \"Bearer $ARMToken\"\r\n        'Content-Type'  = 'application/json'\r\n    }\r\n    \r\n    $body = @{\r\n        resource  = $graphUrl\r\n        client_id = $ClientId\r\n    } | ConvertTo-Json\r\n    \r\n    try {\r\n        $response = Invoke-RestMethod -Uri \"$($env:IDENTITY_ENDPOINT)?api-version=2019-08-01&client_id=$ClientId\" -Method Post -Headers $headers -Body $body\r\n        \r\n        # Cache the token - calculate expiration (typically 3600 seconds)\r\n        $Script:GraphTokenCache.Token = $response.access_token\r\n        $Script:GraphTokenCache.ExpiresOn = (Get-Date).AddSeconds(3600)\r\n        \r\n        Write-Verbose \"Retrieved new Graph token (expires: $($Script:GraphTokenCache.ExpiresOn))\"\r\n        return $response.access_token\r\n    }\r\n    catch {\r\n        Write-Error \"Failed to acquire Graph token: $_\"\r\n        throw\r\n    }\r\n}\r\n\r\n#EndRegion Optional: Enhanced Token Caching\r\n\r\n<#\r\n.NOTES\r\n    Microsoft Graph API Documentation:\r\n    \r\n    Environment Detection:\r\n    https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-deployment#environment\r\n    https://learn.microsoft.com/en-us/graph/deployments\r\n    \r\n    Entra ID Device Management:\r\n    https://learn.microsoft.com/en-us/graph/api/device-list?view=graph-rest-1.0&tabs=http\r\n    https://learn.microsoft.com/en-us/graph/api/device-delete?view=graph-rest-1.0&tabs=http\r\n    \r\n    Intune Device Management:\r\n    https://learn.microsoft.com/en-us/graph/api/intune-devices-manageddevice-list?view=graph-rest-1.0\r\n    DELETE https://graph.microsoft.com/v1.0/devices/{id}\r\n#>\r\n\r\n",
    "deploymentSuffix": "[uniqueString(resourceGroup().id, deployment().name)]",
    "hostPoolName": "[split(parameters('hostPoolResourceId'), '/')[8]]",
    "hostPoolResourceGroupName": "[split(parameters('hostPoolResourceId'), '/')[4]]",
    "hostPoolSubscriptionId": "[split(parameters('hostPoolResourceId'), '/')[2]]",
    "virtualMachinesResourceGroupName": "[last(split(parameters('virtualMachinesResourceGroupId'), '/'))]",
    "virtualMachinesSubscriptionId": "[split(parameters('virtualMachinesResourceGroupId'), '/')[2]]",
    "templateSpecResourceGroupId": "[if(not(empty(parameters('sessionHostTemplateSpecVersionResourceId'))), format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('sessionHostTemplateSpecVersionResourceId'), '/')[2], split(parameters('sessionHostTemplateSpecVersionResourceId'), '/')[4]), resourceGroup().id)]",
    "cloud": "[toLower(environment().name)]",
    "locationsObject": "[variables('$fxv#0')]",
    "locationsEnvProperty": "[if(startsWith(variables('cloud'), 'us'), 'other', variables('cloud'))]",
    "locations": "[variables('locationsObject')[variables('locationsEnvProperty')]]",
    "graphEndpoint": "[if(equals(environment().name, 'AzureUSGovernment'), 'https://graph.microsoft.us', if(startsWith(environment().name, 'us'), format('https://graph.{0}', environment().suffixes.storage), 'https://graph.microsoft.com'))]",
    "functionAppRegionAbbreviation": "[variables('locations')[parameters('location')].abbreviation]",
    "resourceAbbreviations": "[variables('$fxv#1')]",
    "nameConvReversed": "[if(startsWith(variables('hostPoolName'), variables('resourceAbbreviations').hostPools), false(), if(endsWith(variables('hostPoolName'), variables('resourceAbbreviations').hostPools), true(), false()))]",
    "arrHostPoolName": "[split(variables('hostPoolName'), '-')]",
    "lengthArrHostPoolName": "[length(variables('arrHostPoolName'))]",
    "hpIdentifier": "[if(variables('nameConvReversed'), if(less(variables('lengthArrHostPoolName'), 5), variables('arrHostPoolName')[0], format('{0}-{1}', variables('arrHostPoolName')[0], variables('arrHostPoolName')[1])), if(less(variables('lengthArrHostPoolName'), 5), variables('arrHostPoolName')[1], format('{0}-{1}', variables('arrHostPoolName')[1], variables('arrHostPoolName')[2])))]",
    "hpIndex": "[if(equals(variables('lengthArrHostPoolName'), 3), '', if(variables('nameConvReversed'), if(less(variables('lengthArrHostPoolName'), 5), variables('arrHostPoolName')[1], variables('arrHostPoolName')[2]), if(less(variables('lengthArrHostPoolName'), 5), variables('arrHostPoolName')[2], variables('arrHostPoolName')[3])))]",
    "hpBaseName": "[if(empty(variables('hpIndex')), variables('hpIdentifier'), format('{0}-{1}', variables('hpIdentifier'), variables('hpIndex')))]",
    "hpResPrfx": "[if(variables('nameConvReversed'), variables('hpBaseName'), format('RESOURCETYPE-{0}', variables('hpBaseName')))]",
    "nameConvSuffix": "[if(variables('nameConvReversed'), 'LOCATION-RESOURCETYPE', 'LOCATION')]",
    "nameConv_HP_Resources": "[format('{0}-TOKEN-{1}', variables('hpResPrfx'), variables('nameConvSuffix'))]",
    "uniqueStringHosts": "[take(uniqueString(variables('virtualMachinesSubscriptionId'), variables('virtualMachinesResourceGroupName')), 6)]",
    "nameConv_Shared_Resources": "[if(variables('nameConvReversed'), format('avd-TOKEN-{0}', variables('nameConvSuffix')), format('RESOURCETYPE-avd-TOKEN-{0}', variables('nameConvSuffix')))]",
    "appServicePlanName": "[replace(replace(replace(variables('nameConv_Shared_Resources'), 'RESOURCETYPE', variables('resourceAbbreviations').appServicePlans), 'LOCATION', variables('functionAppRegionAbbreviation')), 'TOKEN-', '')]",
    "appInsightsNameConv": "[replace(replace(variables('nameConv_HP_Resources'), 'RESOURCETYPE', variables('resourceAbbreviations').applicationInsights), 'LOCATION', variables('functionAppRegionAbbreviation'))]",
    "functionAppNameConv": "[replace(replace(variables('nameConv_HP_Resources'), 'RESOURCETYPE', variables('resourceAbbreviations').functionApps), 'LOCATION', variables('functionAppRegionAbbreviation'))]",
    "privateEndpointNameConv": "[replace(if(variables('nameConvReversed'), 'RESOURCE-SUBRESOURCE-VNETID-RESOURCETYPE', 'RESOURCETYPE-RESOURCE-SUBRESOURCE-VNETID'), 'RESOURCETYPE', variables('resourceAbbreviations').privateEndpoints)]",
    "privateEndpointNICNameConvTemp": "[if(variables('nameConvReversed'), format('{0}-RESOURCETYPE', variables('privateEndpointNameConv')), format('RESOURCETYPE-{0}', variables('privateEndpointNameConv')))]",
    "privateEndpointNICNameConv": "[replace(variables('privateEndpointNICNameConvTemp'), 'RESOURCETYPE', variables('resourceAbbreviations').networkInterfaces)]",
    "sessionHostReplacerFAStorageAccountName": "[format('shreplacer{0}', variables('uniqueStringHosts'))]",
    "functionAppName": "[replace(variables('functionAppNameConv'), 'TOKEN-', format('shreplacer-{0}-', variables('uniqueStringHosts')))]",
    "storageAccountName": "[variables('sessionHostReplacerFAStorageAccountName')]",
    "appInsightsName": "[replace(variables('appInsightsNameConv'), 'TOKEN-', format('shreplacer-{0}-', variables('uniqueStringHosts')))]",
    "encryptionKeyName": "[format('{0}-encryption-key-{1}', variables('hpBaseName'), variables('sessionHostReplacerFAStorageAccountName'))]",
    "templateSpecNameFinal": "[if(not(empty(parameters('templateSpecName'))), parameters('templateSpecName'), replace(replace(replace(variables('nameConv_Shared_Resources'), 'RESOURCETYPE', variables('resourceAbbreviations').templateSpecs), 'TOKEN', 'sessionhost'), 'LOCATION', variables('functionAppRegionAbbreviation')))]",
    "vmNamePrefixWithoutDash": "[toLower(if(equals(last(parameters('virtualMachineNamePrefix')), '-'), take(parameters('virtualMachineNamePrefix'), sub(length(parameters('virtualMachineNamePrefix')), 1)), parameters('virtualMachineNamePrefix')))]",
    "availabilitySetNamePrefix": "[if(variables('nameConvReversed'), format('{0}-{1}-', variables('vmNamePrefixWithoutDash'), variables('resourceAbbreviations').availabilitySets), format('{0}-{1}-', variables('resourceAbbreviations').availabilitySets, variables('vmNamePrefixWithoutDash')))]",
    "virtualMachineNameConv": "[if(variables('nameConvReversed'), format('VMNAMEPREFIX###-{0}', variables('resourceAbbreviations').virtualMachines), format('{0}-VMNAMEPREFIX###', variables('resourceAbbreviations').virtualMachines))]",
    "diskNameConv": "[if(variables('nameConvReversed'), format('VMNAMEPREFIX###-{0}', variables('resourceAbbreviations').osdisks), format('{0}-VMNAMEPREFIX###', variables('resourceAbbreviations').osdisks))]",
    "networkInterfaceNameConv": "[if(variables('nameConvReversed'), format('VMNAMEPREFIX###-{0}', variables('resourceAbbreviations').networkInterfaces), format('{0}-VMNAMEPREFIX###', variables('resourceAbbreviations').networkInterfaces))]"
  },
  "resources": [
    {
      "condition": "[empty(parameters('sessionHostTemplateSpecVersionResourceId'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('SessionHostTemplateSpec-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "templateSpecName": {
            "value": "[variables('templateSpecNameFinal')]"
          },
          "templateSpecVersion": {
            "value": "[parameters('templateSpecVersion')]"
          },
          "tags": {
            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/templateSpecs'), createObject()))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8827377793163652904"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "templateSpecName": {
              "type": "string"
            },
            "templateSpecVersion": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "$fxv#0": {
              "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "metadata": {
                "_generator": {
                  "name": "bicep",
                  "version": "0.39.26.7824",
                  "templateHash": "322199940451995423"
                }
              },
              "parameters": {
                "deploymentType": {
                  "type": "string"
                },
                "appGroupSecurityGroups": {
                  "type": "array"
                },
                "artifactsContainerUri": {
                  "type": "string"
                },
                "artifactsUserAssignedIdentityResourceId": {
                  "type": "string"
                },
                "availability": {
                  "type": "string"
                },
                "availabilitySetNamePrefix": {
                  "type": "string"
                },
                "availabilitySetsCount": {
                  "type": "int"
                },
                "availabilitySetsIndex": {
                  "type": "int"
                },
                "availabilityZones": {
                  "type": "array"
                },
                "avdInsightsDataCollectionRulesResourceId": {
                  "type": "string"
                },
                "azureBackupPrivateDnsZoneResourceId": {
                  "type": "string"
                },
                "azureBlobPrivateDnsZoneResourceId": {
                  "type": "string"
                },
                "azureQueuePrivateDnsZoneResourceId": {
                  "type": "string"
                },
                "confidentialVMOrchestratorObjectId": {
                  "type": "string"
                },
                "confidentialVMOSDiskEncryption": {
                  "type": "bool"
                },
                "customImageResourceId": {
                  "type": "string"
                },
                "dataCollectionEndpointResourceId": {
                  "type": "string"
                },
                "dedicatedHostGroupResourceId": {
                  "type": "string"
                },
                "dedicatedHostGroupZones": {
                  "type": "array"
                },
                "dedicatedHostResourceId": {
                  "type": "string"
                },
                "deployDiskAccessPolicy": {
                  "type": "bool"
                },
                "deployDiskAccessResource": {
                  "type": "bool"
                },
                "deploymentUserAssignedIdentityClientId": {
                  "type": "string"
                },
                "deploymentVirtualMachineName": {
                  "type": "string"
                },
                "domainJoinUserPassword": {
                  "type": "securestring"
                },
                "domainJoinUserPrincipalName": {
                  "type": "securestring"
                },
                "diskEncryptionSetNames": {
                  "type": "object"
                },
                "diskAccessName": {
                  "type": "string"
                },
                "diskSizeGB": {
                  "type": "int"
                },
                "diskSku": {
                  "type": "string"
                },
                "divisionRemainderValue": {
                  "type": "int"
                },
                "domainName": {
                  "type": "string"
                },
                "enableAcceleratedNetworking": {
                  "type": "bool"
                },
                "encryptionAtHost": {
                  "type": "bool"
                },
                "encryptionKeyName": {
                  "type": "string"
                },
                "encryptionKeyVaultResourceId": {
                  "type": "string"
                },
                "encryptionKeyVaultUri": {
                  "type": "string"
                },
                "existingDiskAccessResourceId": {
                  "type": "string"
                },
                "existingDiskEncryptionSetResourceId": {
                  "type": "string"
                },
                "existingRecoveryServicesVaultResourceId": {
                  "type": "string"
                },
                "fslogixFileShareNames": {
                  "type": "array"
                },
                "fslogixConfigureSessionHosts": {
                  "type": "bool"
                },
                "fslogixContainerType": {
                  "type": "string"
                },
                "fslogixLocalNetAppVolumeResourceIds": {
                  "type": "array"
                },
                "fslogixLocalStorageAccountResourceIds": {
                  "type": "array"
                },
                "fslogixOSSGroups": {
                  "type": "array"
                },
                "fslogixRemoteNetAppVolumeResourceIds": {
                  "type": "array"
                },
                "fslogixRemoteStorageAccountResourceIds": {
                  "type": "array"
                },
                "fslogixSizeInMBs": {
                  "type": "int"
                },
                "fslogixStorageService": {
                  "type": "string"
                },
                "hibernationEnabled": {
                  "type": "bool"
                },
                "hostPoolResourceId": {
                  "type": "string"
                },
                "identitySolution": {
                  "type": "string"
                },
                "imageOffer": {
                  "type": "string"
                },
                "imagePublisher": {
                  "type": "string"
                },
                "imageSku": {
                  "type": "string"
                },
                "integrityMonitoring": {
                  "type": "bool"
                },
                "intuneEnrollment": {
                  "type": "bool"
                },
                "keyExpirationInDays": {
                  "type": "int"
                },
                "keyManagementDisks": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "logAnalyticsWorkspaceResourceId": {
                  "type": "string"
                },
                "maxResourcesPerTemplateDeployment": {
                  "type": "int"
                },
                "privateEndpoint": {
                  "type": "bool"
                },
                "privateEndpointNameConv": {
                  "type": "string"
                },
                "privateEndpointNICNameConv": {
                  "type": "string"
                },
                "privateEndpointSubnetResourceId": {
                  "type": "string"
                },
                "enableMonitoring": {
                  "type": "bool"
                },
                "networkInterfaceNameConv": {
                  "type": "string"
                },
                "osDiskNameConv": {
                  "type": "string"
                },
                "ouPath": {
                  "type": "string"
                },
                "pooledHostPool": {
                  "type": "bool"
                },
                "recoveryServices": {
                  "type": "bool"
                },
                "recoveryServicesVaultName": {
                  "type": "string"
                },
                "resourceGroupDeployment": {
                  "type": "string"
                },
                "resourceGroupHosts": {
                  "type": "string"
                },
                "secureBootEnabled": {
                  "type": "bool"
                },
                "securityDataCollectionRulesResourceId": {
                  "type": "string"
                },
                "securityType": {
                  "type": "string"
                },
                "sessionHostBatchCount": {
                  "type": "int"
                },
                "sessionHostCustomizations": {
                  "type": "array"
                },
                "sessionHostRegistrationDSCUrl": {
                  "type": "string"
                },
                "sessionHostIndex": {
                  "type": "int"
                },
                "vmNameIndexLength": {
                  "type": "int"
                },
                "storageSuffix": {
                  "type": "string"
                },
                "subnetResourceId": {
                  "type": "string"
                },
                "tags": {
                  "type": "object"
                },
                "deploymentSuffix": {
                  "type": "string"
                },
                "timeZone": {
                  "type": "string"
                },
                "useAgentDownloadEndpoint": {
                  "type": "bool"
                },
                "virtualMachineNameConv": {
                  "type": "string"
                },
                "virtualMachineNamePrefix": {
                  "type": "string"
                },
                "virtualMachineSize": {
                  "type": "string"
                },
                "virtualMachineAdminPassword": {
                  "type": "securestring"
                },
                "virtualMachineAdminUserName": {
                  "type": "securestring"
                },
                "vTpmEnabled": {
                  "type": "bool"
                },
                "vmInsightsDataCollectionRulesResourceId": {
                  "type": "string"
                }
              },
              "variables": {
                "backupPolicyName": "AvdPolicyVm",
                "confidentialVMOSDiskEncryptionType": "[[if(parameters('confidentialVMOSDiskEncryption'), 'DiskWithVMGuestState', 'VMGuestStateOnly')]",
                "localNetAppProfileContainerVolumeResourceIds": "[[if(not(empty(parameters('fslogixLocalNetAppVolumeResourceIds'))), filter(parameters('fslogixLocalNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0]))), createArray())]",
                "localNetAppOfficeContainerVolumeResourceIds": "[[if(and(not(empty(parameters('fslogixLocalNetAppVolumeResourceIds'))), greater(length(parameters('fslogixFileShareNames')), 1)), filter(parameters('fslogixLocalNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[1]))), createArray())]",
                "sortedLocalNetAppResourceIds": "[[union(variables('localNetAppProfileContainerVolumeResourceIds'), variables('localNetAppOfficeContainerVolumeResourceIds'))]",
                "remoteNetAppProfileContainerVolumeResourceIds": "[[if(not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds'))), filter(parameters('fslogixRemoteNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0]))), createArray())]",
                "remoteNetAppOfficeContainerVolumeResourceIds": "[[if(and(not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds'))), greater(length(parameters('fslogixFileShareNames')), 1)), filter(parameters('fslogixRemoteNetAppVolumeResourceIds'), lambda('id', not(contains(lambdaVariables('id'), parameters('fslogixFileShareNames')[0])))), createArray())]",
                "sortedRemoteNetAppResourceIds": "[[union(variables('remoteNetAppProfileContainerVolumeResourceIds'), variables('remoteNetAppOfficeContainerVolumeResourceIds'))]",
                "backupPrivateDNSZoneResourceIds": [
                  "[[parameters('azureBackupPrivateDnsZoneResourceId')]",
                  "[[parameters('azureBlobPrivateDnsZoneResourceId')]",
                  "[[parameters('azureQueuePrivateDnsZoneResourceId')]"
                ],
                "nonEmptyBackupPrivateDNSZoneResourceIds": "[[filter(variables('backupPrivateDNSZoneResourceIds'), lambda('zone', not(empty(lambdaVariables('zone')))))]"
              },
              "resources": [
                {
                  "[string('copy')]": {
                    "name": "roleAssignment_VirtualMachineUserLogin",
                    "count": "[[length(range(0, length(parameters('appGroupSecurityGroups'))))]"
                  },
                  "condition": "[[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(contains(parameters('identitySolution'), 'DomainServices')))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('RA-Hosts-VMLoginUser-{0}-{1}', range(0, length(parameters('appGroupSecurityGroups')))[copyIndex()], parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "principalId": {
                        "value": "[[parameters('appGroupSecurityGroups')[range(0, length(parameters('appGroupSecurityGroups')))[copyIndex()]]]"
                      },
                      "principalType": {
                        "value": "Group"
                      },
                      "roleDefinitionId": {
                        "value": "fb879df8-f326-4884-b1cf-06f3ad86be52"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "17889000177953870600"
                        }
                      },
                      "parameters": {
                        "roleDefinitionId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. You can provide either the role definition GUID or its fully qualified ID in the following format: \\'/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11\\'.\nYou can find the GUIDs in the ID column on the table at https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles.\n"
                          }
                        },
                        "principalId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The Principal or Object ID of the Security Principal (User, Group, Service Principal, Managed Identity)."
                          }
                        },
                        "resourceGroupName": {
                          "type": "string",
                          "defaultValue": "[[resourceGroup().name]",
                          "metadata": {
                            "description": "Optional. Name of the Resource Group to assign the RBAC role to. If not provided, will use the current scope for deployment."
                          }
                        },
                        "subscriptionId": {
                          "type": "string",
                          "defaultValue": "[[subscription().subscriptionId]",
                          "metadata": {
                            "description": "Optional. Subscription ID of the subscription to assign the RBAC role to. If not provided, will use the current scope for deployment."
                          }
                        },
                        "principalType": {
                          "type": "string",
                          "defaultValue": "",
                          "allowedValues": [
                            "ServicePrincipal",
                            "Group",
                            "User",
                            "ForeignGroup",
                            "Device",
                            ""
                          ],
                          "metadata": {
                            "description": "Optional. The principal type of the assigned principal ID."
                          }
                        }
                      },
                      "variables": {
                        "roleDefinitionIdVar": "[[if(contains(parameters('roleDefinitionId'), '/providers/Microsoft.Authorization/roleDefinitions/'), parameters('roleDefinitionId'), format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleDefinitionId')))]"
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Authorization/roleAssignments",
                          "apiVersion": "2022-04-01",
                          "name": "[[guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId'))]",
                          "properties": {
                            "roleDefinitionId": "[[variables('roleDefinitionIdVar')]",
                            "principalId": "[[parameters('principalId')]",
                            "principalType": "[[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]"
                          }
                        }
                      ],
                      "outputs": {
                        "resourceId": {
                          "type": "string",
                          "value": "[[resourceId('Microsoft.Authorization/roleAssignments', guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId')))]"
                        }
                      }
                    }
                  }
                },
                {
                  "condition": "[[equals(parameters('deploymentType'), 'SessionHostsOnly')]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix'))]",
                  "subscriptionId": "[[split(parameters('hostPoolResourceId'), '/')[2]]",
                  "resourceGroup": "[[split(parameters('hostPoolResourceId'), '/')[4]]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "hostPoolType": "[[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').hostPoolType), createObject('value', ''))]",
                      "loadBalancerType": "[[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').loadBalancerType), createObject('value', ''))]",
                      "location": "[[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05', 'full').location), createObject('value', parameters('location')))]",
                      "name": "[[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', last(split(parameters('hostPoolResourceId'), '/'))), createObject('value', ''))]",
                      "preferredAppGroupType": "[[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').preferredAppGroupType), createObject('value', ''))]"
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "8593275479235695745"
                        }
                      },
                      "parameters": {
                        "hostPoolType": {
                          "type": "string"
                        },
                        "loadBalancerType": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "preferredAppGroupType": {
                          "type": "string"
                        },
                        "time": {
                          "type": "string",
                          "defaultValue": "[[utcNow()]"
                        }
                      },
                      "resources": [
                        {
                          "type": "Microsoft.DesktopVirtualization/hostPools",
                          "apiVersion": "2024-04-03",
                          "name": "[[parameters('name')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "hostPoolType": "[[parameters('hostPoolType')]",
                            "loadBalancerType": "[[parameters('loadBalancerType')]",
                            "preferredAppGroupType": "[[parameters('preferredAppGroupType')]",
                            "registrationInfo": {
                              "expirationTime": "[[dateTimeAdd(parameters('time'), 'PT2H')]",
                              "registrationTokenOperation": "Update"
                            }
                          }
                        }
                      ],
                      "outputs": {
                        "resourceId": {
                          "type": "string",
                          "value": "[[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('name'))]"
                        }
                      }
                    }
                  }
                },
                {
                  "condition": "[[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('deployDiskAccessResource'))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('DiskAccess-{0}', parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "name": {
                        "value": "[[parameters('diskAccessName')]"
                      },
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "privateEndpoints": {
                        "value": [
                          {
                            "customNetworkInterfaceName": "[[replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', 'disks'), 'RESOURCE', parameters('diskAccessName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8]))]",
                            "name": "[[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'disks'), 'RESOURCE', parameters('diskAccessName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8]))]",
                            "privateDnsZoneGroup": "[[if(empty(parameters('azureBlobPrivateDnsZoneResourceId')), null(), createObject('privateDNSResourceIds', createArray(parameters('azureBlobPrivateDnsZoneResourceId'))))]",
                            "service": "disks",
                            "subnetResourceId": "[[parameters('privateEndpointSubnetResourceId')]",
                            "tags": "[[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject())]"
                          }
                        ]
                      },
                      "tags": {
                        "value": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskAccesses'), createObject()))]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "12211048938195293438"
                        }
                      },
                      "parameters": {
                        "name": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "privateEndpoints": {
                          "type": "array"
                        },
                        "tags": {
                          "type": "object",
                          "defaultValue": {}
                        }
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Compute/diskAccesses",
                          "apiVersion": "2021-04-01",
                          "name": "[[parameters('name')]",
                          "location": "[[parameters('location')]",
                          "tags": "[[parameters('tags')]",
                          "properties": {}
                        },
                        {
                          "[string('copy')]": {
                            "name": "diskAccess_privateEndpoints",
                            "count": "[[length(parameters('privateEndpoints'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('DiskAccess-PrivateEndpoint-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "groupIds": {
                                "value": [
                                  "[[parameters('privateEndpoints')[copyIndex()].service]"
                                ]
                              },
                              "name": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'name'), format('pe-{0}-{1}-{2}', last(split(resourceId('Microsoft.Compute/diskAccesses', parameters('name')), '/')), parameters('privateEndpoints')[copyIndex()].service, copyIndex()))]"
                              },
                              "serviceResourceId": {
                                "value": "[[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
                              },
                              "subnetResourceId": {
                                "value": "[[parameters('privateEndpoints')[copyIndex()].subnetResourceId]"
                              },
                              "location": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'location'), reference(split(parameters('privateEndpoints')[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                              },
                              "privateDnsZoneGroup": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'privateDnsZoneGroup'), createObject())]"
                              },
                              "tags": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'tags'), createObject())]"
                              },
                              "manualPrivateLinkServiceConnections": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'manualPrivateLinkServiceConnections'), createArray())]"
                              },
                              "customDnsConfigs": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customDnsConfigs'), createArray())]"
                              },
                              "ipConfigurations": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'ipConfigurations'), createArray())]"
                              },
                              "applicationSecurityGroups": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'applicationSecurityGroups'), createArray())]"
                              },
                              "customNetworkInterfaceName": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customNetworkInterfaceName'), '')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "13574490579232233940"
                                },
                                "name": "Private Endpoints"
                              },
                              "parameters": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Name of the private endpoint resource to create."
                                  }
                                },
                                "subnetResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                  }
                                },
                                "serviceResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Resource ID of the resource that needs to be connected to the network."
                                  }
                                },
                                "applicationSecurityGroups": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                  }
                                },
                                "customNetworkInterfaceName": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                  }
                                },
                                "ipConfigurations": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                  }
                                },
                                "groupIds": {
                                  "type": "array",
                                  "metadata": {
                                    "description": "Required. Subtype(s) of the connection to be created. The allowed values depend on the type serviceResourceId refers to."
                                  }
                                },
                                "privateDnsZoneGroup": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. The private DNS zone group configuration used to associate the private endpoint with one or multiple private DNS zones. A DNS zone group can support up to 5 DNS zones."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Optional. Location for all Resources."
                                  }
                                },
                                "tags": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                  }
                                },
                                "customDnsConfigs": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Custom DNS configurations."
                                  }
                                },
                                "manualPrivateLinkServiceConnections": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Manual PrivateLink Service Connections."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Network/privateEndpoints",
                                  "apiVersion": "2023-04-01",
                                  "name": "[[parameters('name')]",
                                  "location": "[[parameters('location')]",
                                  "tags": "[[parameters('tags')]",
                                  "properties": {
                                    "applicationSecurityGroups": "[[parameters('applicationSecurityGroups')]",
                                    "customDnsConfigs": "[[parameters('customDnsConfigs')]",
                                    "customNetworkInterfaceName": "[[parameters('customNetworkInterfaceName')]",
                                    "ipConfigurations": "[[parameters('ipConfigurations')]",
                                    "manualPrivateLinkServiceConnections": "[[parameters('manualPrivateLinkServiceConnections')]",
                                    "privateLinkServiceConnections": [
                                      {
                                        "name": "[[parameters('name')]",
                                        "properties": {
                                          "privateLinkServiceId": "[[parameters('serviceResourceId')]",
                                          "groupIds": "[[parameters('groupIds')]"
                                        }
                                      }
                                    ],
                                    "subnet": {
                                      "id": "[[parameters('subnetResourceId')]"
                                    }
                                  }
                                },
                                {
                                  "condition": "[[not(empty(parameters('privateDnsZoneGroup')))]",
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('PE-PrivateDnsZoneGroup-{0}', uniqueString(deployment().name))]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "privateDNSResourceIds": {
                                        "value": "[[parameters('privateDnsZoneGroup').privateDNSResourceIds]"
                                      },
                                      "privateEndpointName": {
                                        "value": "[[parameters('name')]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "10522840417060554620"
                                        }
                                      },
                                      "parameters": {
                                        "privateEndpointName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "privateDNSResourceIds": {
                                          "type": "array",
                                          "minLength": 1,
                                          "maxLength": 5,
                                          "metadata": {
                                            "description": "Required. Array of private DNS zone resource IDs. A DNS zone group can support up to 5 DNS zones."
                                          }
                                        },
                                        "name": {
                                          "type": "string",
                                          "defaultValue": "default",
                                          "metadata": {
                                            "description": "Optional. The name of the private DNS zone group."
                                          }
                                        }
                                      },
                                      "variables": {
                                        "[string('copy')]": [
                                          {
                                            "name": "privateDnsZoneConfigs",
                                            "count": "[[length(parameters('privateDNSResourceIds'))]",
                                            "input": {
                                              "name": "[[last(split(parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                                              "properties": {
                                                "privateDnsZoneId": "[[parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')]]"
                                              }
                                            }
                                          }
                                        ]
                                      },
                                      "resources": [
                                        {
                                          "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                          "apiVersion": "2023-04-01",
                                          "name": "[[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                          "properties": {
                                            "privateDnsZoneConfigs": "[[variables('privateDnsZoneConfigs')]"
                                          }
                                        }
                                      ],
                                      "outputs": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint DNS zone group."
                                          },
                                          "value": "[[parameters('name')]"
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint DNS zone group."
                                          },
                                          "value": "[[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                        }
                                      }
                                    }
                                  },
                                  "dependsOn": [
                                    "[[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                  ]
                                }
                              ],
                              "outputs": {
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource group the private endpoint was deployed into."
                                  },
                                  "value": "[[resourceGroup().name]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the private endpoint."
                                  },
                                  "value": "[[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the private endpoint."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "location": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The location the resource was deployed into."
                                  },
                                  "value": "[[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01', 'full').location]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
                          ]
                        }
                      ],
                      "outputs": {
                        "resourceId": {
                          "type": "string",
                          "value": "[[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
                        }
                      }
                    }
                  }
                },
                {
                  "condition": "[[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('deployDiskAccessPolicy'))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('ManagedDisks-NetworkAccess-Policy-{0}', parameters('deploymentSuffix'))]",
                  "location": "[[deployment().location]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "diskAccessId": "[[if(parameters('deployDiskAccessResource'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value), createObject('value', ''))]",
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "resourceGroupName": {
                        "value": "[[parameters('resourceGroupHosts')]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "16147463376755190877"
                        }
                      },
                      "parameters": {
                        "diskAccessId": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "resourceGroupName": {
                          "type": "string"
                        }
                      },
                      "variables": {
                        "parameters": "[[if(not(empty(parameters('diskAccessId'))), createObject('diskAccessId', createObject('type', 'String', 'metadata', createObject('displayName', 'Disk Access Resource Id', 'description', 'The resource Id of the Disk Access to associate to the managed disks.'))), createObject())]",
                        "operations": "[[if(not(empty(parameters('diskAccessId'))), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'AllowPrivate'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/diskAccessId', 'value', '[parameters(''diskAccessId'')]')), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'DenyAll'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled')))]",
                        "policyName": "[[if(not(empty(parameters('diskAccessId'))), 'DisableDisksPublicNetworkAccess', 'DisableDisksAllNetworkAccess')]",
                        "policyDescription": "[[if(not(empty(parameters('diskAccessId'))), 'Disable public network access to managed disks', 'Disable public network access to managed disks, but allow private network access.')]",
                        "policyDisplayName": "[[if(not(empty(parameters('diskAccessId'))), 'Disable public network access to managed disks', 'Disable all network access to managed disks')]"
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Authorization/policyDefinitions",
                          "apiVersion": "2021-06-01",
                          "name": "[[variables('policyName')]",
                          "properties": {
                            "description": "[[variables('policyDescription')]",
                            "displayName": "[[variables('policyDisplayName')]",
                            "mode": "All",
                            "parameters": "[[variables('parameters')]",
                            "policyRule": {
                              "if": {
                                "field": "type",
                                "equals": "Microsoft.Compute/disks"
                              },
                              "then": {
                                "effect": "modify",
                                "details": {
                                  "roleDefinitionIds": [
                                    "/providers/Microsoft.Authorization/roleDefinitions/60fc6e62-5479-42d4-8bf4-67625fcc2840"
                                  ],
                                  "operations": "[[variables('operations')]"
                                }
                              }
                            },
                            "policyType": "Custom"
                          }
                        },
                        {
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "DiskNetworkAccess",
                          "resourceGroup": "[[parameters('resourceGroupName')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "location": {
                                "value": "[[parameters('location')]"
                              },
                              "diskAccessId": {
                                "value": "[[parameters('diskAccessId')]"
                              },
                              "policyDefinitionId": {
                                "value": "[[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName'))]"
                              },
                              "policyDisplayName": {
                                "value": "[[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName')), '2021-06-01').displayName]"
                              },
                              "policyName": {
                                "value": "[[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName')), '2021-06-01').displayName]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "386624604173233219"
                                }
                              },
                              "parameters": {
                                "location": {
                                  "type": "string"
                                },
                                "diskAccessId": {
                                  "type": "string"
                                },
                                "policyDefinitionId": {
                                  "type": "string"
                                },
                                "policyDisplayName": {
                                  "type": "string"
                                },
                                "policyName": {
                                  "type": "string"
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Authorization/policyAssignments",
                                  "apiVersion": "2022-06-01",
                                  "name": "[[parameters('policyName')]",
                                  "location": "[[parameters('location')]",
                                  "identity": {
                                    "type": "SystemAssigned"
                                  },
                                  "properties": {
                                    "displayName": "[[parameters('policyDisplayName')]",
                                    "policyDefinitionId": "[[parameters('policyDefinitionId')]",
                                    "parameters": "[[if(not(empty(parameters('diskAccessId'))), createObject('diskAccessId', createObject('value', parameters('diskAccessId'))), createObject())]"
                                  }
                                }
                              ]
                            }
                          },
                          "dependsOn": [
                            "[[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName'))]"
                          ]
                        }
                      ]
                    }
                  },
                  "dependsOn": [
                    "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix')))]"
                  ]
                },
                {
                  "condition": "[[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(equals(parameters('keyManagementDisks'), 'PlatformManaged')))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "confidentialVMOrchestratorObjectId": {
                        "value": "[[parameters('confidentialVMOrchestratorObjectId')]"
                      },
                      "confidentialVMOSDiskEncryption": {
                        "value": "[[parameters('confidentialVMOSDiskEncryption')]"
                      },
                      "deploymentUserAssignedIdentityClientId": {
                        "value": "[[parameters('deploymentUserAssignedIdentityClientId')]"
                      },
                      "deploymentVirtualMachineName": {
                        "value": "[[parameters('deploymentVirtualMachineName')]"
                      },
                      "diskEncryptionSetNames": {
                        "value": "[[parameters('diskEncryptionSetNames')]"
                      },
                      "hostPoolResourceId": {
                        "value": "[[parameters('hostPoolResourceId')]"
                      },
                      "keyExpirationInDays": {
                        "value": "[[parameters('keyExpirationInDays')]"
                      },
                      "keyManagementDisks": {
                        "value": "[[parameters('keyManagementDisks')]"
                      },
                      "keyName": {
                        "value": "[[parameters('encryptionKeyName')]"
                      },
                      "keyVaultResourceId": {
                        "value": "[[parameters('encryptionKeyVaultResourceId')]"
                      },
                      "keyVaultUri": {
                        "value": "[[parameters('encryptionKeyVaultUri')]"
                      },
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "deploymentResourceGroupName": {
                        "value": "[[parameters('resourceGroupDeployment')]"
                      },
                      "tags": {
                        "value": "[[parameters('tags')]"
                      },
                      "deploymentSuffix": {
                        "value": "[[parameters('deploymentSuffix')]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "13941907654962239870"
                        }
                      },
                      "parameters": {
                        "confidentialVMOSDiskEncryption": {
                          "type": "bool"
                        },
                        "confidentialVMOrchestratorObjectId": {
                          "type": "string"
                        },
                        "deploymentUserAssignedIdentityClientId": {
                          "type": "string"
                        },
                        "keyName": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "diskEncryptionSetNames": {
                          "type": "object"
                        },
                        "hostPoolResourceId": {
                          "type": "string"
                        },
                        "keyExpirationInDays": {
                          "type": "int",
                          "defaultValue": 180
                        },
                        "keyManagementDisks": {
                          "type": "string"
                        },
                        "keyVaultResourceId": {
                          "type": "string"
                        },
                        "keyVaultUri": {
                          "type": "string"
                        },
                        "deploymentVirtualMachineName": {
                          "type": "string"
                        },
                        "deploymentResourceGroupName": {
                          "type": "string"
                        },
                        "tags": {
                          "type": "object"
                        },
                        "deploymentSuffix": {
                          "type": "string"
                        }
                      },
                      "variables": {
                        "$fxv#0": "[CmdletBinding()]\r\nparam (\r\n    [string]$KeyName,\r\n    [string]$Tags,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VaultUri\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the Vault URI since only AzureCloud contains a trailing slash\r\n$VaultUriFixed = if($VaultUri[-1] -eq '/'){$VaultUri.Substring(0,$VaultUri.Length - 1)} else {$VaultUri}\r\n\r\n$PolicyContentJson = @\"\r\n{\"version\":\"1.0.0\",\"anyOf\":[{\"authority\":\"https://sharedeus.eus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedwus.wus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedneu.neu.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedweu.weu.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedsasia.sasia.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeasia.easia.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedjpe.jpe.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedswn.swn.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareditn.itn.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeus2.eus2.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeus2e.eus2e.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedscus.scus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcuse.cuse.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcus.cus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeau.eau.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedsau.sau.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcin.cin.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareduaen.uaen.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareddewc.dewc.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedwus3.wus3.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]}]}\r\n\"@\r\nIf ($Tags -ne '{}') {\r\n    [PSCustomObject]$TagsObject = $Tags | ConvertFrom-Json\r\n}\r\ntry \r\n{\r\n    # Get an access token for Azure resources\r\n    $AzureKeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata=\"true\"} `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $VaultUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureKeyVaultHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureKeyVaultAccessToken\r\n    }\r\n\r\n    $Key = (Invoke-RestMethod `\r\n        -Headers $AzureKeyVaultHeader `\r\n        -Method 'GET' `\r\n        -Uri $($VaultUriFixed + '/keys?api-version=7.4')).value | Where-Object { $_.kid -eq \"$VaultUriFixed/keys/$KeyName\" }\r\n        \r\n    If (!$Key) {\r\n        #$PolicyContentJson | ConvertFrom-Json | ConvertTo-Json -Depth 100\r\n        $Release_Policy_Data = [Convert]::ToBase64String([char[]]$PolicyContentJson)\r\n        $Body = (@{\r\n            attributes = @{\r\n                enabled = $true\r\n                exportable = $true\r\n            }\r\n            kty='RSA-HSM'\r\n            key_size=4096\r\n            key_ops=@('encrypt', 'decrypt', 'sign', 'verify', 'wrapKey', 'unwrapKey')\r\n            release_policy=@{\r\n                data=$Release_Policy_Data\r\n            }\r\n        })\r\n        If($TagsObject) {\r\n            $Body.tags = $TagsObject\r\n        }\r\n        $Body = $Body | ConvertTo-Json -Depth 100 -Compress\r\n\r\n        Invoke-RestMethod `\r\n            -Headers $AzureKeyVaultHeader `\r\n            -Method 'POST' `\r\n            -Uri $($VaultUriFixed + '/keys/' + $KeyName + '/create?api-version=7.4') `\r\n            -Body $Body\r\n    }\r\n}\r\ncatch \r\n{\r\n    Write-Error -Message \"Failed to create or retrieve the key from the Key Vault. $_\"\r\n    throw\r\n}",
                        "keyVaultName": "[[last(split(parameters('keyVaultResourceId'), '/'))]",
                        "keyVaultResourceGroup": "[[split(parameters('keyVaultResourceId'), '/')[4]]",
                        "roleKeyVaultCryptoUser": "e147488a-f6f5-4113-8e2d-b22465e65bf6",
                        "roleKeyVaultCryptoReleaseUser": "08bbd89e-9f13-488c-ac41-acfcb10c90ab",
                        "diskEncryptionSetEncryptionType": "[[if(parameters('confidentialVMOSDiskEncryption'), 'ConfidentialVmEncryptedWithCustomerKey', if(not(contains(parameters('keyManagementDisks'), 'Platform')), 'EncryptionAtRestWithCustomerKey', 'EncryptionAtRestWithPlatformAndCustomerKeys'))]"
                      },
                      "resources": [
                        {
                          "condition": "[[not(parameters('confidentialVMOSDiskEncryption'))]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('Encryption-Key-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[variables('keyVaultResourceGroup')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "attributesEnabled": {
                                "value": true
                              },
                              "attributesExportable": {
                                "value": false
                              },
                              "keySize": {
                                "value": 4096
                              },
                              "keyVaultName": {
                                "value": "[[variables('keyVaultName')]"
                              },
                              "kty": "[[if(contains(parameters('keyManagementDisks'), 'HSM'), createObject('value', 'RSA-HSM'), createObject('value', 'RSA'))]",
                              "name": {
                                "value": "[[parameters('keyName')]"
                              },
                              "rotationPolicy": {
                                "value": {
                                  "attributes": {
                                    "expiryTime": "[[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                                  },
                                  "lifetimeActions": [
                                    {
                                      "action": {
                                        "type": "Notify"
                                      },
                                      "trigger": {
                                        "timeBeforeExpiry": "P10D"
                                      }
                                    },
                                    {
                                      "action": {
                                        "type": "Rotate"
                                      },
                                      "trigger": {
                                        "timeAfterCreate": "[[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "tags": {
                                "value": {
                                  "cm-resource-parent": "[[parameters('hostPoolResourceId')]"
                                }
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "3718319161044008822"
                                }
                              },
                              "parameters": {
                                "keyVaultName": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                },
                                "tags": {
                                  "type": "object",
                                  "defaultValue": {}
                                },
                                "attributesEnabled": {
                                  "type": "bool",
                                  "defaultValue": true
                                },
                                "attributesExp": {
                                  "type": "int",
                                  "defaultValue": -1
                                },
                                "attributesNbf": {
                                  "type": "int",
                                  "defaultValue": -1
                                },
                                "curveName": {
                                  "type": "string",
                                  "defaultValue": "P-256"
                                },
                                "attributesExportable": {
                                  "type": "bool",
                                  "defaultValue": false
                                },
                                "keyOps": {
                                  "type": "array",
                                  "defaultValue": []
                                },
                                "keySize": {
                                  "type": "int",
                                  "defaultValue": -1
                                },
                                "kty": {
                                  "type": "string",
                                  "defaultValue": "EC"
                                },
                                "release_policy": {
                                  "type": "object",
                                  "defaultValue": {}
                                },
                                "rotationPolicy": {
                                  "type": "object",
                                  "defaultValue": {}
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.KeyVault/vaults/keys",
                                  "apiVersion": "2022-07-01",
                                  "name": "[[format('{0}/{1}', parameters('keyVaultName'), parameters('name'))]",
                                  "tags": "[[if(empty(parameters('tags')), null(), parameters('tags'))]",
                                  "properties": {
                                    "attributes": {
                                      "enabled": "[[parameters('attributesEnabled')]",
                                      "exportable": "[[parameters('attributesExportable')]",
                                      "exp": "[[if(not(equals(parameters('attributesExp'), -1)), parameters('attributesExp'), null())]",
                                      "nbf": "[[if(not(equals(parameters('attributesNbf'), -1)), parameters('attributesNbf'), null())]"
                                    },
                                    "curveName": "[[parameters('curveName')]",
                                    "keyOps": "[[parameters('keyOps')]",
                                    "keySize": "[[if(not(equals(parameters('keySize'), -1)), parameters('keySize'), null())]",
                                    "kty": "[[parameters('kty')]",
                                    "release_policy": "[[if(empty(parameters('release_policy')), null(), parameters('release_policy'))]",
                                    "rotationPolicy": "[[if(empty(parameters('rotationPolicy')), null(), parameters('rotationPolicy'))]"
                                  }
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "value": "[[parameters('name')]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "value": "[[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('name'))]"
                                }
                              }
                            }
                          }
                        },
                        {
                          "condition": "[[parameters('confidentialVMOSDiskEncryption')]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[parameters('deploymentResourceGroupName')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "name": {
                                "value": "Set-ConfidentialVM-Key-Disks"
                              },
                              "parameters": {
                                "value": [
                                  {
                                    "name": "KeyName",
                                    "value": "[[parameters('keyName')]"
                                  },
                                  {
                                    "name": "Tags",
                                    "value": "[[string(createObject('cm-resource-parent', parameters('hostPoolResourceId')))]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[[parameters('deploymentUserAssignedIdentityClientId')]"
                                  },
                                  {
                                    "name": "VaultUri",
                                    "value": "[[parameters('keyVaultUri')]"
                                  }
                                ]
                              },
                              "script": {
                                "value": "[[variables('$fxv#0')]"
                              },
                              "treatFailureAsDeploymentFailure": {
                                "value": true
                              },
                              "virtualMachineName": {
                                "value": "[[parameters('deploymentVirtualMachineName')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "8433848325792194852"
                                },
                                "name": "Virtual Machine RunCommand",
                                "description": "This module deploys a Virtual Machine Run Command.",
                                "owner": "shawn.meyer@microsoft.com"
                              },
                              "parameters": {
                                "virtualMachineName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent virtual machine that extension is provisioned for. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The name of the virtual machine extension."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Optional. The location the extension is deployed to."
                                  }
                                },
                                "asyncExecution": {
                                  "type": "bool",
                                  "defaultValue": false,
                                  "metadata": {
                                    "description": "Optional.  If set to true, provisioning will complete as soon as the script starts and will not wait for script to complete."
                                  }
                                },
                                "errorBlobManagedIdentity": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. User-assigned managed identity that has access to errorBlobContainerUri storage blob container.\nUse an empty object in case of system-assigned identity. Make sure managed identity has been given access to blob\\'s container with \\'Storage Blob Data Contributor\\' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged"
                                  }
                                },
                                "errorBlobContainerUri": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. \tSpecifies the Azure storage blob where script error stream will be uploaded.\nUse a SAS URI with read, append, create, write access OR use managed identity to provide the VM access to the blob.\nRefer errorBlobManagedIdentity parameter."
                                  }
                                },
                                "outputBlobManagedIdentity": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. User-assigned managed identity that has access to outputBlobContainerUri storage blob container.\nUse an empty object in case of system-assigned identity. Make sure managed identity has been given access to blob\\'s container with \\'Storage Blob Data Contributor\\' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged"
                                  }
                                },
                                "outputBlobContainerUri": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. \tSpecifies the Azure storage blob where script error stream will be uploaded.\nUse a SAS URI with read, append, create, write access OR use managed identity to provide the VM access to the blob.\nRefer errorBlobManagedIdentity parameter."
                                  }
                                },
                                "parameters": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Parameters used by the script."
                                  }
                                },
                                "protectedParameters": {
                                  "type": "secureObject",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. Protected parameters used by the script. These parameters will not show up in deployment data.\nFormat the object as follows:\n{\n  SecureParameterName1: { value: 'secureParameterValue1'}\n  SecureParameterName2: { value: 'secureParameterValue2'}\n}    \n"
                                  }
                                },
                                "runAsPassword": {
                                  "type": "securestring",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Specifies the user account password on the VM when executing the run command."
                                  }
                                },
                                "runAsUser": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Specifies the user account on the VM when executing the run command."
                                  }
                                },
                                "commandId": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Conditional. Specifies a commandId of predefined built-in script. Do not use with [script] or [scriptUri] parameters."
                                  }
                                },
                                "script": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Specifies the script content to be executed on the VM. Do not use with [commandId] or [scriptUri] parameters."
                                  }
                                },
                                "scriptUri": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Specifies the script download location. It can be either SAS URI of an Azure storage blob with read access or public URI.\nDo not use with [commandId] or [script] parameters."
                                  }
                                },
                                "scriptUriManagedIdentity": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. User-assigned managed identity that has access to scriptUri in case of Azure storage blob.\nUse an empty object in case of system-assigned identity.\nMake sure the Azure storage blob exists, and managed identity has been given access to blob's container with 'Storage Blob Data Reader' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged."
                                  }
                                },
                                "timeoutInSeconds": {
                                  "type": "int",
                                  "defaultValue": -1,
                                  "metadata": {
                                    "description": "Optional. The timeout in seconds to execute the run command."
                                  }
                                },
                                "treatFailureAsDeploymentFailure": {
                                  "type": "bool",
                                  "defaultValue": false,
                                  "metadata": {
                                    "description": "Optional. Optional. If set to true, any failure in the script will fail the deployment and ProvisioningState will be marked as Failed.\nIf set to false, ProvisioningState would only reflect whether the run command was run or not by the extensions platform, it would not indicate whether script failed in case of script failures.\nSee instance view of run command in case of script failures to see executionMessage, output, error: https://aka.ms/runcommandmanaged#get-execution-status-and-results"
                                  }
                                },
                                "tags": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. Tags of the resource."
                                  }
                                }
                              },
                              "variables": {
                                "[string('copy')]": [
                                  {
                                    "name": "protectedParametersArray",
                                    "count": "[[length(items(parameters('protectedParameters')))]",
                                    "input": {
                                      "name": "[[items(parameters('protectedParameters'))[copyIndex('protectedParametersArray')].key]",
                                      "value": "[[items(parameters('protectedParameters'))[copyIndex('protectedParametersArray')].value.value]"
                                    }
                                  }
                                ]
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Compute/virtualMachines/runCommands",
                                  "apiVersion": "2023-03-01",
                                  "name": "[[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                                  "location": "[[parameters('location')]",
                                  "tags": "[[parameters('tags')]",
                                  "properties": {
                                    "asyncExecution": "[[parameters('asyncExecution')]",
                                    "errorBlobManagedIdentity": "[[if(not(empty(parameters('errorBlobManagedIdentity'))), parameters('errorBlobManagedIdentity'), null())]",
                                    "errorBlobUri": "[[if(not(empty(parameters('errorBlobContainerUri'))), format('{0}{1}-error.log', toLower(parameters('errorBlobContainerUri')), parameters('name')), null())]",
                                    "outputBlobManagedIdentity": "[[if(not(empty(parameters('outputBlobManagedIdentity'))), parameters('outputBlobManagedIdentity'), null())]",
                                    "outputBlobUri": "[[if(not(empty(parameters('outputBlobContainerUri'))), format('{0}{1}-output.log', toLower(parameters('outputBlobContainerUri')), parameters('name')), null())]",
                                    "parameters": "[[if(not(empty(parameters('parameters'))), parameters('parameters'), null())]",
                                    "protectedParameters": "[[variables('protectedParametersArray')]",
                                    "runAsPassword": "[[if(not(empty(parameters('runAsPassword'))), parameters('runAsPassword'), null())]",
                                    "runAsUser": "[[if(not(empty(parameters('runAsUser'))), parameters('runAsUser'), null())]",
                                    "source": {
                                      "commandId": "[[if(not(empty(parameters('commandId'))), parameters('commandId'), null())]",
                                      "script": "[[if(not(empty(parameters('script'))), parameters('script'), null())]",
                                      "scriptUri": "[[if(not(empty(parameters('scriptUri'))), parameters('scriptUri'), null())]",
                                      "scriptUriManagedIdentity": "[[if(not(empty(parameters('scriptUriManagedIdentity'))), parameters('scriptUriManagedIdentity'), null())]"
                                    },
                                    "timeoutInSeconds": "[[if(not(equals(parameters('timeoutInSeconds'), -1)), parameters('timeoutInSeconds'), null())]",
                                    "treatFailureAsDeploymentFailure": "[[parameters('treatFailureAsDeploymentFailure')]"
                                  }
                                }
                              ]
                            }
                          }
                        },
                        {
                          "condition": "[[parameters('confidentialVMOSDiskEncryption')]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('RoleAssignment-ConfVMOrchestrator-ReleaseUser-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[variables('keyVaultResourceGroup')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "keyName": {
                                "value": "[[parameters('keyName')]"
                              },
                              "keyVaultName": {
                                "value": "[[variables('keyVaultName')]"
                              },
                              "principalId": {
                                "value": "[[parameters('confidentialVMOrchestratorObjectId')]"
                              },
                              "principalType": {
                                "value": "ServicePrincipal"
                              },
                              "roleDefinitionId": {
                                "value": "[[variables('roleKeyVaultCryptoReleaseUser')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "10428209994367129507"
                                }
                              },
                              "parameters": {
                                "keyVaultName": {
                                  "type": "string"
                                },
                                "principalId": {
                                  "type": "string"
                                },
                                "principalType": {
                                  "type": "string"
                                },
                                "keyName": {
                                  "type": "string"
                                },
                                "roleDefinitionId": {
                                  "type": "string"
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Authorization/roleAssignments",
                                  "apiVersion": "2022-04-01",
                                  "scope": "[[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                                  "name": "[[guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId'))]",
                                  "properties": {
                                    "principalId": "[[parameters('principalId')]",
                                    "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                    "principalType": "[[parameters('principalType')]"
                                  }
                                }
                              ],
                              "outputs": {
                                "roleAssignmentId": {
                                  "type": "string",
                                  "value": "[[extensionResourceId(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId')))]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('deploymentResourceGroupName')), 'Microsoft.Resources/deployments', format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix')))]"
                          ]
                        },
                        {
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "rotationToLatestKeyVersionEnabled": "[[if(parameters('confidentialVMOSDiskEncryption'), createObject('value', false()), createObject('value', true()))]",
                              "name": "[[if(parameters('confidentialVMOSDiskEncryption'), createObject('value', parameters('diskEncryptionSetNames').confidentialVMs), if(equals(variables('diskEncryptionSetEncryptionType'), 'EncryptionAtRestWithCustomerKey'), createObject('value', parameters('diskEncryptionSetNames').customerManaged), createObject('value', parameters('diskEncryptionSetNames').platformAndCustomerManaged)))]",
                              "encryptionType": {
                                "value": "[[variables('diskEncryptionSetEncryptionType')]"
                              },
                              "keyName": {
                                "value": "[[parameters('keyName')]"
                              },
                              "keyVaultResourceId": {
                                "value": "[[parameters('keyVaultResourceId')]"
                              },
                              "systemAssignedIdentity": {
                                "value": true
                              },
                              "tags": {
                                "value": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskEncryptionSets'), createObject()))]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "2742474656852420824"
                                }
                              },
                              "parameters": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The name of the disk encryption set that is being created."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Optional. Resource location."
                                  }
                                },
                                "keyVaultResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Resource ID of the KeyVault containing the key or secret."
                                  }
                                },
                                "keyName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Key URL (with version) pointing to a key or secret in KeyVault."
                                  }
                                },
                                "keyVersion": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, the latest key version is used."
                                  }
                                },
                                "encryptionType": {
                                  "type": "string",
                                  "defaultValue": "EncryptionAtRestWithPlatformAndCustomerKeys",
                                  "allowedValues": [
                                    "ConfidentialVmEncryptedWithCustomerKey",
                                    "EncryptionAtRestWithCustomerKey",
                                    "EncryptionAtRestWithPlatformAndCustomerKeys"
                                  ],
                                  "metadata": {
                                    "description": "Optional. The type of key used to encrypt the data of the disk. For security reasons, it is recommended to set encryptionType to EncryptionAtRestWithPlatformAndCustomerKeys."
                                  }
                                },
                                "federatedClientId": {
                                  "type": "string",
                                  "defaultValue": "None",
                                  "metadata": {
                                    "description": "Optional. Multi-tenant application client ID to access key vault in a different tenant. Setting the value to \"None\" will clear the property."
                                  }
                                },
                                "rotationToLatestKeyVersionEnabled": {
                                  "type": "bool",
                                  "defaultValue": false,
                                  "metadata": {
                                    "description": "Optional. Set this flag to true to enable auto-updating of this disk encryption set to the latest key version."
                                  }
                                },
                                "systemAssignedIdentity": {
                                  "type": "bool",
                                  "defaultValue": true,
                                  "metadata": {
                                    "description": "Conditional. Enables system assigned managed identity on the resource. Required if userAssignedIdentities is empty."
                                  }
                                },
                                "userAssignedIdentities": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Conditional. The ID(s) to assign to the resource. Required if systemAssignedIdentity is set to \"false\"."
                                  }
                                },
                                "tags": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. Tags of the disk encryption resource."
                                  }
                                }
                              },
                              "variables": {
                                "identityType": "[[if(parameters('systemAssignedIdentity'), if(not(empty(parameters('userAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), 'UserAssigned')]",
                                "identity": {
                                  "type": "[[variables('identityType')]",
                                  "userAssignedIdentities": "[[if(not(empty(parameters('userAssignedIdentities'))), parameters('userAssignedIdentities'), null())]"
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Compute/diskEncryptionSets",
                                  "apiVersion": "2023-10-02",
                                  "name": "[[parameters('name')]",
                                  "location": "[[parameters('location')]",
                                  "tags": "[[parameters('tags')]",
                                  "identity": "[[variables('identity')]",
                                  "properties": {
                                    "activeKey": {
                                      "sourceVault": {
                                        "id": "[[parameters('keyVaultResourceId')]"
                                      },
                                      "keyUrl": "[[if(not(empty(parameters('keyVersion'))), format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), '2023-07-01').keyUri, parameters('keyVersion')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), '2023-07-01').keyUriWithVersion)]"
                                    },
                                    "encryptionType": "[[parameters('encryptionType')]",
                                    "federatedClientId": "[[parameters('federatedClientId')]",
                                    "rotationToLatestKeyVersionEnabled": "[[parameters('rotationToLatestKeyVersionEnabled')]"
                                  },
                                  "dependsOn": [
                                    "keyVaultPermissions"
                                  ]
                                },
                                {
                                  "[string('copy')]": {
                                    "name": "keyVaultPermissions",
                                    "count": "[[length(items(parameters('userAssignedIdentities')))]"
                                  },
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('DiskEncrSet-KVPermissions-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                                  "subscriptionId": "[[split(parameters('keyVaultResourceId'), '/')[2]]",
                                  "resourceGroup": "[[split(parameters('keyVaultResourceId'), '/')[4]]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "location": {
                                        "value": "[[parameters('location')]"
                                      },
                                      "keyName": {
                                        "value": "[[parameters('keyName')]"
                                      },
                                      "keyVaultResourceId": {
                                        "value": "[[parameters('keyVaultResourceId')]"
                                      },
                                      "userAssignedIdentityResourceId": {
                                        "value": "[[items(parameters('userAssignedIdentities'))[copyIndex()].key]"
                                      },
                                      "rbacAuthorizationEnabled": {
                                        "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('keyVaultResourceId'), '/'))), '2023-07-01').enableRbacAuthorization]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "17596545792008830237"
                                        }
                                      },
                                      "parameters": {
                                        "rbacAuthorizationEnabled": {
                                          "type": "bool",
                                          "defaultValue": true,
                                          "metadata": {
                                            "description": "Required. A boolean to specify whether or not the used Key Vault has RBAC authentication enabled or not."
                                          }
                                        },
                                        "userAssignedIdentityResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The resourceID of the User Assigned Identity to assign permissions to."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "defaultValue": "[[resourceGroup().location]",
                                          "metadata": {
                                            "description": "Optional. Resource location."
                                          }
                                        },
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the KeyVault containing the key or secret."
                                          }
                                        },
                                        "keyName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Key URL (with version) pointing to a key or secret in KeyVault."
                                          }
                                        }
                                      },
                                      "resources": [
                                        {
                                          "condition": "[[equals(parameters('rbacAuthorizationEnabled'), true())]",
                                          "type": "Microsoft.Authorization/roleAssignments",
                                          "apiVersion": "2022-04-01",
                                          "scope": "[[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName'))]",
                                          "name": "[[guid(format('msi-{0}-{1}-{2}-Key-Reader-RoleAssignment', resourceId('Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), parameters('location'), parameters('userAssignedIdentityResourceId')))]",
                                          "properties": {
                                            "principalId": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location')))), '2025-04-01').outputs.principalId.value]",
                                            "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
                                            "principalType": "ServicePrincipal"
                                          },
                                          "dependsOn": [
                                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location'))))]"
                                          ]
                                        },
                                        {
                                          "type": "Microsoft.Resources/deployments",
                                          "apiVersion": "2025-04-01",
                                          "name": "[[format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location')))]",
                                          "subscriptionId": "[[split(parameters('userAssignedIdentityResourceId'), '/')[2]]",
                                          "resourceGroup": "[[split(parameters('userAssignedIdentityResourceId'), '/')[4]]",
                                          "properties": {
                                            "expressionEvaluationOptions": {
                                              "scope": "inner"
                                            },
                                            "mode": "Incremental",
                                            "parameters": {
                                              "location": {
                                                "value": "[[parameters('location')]"
                                              },
                                              "userAssignedIdentityName": {
                                                "value": "[[last(split(parameters('userAssignedIdentityResourceId'), '/'))]"
                                              }
                                            },
                                            "template": {
                                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                              "contentVersion": "1.0.0.0",
                                              "metadata": {
                                                "_generator": {
                                                  "name": "bicep",
                                                  "version": "0.39.26.7824",
                                                  "templateHash": "14177805491320207633"
                                                }
                                              },
                                              "parameters": {
                                                "userAssignedIdentityName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the User Assigned Identity to fetch the principal ID from."
                                                  }
                                                },
                                                "location": {
                                                  "type": "string",
                                                  "defaultValue": "[[resourceGroup().location]",
                                                  "metadata": {
                                                    "description": "Optional. Resource location."
                                                  }
                                                }
                                              },
                                              "resources": [
                                                {
                                                  "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                                  "apiVersion": "2018-11-30",
                                                  "name": "[[parameters('userAssignedIdentityName')]",
                                                  "location": "[[parameters('location')]"
                                                }
                                              ],
                                              "outputs": {
                                                "principalId": {
                                                  "type": "string",
                                                  "value": "[[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2018-11-30').principalId]"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      ]
                                    }
                                  }
                                }
                              ],
                              "outputs": {
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the disk encryption set."
                                  },
                                  "value": "[[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name'))]"
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the disk encryption set."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource group the disk encryption set was deployed into."
                                  },
                                  "value": "[[resourceGroup().name]"
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The principal ID of the disk encryption set."
                                  },
                                  "value": "[[if(equals(parameters('systemAssignedIdentity'), true()), reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').identity.principalId, '')]"
                                },
                                "identities": {
                                  "type": "object",
                                  "metadata": {
                                    "description": "The idenities of the disk encryption set."
                                  },
                                  "value": "[[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').identity]"
                                },
                                "keyVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the key vault with the disk encryption key."
                                  },
                                  "value": "[[last(split(parameters('keyVaultResourceId'), '/'))]"
                                },
                                "location": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The location the resource was deployed into."
                                  },
                                  "value": "[[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').location]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('deploymentResourceGroupName')), 'Microsoft.Resources/deployments', format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix')))]",
                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('Encryption-Key-{0}', parameters('deploymentSuffix')))]"
                          ]
                        },
                        {
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('RA-DiskEncryptionSet-CryptoServiceEncryptionUser-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[variables('keyVaultResourceGroup')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "keyName": {
                                "value": "[[parameters('keyName')]"
                              },
                              "keyVaultName": {
                                "value": "[[variables('keyVaultName')]"
                              },
                              "principalId": {
                                "value": "[[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.principalId.value]"
                              },
                              "principalType": {
                                "value": "ServicePrincipal"
                              },
                              "roleDefinitionId": {
                                "value": "[[variables('roleKeyVaultCryptoUser')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "10428209994367129507"
                                }
                              },
                              "parameters": {
                                "keyVaultName": {
                                  "type": "string"
                                },
                                "principalId": {
                                  "type": "string"
                                },
                                "principalType": {
                                  "type": "string"
                                },
                                "keyName": {
                                  "type": "string"
                                },
                                "roleDefinitionId": {
                                  "type": "string"
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Authorization/roleAssignments",
                                  "apiVersion": "2022-04-01",
                                  "scope": "[[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                                  "name": "[[guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId'))]",
                                  "properties": {
                                    "principalId": "[[parameters('principalId')]",
                                    "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                    "principalType": "[[parameters('principalType')]"
                                  }
                                }
                              ],
                              "outputs": {
                                "roleAssignmentId": {
                                  "type": "string",
                                  "value": "[[extensionResourceId(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId')))]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix')))]"
                          ]
                        },
                        {
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('Get-DiskEncryptionSet-Crypto-User-RoleAssignment-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[parameters('deploymentResourceGroupName')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "location": {
                                "value": "[[parameters('location')]"
                              },
                              "principalId": {
                                "value": "[[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.principalId.value]"
                              },
                              "resourceIds": {
                                "value": [
                                  "[[format('{0}/keys/{1}', parameters('keyVaultResourceId'), parameters('keyName'))]"
                                ]
                              },
                              "roleDefinitionId": {
                                "value": "[[variables('roleKeyVaultCryptoUser')]"
                              },
                              "runCommandName": {
                                "value": "Get-DiskEncryptionSetCryptoUserRoleAssignment"
                              },
                              "userAssignedIdentityClientId": {
                                "value": "[[parameters('deploymentUserAssignedIdentityClientId')]"
                              },
                              "virtualMachineName": {
                                "value": "[[parameters('deploymentVirtualMachineName')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "1881876003492702290"
                                }
                              },
                              "parameters": {
                                "location": {
                                  "type": "string"
                                },
                                "runCommandName": {
                                  "type": "string"
                                },
                                "principalId": {
                                  "type": "string"
                                },
                                "resourceIds": {
                                  "type": "array"
                                },
                                "roleDefinitionId": {
                                  "type": "string"
                                },
                                "userAssignedIdentityClientId": {
                                  "type": "string",
                                  "defaultValue": ""
                                },
                                "virtualMachineName": {
                                  "type": "string"
                                }
                              },
                              "variables": {
                                "$fxv#0": "param(\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$ResourceManagerUri,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string[]]$ResourceIds,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$UserAssignedIdentityClientId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$PrincipalId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$RoleDefinitionId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n[array]$ResIds = $ResourceIds.replace('\\\"', '\"') | ConvertFrom-Json\r\n\r\nTry {\r\n    # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n    $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n    # Get an access token for Azure resources\r\n    $AzureManagementAccessToken = (Invoke-RestMethod -Headers @{Metadata=\"true\"} -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureManagementHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n    }\r\n\r\n    # Loop through each resource ID to find the role assignment\r\n    Write-Output \"Searching for role assignment for Principal '$PrincipalId' with Role '$RoleDefinitionId' across $($ResIds.Count) resource(s)\"\r\n    \r\n    $StartTime = Get-Date\r\n    $TimeoutSeconds = 120\r\n    $FoundRoleAssignments = @{}\r\n    $Attempt = 1\r\n\r\n    do {\r\n        Write-Output \"Attempt $Attempt - Checking for role assignment across all resources...\"\r\n        \r\n        foreach ($ResourceId in $ResIds) {\r\n            # Skip if we already found the role assignment for this resource\r\n            if ($FoundRoleAssignments.ContainsKey($ResourceId)) {\r\n                continue\r\n            }\r\n            \r\n            Write-Output \"  Checking resource id: $ResourceId\"\r\n            \r\n            # Construct the API URL for role assignments for the specific resource\r\n            $RoleAssignmentsUri = $ResourceManagerUriFixed + $ResourceId + '/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01'\r\n            \r\n            try {\r\n                # Query role assignments for the resource\r\n                $RoleAssignments = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'GET' -Uri $RoleAssignmentsUri\r\n\r\n                # Look for the specific role assignment matching both PrincipalId and RoleDefinitionId\r\n                $TargetRoleAssignment = $RoleAssignments.value.properties | Where-Object { \r\n                    $_.principalId -eq $PrincipalId -and \r\n                    $_.roleDefinitionId -eq $RoleDefinitionId \r\n                }\r\n\r\n                if ($TargetRoleAssignment) {\r\n                    $FoundRoleAssignments[$ResourceId] = $TargetRoleAssignment\r\n                    Write-Output \"  Role assignment found on resource id '$ResourceId'\"\r\n                } else {\r\n                    Write-Output \"  Role assignment not found on resource id '$ResourceId'\"\r\n                }\r\n            }\r\n            catch {\r\n                Write-Warning \"  Failed to query role assignments for resource id '$ResourceId': $($_.Exception.Message)\"\r\n                continue\r\n            }\r\n        }\r\n        $ElapsedTime = (Get-Date) - $StartTime\r\n        # Check if we found role assignments for all resources\r\n        $AllResourcesHaveAssignment = $FoundRoleAssignments.Count -eq $ResIds.Count\r\n        \r\n        if ($AllResourcesHaveAssignment) {\r\n            Write-Output \"Role assignment found on all $($ResIds.Count) resources after $($ElapsedTime.TotalSeconds) seconds.\"\r\n            break\r\n        }\r\n\r\n        if ($ElapsedTime.TotalSeconds -ge $TimeoutSeconds) {\r\n            break\r\n        }\r\n\r\n        $MissingCount = $ResIds.Count - $FoundRoleAssignments.Count\r\n        Write-Output \"Role assignment found on $($FoundRoleAssignments.Count)/$($ResIds.Count) resources. Still missing $MissingCount. Waiting 5 seconds before retry...\"\r\n        Start-Sleep -Seconds 5\r\n        $Attempt++\r\n    } while ($ElapsedTime.TotalSeconds -lt $TimeoutSeconds)\r\n\r\n    if ($FoundRoleAssignments.Count -eq 0) {\r\n        Write-Warning \"Role assignment not found on any resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId', Resources checked: $($ResIds -join ', ')\"\r\n    } elseif ($FoundRoleAssignments.Count -lt $ResIds.Count) {\r\n        $MissingResources = $ResIds | Where-Object { -not $FoundRoleAssignments.ContainsKey($_) }\r\n        Write-Warning \"Role assignment not found on all resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId'. Missing on resources: $($MissingResources -join ', ')\"\r\n    }\r\n}\r\ncatch {\r\n    Write-Error \"Error querying role assignments: $($_.Exception.Message)\"\r\n    throw $($_.Exception.Message)\r\n}\r\n"
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Compute/virtualMachines/runCommands",
                                  "apiVersion": "2023-03-01",
                                  "name": "[[format('{0}/{1}', parameters('virtualMachineName'), parameters('runCommandName'))]",
                                  "location": "[[parameters('location')]",
                                  "properties": {
                                    "asyncExecution": false,
                                    "parameters": [
                                      {
                                        "name": "ResourceManagerUri",
                                        "value": "[[environment().resourceManager]"
                                      },
                                      {
                                        "name": "ResourceIds",
                                        "value": "[[string(parameters('resourceIds'))]"
                                      },
                                      {
                                        "name": "UserAssignedIdentityClientId",
                                        "value": "[[parameters('userAssignedIdentityClientId')]"
                                      },
                                      {
                                        "name": "PrincipalId",
                                        "value": "[[parameters('principalId')]"
                                      },
                                      {
                                        "name": "RoleDefinitionId",
                                        "value": "[[subscriptionResourceId('microsoft.authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                                      }
                                    ],
                                    "source": {
                                      "script": "[[variables('$fxv#0')]"
                                    },
                                    "timeoutInSeconds": 180,
                                    "treatFailureAsDeploymentFailure": false
                                  }
                                }
                              ]
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix')))]",
                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('RA-DiskEncryptionSet-CryptoServiceEncryptionUser-{0}', parameters('deploymentSuffix')))]"
                          ]
                        },
                        {
                          "condition": "[[parameters('confidentialVMOSDiskEncryption')]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('Get-DiskEncryptionSet-CryptoReleaseUser-RoleAssignment-{0}', parameters('deploymentSuffix'))]",
                          "resourceGroup": "[[parameters('deploymentResourceGroupName')]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "location": {
                                "value": "[[parameters('location')]"
                              },
                              "principalId": {
                                "value": "[[parameters('confidentialVMOrchestratorObjectId')]"
                              },
                              "resourceIds": {
                                "value": [
                                  "[[format('{0}/keys/{1}', parameters('keyVaultResourceId'), parameters('keyName'))]"
                                ]
                              },
                              "roleDefinitionId": {
                                "value": "[[variables('roleKeyVaultCryptoReleaseUser')]"
                              },
                              "runCommandName": {
                                "value": "Get-DiskEncryptionSetCryptoReleaseUserRoleAssignment"
                              },
                              "userAssignedIdentityClientId": {
                                "value": "[[parameters('deploymentUserAssignedIdentityClientId')]"
                              },
                              "virtualMachineName": {
                                "value": "[[parameters('deploymentVirtualMachineName')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "1881876003492702290"
                                }
                              },
                              "parameters": {
                                "location": {
                                  "type": "string"
                                },
                                "runCommandName": {
                                  "type": "string"
                                },
                                "principalId": {
                                  "type": "string"
                                },
                                "resourceIds": {
                                  "type": "array"
                                },
                                "roleDefinitionId": {
                                  "type": "string"
                                },
                                "userAssignedIdentityClientId": {
                                  "type": "string",
                                  "defaultValue": ""
                                },
                                "virtualMachineName": {
                                  "type": "string"
                                }
                              },
                              "variables": {
                                "$fxv#0": "param(\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$ResourceManagerUri,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string[]]$ResourceIds,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$UserAssignedIdentityClientId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$PrincipalId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$RoleDefinitionId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n[array]$ResIds = $ResourceIds.replace('\\\"', '\"') | ConvertFrom-Json\r\n\r\nTry {\r\n    # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n    $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n    # Get an access token for Azure resources\r\n    $AzureManagementAccessToken = (Invoke-RestMethod -Headers @{Metadata=\"true\"} -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureManagementHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n    }\r\n\r\n    # Loop through each resource ID to find the role assignment\r\n    Write-Output \"Searching for role assignment for Principal '$PrincipalId' with Role '$RoleDefinitionId' across $($ResIds.Count) resource(s)\"\r\n    \r\n    $StartTime = Get-Date\r\n    $TimeoutSeconds = 120\r\n    $FoundRoleAssignments = @{}\r\n    $Attempt = 1\r\n\r\n    do {\r\n        Write-Output \"Attempt $Attempt - Checking for role assignment across all resources...\"\r\n        \r\n        foreach ($ResourceId in $ResIds) {\r\n            # Skip if we already found the role assignment for this resource\r\n            if ($FoundRoleAssignments.ContainsKey($ResourceId)) {\r\n                continue\r\n            }\r\n            \r\n            Write-Output \"  Checking resource id: $ResourceId\"\r\n            \r\n            # Construct the API URL for role assignments for the specific resource\r\n            $RoleAssignmentsUri = $ResourceManagerUriFixed + $ResourceId + '/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01'\r\n            \r\n            try {\r\n                # Query role assignments for the resource\r\n                $RoleAssignments = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'GET' -Uri $RoleAssignmentsUri\r\n\r\n                # Look for the specific role assignment matching both PrincipalId and RoleDefinitionId\r\n                $TargetRoleAssignment = $RoleAssignments.value.properties | Where-Object { \r\n                    $_.principalId -eq $PrincipalId -and \r\n                    $_.roleDefinitionId -eq $RoleDefinitionId \r\n                }\r\n\r\n                if ($TargetRoleAssignment) {\r\n                    $FoundRoleAssignments[$ResourceId] = $TargetRoleAssignment\r\n                    Write-Output \"  Role assignment found on resource id '$ResourceId'\"\r\n                } else {\r\n                    Write-Output \"  Role assignment not found on resource id '$ResourceId'\"\r\n                }\r\n            }\r\n            catch {\r\n                Write-Warning \"  Failed to query role assignments for resource id '$ResourceId': $($_.Exception.Message)\"\r\n                continue\r\n            }\r\n        }\r\n        $ElapsedTime = (Get-Date) - $StartTime\r\n        # Check if we found role assignments for all resources\r\n        $AllResourcesHaveAssignment = $FoundRoleAssignments.Count -eq $ResIds.Count\r\n        \r\n        if ($AllResourcesHaveAssignment) {\r\n            Write-Output \"Role assignment found on all $($ResIds.Count) resources after $($ElapsedTime.TotalSeconds) seconds.\"\r\n            break\r\n        }\r\n\r\n        if ($ElapsedTime.TotalSeconds -ge $TimeoutSeconds) {\r\n            break\r\n        }\r\n\r\n        $MissingCount = $ResIds.Count - $FoundRoleAssignments.Count\r\n        Write-Output \"Role assignment found on $($FoundRoleAssignments.Count)/$($ResIds.Count) resources. Still missing $MissingCount. Waiting 5 seconds before retry...\"\r\n        Start-Sleep -Seconds 5\r\n        $Attempt++\r\n    } while ($ElapsedTime.TotalSeconds -lt $TimeoutSeconds)\r\n\r\n    if ($FoundRoleAssignments.Count -eq 0) {\r\n        Write-Warning \"Role assignment not found on any resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId', Resources checked: $($ResIds -join ', ')\"\r\n    } elseif ($FoundRoleAssignments.Count -lt $ResIds.Count) {\r\n        $MissingResources = $ResIds | Where-Object { -not $FoundRoleAssignments.ContainsKey($_) }\r\n        Write-Warning \"Role assignment not found on all resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId'. Missing on resources: $($MissingResources -join ', ')\"\r\n    }\r\n}\r\ncatch {\r\n    Write-Error \"Error querying role assignments: $($_.Exception.Message)\"\r\n    throw $($_.Exception.Message)\r\n}\r\n"
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Compute/virtualMachines/runCommands",
                                  "apiVersion": "2023-03-01",
                                  "name": "[[format('{0}/{1}', parameters('virtualMachineName'), parameters('runCommandName'))]",
                                  "location": "[[parameters('location')]",
                                  "properties": {
                                    "asyncExecution": false,
                                    "parameters": [
                                      {
                                        "name": "ResourceManagerUri",
                                        "value": "[[environment().resourceManager]"
                                      },
                                      {
                                        "name": "ResourceIds",
                                        "value": "[[string(parameters('resourceIds'))]"
                                      },
                                      {
                                        "name": "UserAssignedIdentityClientId",
                                        "value": "[[parameters('userAssignedIdentityClientId')]"
                                      },
                                      {
                                        "name": "PrincipalId",
                                        "value": "[[parameters('principalId')]"
                                      },
                                      {
                                        "name": "RoleDefinitionId",
                                        "value": "[[subscriptionResourceId('microsoft.authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                                      }
                                    ],
                                    "source": {
                                      "script": "[[variables('$fxv#0')]"
                                    },
                                    "timeoutInSeconds": 180,
                                    "treatFailureAsDeploymentFailure": false
                                  }
                                }
                              ]
                            }
                          },
                          "dependsOn": [
                            "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('RoleAssignment-ConfVMOrchestrator-ReleaseUser-{0}', parameters('deploymentSuffix')))]"
                          ]
                        }
                      ],
                      "outputs": {
                        "diskEncryptionSetResourceId": {
                          "type": "string",
                          "value": "[[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value]"
                        }
                      }
                    }
                  }
                },
                {
                  "condition": "[[not(empty(parameters('artifactsUserAssignedIdentityResourceId')))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('ArtifactsUserAssignedIdentity-{0}', parameters('deploymentSuffix'))]",
                  "location": "[[deployment().location]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "userAssignedIdentityResourceId": {
                        "value": "[[parameters('artifactsUserAssignedIdentityResourceId')]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "9499094482521677147"
                        }
                      },
                      "parameters": {
                        "userAssignedIdentityResourceId": {
                          "type": "string"
                        }
                      },
                      "resources": [],
                      "outputs": {
                        "clientId": {
                          "type": "string",
                          "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(parameters('userAssignedIdentityResourceId'), '/'))), '2018-11-30').clientId]"
                        },
                        "principalId": {
                          "type": "string",
                          "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(parameters('userAssignedIdentityResourceId'), '/'))), '2018-11-30').principalId]"
                        }
                      }
                    }
                  }
                },
                {
                  "[string('copy')]": {
                    "name": "availabilitySets",
                    "count": "[[length(range(0, parameters('availabilitySetsCount')))]"
                  },
                  "condition": "[[and(parameters('pooledHostPool'), equals(parameters('availability'), 'AvailabilitySets'))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('{0}{1}-{2}', parameters('availabilitySetNamePrefix'), padLeft(add(range(0, parameters('availabilitySetsCount'))[copyIndex()], parameters('availabilitySetsIndex')), 2, '0'), parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "name": {
                        "value": "[[format('{0}{1}', parameters('availabilitySetNamePrefix'), padLeft(add(range(0, parameters('availabilitySetsCount'))[copyIndex()], parameters('availabilitySetsIndex')), 2, '0'))]"
                      },
                      "platformFaultDomainCount": {
                        "value": 2
                      },
                      "platformUpdateDomainCount": {
                        "value": 5
                      },
                      "proximityPlacementGroupResourceId": {
                        "value": ""
                      },
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "skuName": {
                        "value": "Aligned"
                      },
                      "tags": {
                        "value": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/availabilitySets'), createObject()))]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "3553316518590342751"
                        },
                        "name": "Availability Sets",
                        "description": "This module deploys an Availability Set.",
                        "owner": "Azure/module-maintainers"
                      },
                      "parameters": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The name of the availability set that is being created."
                          }
                        },
                        "platformFaultDomainCount": {
                          "type": "int",
                          "defaultValue": 2,
                          "metadata": {
                            "description": "Optional. The number of fault domains to use."
                          }
                        },
                        "platformUpdateDomainCount": {
                          "type": "int",
                          "defaultValue": 5,
                          "metadata": {
                            "description": "Optional. The number of update domains to use."
                          }
                        },
                        "skuName": {
                          "type": "string",
                          "defaultValue": "Aligned",
                          "metadata": {
                            "description": "Optional. SKU of the availability set.</p>- Use 'Aligned' for virtual machines with managed disks.</p>- Use 'Classic' for virtual machines with unmanaged disks."
                          }
                        },
                        "proximityPlacementGroupResourceId": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. Resource ID of a proximity placement group."
                          }
                        },
                        "location": {
                          "type": "string",
                          "defaultValue": "[[resourceGroup().location]",
                          "metadata": {
                            "description": "Optional. Resource location."
                          }
                        },
                        "tags": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. Tags of the availability set resource."
                          }
                        }
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Compute/availabilitySets",
                          "apiVersion": "2022-11-01",
                          "name": "[[parameters('name')]",
                          "location": "[[parameters('location')]",
                          "tags": "[[parameters('tags')]",
                          "properties": {
                            "platformFaultDomainCount": "[[parameters('platformFaultDomainCount')]",
                            "platformUpdateDomainCount": "[[parameters('platformUpdateDomainCount')]",
                            "proximityPlacementGroup": "[[if(not(empty(parameters('proximityPlacementGroupResourceId'))), createObject('id', parameters('proximityPlacementGroupResourceId')), null())]"
                          },
                          "sku": {
                            "name": "[[parameters('skuName')]"
                          }
                        }
                      ],
                      "outputs": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "The name of the availability set."
                          },
                          "value": "[[parameters('name')]"
                        },
                        "resourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "The resource ID of the availability set."
                          },
                          "value": "[[resourceId('Microsoft.Compute/availabilitySets', parameters('name'))]"
                        },
                        "resourceGroupName": {
                          "type": "string",
                          "metadata": {
                            "description": "The resource group the availability set was deployed into."
                          },
                          "value": "[[resourceGroup().name]"
                        },
                        "location": {
                          "type": "string",
                          "metadata": {
                            "description": "The location the resource was deployed into."
                          },
                          "value": "[[reference(resourceId('Microsoft.Compute/availabilitySets', parameters('name')), '2022-11-01', 'full').location]"
                        }
                      }
                    }
                  }
                },
                {
                  "[string('copy')]": {
                    "name": "localNetAppVolumes",
                    "count": "[[length(range(0, length(variables('sortedLocalNetAppResourceIds'))))]"
                  },
                  "condition": "[[not(empty(variables('sortedLocalNetAppResourceIds')))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('LocalNetAppVolumes-{0}-{1}', range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()], parameters('deploymentSuffix'))]",
                  "location": "[[deployment().location]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "netAppVolumeResourceId": {
                        "value": "[[variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "5461462028360552444"
                        }
                      },
                      "parameters": {
                        "netAppVolumeResourceId": {
                          "type": "string"
                        }
                      },
                      "resources": [],
                      "outputs": {
                        "smbServerFqdn": {
                          "type": "string",
                          "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('netAppVolumeResourceId'), '/')[2], split(parameters('netAppVolumeResourceId'), '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(parameters('netAppVolumeResourceId'), '/')[8], split(parameters('netAppVolumeResourceId'), '/')[10], last(split(parameters('netAppVolumeResourceId'), '/'))), '2023-11-01').mountTargets[0].smbServerFqdn]"
                        }
                      }
                    }
                  }
                },
                {
                  "[string('copy')]": {
                    "name": "remoteNetAppVolumes",
                    "count": "[[length(range(0, length(variables('sortedRemoteNetAppResourceIds'))))]"
                  },
                  "condition": "[[not(empty(variables('sortedRemoteNetAppResourceIds')))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('RemoteNetAppVolumes-{0}-{1}', range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()], parameters('deploymentSuffix'))]",
                  "location": "[[deployment().location]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "netAppVolumeResourceId": {
                        "value": "[[variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "5461462028360552444"
                        }
                      },
                      "parameters": {
                        "netAppVolumeResourceId": {
                          "type": "string"
                        }
                      },
                      "resources": [],
                      "outputs": {
                        "smbServerFqdn": {
                          "type": "string",
                          "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('netAppVolumeResourceId'), '/')[2], split(parameters('netAppVolumeResourceId'), '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(parameters('netAppVolumeResourceId'), '/')[8], split(parameters('netAppVolumeResourceId'), '/')[10], last(split(parameters('netAppVolumeResourceId'), '/'))), '2023-11-01').mountTargets[0].smbServerFqdn]"
                        }
                      }
                    }
                  }
                },
                {
                  "[string('copy')]": {
                    "name": "virtualMachines",
                    "count": "[[length(range(1, parameters('sessionHostBatchCount')))]",
                    "mode": "serial",
                    "batchSize": 5
                  },
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('VirtualMachines-Batch-{0}-{1}', sub(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "artifactsContainerUri": {
                        "value": "[[parameters('artifactsContainerUri')]"
                      },
                      "artifactsUserAssignedIdentityResourceId": {
                        "value": "[[parameters('artifactsUserAssignedIdentityResourceId')]"
                      },
                      "artifactsUserAssignedIdentityClientId": "[[if(empty(parameters('artifactsUserAssignedIdentityResourceId')), createObject('value', ''), createObject('value', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('ArtifactsUserAssignedIdentity-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.clientId.value))]",
                      "availability": {
                        "value": "[[parameters('availability')]"
                      },
                      "availabilityZones": {
                        "value": "[[parameters('availabilityZones')]"
                      },
                      "availabilitySetNamePrefix": {
                        "value": "[[parameters('availabilitySetNamePrefix')]"
                      },
                      "avdInsightsDataCollectionRulesResourceId": {
                        "value": "[[parameters('avdInsightsDataCollectionRulesResourceId')]"
                      },
                      "confidentialVMOSDiskEncryptionType": {
                        "value": "[[variables('confidentialVMOSDiskEncryptionType')]"
                      },
                      "customImageResourceId": {
                        "value": "[[parameters('customImageResourceId')]"
                      },
                      "dataCollectionEndpointResourceId": {
                        "value": "[[parameters('dataCollectionEndpointResourceId')]"
                      },
                      "dedicatedHostGroupResourceId": {
                        "value": "[[parameters('dedicatedHostGroupResourceId')]"
                      },
                      "dedicatedHostGroupZones": {
                        "value": "[[parameters('dedicatedHostGroupZones')]"
                      },
                      "dedicatedHostResourceId": {
                        "value": "[[parameters('dedicatedHostResourceId')]"
                      },
                      "diskAccessId": "[[if(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), if(parameters('deployDiskAccessResource'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value), createObject('value', '')), createObject('value', parameters('existingDiskAccessResourceId')))]",
                      "diskEncryptionSetResourceId": "[[if(and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(equals(parameters('keyManagementDisks'), 'PlatformManaged'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value), if(not(empty(parameters('existingDiskEncryptionSetResourceId'))), createObject('value', parameters('existingDiskEncryptionSetResourceId')), createObject('value', '')))]",
                      "diskSizeGB": {
                        "value": "[[parameters('diskSizeGB')]"
                      },
                      "diskSku": {
                        "value": "[[parameters('diskSku')]"
                      },
                      "domainJoinUserPassword": {
                        "value": "[[parameters('domainJoinUserPassword')]"
                      },
                      "domainJoinUserPrincipalName": {
                        "value": "[[parameters('domainJoinUserPrincipalName')]"
                      },
                      "domainName": {
                        "value": "[[parameters('domainName')]"
                      },
                      "enableAcceleratedNetworking": {
                        "value": "[[parameters('enableAcceleratedNetworking')]"
                      },
                      "enableMonitoring": {
                        "value": "[[parameters('enableMonitoring')]"
                      },
                      "encryptionAtHost": {
                        "value": "[[parameters('encryptionAtHost')]"
                      },
                      "fslogixConfigureSessionHosts": {
                        "value": "[[parameters('fslogixConfigureSessionHosts')]"
                      },
                      "fslogixContainerType": {
                        "value": "[[parameters('fslogixContainerType')]"
                      },
                      "fslogixFileShareNames": {
                        "value": "[[parameters('fslogixFileShareNames')]"
                      },
                      "fslogixOSSGroups": {
                        "value": "[[parameters('fslogixOSSGroups')]"
                      },
                      "fslogixLocalNetAppServerFqdns": {
                        "[string('copy')]": [
                          {
                            "name": "value",
                            "count": "[[length(range(0, length(variables('sortedLocalNetAppResourceIds'))))]",
                            "input": "[[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('LocalNetAppVolumes-{0}-{1}', range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex('value')]], parameters('deploymentSuffix'))), '2025-04-01').outputs.smbServerFqdn.value]"
                          }
                        ]
                      },
                      "fslogixLocalStorageAccountResourceIds": {
                        "value": "[[parameters('fslogixLocalStorageAccountResourceIds')]"
                      },
                      "fslogixRemoteNetAppServerFqdns": {
                        "[string('copy')]": [
                          {
                            "name": "value",
                            "count": "[[length(range(0, length(variables('sortedRemoteNetAppResourceIds'))))]",
                            "input": "[[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('RemoteNetAppVolumes-{0}-{1}', range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex('value')]], parameters('deploymentSuffix'))), '2025-04-01').outputs.smbServerFqdn.value]"
                          }
                        ]
                      },
                      "fslogixRemoteStorageAccountResourceIds": {
                        "value": "[[parameters('fslogixRemoteStorageAccountResourceIds')]"
                      },
                      "fslogixSizeInMBs": {
                        "value": "[[parameters('fslogixSizeInMBs')]"
                      },
                      "fslogixStorageService": {
                        "value": "[[parameters('fslogixStorageService')]"
                      },
                      "hibernationEnabled": {
                        "value": "[[parameters('hibernationEnabled')]"
                      },
                      "hostPoolResourceId": "[[if(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), createObject('value', parameters('hostPoolResourceId')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value))]",
                      "identitySolution": {
                        "value": "[[parameters('identitySolution')]"
                      },
                      "imageOffer": {
                        "value": "[[parameters('imageOffer')]"
                      },
                      "imagePublisher": {
                        "value": "[[parameters('imagePublisher')]"
                      },
                      "imageSku": {
                        "value": "[[parameters('imageSku')]"
                      },
                      "integrityMonitoring": {
                        "value": "[[parameters('integrityMonitoring')]"
                      },
                      "intuneEnrollment": {
                        "value": "[[parameters('intuneEnrollment')]"
                      },
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "networkInterfaceNameConv": {
                        "value": "[[parameters('networkInterfaceNameConv')]"
                      },
                      "osDiskNameConv": {
                        "value": "[[parameters('osDiskNameConv')]"
                      },
                      "ouPath": {
                        "value": "[[parameters('ouPath')]"
                      },
                      "sessionHostCustomizations": {
                        "value": "[[parameters('sessionHostCustomizations')]"
                      },
                      "securityDataCollectionRulesResourceId": {
                        "value": "[[parameters('securityDataCollectionRulesResourceId')]"
                      },
                      "secureBootEnabled": {
                        "value": "[[parameters('secureBootEnabled')]"
                      },
                      "securityType": {
                        "value": "[[parameters('securityType')]"
                      },
                      "sessionHostCount": "[[if(and(equals(range(1, parameters('sessionHostBatchCount'))[copyIndex()], parameters('sessionHostBatchCount')), greater(parameters('divisionRemainderValue'), 0)), createObject('value', parameters('divisionRemainderValue')), createObject('value', parameters('maxResourcesPerTemplateDeployment')))]",
                      "sessionHostIndex": "[[if(equals(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), createObject('value', parameters('sessionHostIndex')), createObject('value', add(mul(sub(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), parameters('maxResourcesPerTemplateDeployment')), parameters('sessionHostIndex'))))]",
                      "vmNameIndexLength": {
                        "value": "[[parameters('vmNameIndexLength')]"
                      },
                      "sessionHostRegistrationDSCUrl": {
                        "value": "[[parameters('sessionHostRegistrationDSCUrl')]"
                      },
                      "storageSuffix": {
                        "value": "[[parameters('storageSuffix')]"
                      },
                      "subnetResourceId": {
                        "value": "[[parameters('subnetResourceId')]"
                      },
                      "tags": {
                        "value": "[[parameters('tags')]"
                      },
                      "deploymentSuffix": {
                        "value": "[[parameters('deploymentSuffix')]"
                      },
                      "timeZone": {
                        "value": "[[parameters('timeZone')]"
                      },
                      "useAgentDownloadEndpoint": {
                        "value": "[[parameters('useAgentDownloadEndpoint')]"
                      },
                      "virtualMachineAdminPassword": {
                        "value": "[[parameters('virtualMachineAdminPassword')]"
                      },
                      "virtualMachineAdminUserName": {
                        "value": "[[parameters('virtualMachineAdminUserName')]"
                      },
                      "virtualMachineNameConv": {
                        "value": "[[parameters('virtualMachineNameConv')]"
                      },
                      "virtualMachineNamePrefix": {
                        "value": "[[parameters('virtualMachineNamePrefix')]"
                      },
                      "virtualMachineSize": {
                        "value": "[[parameters('virtualMachineSize')]"
                      },
                      "vmInsightsDataCollectionRulesResourceId": {
                        "value": "[[parameters('vmInsightsDataCollectionRulesResourceId')]"
                      },
                      "vTpmEnabled": {
                        "value": "[[parameters('vTpmEnabled')]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "11520740710202557766"
                        }
                      },
                      "parameters": {
                        "artifactsContainerUri": {
                          "type": "string"
                        },
                        "artifactsUserAssignedIdentityClientId": {
                          "type": "string"
                        },
                        "artifactsUserAssignedIdentityResourceId": {
                          "type": "string"
                        },
                        "availability": {
                          "type": "string"
                        },
                        "availabilitySetNamePrefix": {
                          "type": "string"
                        },
                        "availabilityZones": {
                          "type": "array"
                        },
                        "avdInsightsDataCollectionRulesResourceId": {
                          "type": "string"
                        },
                        "confidentialVMOSDiskEncryptionType": {
                          "type": "string"
                        },
                        "customImageResourceId": {
                          "type": "string"
                        },
                        "dataCollectionEndpointResourceId": {
                          "type": "string"
                        },
                        "dedicatedHostGroupResourceId": {
                          "type": "string"
                        },
                        "dedicatedHostGroupZones": {
                          "type": "array"
                        },
                        "dedicatedHostResourceId": {
                          "type": "string"
                        },
                        "diskAccessId": {
                          "type": "string"
                        },
                        "diskEncryptionSetResourceId": {
                          "type": "string"
                        },
                        "diskSizeGB": {
                          "type": "int"
                        },
                        "diskSku": {
                          "type": "string"
                        },
                        "domainJoinUserPassword": {
                          "type": "securestring"
                        },
                        "domainJoinUserPrincipalName": {
                          "type": "securestring"
                        },
                        "domainName": {
                          "type": "string"
                        },
                        "enableAcceleratedNetworking": {
                          "type": "bool"
                        },
                        "enableMonitoring": {
                          "type": "bool"
                        },
                        "encryptionAtHost": {
                          "type": "bool"
                        },
                        "fslogixConfigureSessionHosts": {
                          "type": "bool"
                        },
                        "fslogixContainerType": {
                          "type": "string"
                        },
                        "fslogixFileShareNames": {
                          "type": "array"
                        },
                        "fslogixLocalNetAppServerFqdns": {
                          "type": "array"
                        },
                        "fslogixLocalStorageAccountResourceIds": {
                          "type": "array"
                        },
                        "fslogixOSSGroups": {
                          "type": "array"
                        },
                        "fslogixRemoteNetAppServerFqdns": {
                          "type": "array"
                        },
                        "fslogixRemoteStorageAccountResourceIds": {
                          "type": "array"
                        },
                        "fslogixSizeInMBs": {
                          "type": "int"
                        },
                        "fslogixStorageService": {
                          "type": "string"
                        },
                        "hibernationEnabled": {
                          "type": "bool"
                        },
                        "hostPoolResourceId": {
                          "type": "string"
                        },
                        "identitySolution": {
                          "type": "string"
                        },
                        "imageOffer": {
                          "type": "string"
                        },
                        "imagePublisher": {
                          "type": "string"
                        },
                        "imageSku": {
                          "type": "string"
                        },
                        "integrityMonitoring": {
                          "type": "bool"
                        },
                        "intuneEnrollment": {
                          "type": "bool"
                        },
                        "location": {
                          "type": "string"
                        },
                        "networkInterfaceNameConv": {
                          "type": "string"
                        },
                        "osDiskNameConv": {
                          "type": "string"
                        },
                        "ouPath": {
                          "type": "string"
                        },
                        "sessionHostCustomizations": {
                          "type": "array"
                        },
                        "sessionHostCount": {
                          "type": "int"
                        },
                        "sessionHostIndex": {
                          "type": "int"
                        },
                        "vmNameIndexLength": {
                          "type": "int"
                        },
                        "sessionHostRegistrationDSCUrl": {
                          "type": "string"
                        },
                        "securityDataCollectionRulesResourceId": {
                          "type": "string"
                        },
                        "securityType": {
                          "type": "string"
                        },
                        "secureBootEnabled": {
                          "type": "bool"
                        },
                        "storageSuffix": {
                          "type": "string"
                        },
                        "subnetResourceId": {
                          "type": "string"
                        },
                        "tags": {
                          "type": "object"
                        },
                        "deploymentSuffix": {
                          "type": "string"
                        },
                        "timeZone": {
                          "type": "string"
                        },
                        "useAgentDownloadEndpoint": {
                          "type": "bool"
                        },
                        "virtualMachineAdminPassword": {
                          "type": "securestring"
                        },
                        "virtualMachineAdminUserName": {
                          "type": "securestring"
                        },
                        "virtualMachineNameConv": {
                          "type": "string"
                        },
                        "virtualMachineNamePrefix": {
                          "type": "string"
                        },
                        "virtualMachineSize": {
                          "type": "string"
                        },
                        "vmInsightsDataCollectionRulesResourceId": {
                          "type": "string"
                        },
                        "vTpmEnabled": {
                          "type": "bool"
                        }
                      },
                      "variables": {
                        "[string('copy')]": [
                          {
                            "name": "fslogixLocalStorageAccountNames",
                            "count": "[[length(parameters('fslogixLocalStorageAccountResourceIds'))]",
                            "input": "[[last(split(parameters('fslogixLocalStorageAccountResourceIds')[copyIndex('fslogixLocalStorageAccountNames')], '/'))]"
                          },
                          {
                            "name": "fslogixRemoteStorageAccountNames",
                            "count": "[[length(parameters('fslogixRemoteStorageAccountResourceIds'))]",
                            "input": "[[last(split(parameters('fslogixRemoteStorageAccountResourceIds')[copyIndex('fslogixRemoteStorageAccountNames')], '/'))]"
                          },
                          {
                            "name": "fslogixLocalSANameMinus2",
                            "count": "[[length(variables('fslogixLocalStorageAccountNames'))]",
                            "input": "[[take(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')], sub(length(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')]), 2))]"
                          },
                          {
                            "name": "fslogixRemoteSANameMinus2",
                            "count": "[[length(variables('fslogixRemoteStorageAccountNames'))]",
                            "input": "[[take(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')], sub(length(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')]), 2))]"
                          },
                          {
                            "name": "fslogixExclusionsOfficeArray",
                            "count": "[[length(variables('fslogixOfficeVHDXs'))]",
                            "input": "[[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')])]"
                          },
                          {
                            "name": "fslogixExclusionProfileArray",
                            "count": "[[length(variables('fslogixProfileVHDXs'))]",
                            "input": "[[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')])]"
                          }
                        ],
                        "$fxv#0": "[CmdletBinding(SupportsShouldProcess = $true)]\r\nparam (\r\n    [string]$AmdVmSize,\r\n    [string]$NvidiaVmSize,\r\n    [string]$DisableUpdates,\r\n    [string]$ConfigureFSLogix,\r\n    [string]$CloudCache = 'false',\r\n    [string]$IdentitySolution,\r\n    [string]$LocalNetAppServers,\r\n    [string]$LocalStorageAccountNames,\r\n    [string]$LocalStorageAccountKeys,\r\n    [string]$OSSGroups,\r\n    [string]$RemoteNetAppServers,\r\n    [string]$RemoteStorageAccountNames,\r\n    [string]$RemoteStorageAccountKeys,\r\n    [string]$Shares,\r\n    [string]$SizeInMBs,\r\n    [string]$StorageAccountDNSSuffix,\r\n    [string]$StorageService,\r\n    [string]$TimeZone\r\n)\r\n\r\n#region Functions\r\n\r\nfunction New-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $true, Position = 0)]\r\n        [string] $Path\r\n    )\r\n\r\n    $date = Get-Date -UFormat \"%Y-%m-%d %H-%M-%S\"\r\n    Set-Variable logFile -Scope Script\r\n    $script:logFile = \"$Script:Name-$date.log\"\r\n\r\n    if ((Test-Path $path ) -eq $false) {\r\n        $null = New-Item -Path $path -type directory\r\n    }\r\n\r\n    $script:Log = Join-Path $path $logfile\r\n\r\n    Add-Content $script:Log \"Date`t`t`tCategory`t`tDetails\"\r\n}\r\n\r\nfunction Write-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $false, Position = 0)]\r\n        [ValidateSet(\"Info\", \"Warning\", \"Error\")]\r\n        $Category = 'Info',\r\n        [Parameter(Mandatory = $true, Position = 1)]\r\n        $Message\r\n    )\r\n\r\n    $Date = get-date\r\n    $Content = \"[$Date]`t$Category`t`t$Message`n\" \r\n    Add-Content $Script:Log $content -ErrorAction Stop\r\n    If ($Verbose) {\r\n        Write-Verbose $Content\r\n    }\r\n    Else {\r\n        Switch ($Category) {\r\n            'Info' { Write-Host $content }\r\n            'Error' { Write-Error $Content }\r\n            'Warning' { Write-Warning $Content }\r\n        }\r\n    }\r\n}\r\n\r\nFunction ConvertFrom-JsonString {\r\n    [CmdletBinding()]\r\n    param (\r\n        [string]$JsonString,\r\n        [string]$Name,\r\n        [switch]$SensitiveValues      \r\n    )\r\n    If ($JsonString -ne '[]' -and $JsonString -ne $null) {\r\n        [array]$Array = $JsonString.replace('\\', '') | ConvertFrom-Json\r\n        If ($Array.Length -gt 0) {\r\n            If ($SensitiveValues) { Write-Log -message \"Array '$Name' has $($Array.Length) members\" } Else { Write-Log -message \"$($Name): '$($Array -join \"', '\")'\" }\r\n            Return $Array\r\n        }\r\n        Else {\r\n            Return $null\r\n        }            \r\n    }\r\n    Else {\r\n        Return $null\r\n    }    \r\n}\r\n\r\nFunction Convert-GroupToSID {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$DomainName,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$GroupName\r\n    )\r\n    Begin {\r\n        [string]$groupSID = ''\r\n    }\r\n    Process {\r\n        Try {\r\n            $groupSID = (New-Object System.Security.Principal.NTAccount(\"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n        }\r\n        Catch {\r\n            Try {\r\n                $groupSID = (New-Object System.Security.Principal.NTAccount($DomainName, \"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n            }\r\n            Catch {\r\n                Write-Error -Message \"Failed to convert group name '$GroupName' to SID.\"\r\n            }\r\n        }\r\n        Write-Output -InputObject $groupSID\r\n    }\r\n}\r\n\r\nFunction Get-InstalledApplication {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string[]]$Name,\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string]$ProductCode\r\n    )\r\n\r\n    Begin {\r\n        [string[]]$regKeyApplications = 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall', 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall'\r\n    }\r\n    Process { \r\n        ## Enumerate the installed applications from the registry for applications that have the \"DisplayName\" property\r\n        [psobject[]]$regKeyApplication = @()\r\n        ForEach ($regKey in $regKeyApplications) {\r\n            If (Test-Path -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath') {\r\n                [psobject[]]$UninstallKeyApps = Get-ChildItem -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath'\r\n                ForEach ($UninstallKeyApp in $UninstallKeyApps) {\r\n                    Try {\r\n                        [psobject]$regKeyApplicationProps = Get-ItemProperty -LiteralPath $UninstallKeyApp.PSPath -ErrorAction 'Stop'\r\n                        If ($regKeyApplicationProps.DisplayName) { [psobject[]]$regKeyApplication += $regKeyApplicationProps }\r\n                    }\r\n                    Catch {\r\n                        Continue\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ## Create a custom object with the desired properties for the installed applications and sanitize property details\r\n        [psobject[]]$installedApplication = @()\r\n        ForEach ($regKeyApp in $regKeyApplication) {\r\n            Try {\r\n                [string]$appDisplayName = ''\r\n                [string]$appDisplayVersion = ''\r\n                [string]$appPublisher = ''\r\n\r\n                ## Bypass any updates or hotfixes\r\n                If (($regKeyApp.DisplayName -match '(?i)kb\\d+') -or ($regKeyApp.DisplayName -match 'Cumulative Update') -or ($regKeyApp.DisplayName -match 'Security Update') -or ($regKeyApp.DisplayName -match 'Hotfix')) {\r\n                    Continue\r\n                }\r\n\r\n                ## Remove any control characters which may interfere with logging and creating file path names from these variables\r\n                $appDisplayName = $regKeyApp.DisplayName -replace '[^\\u001F-\\u007F]', ''\r\n                $appDisplayVersion = $regKeyApp.DisplayVersion -replace '[^\\u001F-\\u007F]', ''\r\n                $appPublisher = $regKeyApp.Publisher -replace '[^\\u001F-\\u007F]', ''\r\n\r\n                ## Determine if application is a 64-bit application\r\n                [boolean]$Is64BitApp = If (($is64Bit) -and ($regKeyApp.PSPath -notmatch '^Microsoft\\.PowerShell\\.Core\\\\Registry::HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Wow6432Node')) { $true } Else { $false }\r\n\r\n                If ($ProductCode) {\r\n                    ## Verify if there is a match with the product code passed to the script\r\n                    If ($regKeyApp.PSChildName -match [regex]::Escape($productCode)) {\r\n                        $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                            UninstallSubkey    = $regKeyApp.PSChildName\r\n                            ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                            DisplayName        = $appDisplayName\r\n                            DisplayVersion     = $appDisplayVersion\r\n                            UninstallString    = $regKeyApp.UninstallString\r\n                            InstallSource      = $regKeyApp.InstallSource\r\n                            InstallLocation    = $regKeyApp.InstallLocation\r\n                            InstallDate        = $regKeyApp.InstallDate\r\n                            Publisher          = $appPublisher\r\n                            Is64BitApplication = $Is64BitApp\r\n                        }\r\n                    }\r\n                }\r\n\r\n                If ($name) {\r\n                    ## Verify if there is a match with the application name(s) passed to the script\r\n                    ForEach ($application in $Name) {\r\n                        $applicationMatched = $false\r\n                        #  Check for a contains application name match\r\n                        If ($regKeyApp.DisplayName -match [regex]::Escape($application)) {\r\n                            $applicationMatched = $true\r\n                        }\r\n\r\n                        If ($applicationMatched) {\r\n                            $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                                UninstallSubkey    = $regKeyApp.PSChildName\r\n                                ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                                DisplayName        = $appDisplayName\r\n                                DisplayVersion     = $appDisplayVersion\r\n                                UninstallString    = $regKeyApp.UninstallString\r\n                                InstallSource      = $regKeyApp.InstallSource\r\n                                InstallLocation    = $regKeyApp.InstallLocation\r\n                                InstallDate        = $regKeyApp.InstallDate\r\n                                Publisher          = $appPublisher\r\n                                Is64BitApplication = $Is64BitApp\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Catch {\r\n                Continue\r\n            }\r\n        }\r\n        Write-Output -InputObject $installedApplication\r\n    }\r\n}\r\n\r\nFunction Set-RegistryValue {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string]\r\n        $Name,\r\n        [Parameter()]\r\n        [string]\r\n        $Path,\r\n        [Parameter()]\r\n        [string]$PropertyType,\r\n        [Parameter()]\r\n        $Value\r\n    )\r\n    Begin {\r\n        Write-Log -message \"[Set-RegistryValue]: Setting Registry Value: $Name\"\r\n    }\r\n    Process {\r\n        # Create the registry Key(s) if necessary.\r\n        If (!(Test-Path -Path $Path)) {\r\n            Write-Log -message \"[Set-RegistryValue]: Creating Registry Key: $Path\"\r\n            New-Item -Path $Path -Force | Out-Null\r\n        }\r\n        # Check for existing registry setting\r\n        $RemoteValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue\r\n        If ($RemoteValue) {\r\n            # Get current Value\r\n            $CurrentValue = Get-ItemPropertyValue -Path $Path -Name $Name\r\n            Write-Log -message \"[Set-RegistryValue]: Current Value of $($Path)\\$($Name) : $CurrentValue\"\r\n            If ($Value -ne $CurrentValue) {\r\n                Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n                Set-ItemProperty -Path $Path -Name $Name -Value $Value -Force | Out-Null\r\n            }\r\n            Else {\r\n                Write-Log -message \"[Set-RegistryValue]: Value of $($Path)\\$($Name) is already set to $Value\"\r\n            }           \r\n        }\r\n        Else {\r\n            Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n            New-ItemProperty -Path $Path -Name $Name -PropertyType $PropertyType -Value $Value -Force | Out-Null\r\n        }\r\n        Start-Sleep -Milliseconds 500\r\n    }\r\n    End {\r\n    }\r\n}\r\n\r\n#endregion Functions\r\n$Script:Name = 'Set-SessionHostConfiguration'\r\n# from https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#recommended-for-exclusion\r\n# only specifying the folders that do not affect performance per article\r\n$redirectionsXMLStart = @'\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<FrxProfileFolderRedirection ExcludeCommonFolders=\"0\">\r\n<Excludes>\r\n'@\r\n$redirectionsXMLExcludesTeams = @'\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\Logs</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\PerfLog</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\EBWebView\\WV2Profile_tfw\\GPUCache</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\Microsoft.Windows.StartMenuExperienceHost_cw5n1h2txyewy\\TempState</Exclude>\r\n'@\r\n$redirectionsXMLExcludesAzCLI = @'\r\n<Exclude Copy=\"0\">.Azure</Exclude>\r\n'@\r\n$redirectionsXMLEnd = @'\r\n</Excludes>\r\n<Includes>\r\n</Includes>\r\n</FrxProfileFolderRedirection>\r\n'@\r\n\r\nNew-Log -Path (Join-Path -Path $env:SystemRoot -ChildPath 'Logs')\r\nwrite-log -message \"*** Parameter Values ***\"\r\nWrite-Log -message \"AmdVmSize: $AmdVmSize\"\r\nWrite-Log -message \"NvidiaVmSize: $NvidiaVmSize\"\r\nWrite-Log -message \"DisableUpdates: $DisableUpdates\"\r\n[bool]$ConfigureFSLogix = [System.Convert]::ToBoolean($ConfigureFSLogix)\r\nWrite-Log -message \"ConfigureFSLogix: $ConfigureFSLogix\"\r\nif ($ConfigureFSLogix) {\r\n    #Convert CloudCache to Boolean\r\n    $CloudCache = [System.Convert]::ToBoolean($CloudCache)\r\n    Write-Log -message \"CloudCache: $CloudCache\"\r\n    #Convert Shares to Array\r\n    [array]$Shares = ConvertFrom-JsonString -JsonString $Shares -Name 'Shares'\r\n    $ProfileShareName = $Shares[0]\r\n    if ($Shares.Count -gt 1) {\r\n        $OfficeShareName = $Shares[1]\r\n    }\r\n    Else {\r\n        $OfficeShareName = $null\r\n    }\r\n\r\n    Write-Log -message \"ProfileShareName: $ProfileShareName\"\r\n    Write-Log -message \"OfficeShareName: $OfficeShareName\"\r\n    Write-Log -message \"StorageService: $StorageService\"\r\n    if ($SizeInMBs -ne '' -and $null -ne $SizeInMBs) {\r\n        [int]$SizeInMBs = $SizeInMBs\r\n        Write-Log -message \"SizeInMBs: $SizeInMBs\"\r\n    }\r\n    Else {\r\n        [int]$SizeInMBs = 30000\r\n        Write-Log -message \"SizeInMBs not specified. Defaulting to: $SizeInMBs\"\r\n    }\r\n    $IdentitySolution = ConvertFrom-JsonString -JsonString $IdentitySolution -Name 'IdentitySolution'  \r\n}\r\n\r\nWrite-Log -message \"TimeZone: $TimeZone\"\r\n\r\nWrite-Log -message \"Configuring Time Zone to: $TimeZone\"\r\nSet-TimeZone -Id \"$TimeZone\"\r\n\r\nWrite-Log -message \"*** Building Array of Registry Settings ***\"\r\n$RegSettings = New-Object System.Collections.ArrayList\r\nIf ($DisableUpdates -eq 'true') {\r\n    # Disable Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-automatic-updates\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU'; Name = 'NoAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Disable Edge Updates : https://learn.microsoft.com/en-us/deployedge/microsoft-edge-update-policies#updatedefault\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\EdgeUpdate'; Name = 'UpdateDefault'; PropertyType = 'DWORD'; Value = 0 })\r\n    # Set the OneDrive Update Ring to Deferred: https://learn.microsoft.com/en-us/sharepoint/use-group-policy#set-the-sync-app-update-ring\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\OneDrive'; Name = 'GPOSetUpdateRing'; PropertyType = 'DWORD'; Value = 0 })\r\n    If (Get-InstalledApplication -Name 'Microsoft 365 Apps') {\r\n        # Disable Office Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-office-automatic-updates\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideupdatenotifications'; PropertyType = 'DWORD'; Value = 1 })\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideenabledisableupdates'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n    If ($TeamsInstalled) {\r\n        # Disable Teams Auto-Update: https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#disable-new-teams-autoupdate-in-non-persistent-vdi\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Microsoft\\Teams'; Name = 'disableAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n}\r\n# Enable Time Zone Redirection: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#set-up-time-zone-redirection\r\n$RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'fEnableTimeZoneRedirection'; PropertyType = 'DWORD'; Value = 1 })\r\n\r\n##############################################################\r\n#  Add GPU Settings\r\n##############################################################\r\n# This setting applies to the VM Size's recommended for AVD with a GPU\r\nif ($AmdVmSize -eq 'true' -or $NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding GPU Settings\"\r\n    # Configure GPU-accelerated app rendering: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-app-rendering\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'bEnumerateHWBeforeSW'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Configure fullscreen video encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-fullscreen-video-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVC444ModePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\n# This setting applies only to VM Size's recommended for AVD with a Nvidia GPU\r\nif ($NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding Nvidia GPU Settings\"\r\n    # Configure GPU-accelerated frame encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-frame-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVChardwareEncodePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\nIf ($ConfigureFSLogix) {\r\n    $AzCLIInstalled = Get-InstalledApplication -Name 'Azure CLI'\r\n    $TeamsInstalled = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -eq 'MSTeams' }\r\n    # Create Array Lists so it is easy to add them\r\n    [System.Collections.ArrayList]$LocalProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheOfficeContainerPaths = @()\r\n\r\n    switch ($StorageService) {\r\n        'AzureFiles' {\r\n            Write-Log -message \"Gathering Azure Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$OSSGroups = ConvertFrom-JsonString -JsonString $OSSGroups -Name 'OSSGroups'\r\n            [array]$LocalStorageAccountNames = ConvertFrom-JsonString -JsonString $LocalStorageAccountNames -Name 'LocalStorageAccountNames'\r\n            [array]$LocalStorageAccountKeys = ConvertFrom-JsonString -JsonString $LocalStorageAccountKeys -Name 'LocalStorageAccountKeys' -SensitiveValues\r\n            [array]$RemoteStorageAccountNames = ConvertFrom-JsonString -JsonString $RemoteStorageAccountNames -Name 'RemoteStorageAccountNames'\r\n            [array]$RemoteStorageAccountKeys = ConvertFrom-JsonString -JsonString $RemoteStorageAccountKeys -Name 'RemoteStorageAccountKeys' -SensitiveValues\r\n            \r\n            Write-Log -message \"*** Begin Processing Storage Accounts ***\"\r\n            # Local Storage Accounts\r\n            Write-Log -message \"Processing Local Storage Accounts\"\r\n            For ($i = 0; $i -lt $LocalStorageAccountNames.Count; $i++) {\r\n                $SAFQDN = \"$($LocalStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                Write-Log -message \"LocalStorageAccountFQDN: '$SAFQDN'\"\r\n                If ($LocalStorageAccountKeys.Count -gt 0) {\r\n                    If ($LocalStorageAccountKeys[$i]) {\r\n                        Write-Log -message \"Adding Local Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                        Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$SAFQDN /user:localhost\\$($LocalStorageAccountNames[$i]) /pass:$($LocalStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                    }\r\n                }\r\n                If ($OfficeShareName) {\r\n                    $LocalOfficeContainerPaths.Add(\"\\\\$SAFQDN\\$OfficeShareName\")\r\n                    Write-Log -message \"LocalOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"                \r\n                    $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                    Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                }\r\n                $LocalProfileContainerPaths.Add(\"\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalProfileContainerPath: \\\\$($SAFQDN)\\$($ProfileShareName)\"\r\n                $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n            }\r\n            # Remote / Existing Storage Accounts\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                Write-Log Info \"Processing Remote Storage Accounts\"\r\n                For ($i = 0; $i -lt $RemoteStorageAccountNames.Count; $i++) {\r\n                    $SAFQDN = \"$($RemoteStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                    Write-Log -message \"RemoteStorageAccountFQDN: '$SAFQDN'\"\r\n                    If ($RemoteStorageAccountKeys.Count -gt 0) {\r\n                        If ($RemoteStorageAccountKeys[$i]) {\r\n                            Write-Log -message \"Adding Remote Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                            Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$($SAFQDN) /user:localhost\\$($RemoteStorageAccountNames[$i]) /pass:$($RemoteStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                        }\r\n                    }\r\n                    If ($OfficeShareName) {\r\n                        $RemoteOfficeContainerPaths.Add(\"\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                        $RemoteCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\"\r\n                    }\r\n                    $RemoteProfileContainerPaths.Add(\"\\\\$(SAFQDN)\\$(ProfileShareName)\")\r\n                    Write-Log -message \"RemoteProfileContainerPath: '\\\\$($SAFQDN)\\$(ProfileShareName)'\"\r\n                    $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n                }\r\n            }\r\n            Write-Log -message \"Done Adding UNC Paths to arrays.\"\r\n        }\r\n        'AzureNetAppFiles' {\r\n            Write-Log -message \"Gathering Azure NetApp Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$LocalNetAppServers = ConvertFrom-JsonString -JsonString $LocalNetAppServers -Name 'LocalNetAppServers'\r\n            [array]$RemoteNetAppServers = ConvertFrom-JsonString -JsonString $RemoteNetAppServers -Name 'RemoteNetAppServers' \r\n            Write-Log -message \"Processing Local Azure NetApp Servers\"        \r\n            $LocalProfileContainerPaths.Add(\"\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalProfileContainerPath: '\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            If ($LocalNetAppServers.Length -gt 1 -and $OfficeShareName) {            \r\n                $LocalOfficeContainerPaths.Add(\"\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalOfficeContainerPath: \\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\"\r\n                $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)'\"\r\n            }\r\n            \r\n            If ($RemoteNetAppServers.Count -gt 0) {\r\n                Write-Log -message \"Processing Remote Azure NetApp Servers\"\r\n                $RemoteProfileContainerPaths.Add(\"\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteProfileContainerPath: '\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)'\"\r\n                $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\"\r\n                If ($RemoteNetAppShares.Length -gt 1 -and $OfficeShareName) {\r\n                    $RemoteOfficeContainerPaths.Add(\"\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                    $RemoteCloudCacheOfficeContainers.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                }        \r\n            }\r\n        }\r\n    }\r\n\r\n    Write-Log -message \"Adding Common FSLogix Settings\"\r\n    # Cleans up an invalid sessions to enable a successful sign-in: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#cleanupinvalidsessions\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'CleanupInvalidSessions'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Apps'; PropertyType = 'DWord'; Value = 1 })\r\n    # Enables Fslogix profile containers: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#enabled\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Fslogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Deletes a local profile if it exists and matches the profile being loaded from VHD: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#deletelocalprofilewhenvhdshouldapply\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'DeleteLocalProfileWhenVHDShouldApply'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#flipflopprofiledirectoryname\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithfailure\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a temporary profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithtempprofile\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachintervalseconds\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 15 })\r\n    # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachretrycount\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 3 })\r\n    # Specifies the maximum size of the user's container in megabytes. Newly created VHD(x) containers are of this size: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#sizeinmbs\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n    # Specifies the file extension for the profile containers: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#volumetype\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'String'; Value = 'VHDX' })\r\n\r\n    If ($LocalStorageAccountKeys.Count -gt 0) {\r\n        Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n        # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#accessnetworkascomputerobject\r\n        $RegSettings.Add([PSCustomObject]@{Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    if ($CloudCache -eq $True) {\r\n        Write-Log -message \"Adding Cloud Cache Settings\"\r\n        # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n        Write-Log -message \"Adding Office Container Settings\"    \r\n        # Enables Fslogix office containers: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#enabled-1   \r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })   \r\n        # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#flipflopprofiledirectoryname-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Specifies the number of retries attempted when a VHD(x) file is locked: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the number of seconds to wait between retries: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretryinterval\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryInterval'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithfailure-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Prevent Login with Temporary Profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithtempprofile-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })    \r\n        # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachintervalseconds\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the maximum size of the user's container in megabytes: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#sizeinmbs\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n        # Specifies the type of container: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#volumetype\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'String'; Value = 'VHDX' })\r\n        If ($LocalStorageAccountKeys.Count -gt 0) {\r\n            Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n            # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#accessnetworkascomputerobject-1\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Settings\"\r\n            # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }   \r\n    }\r\n\r\n    If ($OSSGroups.Count -gt 0) {\r\n        Write-Log -message \"Adding Object Specific Settings\"\r\n        # Object Specific Settings\r\n        $DomainName = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object -ExpandProperty Domain\r\n        Write-Log -message \"DomainName: $DomainName\"\r\n        For ($i = 0; $i -lt $OSSGroups.Count; $i++) {\r\n            # Get Domain information\r\n            Write-Log -message \"Getting SID for $($OSSGroups[$i])\"        \r\n            $OSSGroupSID = Convert-GroupToSID -DomainName $DomainName -GroupName $OSSGroups[$i]\r\n            [string]$LocalProfileContainerPath = $LocalProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalProfileContainerPath: '$LocalProfileContainerPath'\"\r\n            [string]$LocalCloudCacheProfileContainerPath = $LocalCloudCacheProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: '$LocalCloudCacheProfileContainerPath'\"\r\n\r\n            If ($RemoteStorageAccountNames) {\r\n                [string]$RemoteProfileContainerPath = $RemoteProfileContainerPaths[$i]\r\n                Write-Log -message \"RemoteProfileContainerPath: '$RemoteProfileContainerPath'\"\r\n                [string]$RemoteCloudCacheProfileContainerPath = $RemoteCloudCacheProfilePaths[$i]\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: '$RemoteCloudCacheProfileContainerPath'\"\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath + $RemoteProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath + $RemoteCloudCacheProfileContainerPath)\r\n            }\r\n            Else {\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath)\r\n            }\r\n\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Profile Container Settings: $OSSGroupSID : '$($CloudCacheProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Profile Container Settings: $OSSGroupSID : '$($ProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n            }   \r\n\r\n            If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n                [string]$LocalOfficeContainerPath = $LocalOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalOfficeContainerPath: '$LocalOfficeContainerPath'\"\r\n                [string]$LocalCloudCacheOfficeContainerPath = $LocalCloudCacheOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: '$LocalCloudCacheOfficeContainerPath'\"\r\n                If ($RemoteStorageAccountNames) {\r\n                    [string]$RemoteOfficeContainerPath = $RemoteOfficeContainerPaths[$i]\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '$RemoteOfficeContainerPath'\"\r\n                    [string]$RemoteCloudCacheOfficeContainerPath = $RemoteCloudCacheOfficePaths[$i]\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: '$RemoteCloudCacheOfficeContainerPath'\"\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath + $RemoteOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath + $RemoteCloudCacheOfficeContainerPath)\r\n                }\r\n                Else {\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath)\r\n                }\r\n                If ($CloudCache -eq $True) {\r\n                    Write-Log -message \"Adding Cloud Cache Office Container Settings: $OSSGroupSID : '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n                }\r\n                Else {\r\n                    Write-Log -message \"Adding Office Container Settings: $OSSGroupSID : '$($OfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n                }\r\n            }  \r\n        }          \r\n    }\r\n    Else {\r\n        If ($RemoteStorageAccountNames.Count -gt 0) {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths + $RemoteProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths + $RemoteCloudCacheProfileContainerPaths\r\n        }\r\n        Else {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Profile Container Settings: '$($CloudCacheProfileContainerPaths -join \"', '\")'\"   \r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations \r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })             \r\n        }\r\n        Else {\r\n            Write-Log -message \"Adding Profile Container Settings: '$($ProfileContainerPaths -join \"', '\")'\"\r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n        }\r\n        If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths + $RemoteOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths + $RemoteCloudCacheOfficeContainerPaths\r\n            }\r\n            Else {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths\r\n            }\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Office Container Settings: '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Office Container Settings: '$($OfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n            }\r\n        }    \r\n    }\r\n    If ($TeamsInstalled -or $AzCLIInstalled) {\r\n        $customRedirFolder = \"$env:ProgramData\\FSLogix_CustomRedirections\"\r\n        Write-Log -message \"Creating custom redirections.xml file in $customRedirFolder\"\r\n        If (-not (Test-Path $customRedirFolder )) {\r\n            New-Item -Path $customRedirFolder -ItemType Directory -Force\r\n        }\r\n        $customRedirFilePath = \"$customRedirFolder\\redirections.xml\"\r\n        $redirectionsXMLContent = $redirectionsXMLStart\r\n        if ($AzCLIInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesAzCLI\r\n        }\r\n        if ($TeamsInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesTeams\r\n        }\r\n        $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLEnd\r\n        $redirectionsXMLContent | Out-File -FilePath $customRedirFilePath -Encoding unicode\r\n        # Path where FSLogix looks for the redirections.xml file to copy from and into the user's profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#redirxmlsourcefolder\r\n        \r\n        $RegSettings.Add(\r\n            [PSCustomObject]@{\r\n                Name         = 'RedirXMLSourceFolder'\r\n                Path         = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'\r\n                PropertyType = 'String'\r\n                Value        = $customRedirFolder\r\n            }\r\n        )\r\n    }\r\n    If ($IdentitySolution -match 'EntraKerberos') {\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'CloudKerberosTicketRetrievalEnabled'; Path = 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Kerberos\\Parameters'; PropertyType = 'DWord'; Value = 1})\r\n    }\r\n\r\n    $LocalAdministrator = (Get-LocalUser | Where-Object { $_.SID -like '*-500' }).Name\r\n    $LocalGroups = 'FSLogix Profile Exclude List', 'FSLogix ODFC Exclude List'\r\n    ForEach ($Group in $LocalGroups) {\r\n        If (-not (Get-LocalGroupMember -Group $Group | Where-Object { $_.Name -like \"*$LocalAdministrator\" })) {\r\n            Add-LocalGroupMember -Group $Group -Member $LocalAdministrator\r\n        }\r\n    }\r\n}\r\n\r\nWrite-Log -message \"*** Setting Registry Values ***\"\r\nForEach ($Setting in $RegSettings) {\r\n    Set-RegistryValue -Name $Setting.Name -Path $Setting.Path -PropertyType $Setting.PropertyType -Value $Setting.Value -Verbose\r\n}\r\n\r\n# Resize OS Disk\r\nWrite-Log -message \"Resizing OS Disk\"\r\n$driveLetter = $env:SystemDrive.Substring(0, 1)\r\n$size = Get-PartitionSupportedSize -DriveLetter $driveLetter\r\nResize-Partition -DriveLetter $driveLetter -Size $size.SizeMax\r\nWrite-Log -message \"OS Disk Resized\"\r\nClear-EventLog \"Windows PowerShell\" -ErrorAction SilentlyContinue\r\nWrite-Log -message \"Done\"",
                        "amdVmSize": "[[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), 'as_v4'), endsWith(parameters('virtualMachineSize'), '_V710_v5')))]",
                        "nvidiaVmSize": "[[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), '_v3'), endsWith(parameters('virtualMachineSize'), '_A10_v5')))]",
                        "profileShareName": "[[parameters('fslogixFileShareNames')[0]]",
                        "officeShareName": "[[if(greater(length(parameters('fslogixFileShareNames')), 1), parameters('fslogixFileShareNames')[1], '')]",
                        "fslogixLocalNetAppProfileShare": "[[if(not(empty(parameters('fslogixLocalNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[0], variables('profileShareName')), '')]",
                        "fslogixLocalNetAppOfficeShare": "[[if(greater(length(parameters('fslogixLocalNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[1], variables('officeShareName')), '')]",
                        "fslogixRemoteNetAppProfileShare": "[[if(not(empty(parameters('fslogixRemoteNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[0], variables('profileShareName')), '')]",
                        "fslogixRemoteNetAppOfficeShare": "[[if(greater(length(parameters('fslogixRemoteNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[1], variables('officeShareName')), '')]",
                        "vhdxPath": "\\*\\*.VHDX",
                        "fslogixExclusionsCloudCache": "[[if(contains(parameters('fslogixContainerType'), 'CloudCache'), '%ProgramData%\\FSLogix\\Cache\\*;%ProgramData%\\FSLogix\\Proxy\\*', '')]",
                        "fslogixLocalDedupedSANames": "[[union(variables('fslogixLocalSANameMinus2'), variables('fslogixLocalSANameMinus2'))]",
                        "fslogixLocalMatchPrefix": "[[if(equals(length(variables('fslogixLocalDedupedSANames')), 1), true(), false())]",
                        "fslogixLocalOfficeSharesPrefixMatch": "[[if(and(not(empty(variables('fslogixLocalDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
                        "fslogixLocalProfileSharesPrefixMatch": "[[if(not(empty(variables('fslogixLocalDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
                        "fslogixLocalOfficeSharesNoMatch": "[[if(not(empty(variables('officeShareName'))), map(variables('fslogixLocalStorageAccountNames'), lambda('name', createArray(format('\\\\{0}??.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))))), createArray())]",
                        "fslogixLocalProfileSharesNoMatch": "[[map(variables('fslogixLocalStorageAccountNames'), lambda('name', createArray(format('\\\\{0}.file.{1}}}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath')))))]",
                        "fslogixLocalOfficeVHDXs": "[[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalOfficeSharesPrefixMatch'), variables('fslogixLocalOfficeSharesNoMatch'))]",
                        "fslogixLocalProfileVHDXs": "[[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalProfileSharesPrefixMatch'), variables('fslogixLocalProfileSharesNoMatch'))]",
                        "fslogixRemoteDedupedSANames": "[[union(variables('fslogixRemoteSANameMinus2'), variables('fslogixRemoteSANameMinus2'))]",
                        "fslogixRemoteMatchPrefix": "[[if(equals(length(variables('fslogixRemoteDedupedSANames')), 1), true(), false())]",
                        "fslogixRemoteOfficeSharesPrefixMatch": "[[if(and(not(empty(variables('fslogixRemoteDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
                        "fslogixRemoteProfileSharesPrefixMatch": "[[if(not(empty(variables('fslogixRemoteDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
                        "fslogixRemoteOfficeSharesNoMatch": "[[if(and(not(empty(variables('fslogixRemoteStorageAccountNames'))), not(empty(variables('officeShareName')))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', createArray(format('\\\\{0}??.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))))), createArray())]",
                        "fslogixRemoteProfileSharesNoMatch": "[[if(not(empty(variables('fslogixRemoteStorageAccountNames'))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', createArray(format('\\\\{0}.file.{1}}}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))))), createArray())]",
                        "fslogixRemoteOfficeVHDXs": "[[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteOfficeSharesPrefixMatch'), variables('fslogixRemoteOfficeSharesNoMatch'))]",
                        "fslogixRemoteProfileVHDXs": "[[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteProfileSharesPrefixMatch'), variables('fslogixRemoteProfileSharesNoMatch'))]",
                        "fslogixOfficeVHDXs": "[[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalOfficeVHDXs'), variables('fslogixRemoteOfficeVHDXs')), if(empty(variables('fslogixLocalNetAppOfficeShare')), createArray(), if(empty(variables('fslogixRemoteNetAppOfficeShare')), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppOfficeShare'), variables('vhdxPath'))))))]",
                        "fslogixProfileVHDXs": "[[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalProfileVHDXs'), variables('fslogixRemoteProfileVHDXs')), if(empty(variables('fslogixLocalNetAppProfileShare')), createArray(), if(empty(variables('fslogixRemoteNetAppProfileShare')), createArray(format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppProfileShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))))))]",
                        "fslogixExclusionsOfficeString": "[[if(contains(parameters('fslogixContainerType'), 'Office'), join(variables('fslogixExclusionsOfficeArray'), ';'), '')]",
                        "fslogixExclusionsProfileString": "[[join(variables('fslogixExclusionProfileArray'), ';')]",
                        "fslogixExclusionsArray": [
                          "[[format('$TEMP%{0}', variables('vhdxPath'))]",
                          "[[format('%WinDir%\\TEMP{0}', variables('vhdxPath'))]",
                          "[[variables('fslogixExclusionsCloudCache')]",
                          "[[variables('fslogixExclusionsProfileString')]",
                          "[[variables('fslogixExclusionsOfficeString')]"
                        ],
                        "fslogixPathExclusions": "[[join(filter(variables('fslogixExclusionsArray'), lambda('exclusion', not(empty(lambdaVariables('exclusion'))))), ';')]",
                        "identityType": "[[if(if(or(not(contains(parameters('identitySolution'), 'DomainServices')), parameters('enableMonitoring')), true(), false()), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'SystemAssigned, UserAssigned', 'SystemAssigned'), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'UserAssigned', 'None'))]",
                        "userAssignedIdentities": "[[if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), createObject(format('{0}', parameters('artifactsUserAssignedIdentityResourceId')), createObject()), createObject())]",
                        "identity": "[[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(variables('userAssignedIdentities'))), variables('userAssignedIdentities'), null())), null())]",
                        "ImageReference": "[[if(empty(parameters('customImageResourceId')), createObject('publisher', parameters('imagePublisher'), 'offer', parameters('imageOffer'), 'sku', parameters('imageSku'), 'version', 'latest'), createObject('id', parameters('customImageResourceId')))]"
                      },
                      "resources": [
                        {
                          "[string('copy')]": {
                            "name": "networkInterface",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "type": "Microsoft.Network/networkInterfaces",
                          "apiVersion": "2020-05-01",
                          "name": "[[replace(parameters('networkInterfaceNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                          "location": "[[parameters('location')]",
                          "tags": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()))]",
                          "properties": {
                            "ipConfigurations": [
                              {
                                "name": "ipconfig",
                                "properties": {
                                  "privateIPAllocationMethod": "Dynamic",
                                  "subnet": {
                                    "id": "[[parameters('subnetResourceId')]"
                                  },
                                  "primary": true,
                                  "privateIPAddressVersion": "IPv4"
                                }
                              }
                            ],
                            "enableAcceleratedNetworking": "[[parameters('enableAcceleratedNetworking')]",
                            "enableIPForwarding": false
                          }
                        },
                        {
                          "[string('copy')]": {
                            "name": "virtualMachine",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "type": "Microsoft.Compute/virtualMachines",
                          "apiVersion": "2022-11-01",
                          "name": "[[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                          "location": "[[parameters('location')]",
                          "tags": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()))]",
                          "zones": "[[if(or(not(empty(parameters('dedicatedHostResourceId'))), not(empty(parameters('dedicatedHostGroupResourceId')))), parameters('dedicatedHostGroupZones'), if(and(equals(parameters('availability'), 'availabilityZones'), not(empty(parameters('availabilityZones')))), createArray(parameters('availabilityZones')[mod(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), length(parameters('availabilityZones')))]), null()))]",
                          "identity": "[[variables('identity')]",
                          "properties": {
                            "additionalCapabilities": {
                              "hibernationEnabled": "[[parameters('hibernationEnabled')]"
                            },
                            "availabilitySet": "[[if(equals(parameters('availability'), 'AvailabilitySets'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', format('{0}-{1}', parameters('availabilitySetNamePrefix'), div(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), 200)))), null())]",
                            "hardwareProfile": {
                              "vmSize": "[[parameters('virtualMachineSize')]"
                            },
                            "host": "[[if(not(empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostResourceId')), null())]",
                            "hostGroup": "[[if(and(not(empty(parameters('dedicatedHostGroupResourceId'))), empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostGroupResourceId')), null())]",
                            "storageProfile": {
                              "imageReference": "[[variables('ImageReference')]",
                              "osDisk": {
                                "diskSizeGB": "[[if(not(equals(parameters('diskSizeGB'), 0)), parameters('diskSizeGB'), null())]",
                                "name": "[[replace(parameters('osDiskNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                                "osType": "Windows",
                                "createOption": "FromImage",
                                "caching": "ReadWrite",
                                "deleteOption": "Delete",
                                "managedDisk": {
                                  "diskEncryptionSet": "[[if(and(not(equals(parameters('securityType'), 'ConfidentialVM')), not(empty(parameters('diskEncryptionSetResourceId')))), createObject('id', parameters('diskEncryptionSetResourceId')), null())]",
                                  "securityProfile": "[[if(equals(parameters('securityType'), 'ConfidentialVM'), createObject('diskEncryptionSet', if(not(empty(parameters('diskEncryptionSetResourceId'))), createObject('id', parameters('diskEncryptionSetResourceId')), null()), 'securityEncryptionType', parameters('confidentialVMOSDiskEncryptionType')), null())]",
                                  "storageAccountType": "[[parameters('diskSku')]"
                                }
                              },
                              "dataDisks": []
                            },
                            "osProfile": {
                              "computerName": "[[format('{0}{1}', parameters('virtualMachineNamePrefix'), padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                              "adminUsername": "[[parameters('virtualMachineAdminUserName')]",
                              "adminPassword": "[[parameters('virtualMachineAdminPassword')]",
                              "windowsConfiguration": {
                                "provisionVMAgent": true,
                                "enableAutomaticUpdates": false
                              },
                              "secrets": [],
                              "allowExtensionOperations": true
                            },
                            "networkProfile": {
                              "networkInterfaces": [
                                {
                                  "id": "[[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('networkInterfaceNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                                  "properties": {
                                    "deleteOption": "Delete"
                                  }
                                }
                              ]
                            },
                            "securityProfile": {
                              "encryptionAtHost": "[[if(parameters('encryptionAtHost'), true(), null())]",
                              "securityType": "[[if(not(equals(parameters('securityType'), 'Standard')), parameters('securityType'), null())]",
                              "uefiSettings": "[[if(not(equals(parameters('securityType'), 'Standard')), createObject('secureBootEnabled', parameters('secureBootEnabled'), 'vTpmEnabled', parameters('vTpmEnabled')), null())]"
                            },
                            "diagnosticsProfile": {
                              "bootDiagnostics": {
                                "enabled": false
                              }
                            },
                            "licenseType": "[[if(or(equals(parameters('imagePublisher'), 'MicrosoftWindowsDesktop'), not(empty(parameters('customImageResourceId')))), 'Windows_Client', 'Windows_Server')]"
                          },
                          "dependsOn": [
                            "networkInterface"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_JsonADDomainExtension",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[contains(parameters('identitySolution'), 'DomainServices')]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'JsonADDomainExtension')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "forceUpdateTag": "[[parameters('deploymentSuffix')]",
                            "publisher": "Microsoft.Compute",
                            "type": "JsonADDomainExtension",
                            "typeHandlerVersion": "1.3",
                            "autoUpgradeMinorVersion": true,
                            "settings": {
                              "Name": "[[parameters('domainName')]",
                              "User": "[[parameters('domainJoinUserPrincipalName')]",
                              "Restart": "true",
                              "Options": "3",
                              "OUPath": "[[parameters('ouPath')]"
                            },
                            "protectedSettings": {
                              "Password": "[[parameters('domainJoinUserPassword')]"
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_AADLoginForWindows",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[or(startsWith(parameters('identitySolution'), 'EntraKerberos'), equals(parameters('identitySolution'), 'EntraId'))]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AADLoginForWindows')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.Azure.ActiveDirectory",
                            "type": "AADLoginForWindows",
                            "typeHandlerVersion": "1.0",
                            "autoUpgradeMinorVersion": true,
                            "settings": "[[if(parameters('intuneEnrollment'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), null())]"
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_IaasAntimalware",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[not(startsWith(environment().name, 'USN'))]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'IaaSAntimalware')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.Azure.Security",
                            "type": "IaaSAntimalware",
                            "typeHandlerVersion": "1.3",
                            "autoUpgradeMinorVersion": true,
                            "settings": {
                              "AntimalwareEnabled": true,
                              "RealtimeProtectionEnabled": "true",
                              "ScheduledScanSettings": {
                                "isEnabled": "true",
                                "day": "7",
                                "time": "120",
                                "scanType": "Quick"
                              },
                              "Exclusions": {
                                "Paths": "[[variables('fslogixPathExclusions')]"
                              }
                            }
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_JsonADDomainExtension",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_AzureMonitorWindowsAgent",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[parameters('enableMonitoring')]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2023-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AzureMonitorAgent')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.Azure.Monitor",
                            "type": "AzureMonitorWindowsAgent",
                            "typeHandlerVersion": "1.0",
                            "autoUpgradeMinorVersion": true,
                            "enableAutomaticUpgrade": true
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_IaasAntimalware",
                            "extension_JsonADDomainExtension",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "dataCollectionEndpointAssociation",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionEndpointResourceId'))))]",
                          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                          "apiVersion": "2022-06-01",
                          "scope": "[[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "name": "configurationAccessEndpoint",
                          "properties": {
                            "dataCollectionEndpointId": "[[parameters('dataCollectionEndpointResourceId')]",
                            "description": "Data Collection Endpoint Association"
                          },
                          "dependsOn": [
                            "extension_AzureMonitorWindowsAgent",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "avdInsightsDataCollectionRuleAssociation",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[and(parameters('enableMonitoring'), not(empty(parameters('avdInsightsDataCollectionRulesResourceId'))))]",
                          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                          "apiVersion": "2022-06-01",
                          "scope": "[[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "name": "[[format('{0}-avdInsights-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "properties": {
                            "dataCollectionRuleId": "[[parameters('avdInsightsDataCollectionRulesResourceId')]",
                            "description": "AVD Insights data collection rule association"
                          },
                          "dependsOn": [
                            "extension_AzureMonitorWindowsAgent",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "vmInsightsDataCollectionRuleAssociation",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[and(parameters('enableMonitoring'), not(empty(parameters('vmInsightsDataCollectionRulesResourceId'))))]",
                          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                          "apiVersion": "2022-06-01",
                          "scope": "[[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "name": "[[format('{0}-vmInsights-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "properties": {
                            "dataCollectionRuleId": "[[parameters('vmInsightsDataCollectionRulesResourceId')]",
                            "description": "VM Insights data collection rule association"
                          },
                          "dependsOn": [
                            "extension_AzureMonitorWindowsAgent",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "securityDataCollectionRuleAssociation",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[not(empty(parameters('securityDataCollectionRulesResourceId')))]",
                          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                          "apiVersion": "2022-06-01",
                          "scope": "[[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "name": "[[format('{0}-security-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                          "properties": {
                            "dataCollectionRuleId": "[[parameters('securityDataCollectionRulesResourceId')]",
                            "description": "Security Events data collection rule association"
                          },
                          "dependsOn": [
                            "extension_AzureMonitorWindowsAgent",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_GuestAttestation",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[parameters('integrityMonitoring')]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2023-09-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'GuestAttestation')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.Azure.Security.WindowsAttestation",
                            "type": "GuestAttestation",
                            "typeHandlerVersion": "1.0",
                            "autoUpgradeMinorVersion": true,
                            "settings": {
                              "AttestationConfig": {
                                "MaaSettings": {
                                  "maaEndpoint": "",
                                  "maaTenantName": "GuestAttestation"
                                },
                                "AscSettings": {
                                  "ascReportingEndpoint": "",
                                  "ascReportingFrequency": ""
                                },
                                "useCustomToken": "false",
                                "disableAlerts": "false"
                              }
                            }
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_AzureMonitorWindowsAgent",
                            "extension_IaasAntimalware",
                            "extension_JsonADDomainExtension",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_AmdGpuDriverWindows",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[variables('amdVmSize')]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AmdGpuDriverWindows')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.HpcCompute",
                            "type": "AmdGpuDriverWindows",
                            "typeHandlerVersion": "1.0",
                            "autoUpgradeMinorVersion": true,
                            "settings": {}
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_AzureMonitorWindowsAgent",
                            "extension_IaasAntimalware",
                            "extension_JsonADDomainExtension",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_NvidiaGpuDriverWindows",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[variables('nvidiaVmSize')]",
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'NvidiaGpuDriverWindows')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.HpcCompute",
                            "type": "NvidiaGpuDriverWindows",
                            "typeHandlerVersion": "1.2",
                            "autoUpgradeMinorVersion": true,
                            "settings": {}
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_AzureMonitorWindowsAgent",
                            "extension_JsonADDomainExtension",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "runCommand_ConfigureSessionHost",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "type": "Microsoft.Compute/virtualMachines/runCommands",
                          "apiVersion": "2023-09-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'configureSessionHost')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "parameters": [
                              {
                                "name": "AmdVmSize",
                                "value": "[[if(variables('amdVmSize'), 'true', 'false')]"
                              },
                              {
                                "name": "NvidiaVmSize",
                                "value": "[[if(variables('nvidiaVmSize'), 'true', 'false')]"
                              },
                              {
                                "name": "DisableUpdates",
                                "value": "false"
                              },
                              {
                                "name": "ConfigureFSLogix",
                                "value": "[[if(parameters('fslogixConfigureSessionHosts'), 'true', 'false')]"
                              },
                              {
                                "name": "CloudCache",
                                "value": "[[if(contains(parameters('fslogixContainerType'), 'CloudCache'), 'true', 'false')]"
                              },
                              {
                                "name": "IdentitySolution",
                                "value": "[[parameters('identitySolution')]"
                              },
                              {
                                "name": "LocalNetAppServers",
                                "value": "[[string(parameters('fslogixLocalNetAppServerFqdns'))]"
                              },
                              {
                                "name": "LocalStorageAccountNames",
                                "value": "[[string(variables('fslogixLocalStorageAccountNames'))]"
                              },
                              {
                                "name": "OSSGroups",
                                "value": "[[string(parameters('fslogixOSSGroups'))]"
                              },
                              {
                                "name": "RemoteNetAppServers",
                                "value": "[[string(parameters('fslogixRemoteNetAppServerFqdns'))]"
                              },
                              {
                                "name": "RemoteStorageAccountNames",
                                "value": "[[string(variables('fslogixRemoteStorageAccountNames'))]"
                              },
                              {
                                "name": "Shares",
                                "value": "[[string(parameters('fslogixFileShareNames'))]"
                              },
                              {
                                "name": "SizeInMBs",
                                "value": "[[string(parameters('fslogixSizeInMBs'))]"
                              },
                              {
                                "name": "StorageAccountDNSSuffix",
                                "value": "[[parameters('storageSuffix')]"
                              },
                              {
                                "name": "StorageService",
                                "value": "[[parameters('fslogixStorageService')]"
                              },
                              {
                                "name": "TimeZone",
                                "value": "[[parameters('timeZone')]"
                              }
                            ],
                            "protectedParameters": "[[if(parameters('fslogixConfigureSessionHosts'), createArray(createObject('name', 'LocalStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixLocalStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixLocalStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray())))), createObject('name', 'RemoteStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixRemoteStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixRemoteStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray()))))), null())]",
                            "source": {
                              "script": "[[variables('$fxv#0')]"
                            },
                            "treatFailureAsDeploymentFailure": true,
                            "timeoutInSeconds": 600
                          },
                          "dependsOn": [
                            "extension_AADLoginForWindows",
                            "extension_AmdGpuDriverWindows",
                            "extension_AzureMonitorWindowsAgent",
                            "extension_GuestAttestation",
                            "extension_IaasAntimalware",
                            "extension_JsonADDomainExtension",
                            "extension_NvidiaGpuDriverWindows",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "extension_DSC_installAvdAgents",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "type": "Microsoft.Compute/virtualMachines/extensions",
                          "apiVersion": "2021-03-01",
                          "name": "[[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AVDAgentInstallandConfig')]",
                          "location": "[[parameters('location')]",
                          "properties": {
                            "publisher": "Microsoft.Powershell",
                            "type": "DSC",
                            "typeHandlerVersion": "2.73",
                            "autoUpgradeMinorVersion": true,
                            "settings": {
                              "modulesUrl": "[[parameters('sessionHostRegistrationDSCUrl')]",
                              "configurationFunction": "Configuration.ps1\\AddSessionHost",
                              "properties": {
                                "hostPoolName": "[[last(split(parameters('hostPoolResourceId'), '/'))]",
                                "registrationInfoTokenCredential": {
                                  "UserName": "PLACEHOLDER_DO_NOT_USE",
                                  "Password": "PrivateSettingsRef:RegistrationInfoToken"
                                },
                                "aadJoin": "[[not(contains(parameters('identitySolution'), 'DomainServices'))]",
                                "UseAgentDownloadEndpoint": "[[parameters('useAgentDownloadEndpoint')]",
                                "mdmId": "[[if(parameters('intuneEnrollment'), '0000000a-0000-0000-c000-000000000000', '')]"
                              }
                            },
                            "protectedSettings": {
                              "Items": {
                                "RegistrationInfoToken": "[[listRegistrationTokens(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').value[0].token]"
                              }
                            }
                          },
                          "dependsOn": [
                            "postDeploymentScripts",
                            "runCommand_ConfigureSessionHost",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "postDeploymentScripts",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "condition": "[[not(empty(parameters('sessionHostCustomizations')))]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-Customizations-{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), parameters('deploymentSuffix'))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "artifactsContainerUri": {
                                "value": "[[parameters('artifactsContainerUri')]"
                              },
                              "customizations": {
                                "value": "[[parameters('sessionHostCustomizations')]"
                              },
                              "userAssignedIdentityClientId": {
                                "value": "[[parameters('artifactsUserAssignedIdentityClientId')]"
                              },
                              "virtualMachineName": {
                                "value": "[[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "6032795963718933388"
                                }
                              },
                              "parameters": {
                                "artifactsContainerUri": {
                                  "type": "string"
                                },
                                "customizations": {
                                  "type": "array"
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]"
                                },
                                "userAssignedIdentityClientId": {
                                  "type": "string"
                                },
                                "virtualMachineName": {
                                  "type": "string"
                                }
                              },
                              "variables": {
                                "[string('copy')]": [
                                  {
                                    "name": "customizers",
                                    "count": "[[length(parameters('customizations'))]",
                                    "input": {
                                      "name": "[[replace(parameters('customizations')[copyIndex('customizers')].name, ' ', '-')]",
                                      "uri": "[[if(or(startsWith(parameters('customizations')[copyIndex('customizers')].blobNameOrUri, 'https://'), startsWith(parameters('customizations')[copyIndex('customizers')].blobNameorUri, 'http://')), parameters('customizations')[copyIndex('customizers')].blobNameOrUri, format('{0}/{1}', parameters('artifactsContainerUri'), parameters('customizations')[copyIndex('customizers')].blobNameOrUri))]",
                                      "arguments": "[[coalesce(tryGet(parameters('customizations')[copyIndex('customizers')], 'arguments'), '')]"
                                    }
                                  }
                                ],
                                "$fxv#0": "param(\r\n  [string]$APIVersion,\r\n  [string]$Arguments='',\r\n  [string]$BlobStorageSuffix,\r\n  [string]$BuildDir='',\r\n  [string]$Name,\r\n  [string]$Uri,\r\n  [string]$UserAssignedIdentityClientId\r\n)\r\n\r\nfunction Write-OutputWithTimeStamp {\r\n  param(\r\n      [string]$Message\r\n  )    \r\n  $Timestamp = Get-Date -Format 'MM/dd/yyyy HH:mm:ss'\r\n  $Entry = '[' + $Timestamp + '] ' + $Message\r\n  Write-Output $Entry\r\n}\r\n\r\nFunction Split-ArgumentString {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @()\r\n    }\r\n\r\n    # For PowerShell execution with &, we want individual arguments, not combined ones\r\n    $arguments = @()\r\n    $currentArg = \"\"\r\n    $inQuotes = $false\r\n    \r\n    for ($i = 0; $i -lt $ArgumentString.Length; $i++) {\r\n        $char = $ArgumentString[$i]\r\n        \r\n        if ($char -eq '\"' -and ($i -eq 0 -or $ArgumentString[$i-1] -ne '\\')) {\r\n            $inQuotes = !$inQuotes\r\n            $currentArg += $char\r\n        }\r\n        elseif ($char -eq ' ' -and !$inQuotes) {\r\n            if ($currentArg.Length -gt 0) {\r\n                # Handle boolean conversion\r\n                $value = $currentArg.Trim('\"')\r\n                if ($value -eq 'true') {\r\n                    $arguments += '$true'\r\n                }\r\n                elseif ($value -eq 'false') {\r\n                    $arguments += '$false'\r\n                }\r\n                else {\r\n                    $arguments += $value\r\n                }\r\n                $currentArg = \"\"\r\n            }\r\n        }\r\n        else {\r\n            $currentArg += $char\r\n        }\r\n    }\r\n    \r\n    # Add the last argument\r\n    if ($currentArg.Length -gt 0) {\r\n        $value = $currentArg.Trim('\"')\r\n        if ($value -eq 'true') {\r\n            $arguments += '$true'\r\n        }\r\n        elseif ($value -eq 'false') {\r\n            $arguments += '$false'\r\n        }\r\n        else {\r\n            $arguments += $value\r\n        }\r\n    }\r\n    \r\n    return $arguments\r\n}\r\n\r\nFunction ConvertTo-ParametersSplat {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @{}\r\n    }\r\n\r\n    $tokens = Split-ArgumentString -ArgumentString $ArgumentString\r\n    $parameters = @{}\r\n    \r\n    $i = 0\r\n    while ($i -lt $tokens.Count) {\r\n        $token = $tokens[$i]\r\n        \r\n        # If this is a parameter (starts with -)\r\n        if ($token -match '^-(\\w+)$') {\r\n            $paramName = $matches[1]  # Remove the dash\r\n            \r\n            # Check if there's a value following this parameter\r\n            if (($i + 1) -lt $tokens.Count -and $tokens[$i + 1] -notmatch '^-\\w+$') {\r\n                # Parameter with value\r\n                $i++  # Move to the value\r\n                $value = $tokens[$i]\r\n                \r\n                # Handle PowerShell booleans\r\n                if ($value -eq '$true') {\r\n                    $parameters[$paramName] = $true\r\n                }\r\n                elseif ($value -eq '$false') {\r\n                    $parameters[$paramName] = $false\r\n                }\r\n                else {\r\n                    # Remove quotes if present\r\n                    $cleanValue = $value.Trim('\"')\r\n                    $parameters[$paramName] = $cleanValue\r\n                }\r\n            }\r\n            else {\r\n                # This is a switch parameter (no value)\r\n                $parameters[$paramName] = $true\r\n            }\r\n        }\r\n        else {\r\n            # Handle positional arguments (rare in this context)\r\n            # You could add logic here if needed\r\n        }\r\n        \r\n        $i++\r\n    }\r\n    \r\n    return $parameters\r\n}\r\n\r\nStart-Transcript -Path \"$env:SystemRoot\\Logs\\$Name.log\" -Force\r\nWrite-OutputWithTimeStamp \"Starting '$Name' script with the following parameters.\"\r\nWrite-Output ( $PSBoundParameters | Format-Table -AutoSize )\r\nIf ($Arguments -eq '') { $Arguments = $null }\r\nIf ($BuildDir -ne '') {\r\n  $TempDir = Join-Path $BuildDir -ChildPath $Name\r\n} Else {\r\n  $TempDir = Join-Path $Env:TEMP -ChildPath $Name\r\n}\r\nNew-Item -Path $TempDir -ItemType Directory -Force | Out-Null\r\n$WebClient = New-Object System.Net.WebClient\r\nIf ($Uri -match $BlobStorageSuffix -and $UserAssignedIdentityClientId -ne '') {\r\n  Write-OutputWithTimeStamp \"Getting access token for '$Uri' using User Assigned Identity.\"\r\n  $StorageEndpoint = ($Uri -split \"://\")[0] + \"://\" + ($Uri -split \"/\")[2] + \"/\"\r\n  $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=$APIVersion&resource=$StorageEndpoint&client_id=$UserAssignedIdentityClientId\"\r\n  $AccessToken = ((Invoke-WebRequest -Headers @{Metadata = $true } -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n  $WebClient.Headers.Add('x-ms-version', '2017-11-09')\r\n  $webClient.Headers.Add(\"Authorization\", \"Bearer $AccessToken\")\r\n}\r\n$SourceFileName = ($Uri -Split \"/\")[-1]\r\nWrite-OutputWithTimeStamp \"Downloading '$Uri' to '$TempDir'.\"\r\n$DestFile = Join-Path -Path $TempDir -ChildPath $SourceFileName\r\n$webClient.DownloadFile(\"$Uri\", \"$DestFile\")\r\nStart-Sleep -Seconds 10\r\nIf (!(Test-Path -Path $DestFile)) { Write-Error \"Failed to download $SourceFileName\"; Exit 1 }\r\nWrite-OutputWithTimeStamp 'Finished downloading'\r\nSet-Location -Path $TempDir\r\n$Ext = [System.IO.Path]::GetExtension($DestFile).ToLower().Replace('.','')\r\nswitch ($Ext) {\r\n  'exe' {\r\n      If ($Arguments) {\r\n        Write-OutputWithTimeStamp \"Executing '`\"$DestFile`\" $Arguments'\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -ArgumentList (Split-ArgumentString -ArgumentString $Arguments) -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }\r\n      Else {\r\n        Write-OutputWithTimeStamp \"Executing `\"$DestFile`\"\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }      \r\n    }\r\n  'msi' {\r\n    If ($Arguments) {\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $InstallArg = \"/i $DestFile\"\r\n        $Arguments = @($InstallArg) + $Arguments\r\n      }\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe $Arguments'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList $Arguments -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe /i $DestFile /qn'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList \"/i $DestFile /qn\" -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }    \r\n  }\r\n  'bat' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\" $Arguments'\"\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $Arguments = @(\"$DestFile\") + $Arguments\r\n      }\r\n      Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\"'\"\r\n      Start-Process -FilePath cmd.exe -ArgumentList \"`\"$DestFile`\"\" -Wait\r\n    }\r\n  }\r\n  'ps1' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $DestFile @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile'\"\r\n      & $DestFile\r\n    }\r\n  }\r\n  'zip' {\r\n    $DestinationPath = Join-Path -Path \"$TempDir\" -ChildPath $([System.IO.Path]::GetFileNameWithoutExtension($SourceFileName))\r\n    Write-OutputWithTimeStamp \"Extracting '$DestFile' to '$DestinationPath'.\"\r\n    Expand-Archive -Path $DestFile -DestinationPath $DestinationPath -Force\r\n    Write-OutputWithTimeStamp \"Finding PowerShell script in root of '$DestinationPath'.\"\r\n    $PSScript = (Get-ChildItem -Path $DestinationPath -filter '*.ps1').FullName\r\n    If ($PSScript.count -gt 1) { $PSScript = $PSScript[0] }\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $PSScript @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$PSScript'\"         \r\n      & $PSScript\r\n    }\r\n  }\r\n}\r\nIf ((Split-Path $TempDir -Parent) -eq $Env:Temp) {Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue}\r\nStop-Transcript",
                                "apiVersion": "[[if(startsWith(environment().name, 'USN'), '2017-08-01', '2018-02-01')]"
                              },
                              "resources": [
                                {
                                  "[string('copy')]": {
                                    "name": "runCommands",
                                    "count": "[[length(variables('customizers'))]",
                                    "mode": "serial",
                                    "batchSize": 1
                                  },
                                  "type": "Microsoft.Compute/virtualMachines/runCommands",
                                  "apiVersion": "2023-03-01",
                                  "name": "[[format('{0}/{1}', parameters('virtualMachineName'), variables('customizers')[copyIndex()].name)]",
                                  "location": "[[parameters('location')]",
                                  "properties": {
                                    "parameters": [
                                      {
                                        "name": "APIVersion",
                                        "value": "[[variables('apiVersion')]"
                                      },
                                      {
                                        "name": "BlobStorageSuffix",
                                        "value": "[[format('blob.{0}', environment().suffixes.storage)]"
                                      },
                                      {
                                        "name": "UserAssignedIdentityClientId",
                                        "value": "[[parameters('userAssignedIdentityClientId')]"
                                      },
                                      {
                                        "name": "Name",
                                        "value": "[[variables('customizers')[copyIndex()].name]"
                                      },
                                      {
                                        "name": "Uri",
                                        "value": "[[variables('customizers')[copyIndex()].uri]"
                                      },
                                      {
                                        "name": "Arguments",
                                        "value": "[[variables('customizers')[copyIndex()].arguments]"
                                      }
                                    ],
                                    "source": {
                                      "script": "[[variables('$fxv#0')]"
                                    },
                                    "treatFailureAsDeploymentFailure": true
                                  }
                                }
                              ]
                            }
                          },
                          "dependsOn": [
                            "runCommand_ConfigureSessionHost",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "updateOSDiskNetworkAccess",
                            "count": "[[length(range(0, parameters('sessionHostCount')))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-disable-osDisk-PublicAccess-{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), parameters('deploymentSuffix'))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "diskAccessId": {
                                "value": "[[parameters('diskAccessId')]"
                              },
                              "diskName": {
                                "value": "[[reference(resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))), '2022-11-01').storageProfile.osDisk.name]"
                              },
                              "location": {
                                "value": "[[parameters('location')]"
                              },
                              "deploymentSuffix": {
                                "value": "[[parameters('deploymentSuffix')]"
                              },
                              "vmName": {
                                "value": "[[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "16266284306868602023"
                                }
                              },
                              "parameters": {
                                "diskAccessId": {
                                  "type": "string"
                                },
                                "diskName": {
                                  "type": "string"
                                },
                                "location": {
                                  "type": "string"
                                },
                                "deploymentSuffix": {
                                  "type": "string"
                                },
                                "vmName": {
                                  "type": "string"
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('Update-OSDisk-{0}-Stage2-{1}', parameters('vmName'), parameters('deploymentSuffix'))]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "diskName": {
                                        "value": "[[parameters('diskName')]"
                                      },
                                      "creationData": {
                                        "value": "[[reference(resourceId('Microsoft.Compute/disks', parameters('diskName')), '2023-10-02').creationData]"
                                      },
                                      "diskAccessId": {
                                        "value": "[[parameters('diskAccessId')]"
                                      },
                                      "location": {
                                        "value": "[[parameters('location')]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "17290095301135652436"
                                        }
                                      },
                                      "parameters": {
                                        "creationData": {
                                          "type": "object"
                                        },
                                        "diskName": {
                                          "type": "string"
                                        },
                                        "diskAccessId": {
                                          "type": "string"
                                        },
                                        "location": {
                                          "type": "string"
                                        }
                                      },
                                      "resources": [
                                        {
                                          "type": "Microsoft.Compute/disks",
                                          "apiVersion": "2023-10-02",
                                          "name": "[[parameters('diskName')]",
                                          "location": "[[parameters('location')]",
                                          "properties": {
                                            "diskAccessId": "[[if(empty(parameters('diskAccessId')), null(), parameters('diskAccessId'))]",
                                            "creationData": "[[parameters('creationData')]",
                                            "networkAccessPolicy": "[[if(empty(parameters('diskAccessId')), 'DenyAll', 'AllowPrivate')]",
                                            "publicNetworkAccess": "Disabled"
                                          }
                                        }
                                      ]
                                    }
                                  }
                                }
                              ]
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                            "[[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
                          ]
                        }
                      ],
                      "outputs": {
                        "virtualMachineNames": {
                          "type": "array",
                          "[string('copy')]": {
                            "count": "[[length(range(0, parameters('sessionHostCount')))]",
                            "input": "[[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
                          }
                        },
                        "fslogixPathExclusions": {
                          "type": "string",
                          "value": "[[variables('fslogixPathExclusions')]"
                        },
                        "fslogixStorageAccounts": {
                          "type": "array",
                          "value": "[[union(variables('fslogixLocalStorageAccountNames'), variables('fslogixRemoteStorageAccountNames'))]"
                        },
                        "fslogixNetAppServers": {
                          "type": "array",
                          "value": "[[union(parameters('fslogixLocalNetAppServerFqdns'), parameters('fslogixRemoteNetAppServerFqdns'))]"
                        }
                      }
                    }
                  },
                  "dependsOn": [
                    "[[subscriptionResourceId('Microsoft.Resources/deployments', format('ArtifactsUserAssignedIdentity-{0}', parameters('deploymentSuffix')))]",
                    "availabilitySets",
                    "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix')))]",
                    "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix')))]",
                    "[[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix')))]",
                    "localNetAppVolumes",
                    "remoteNetAppVolumes"
                  ]
                },
                {
                  "condition": "[[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('recoveryServices'))]",
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('RecoveryServicesVault-VirtualMachines-{0}', parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "location": {
                        "value": "[[parameters('location')]"
                      },
                      "name": {
                        "value": "[[parameters('recoveryServicesVaultName')]"
                      },
                      "backupPolicies": {
                        "value": [
                          {
                            "name": "[[variables('backupPolicyName')]",
                            "properties": {
                              "backupManagementType": "AzureIaasVM",
                              "instantRpRetentionRangeInDays": 2,
                              "policyType": "V2",
                              "retentionPolicy": {
                                "retentionPolicyType": "LongTermRetentionPolicy",
                                "dailySchedule": {
                                  "retentionDuration": {
                                    "count": 30,
                                    "durationType": "Days"
                                  },
                                  "retentionTimes": [
                                    "23:00"
                                  ]
                                }
                              },
                              "schedulePolicy": {
                                "schedulePolicyType": "SimpleSchedulePolicyV2",
                                "scheduleRunFrequency": "Daily",
                                "dailySchedule": {
                                  "scheduleRunTimes": [
                                    "23:00"
                                  ]
                                }
                              },
                              "timeZone": "[[parameters('timeZone')]"
                            }
                          }
                        ]
                      },
                      "privateEndpoints": "[[if(and(and(and(and(parameters('privateEndpoint'), not(empty(parameters('privateEndpointSubnetResourceId')))), not(empty(parameters('azureBackupPrivateDnsZoneResourceId')))), not(empty(parameters('azureBlobPrivateDnsZoneResourceId')))), not(empty(parameters('azureQueuePrivateDnsZoneResourceId')))), createObject('value', createArray(createObject('customNetworkInterfaceName', replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', 'AzureBackup'), 'RESOURCE', parameters('recoveryServicesVaultName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8])), 'name', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'AzureBackup'), 'RESOURCE', parameters('recoveryServicesVaultName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8])), 'privateDnsZoneGroup', if(empty(variables('nonEmptyBackupPrivateDNSZoneResourceIds')), null(), createObject('privateDNSResourceIds', variables('nonEmptyBackupPrivateDNSZoneResourceIds'))), 'service', 'AzureBackup', 'subnetResourceId', parameters('privateEndpointSubnetResourceId'), 'tags', union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()))))), createObject('value', null()))]",
                      "diagnosticWorkspaceId": {
                        "value": "[[parameters('logAnalyticsWorkspaceResourceId')]"
                      },
                      "tags": {
                        "value": "[[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.recoveryServices/vaults'), createObject()))]"
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "1183717082371637162"
                        }
                      },
                      "parameters": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Name of the Azure Recovery Service Vault."
                          }
                        },
                        "backupStorageConfig": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. The storage configuration for the Azure Recovery Service Vault."
                          }
                        },
                        "location": {
                          "type": "string",
                          "defaultValue": "[[resourceGroup().location]",
                          "metadata": {
                            "description": "Optional. Location for all resources."
                          }
                        },
                        "backupPolicies": {
                          "type": "array",
                          "defaultValue": [],
                          "metadata": {
                            "description": "Optional. List of all backup policies."
                          }
                        },
                        "backupConfig": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. The backup configuration."
                          }
                        },
                        "protectionContainers": {
                          "type": "array",
                          "defaultValue": [],
                          "minLength": 0,
                          "metadata": {
                            "description": "Optional. List of all protection containers."
                          }
                        },
                        "replicationFabrics": {
                          "type": "array",
                          "defaultValue": [],
                          "minLength": 0,
                          "metadata": {
                            "description": "Optional. List of all replication fabrics."
                          }
                        },
                        "replicationPolicies": {
                          "type": "array",
                          "defaultValue": [],
                          "minLength": 0,
                          "metadata": {
                            "description": "Optional. List of all replication policies."
                          }
                        },
                        "replicationAlertSettings": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. Replication alert settings."
                          }
                        },
                        "diagnosticStorageAccountId": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic storage account."
                          }
                        },
                        "diagnosticWorkspaceId": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic log analytics workspace."
                          }
                        },
                        "diagnosticEventHubAuthorizationRuleId": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                          }
                        },
                        "diagnosticEventHubName": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category."
                          }
                        },
                        "systemAssignedIdentity": {
                          "type": "bool",
                          "defaultValue": false,
                          "metadata": {
                            "description": "Optional. Enables system assigned managed identity on the resource."
                          }
                        },
                        "userAssignedIdentities": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. The ID(s) to assign to the resource."
                          }
                        },
                        "tags": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. Tags of the Recovery Service Vault resource."
                          }
                        },
                        "diagnosticLogCategoriesToEnable": {
                          "type": "array",
                          "defaultValue": [
                            "allLogs"
                          ],
                          "allowedValues": [
                            "",
                            "allLogs",
                            "AzureBackupReport",
                            "CoreAzureBackup",
                            "AddonAzureBackupJobs",
                            "AddonAzureBackupAlerts",
                            "AddonAzureBackupPolicy",
                            "AddonAzureBackupStorage",
                            "AddonAzureBackupProtectedInstance",
                            "AzureSiteRecoveryJobs",
                            "AzureSiteRecoveryEvents",
                            "AzureSiteRecoveryReplicatedItems",
                            "AzureSiteRecoveryReplicationStats",
                            "AzureSiteRecoveryRecoveryPoints",
                            "AzureSiteRecoveryReplicationDataUploadRate",
                            "AzureSiteRecoveryProtectedDiskDataChurn"
                          ],
                          "metadata": {
                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to '' to disable log collection."
                          }
                        },
                        "diagnosticMetricsToEnable": {
                          "type": "array",
                          "defaultValue": [
                            "AllMetrics"
                          ],
                          "allowedValues": [
                            "AllMetrics"
                          ],
                          "metadata": {
                            "description": "Optional. The name of metrics that will be streamed."
                          }
                        },
                        "diagnosticSettingsName": {
                          "type": "string",
                          "defaultValue": "",
                          "metadata": {
                            "description": "Optional. The name of the diagnostic setting, if deployed. If left empty, it defaults to \"<resourceName>-diagnosticSettings\"."
                          }
                        },
                        "privateEndpoints": {
                          "type": "array",
                          "defaultValue": [],
                          "metadata": {
                            "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
                          }
                        },
                        "monitoringSettings": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. Monitoring Settings of the vault."
                          }
                        },
                        "securitySettings": {
                          "type": "object",
                          "defaultValue": {},
                          "metadata": {
                            "description": "Optional. Security Settings of the vault."
                          }
                        },
                        "publicNetworkAccess": {
                          "type": "string",
                          "defaultValue": "Disabled",
                          "allowedValues": [
                            "Enabled",
                            "Disabled"
                          ],
                          "metadata": {
                            "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled."
                          }
                        }
                      },
                      "variables": {
                        "[string('copy')]": [
                          {
                            "name": "diagnosticsLogsSpecified",
                            "count": "[[length(filter(parameters('diagnosticLogCategoriesToEnable'), lambda('item', and(not(equals(lambdaVariables('item'), 'allLogs')), not(equals(lambdaVariables('item'), ''))))))]",
                            "input": {
                              "category": "[[filter(parameters('diagnosticLogCategoriesToEnable'), lambda('item', and(not(equals(lambdaVariables('item'), 'allLogs')), not(equals(lambdaVariables('item'), '')))))[copyIndex('diagnosticsLogsSpecified')]]",
                              "enabled": true
                            }
                          },
                          {
                            "name": "diagnosticsMetrics",
                            "count": "[[length(parameters('diagnosticMetricsToEnable'))]",
                            "input": {
                              "category": "[[parameters('diagnosticMetricsToEnable')[copyIndex('diagnosticsMetrics')]]",
                              "timeGrain": null,
                              "enabled": true
                            }
                          }
                        ],
                        "diagnosticsLogs": "[[if(contains(parameters('diagnosticLogCategoriesToEnable'), 'allLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true())), if(contains(parameters('diagnosticLogCategoriesToEnable'), ''), createArray(), variables('diagnosticsLogsSpecified')))]",
                        "identityType": "[[if(parameters('systemAssignedIdentity'), if(not(empty(parameters('userAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(parameters('userAssignedIdentities'))), 'UserAssigned', 'None'))]",
                        "identity": "[[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(parameters('userAssignedIdentities'))), parameters('userAssignedIdentities'), null())), null())]"
                      },
                      "resources": [
                        {
                          "type": "Microsoft.RecoveryServices/vaults",
                          "apiVersion": "2023-01-01",
                          "name": "[[parameters('name')]",
                          "location": "[[parameters('location')]",
                          "tags": "[[parameters('tags')]",
                          "identity": "[[variables('identity')]",
                          "sku": {
                            "name": "RS0",
                            "tier": "Standard"
                          },
                          "properties": {
                            "monitoringSettings": "[[if(not(empty(parameters('monitoringSettings'))), parameters('monitoringSettings'), null())]",
                            "securitySettings": "[[if(not(empty(parameters('securitySettings'))), parameters('securitySettings'), null())]",
                            "publicNetworkAccess": "[[parameters('publicNetworkAccess')]"
                          }
                        },
                        {
                          "condition": "[[or(or(or(not(empty(parameters('diagnosticStorageAccountId'))), not(empty(parameters('diagnosticWorkspaceId')))), not(empty(parameters('diagnosticEventHubAuthorizationRuleId')))), not(empty(parameters('diagnosticEventHubName'))))]",
                          "type": "Microsoft.Insights/diagnosticSettings",
                          "apiVersion": "2021-05-01-preview",
                          "scope": "[[format('Microsoft.RecoveryServices/vaults/{0}', parameters('name'))]",
                          "name": "[[if(not(empty(parameters('diagnosticSettingsName'))), parameters('diagnosticSettingsName'), format('{0}-diagnosticSettings', parameters('name')))]",
                          "properties": {
                            "storageAccountId": "[[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                            "workspaceId": "[[if(not(empty(parameters('diagnosticWorkspaceId'))), parameters('diagnosticWorkspaceId'), null())]",
                            "eventHubAuthorizationRuleId": "[[if(not(empty(parameters('diagnosticEventHubAuthorizationRuleId'))), parameters('diagnosticEventHubAuthorizationRuleId'), null())]",
                            "eventHubName": "[[if(not(empty(parameters('diagnosticEventHubName'))), parameters('diagnosticEventHubName'), null())]",
                            "metrics": "[[if(equals(environment().name, 'AzureCloud'), variables('diagnosticsMetrics'), null())]",
                            "logs": "[[variables('diagnosticsLogs')]"
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "rsv_replicationFabrics",
                            "count": "[[length(parameters('replicationFabrics'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-Fabric-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "name": {
                                "value": "[[coalesce(tryGet(parameters('replicationFabrics')[copyIndex()], 'name'), parameters('replicationFabrics')[copyIndex()].location)]"
                              },
                              "location": {
                                "value": "[[parameters('replicationFabrics')[copyIndex()].location]"
                              },
                              "replicationContainers": {
                                "value": "[[coalesce(tryGet(parameters('replicationFabrics')[copyIndex()], 'replicationContainers'), createArray())]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "9020517797192270065"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Required. The recovery location the fabric represents."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "defaultValue": "[[parameters('location')]",
                                  "metadata": {
                                    "description": "Optional. The name of the fabric."
                                  }
                                },
                                "replicationContainers": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Replication containers to create."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/replicationFabrics",
                                  "apiVersion": "2022-10-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "customDetails": {
                                      "instanceType": "Azure",
                                      "location": "[[parameters('location')]"
                                    }
                                  }
                                },
                                {
                                  "[string('copy')]": {
                                    "name": "fabric_replicationContainers",
                                    "count": "[[length(parameters('replicationContainers'))]"
                                  },
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('RCont-{0}-{1}', copyIndex(), deployment().name)]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "name": {
                                        "value": "[[parameters('replicationContainers')[copyIndex()].name]"
                                      },
                                      "recoveryVaultName": {
                                        "value": "[[parameters('recoveryVaultName')]"
                                      },
                                      "replicationFabricName": {
                                        "value": "[[parameters('name')]"
                                      },
                                      "replicationContainerMappings": {
                                        "value": "[[coalesce(tryGet(parameters('replicationContainers')[copyIndex()], 'replicationContainerMappings'), createArray())]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "7589503989052678595"
                                        },
                                        "name": "Recovery Services Vault Replication Fabric Replication Protection Containers",
                                        "description": "This module deploys a Recovery Services Vault Replication Protection Container.\r\n\r\n> **Note**: this version of the module only supports the `instanceType: 'A2A'` scenario.",
                                        "owner": "Azure/module-maintainers"
                                      },
                                      "parameters": {
                                        "recoveryVaultName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "replicationFabricName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. The name of the parent Replication Fabric. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the replication container."
                                          }
                                        },
                                        "replicationContainerMappings": {
                                          "type": "array",
                                          "defaultValue": [],
                                          "metadata": {
                                            "description": "Optional. Replication containers mappings to create."
                                          }
                                        }
                                      },
                                      "resources": [
                                        {
                                          "type": "Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers",
                                          "apiVersion": "2022-10-01",
                                          "name": "[[format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name'))]",
                                          "properties": {
                                            "providerSpecificInput": [
                                              {
                                                "instanceType": "A2A"
                                              }
                                            ]
                                          }
                                        },
                                        {
                                          "[string('copy')]": {
                                            "name": "fabric_container_containerMappings",
                                            "count": "[[length(parameters('replicationContainerMappings'))]"
                                          },
                                          "type": "Microsoft.Resources/deployments",
                                          "apiVersion": "2025-04-01",
                                          "name": "[[format('Map-{0}-{1}', copyIndex(), deployment().name)]",
                                          "properties": {
                                            "expressionEvaluationOptions": {
                                              "scope": "inner"
                                            },
                                            "mode": "Incremental",
                                            "parameters": {
                                              "name": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'name'), '')]"
                                              },
                                              "policyId": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'policyId'), '')]"
                                              },
                                              "policyName": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'policyName'), '')]"
                                              },
                                              "recoveryVaultName": {
                                                "value": "[[parameters('recoveryVaultName')]"
                                              },
                                              "replicationFabricName": {
                                                "value": "[[parameters('replicationFabricName')]"
                                              },
                                              "sourceProtectionContainerName": {
                                                "value": "[[parameters('name')]"
                                              },
                                              "targetProtectionContainerId": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetProtectionContainerId'), '')]"
                                              },
                                              "targetContainerFabricName": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetContainerFabricName'), parameters('replicationFabricName'))]"
                                              },
                                              "targetContainerName": {
                                                "value": "[[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetContainerName'), '')]"
                                              }
                                            },
                                            "template": {
                                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                              "contentVersion": "1.0.0.0",
                                              "metadata": {
                                                "_generator": {
                                                  "name": "bicep",
                                                  "version": "0.39.26.7824",
                                                  "templateHash": "10236435086576278421"
                                                },
                                                "name": "Recovery Services Vault Replication Fabric Replication Protection Container Replication Protection Container Mappings",
                                                "description": "This module deploys a Recovery Services Vault (RSV) Replication Protection Container Mapping.\r\n\r\n> **Note**: this version of the module only supports the `instanceType: 'A2A'` scenario.",
                                                "owner": "Azure/module-maintainers"
                                              },
                                              "parameters": {
                                                "recoveryVaultName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                                  }
                                                },
                                                "replicationFabricName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Conditional. The name of the parent Replication Fabric. Required if the template is used in a standalone deployment."
                                                  }
                                                },
                                                "sourceProtectionContainerName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Conditional. The name of the parent source Replication container. Required if the template is used in a standalone deployment."
                                                  }
                                                },
                                                "targetProtectionContainerId": {
                                                  "type": "string",
                                                  "defaultValue": "",
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the target Replication container. Must be specified if targetContainerName is not. If specified, targetContainerFabricName and targetContainerName will be ignored."
                                                  }
                                                },
                                                "targetContainerFabricName": {
                                                  "type": "string",
                                                  "defaultValue": "[[parameters('replicationFabricName')]",
                                                  "metadata": {
                                                    "description": "Optional. Name of the fabric containing the target container. If targetProtectionContainerId is specified, this parameter will be ignored."
                                                  }
                                                },
                                                "targetContainerName": {
                                                  "type": "string",
                                                  "defaultValue": "",
                                                  "metadata": {
                                                    "description": "Optional. Name of the target container. Must be specified if targetProtectionContainerId is not. If targetProtectionContainerId is specified, this parameter will be ignored."
                                                  }
                                                },
                                                "policyId": {
                                                  "type": "string",
                                                  "defaultValue": "",
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the replication policy. If defined, policyName will be ignored."
                                                  }
                                                },
                                                "policyName": {
                                                  "type": "string",
                                                  "defaultValue": "",
                                                  "metadata": {
                                                    "description": "Optional. Name of the replication policy. Will be ignored if policyId is also specified."
                                                  }
                                                },
                                                "name": {
                                                  "type": "string",
                                                  "defaultValue": "",
                                                  "metadata": {
                                                    "description": "Optional. The name of the replication container mapping. If not provided, it will be automatically generated as `<source_container_name>-<target_container_name>`."
                                                  }
                                                }
                                              },
                                              "variables": {
                                                "policyResourceId": "[[if(not(equals(parameters('policyId'), '')), parameters('policyId'), subscriptionResourceId('Microsoft.RecoveryServices/vaults/replicationPolicies', parameters('recoveryVaultName'), parameters('policyName')))]",
                                                "targetProtectionContainerResourceId": "[[if(not(equals(parameters('targetProtectionContainerId'), '')), parameters('targetProtectionContainerId'), subscriptionResourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', parameters('recoveryVaultName'), parameters('targetContainerFabricName'), parameters('targetContainerName')))]",
                                                "mappingName": "[[if(not(empty(parameters('name'))), parameters('name'), format('{0}-{1}', parameters('sourceProtectionContainerName'), split(variables('targetProtectionContainerResourceId'), '/')[10]))]"
                                              },
                                              "resources": [
                                                {
                                                  "type": "Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectionContainerMappings",
                                                  "apiVersion": "2022-10-01",
                                                  "name": "[[format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName'))]",
                                                  "properties": {
                                                    "targetProtectionContainerId": "[[variables('targetProtectionContainerResourceId')]",
                                                    "policyId": "[[variables('policyResourceId')]",
                                                    "providerSpecificInput": {
                                                      "instanceType": "A2A"
                                                    }
                                                  }
                                                }
                                              ],
                                              "outputs": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The name of the replication container."
                                                  },
                                                  "value": "[[format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName'))]"
                                                },
                                                "resourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The resource ID of the replication container."
                                                  },
                                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectionContainerMappings', split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[0], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[1], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[2], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[3])]"
                                                },
                                                "resourceGroupName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The name of the resource group the replication container was created in."
                                                  },
                                                  "value": "[[resourceGroup().name]"
                                                }
                                              }
                                            }
                                          },
                                          "dependsOn": [
                                            "[[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[0], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[1], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[2])]"
                                          ]
                                        }
                                      ],
                                      "outputs": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the replication container."
                                          },
                                          "value": "[[format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name'))]"
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the replication container."
                                          },
                                          "value": "[[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[0], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[1], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[2])]"
                                        },
                                        "resourceGroupName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the resource group the replication container was created in."
                                          },
                                          "value": "[[resourceGroup().name]"
                                        }
                                      }
                                    }
                                  },
                                  "dependsOn": [
                                    "[[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                                  ]
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the replication fabric."
                                  },
                                  "value": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the replication fabric."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the resource group the replication fabric was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]",
                            "rsv_replicationPolicies"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "rsv_replicationPolicies",
                            "count": "[[length(parameters('replicationPolicies'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-Policy-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "name": {
                                "value": "[[parameters('replicationPolicies')[copyIndex()].name]"
                              },
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "appConsistentFrequencyInMinutes": {
                                "value": "[[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'appConsistentFrequencyInMinutes'), 60)]"
                              },
                              "crashConsistentFrequencyInMinutes": {
                                "value": "[[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'crashConsistentFrequencyInMinutes'), 5)]"
                              },
                              "multiVmSyncStatus": {
                                "value": "[[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'multiVmSyncStatus'), 'Enable')]"
                              },
                              "recoveryPointHistory": {
                                "value": "[[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'recoveryPointHistory'), 1440)]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "6687773637167043684"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The name of the replication policy."
                                  }
                                },
                                "appConsistentFrequencyInMinutes": {
                                  "type": "int",
                                  "defaultValue": 60,
                                  "metadata": {
                                    "description": "Optional. The app consistent snapshot frequency (in minutes)."
                                  }
                                },
                                "crashConsistentFrequencyInMinutes": {
                                  "type": "int",
                                  "defaultValue": 5,
                                  "metadata": {
                                    "description": "Optional. The crash consistent snapshot frequency (in minutes)."
                                  }
                                },
                                "multiVmSyncStatus": {
                                  "type": "string",
                                  "defaultValue": "Enable",
                                  "allowedValues": [
                                    "Enable",
                                    "Disable"
                                  ],
                                  "metadata": {
                                    "description": "Optional. A value indicating whether multi-VM sync has to be enabled."
                                  }
                                },
                                "recoveryPointHistory": {
                                  "type": "int",
                                  "defaultValue": 1440,
                                  "metadata": {
                                    "description": "Optional. The duration in minutes until which the recovery points need to be stored."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/replicationPolicies",
                                  "apiVersion": "2022-10-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "providerSpecificInput": {
                                      "instanceType": "A2A",
                                      "appConsistentFrequencyInMinutes": "[[parameters('appConsistentFrequencyInMinutes')]",
                                      "crashConsistentFrequencyInMinutes": "[[parameters('crashConsistentFrequencyInMinutes')]",
                                      "multiVmSyncStatus": "[[parameters('multiVmSyncStatus')]",
                                      "recoveryPointHistory": "[[parameters('recoveryPointHistory')]"
                                    }
                                  }
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the replication policy."
                                  },
                                  "value": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the replication policy."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/replicationPolicies', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the resource group the replication policy was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "condition": "[[not(empty(parameters('backupStorageConfig')))]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-BackupStorageConfig', uniqueString(deployment().name, parameters('location')))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "storageModelType": {
                                "value": "[[parameters('backupStorageConfig').storageModelType]"
                              },
                              "crossRegionRestoreFlag": {
                                "value": "[[parameters('backupStorageConfig').crossRegionRestoreFlag]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "13450726873363153760"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "defaultValue": "vaultstorageconfig",
                                  "metadata": {
                                    "description": "Optional. The name of the backup storage config."
                                  }
                                },
                                "storageModelType": {
                                  "type": "string",
                                  "defaultValue": "GeoRedundant",
                                  "allowedValues": [
                                    "GeoRedundant",
                                    "LocallyRedundant",
                                    "ReadAccessGeoZoneRedundant",
                                    "ZoneRedundant"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Change Vault Storage Type (Works if vault has not registered any backup instance)."
                                  }
                                },
                                "crossRegionRestoreFlag": {
                                  "type": "bool",
                                  "defaultValue": true,
                                  "metadata": {
                                    "description": "Optional. Opt in details of Cross Region Restore feature."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/backupstorageconfig",
                                  "apiVersion": "2023-01-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "storageModelType": "[[parameters('storageModelType')]",
                                    "crossRegionRestoreFlag": "[[parameters('crossRegionRestoreFlag')]"
                                  }
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the backup storage config."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the backup storage config."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/backupstorageconfig', parameters('recoveryVaultName'), parameters('name'))]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the Resource Group the backup storage configuration was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "rsv_backupFabric_protectionContainers",
                            "count": "[[length(parameters('protectionContainers'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-ProtectionContainers-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "name": {
                                "value": "[[parameters('protectionContainers')[copyIndex()].name]"
                              },
                              "sourceResourceId": {
                                "value": "[[parameters('protectionContainers')[copyIndex()].sourceResourceId]"
                              },
                              "friendlyName": {
                                "value": "[[parameters('protectionContainers')[copyIndex()].friendlyName]"
                              },
                              "backupManagementType": {
                                "value": "[[parameters('protectionContainers')[copyIndex()].backupManagementType]"
                              },
                              "containerType": {
                                "value": "[[parameters('protectionContainers')[copyIndex()].containerType]"
                              },
                              "protectedItems": {
                                "value": "[[coalesce(tryGet(parameters('protectionContainers')[copyIndex()], 'protectedItems'), createArray())]"
                              },
                              "location": {
                                "value": "[[parameters('location')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "15595070997508437554"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Name of the Azure Recovery Service Vault Protection Container."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Optional. Location for all resources."
                                  }
                                },
                                "backupManagementType": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "allowedValues": [
                                    "AzureBackupServer",
                                    "AzureIaasVM",
                                    "AzureSql",
                                    "AzureStorage",
                                    "AzureWorkload",
                                    "DPM",
                                    "DefaultBackup",
                                    "Invalid",
                                    "MAB",
                                    ""
                                  ],
                                  "metadata": {
                                    "description": "Optional. Backup management type to execute the current Protection Container job."
                                  }
                                },
                                "sourceResourceId": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Resource ID of the target resource for the Protection Container."
                                  }
                                },
                                "friendlyName": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. Friendly name of the Protection Container."
                                  }
                                },
                                "protectedItems": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Protected items to register in the container."
                                  }
                                },
                                "containerType": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "allowedValues": [
                                    "AzureBackupServerContainer",
                                    "AzureSqlContainer",
                                    "GenericContainer",
                                    "Microsoft.ClassicCompute/virtualMachines",
                                    "Microsoft.Compute/virtualMachines",
                                    "SQLAGWorkLoadContainer",
                                    "StorageContainer",
                                    "VMAppContainer",
                                    "Windows",
                                    ""
                                  ],
                                  "metadata": {
                                    "description": "Optional. Type of the container."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers",
                                  "apiVersion": "2023-01-01",
                                  "name": "[[format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "sourceResourceId": "[[if(not(empty(parameters('sourceResourceId'))), parameters('sourceResourceId'), null())]",
                                    "friendlyName": "[[if(not(empty(parameters('friendlyName'))), parameters('friendlyName'), null())]",
                                    "backupManagementType": "[[if(not(empty(parameters('backupManagementType'))), parameters('backupManagementType'), null())]",
                                    "containerType": "[[if(not(empty(parameters('containerType'))), parameters('containerType'), null())]"
                                  }
                                },
                                {
                                  "[string('copy')]": {
                                    "name": "protectionContainer_protectedItems",
                                    "count": "[[length(parameters('protectedItems'))]"
                                  },
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('ProtectedItem-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "policyId": {
                                        "value": "[[parameters('protectedItems')[copyIndex()].policyId]"
                                      },
                                      "name": {
                                        "value": "[[parameters('protectedItems')[copyIndex()].name]"
                                      },
                                      "protectedItemType": {
                                        "value": "[[parameters('protectedItems')[copyIndex()].protectedItemType]"
                                      },
                                      "protectionContainerName": {
                                        "value": "[[parameters('name')]"
                                      },
                                      "recoveryVaultName": {
                                        "value": "[[parameters('recoveryVaultName')]"
                                      },
                                      "sourceResourceId": {
                                        "value": "[[parameters('protectedItems')[copyIndex()].sourceResourceId]"
                                      },
                                      "location": {
                                        "value": "[[parameters('location')]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "7228594859436149519"
                                        }
                                      },
                                      "parameters": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the resource."
                                          }
                                        },
                                        "protectionContainerName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. Name of the Azure Recovery Service Vault Protection Container. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "recoveryVaultName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "defaultValue": "[[resourceGroup().location]",
                                          "metadata": {
                                            "description": "Optional. Location for all resources."
                                          }
                                        },
                                        "protectedItemType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureFileShareProtectedItem",
                                            "AzureVmWorkloadSAPAseDatabase",
                                            "AzureVmWorkloadSAPHanaDatabase",
                                            "AzureVmWorkloadSQLDatabase",
                                            "DPMProtectedItem",
                                            "GenericProtectedItem",
                                            "MabFileFolderProtectedItem",
                                            "Microsoft.ClassicCompute/virtualMachines",
                                            "Microsoft.Compute/virtualMachines",
                                            "Microsoft.Sql/servers/databases"
                                          ],
                                          "metadata": {
                                            "description": "Required. The backup item type."
                                          }
                                        },
                                        "policyId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. ID of the backup policy with which this item is backed up."
                                          }
                                        },
                                        "sourceResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the resource to back up."
                                          }
                                        }
                                      },
                                      "resources": [
                                        {
                                          "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                                          "apiVersion": "2023-01-01",
                                          "name": "[[format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name'))]",
                                          "location": "[[parameters('location')]",
                                          "properties": {
                                            "protectedItemType": "[[parameters('protectedItemType')]",
                                            "policyId": "[[parameters('policyId')]",
                                            "sourceResourceId": "[[parameters('sourceResourceId')]"
                                          }
                                        }
                                      ],
                                      "outputs": {
                                        "resourceGroupName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the Resource Group the protected item was created in."
                                          },
                                          "value": "[[resourceGroup().name]"
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the protected item."
                                          },
                                          "value": "[[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems', split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[2], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[3])]"
                                        },
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The Name of the protected item."
                                          },
                                          "value": "[[format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name'))]"
                                        }
                                      }
                                    }
                                  },
                                  "dependsOn": [
                                    "[[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[2])]"
                                  ]
                                }
                              ],
                              "outputs": {
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the Resource Group the Protection Container was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the Protection Container."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[2])]"
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The Name of the Protection Container."
                                  },
                                  "value": "[[format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "rsv_backupPolicies",
                            "count": "[[length(parameters('backupPolicies'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-BackupPolicy-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "name": {
                                "value": "[[parameters('backupPolicies')[copyIndex()].name]"
                              },
                              "properties": {
                                "value": "[[parameters('backupPolicies')[copyIndex()].properties]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "3466374396884104128"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Name of the Azure Recovery Service Vault Backup Policy."
                                  }
                                },
                                "properties": {
                                  "type": "object",
                                  "metadata": {
                                    "description": "Required. Configuration of the Azure Recovery Service Vault Backup Policy."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                                  "apiVersion": "2023-01-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": "[[parameters('properties')]"
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the backup policy."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the backup policy."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('recoveryVaultName'), parameters('name'))]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the resource group the backup policy was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "condition": "[[not(empty(parameters('backupConfig')))]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('{0}-RSV-BackupConfig', uniqueString(deployment().name, parameters('location')))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "name": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'name'), 'vaultconfig')]"
                              },
                              "enhancedSecurityState": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'enhancedSecurityState'), 'Enabled')]"
                              },
                              "resourceGuardOperationRequests": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'resourceGuardOperationRequests'), createArray())]"
                              },
                              "softDeleteFeatureState": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'softDeleteFeatureState'), 'Enabled')]"
                              },
                              "storageModelType": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'storageModelType'), 'GeoRedundant')]"
                              },
                              "storageType": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'storageType'), 'GeoRedundant')]"
                              },
                              "storageTypeState": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'storageTypeState'), 'Locked')]"
                              },
                              "isSoftDeleteFeatureStateEditable": {
                                "value": "[[coalesce(tryGet(parameters('backupConfig'), 'isSoftDeleteFeatureStateEditable'), true())]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "12731956892465777278"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "defaultValue": "vaultconfig",
                                  "metadata": {
                                    "description": "Optional. Name of the Azure Recovery Service Vault Backup Policy."
                                  }
                                },
                                "enhancedSecurityState": {
                                  "type": "string",
                                  "defaultValue": "Enabled",
                                  "allowedValues": [
                                    "Disabled",
                                    "Enabled"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Enable this setting to protect hybrid backups against accidental deletes and add additional layer of authentication for critical operations."
                                  }
                                },
                                "resourceGuardOperationRequests": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. ResourceGuard Operation Requests."
                                  }
                                },
                                "softDeleteFeatureState": {
                                  "type": "string",
                                  "defaultValue": "Enabled",
                                  "allowedValues": [
                                    "Disabled",
                                    "Enabled"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Enable this setting to protect backup data for Azure VM, SQL Server in Azure VM and SAP HANA in Azure VM from accidental deletes."
                                  }
                                },
                                "storageModelType": {
                                  "type": "string",
                                  "defaultValue": "GeoRedundant",
                                  "allowedValues": [
                                    "GeoRedundant",
                                    "LocallyRedundant",
                                    "ReadAccessGeoZoneRedundant",
                                    "ZoneRedundant"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Storage type."
                                  }
                                },
                                "storageType": {
                                  "type": "string",
                                  "defaultValue": "GeoRedundant",
                                  "allowedValues": [
                                    "GeoRedundant",
                                    "LocallyRedundant",
                                    "ReadAccessGeoZoneRedundant",
                                    "ZoneRedundant"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Storage type."
                                  }
                                },
                                "storageTypeState": {
                                  "type": "string",
                                  "defaultValue": "Locked",
                                  "allowedValues": [
                                    "Locked",
                                    "Unlocked"
                                  ],
                                  "metadata": {
                                    "description": "Optional. Once a machine is registered against a resource, the storageTypeState is always Locked."
                                  }
                                },
                                "isSoftDeleteFeatureStateEditable": {
                                  "type": "bool",
                                  "defaultValue": true,
                                  "metadata": {
                                    "description": "Optional. Is soft delete feature state editable."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/backupconfig",
                                  "apiVersion": "2023-01-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "enhancedSecurityState": "[[parameters('enhancedSecurityState')]",
                                    "resourceGuardOperationRequests": "[[parameters('resourceGuardOperationRequests')]",
                                    "softDeleteFeatureState": "[[parameters('softDeleteFeatureState')]",
                                    "storageModelType": "[[parameters('storageModelType')]",
                                    "storageType": "[[parameters('storageType')]",
                                    "storageTypeState": "[[parameters('storageTypeState')]",
                                    "isSoftDeleteFeatureStateEditable": "[[parameters('isSoftDeleteFeatureStateEditable')]"
                                  }
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the backup config."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the backup config."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/backupconfig', parameters('recoveryVaultName'), parameters('name'))]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the resource group the backup config was created in."
                                  },
                                  "value": "[[resourceGroup().name]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "condition": "[[not(empty(parameters('replicationAlertSettings')))]",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('RSV-replicationAlertSettings-{0}', uniqueString(deployment().name, parameters('location')))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "name": {
                                "value": "defaultAlertSetting"
                              },
                              "recoveryVaultName": {
                                "value": "[[parameters('name')]"
                              },
                              "customEmailAddresses": {
                                "value": "[[coalesce(tryGet(parameters('replicationAlertSettings'), 'customEmailAddresses'), createArray())]"
                              },
                              "locale": {
                                "value": "[[coalesce(tryGet(parameters('replicationAlertSettings'), 'locale'), '')]"
                              },
                              "sendToOwners": {
                                "value": "[[coalesce(tryGet(parameters('replicationAlertSettings'), 'sendToOwners'), 'Send')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "2041586627371120882"
                                }
                              },
                              "parameters": {
                                "recoveryVaultName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                  }
                                },
                                "name": {
                                  "type": "string",
                                  "defaultValue": "defaultAlertSetting",
                                  "metadata": {
                                    "description": "Optional. The name of the replication Alert Setting."
                                  }
                                },
                                "customEmailAddresses": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Comma separated list of custom email address for sending alert emails."
                                  }
                                },
                                "locale": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. The locale for the email notification."
                                  }
                                },
                                "sendToOwners": {
                                  "type": "string",
                                  "defaultValue": "Send",
                                  "allowedValues": [
                                    "DoNotSend",
                                    "Send"
                                  ],
                                  "metadata": {
                                    "description": "Optional. The value indicating whether to send email to subscription administrator."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.RecoveryServices/vaults/replicationAlertSettings",
                                  "apiVersion": "2022-10-01",
                                  "name": "[[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                                  "properties": {
                                    "customEmailAddresses": "[[if(not(empty(parameters('customEmailAddresses'))), parameters('customEmailAddresses'), null())]",
                                    "locale": "[[parameters('locale')]",
                                    "sendToOwners": "[[parameters('sendToOwners')]"
                                  }
                                }
                              ],
                              "outputs": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the replication Alert Setting."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the resource group the replication alert setting was created."
                                  },
                                  "value": "[[resourceGroup().name]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the replication alert setting."
                                  },
                                  "value": "[[resourceId('Microsoft.RecoveryServices/vaults/replicationAlertSettings', parameters('recoveryVaultName'), parameters('name'))]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        },
                        {
                          "[string('copy')]": {
                            "name": "rsv_privateEndpoints",
                            "count": "[[length(parameters('privateEndpoints'))]"
                          },
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2025-04-01",
                          "name": "[[format('RSV-PrivateEndpoint-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                          "properties": {
                            "expressionEvaluationOptions": {
                              "scope": "inner"
                            },
                            "mode": "Incremental",
                            "parameters": {
                              "groupIds": {
                                "value": [
                                  "[[parameters('privateEndpoints')[copyIndex()].service]"
                                ]
                              },
                              "name": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'name'), format('pe-{0}-{1}-{2}', last(split(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '/')), parameters('privateEndpoints')[copyIndex()].service, copyIndex()))]"
                              },
                              "serviceResourceId": {
                                "value": "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                              },
                              "subnetResourceId": {
                                "value": "[[parameters('privateEndpoints')[copyIndex()].subnetResourceId]"
                              },
                              "location": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'location'), reference(split(parameters('privateEndpoints')[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                              },
                              "privateDnsZoneGroup": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'privateDnsZoneGroup'), createObject())]"
                              },
                              "tags": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'tags'), createObject())]"
                              },
                              "manualPrivateLinkServiceConnections": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'manualPrivateLinkServiceConnections'), createArray())]"
                              },
                              "customDnsConfigs": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customDnsConfigs'), createArray())]"
                              },
                              "ipConfigurations": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'ipConfigurations'), createArray())]"
                              },
                              "applicationSecurityGroups": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'applicationSecurityGroups'), createArray())]"
                              },
                              "customNetworkInterfaceName": {
                                "value": "[[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customNetworkInterfaceName'), '')]"
                              }
                            },
                            "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "metadata": {
                                "_generator": {
                                  "name": "bicep",
                                  "version": "0.39.26.7824",
                                  "templateHash": "13574490579232233940"
                                },
                                "name": "Private Endpoints"
                              },
                              "parameters": {
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Name of the private endpoint resource to create."
                                  }
                                },
                                "subnetResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                  }
                                },
                                "serviceResourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. Resource ID of the resource that needs to be connected to the network."
                                  }
                                },
                                "applicationSecurityGroups": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                  }
                                },
                                "customNetworkInterfaceName": {
                                  "type": "string",
                                  "defaultValue": "",
                                  "metadata": {
                                    "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                  }
                                },
                                "ipConfigurations": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                  }
                                },
                                "groupIds": {
                                  "type": "array",
                                  "metadata": {
                                    "description": "Required. Subtype(s) of the connection to be created. The allowed values depend on the type serviceResourceId refers to."
                                  }
                                },
                                "privateDnsZoneGroup": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. The private DNS zone group configuration used to associate the private endpoint with one or multiple private DNS zones. A DNS zone group can support up to 5 DNS zones."
                                  }
                                },
                                "location": {
                                  "type": "string",
                                  "defaultValue": "[[resourceGroup().location]",
                                  "metadata": {
                                    "description": "Optional. Location for all Resources."
                                  }
                                },
                                "tags": {
                                  "type": "object",
                                  "defaultValue": {},
                                  "metadata": {
                                    "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                  }
                                },
                                "customDnsConfigs": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Custom DNS configurations."
                                  }
                                },
                                "manualPrivateLinkServiceConnections": {
                                  "type": "array",
                                  "defaultValue": [],
                                  "metadata": {
                                    "description": "Optional. Manual PrivateLink Service Connections."
                                  }
                                }
                              },
                              "resources": [
                                {
                                  "type": "Microsoft.Network/privateEndpoints",
                                  "apiVersion": "2023-04-01",
                                  "name": "[[parameters('name')]",
                                  "location": "[[parameters('location')]",
                                  "tags": "[[parameters('tags')]",
                                  "properties": {
                                    "applicationSecurityGroups": "[[parameters('applicationSecurityGroups')]",
                                    "customDnsConfigs": "[[parameters('customDnsConfigs')]",
                                    "customNetworkInterfaceName": "[[parameters('customNetworkInterfaceName')]",
                                    "ipConfigurations": "[[parameters('ipConfigurations')]",
                                    "manualPrivateLinkServiceConnections": "[[parameters('manualPrivateLinkServiceConnections')]",
                                    "privateLinkServiceConnections": [
                                      {
                                        "name": "[[parameters('name')]",
                                        "properties": {
                                          "privateLinkServiceId": "[[parameters('serviceResourceId')]",
                                          "groupIds": "[[parameters('groupIds')]"
                                        }
                                      }
                                    ],
                                    "subnet": {
                                      "id": "[[parameters('subnetResourceId')]"
                                    }
                                  }
                                },
                                {
                                  "condition": "[[not(empty(parameters('privateDnsZoneGroup')))]",
                                  "type": "Microsoft.Resources/deployments",
                                  "apiVersion": "2025-04-01",
                                  "name": "[[format('PE-PrivateDnsZoneGroup-{0}', uniqueString(deployment().name))]",
                                  "properties": {
                                    "expressionEvaluationOptions": {
                                      "scope": "inner"
                                    },
                                    "mode": "Incremental",
                                    "parameters": {
                                      "privateDNSResourceIds": {
                                        "value": "[[parameters('privateDnsZoneGroup').privateDNSResourceIds]"
                                      },
                                      "privateEndpointName": {
                                        "value": "[[parameters('name')]"
                                      }
                                    },
                                    "template": {
                                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                      "contentVersion": "1.0.0.0",
                                      "metadata": {
                                        "_generator": {
                                          "name": "bicep",
                                          "version": "0.39.26.7824",
                                          "templateHash": "10522840417060554620"
                                        }
                                      },
                                      "parameters": {
                                        "privateEndpointName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                          }
                                        },
                                        "privateDNSResourceIds": {
                                          "type": "array",
                                          "minLength": 1,
                                          "maxLength": 5,
                                          "metadata": {
                                            "description": "Required. Array of private DNS zone resource IDs. A DNS zone group can support up to 5 DNS zones."
                                          }
                                        },
                                        "name": {
                                          "type": "string",
                                          "defaultValue": "default",
                                          "metadata": {
                                            "description": "Optional. The name of the private DNS zone group."
                                          }
                                        }
                                      },
                                      "variables": {
                                        "[string('copy')]": [
                                          {
                                            "name": "privateDnsZoneConfigs",
                                            "count": "[[length(parameters('privateDNSResourceIds'))]",
                                            "input": {
                                              "name": "[[last(split(parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                                              "properties": {
                                                "privateDnsZoneId": "[[parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')]]"
                                              }
                                            }
                                          }
                                        ]
                                      },
                                      "resources": [
                                        {
                                          "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                          "apiVersion": "2023-04-01",
                                          "name": "[[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                          "properties": {
                                            "privateDnsZoneConfigs": "[[variables('privateDnsZoneConfigs')]"
                                          }
                                        }
                                      ],
                                      "outputs": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint DNS zone group."
                                          },
                                          "value": "[[parameters('name')]"
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint DNS zone group."
                                          },
                                          "value": "[[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                        }
                                      }
                                    }
                                  },
                                  "dependsOn": [
                                    "[[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                  ]
                                }
                              ],
                              "outputs": {
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource group the private endpoint was deployed into."
                                  },
                                  "value": "[[resourceGroup().name]"
                                },
                                "resourceId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The resource ID of the private endpoint."
                                  },
                                  "value": "[[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                },
                                "name": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The name of the private endpoint."
                                  },
                                  "value": "[[parameters('name')]"
                                },
                                "location": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "The location the resource was deployed into."
                                  },
                                  "value": "[[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01', 'full').location]"
                                }
                              }
                            }
                          },
                          "dependsOn": [
                            "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                          ]
                        }
                      ],
                      "outputs": {
                        "resourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "The resource ID of the recovery services vault."
                          },
                          "value": "[[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                        },
                        "resourceGroupName": {
                          "type": "string",
                          "metadata": {
                            "description": "The name of the resource group the recovery services vault was created in."
                          },
                          "value": "[[resourceGroup().name]"
                        },
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "The Name of the recovery services vault."
                          },
                          "value": "[[parameters('name')]"
                        },
                        "systemAssignedPrincipalId": {
                          "type": "string",
                          "metadata": {
                            "description": "The principal ID of the system assigned identity."
                          },
                          "value": "[[if(and(parameters('systemAssignedIdentity'), contains(reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').identity, 'principalId')), reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').identity.principalId, '')]"
                        },
                        "location": {
                          "type": "string",
                          "metadata": {
                            "description": "The location the resource was deployed into."
                          },
                          "value": "[[reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').location]"
                        }
                      }
                    }
                  }
                },
                {
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2025-04-01",
                  "name": "[[format('FlattenVirtualMachineNames-{0}', parameters('deploymentSuffix'))]",
                  "resourceGroup": "[[parameters('resourceGroupHosts')]",
                  "properties": {
                    "expressionEvaluationOptions": {
                      "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                      "virtualMachineNamesPerBatch": {
                        "[string('copy')]": [
                          {
                            "name": "value",
                            "count": "[[length(range(1, parameters('sessionHostBatchCount')))]",
                            "input": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('VirtualMachines-Batch-{0}-{1}', sub(range(1, parameters('sessionHostBatchCount'))[sub(range(1, parameters('sessionHostBatchCount'))[copyIndex('value')], 1)], 1), parameters('deploymentSuffix'))), '2025-04-01').outputs.virtualMachineNames.value]"
                          }
                        ]
                      }
                    },
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "metadata": {
                        "_generator": {
                          "name": "bicep",
                          "version": "0.39.26.7824",
                          "templateHash": "11447244983080427176"
                        }
                      },
                      "parameters": {
                        "virtualMachineNamesPerBatch": {
                          "type": "array"
                        }
                      },
                      "resources": [],
                      "outputs": {
                        "virtualMachineNames": {
                          "type": "array",
                          "value": "[[flatten(parameters('virtualMachineNamesPerBatch'))]"
                        }
                      }
                    }
                  },
                  "dependsOn": [
                    "virtualMachines"
                  ]
                }
              ],
              "outputs": {
                "virtualMachineNames": {
                  "type": "array",
                  "value": "[[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('FlattenVirtualMachineNames-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.virtualMachineNames.value]"
                }
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/templateSpecs",
              "apiVersion": "2022-02-01",
              "name": "[parameters('templateSpecName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Template Spec for AVD Session Host deployment used by Session Host Replacer",
                "displayName": "AVD Session Host Template"
              }
            },
            {
              "type": "Microsoft.Resources/templateSpecs/versions",
              "apiVersion": "2022-02-01",
              "name": "[format('{0}/{1}', parameters('templateSpecName'), parameters('templateSpecVersion'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Session Host deployment template for automated replacement",
                "mainTemplate": "[variables('$fxv#0')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/templateSpecs', parameters('templateSpecName'))]"
              ]
            }
          ],
          "outputs": {
            "templateSpecResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Resources/templateSpecs', parameters('templateSpecName'))]"
            },
            "templateSpecVersionResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Resources/templateSpecs/versions', parameters('templateSpecName'), parameters('templateSpecVersion'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[empty(parameters('appServicePlanResourceId'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('FunctionAppHostingPlan-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppKind": {
            "value": "functionApp"
          },
          "hostingPlanType": {
            "value": "FunctionsPremium"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[variables('appServicePlanName')]"
          },
          "planPricing": {
            "value": "PremiumV3_P1v3"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "zoneRedundant": {
            "value": "[parameters('zoneRedundant')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9030062954926391490"
            }
          },
          "parameters": {
            "hostingPlanType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "functionAppKind": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "planPricing": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "zoneRedundant": {
              "type": "bool"
            }
          },
          "variables": {
            "sku": {
              "name": "[split(parameters('planPricing'), '_')[1]]",
              "tier": "[split(parameters('planPricing'), '_')[0]]",
              "capacity": "[if(parameters('zoneRedundant'), 3, 1)]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": "[variables('sku')]",
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Web/serverfarms'), createObject())]",
              "properties": {
                "maximumElasticWorkerCount": "[if(contains(parameters('hostingPlanType'), 'Consumption'), null(), if(equals(parameters('hostingPlanType'), 'FunctionsPremium'), 20, 1))]",
                "reserved": "[if(contains(parameters('functionAppKind'), 'linux'), true(), false())]",
                "zoneRedundant": "[parameters('zoneRedundant')]"
              }
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/serverfarms/{0}', parameters('name'))]",
              "name": "[format('{0}-diagnosticSettings', parameters('name'))]",
              "properties": {
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "hostingPlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('SessionHostReplacerFunctionApp-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "applicationInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "azureBlobPrivateDnsZoneResourceId": {
            "value": "[parameters('azureBlobPrivateDnsZoneResourceId')]"
          },
          "azureFilePrivateDnsZoneResourceId": {
            "value": "[parameters('azureFilePrivateDnsZoneResourceId')]"
          },
          "azureFunctionAppPrivateDnsZoneResourceId": {
            "value": "[parameters('azureFunctionAppPrivateDnsZoneResourceId')]"
          },
          "azureQueuePrivateDnsZoneResourceId": {
            "value": "[parameters('azureQueuePrivateDnsZoneResourceId')]"
          },
          "azureTablePrivateDnsZoneResourceId": {
            "value": "[parameters('azureTablePrivateDnsZoneResourceId')]"
          },
          "deploymentSuffix": {
            "value": "[variables('deploymentSuffix')]"
          },
          "enableApplicationInsights": {
            "value": "[not(empty(parameters('logAnalyticsWorkspaceResourceId')))]"
          },
          "encryptionKeyName": {
            "value": "[variables('encryptionKeyName')]"
          },
          "encryptionKeyVaultResourceId": {
            "value": "[parameters('encryptionKeyVaultResourceId')]"
          },
          "functionAppAppSettings": {
            "value": [
              {
                "name": "GraphEndpoint",
                "value": "[variables('graphEndpoint')]"
              },
              {
                "name": "HostPoolSubscriptionId",
                "value": "[variables('hostPoolSubscriptionId')]"
              },
              {
                "name": "HostPoolResourceGroupName",
                "value": "[variables('hostPoolResourceGroupName')]"
              },
              {
                "name": "HostPoolName",
                "value": "[variables('hostPoolName')]"
              },
              {
                "name": "VirtualMachinesSubscriptionId",
                "value": "[variables('virtualMachinesSubscriptionId')]"
              },
              {
                "name": "VirtualMachinesResourceGroupName",
                "value": "[variables('virtualMachinesResourceGroupName')]"
              },
              {
                "name": "TargetVMAgeDays",
                "value": "[string(parameters('targetVMAgeDays'))]"
              },
              {
                "name": "DrainGracePeriodHours",
                "value": "[string(parameters('drainGracePeriodHours'))]"
              },
              {
                "name": "FixSessionHostTags",
                "value": "[string(parameters('fixSessionHostTags'))]"
              },
              {
                "name": "IncludePreExistingSessionHosts",
                "value": "[string(parameters('includePreExistingSessionHosts'))]"
              },
              {
                "name": "Tag_IncludeInAutomation",
                "value": "[parameters('tagIncludeInAutomation')]"
              },
              {
                "name": "Tag_DeployTimestamp",
                "value": "[parameters('tagDeployTimestamp')]"
              },
              {
                "name": "Tag_PendingDrainTimestamp",
                "value": "[parameters('tagPendingDrainTimestamp')]"
              },
              {
                "name": "Tag_ScalingPlanExclusionTag",
                "value": "[parameters('tagScalingPlanExclusionTag')]"
              },
              {
                "name": "SessionHostTemplate",
                "value": "[if(not(empty(parameters('sessionHostTemplateSpecVersionResourceId'))), parameters('sessionHostTemplateSpecVersionResourceId'), reference(resourceId('Microsoft.Resources/deployments', format('SessionHostTemplateSpec-{0}', variables('deploymentSuffix'))), '2025-04-01').outputs.templateSpecVersionResourceId.value)]"
              },
              {
                "name": "SessionHostParameters",
                "value": "[string(createObject('artifactsContainerUri', parameters('artifactsContainerUri'), 'artifactsUserAssignedIdentityResourceId', parameters('artifactsUserAssignedIdentityResourceId'), 'availability', parameters('availability'), 'availabilitySetNamePrefix', variables('availabilitySetNamePrefix'), 'availabilityZones', parameters('availabilityZones'), 'avdAgentsDSCPackage', parameters('avdAgentsDSCPackage'), 'avdInsightsDataCollectionRulesResourceId', parameters('avdInsightsDataCollectionRulesResourceId'), 'confidentialVMOSDiskEncryption', parameters('confidentialVMOSDiskEncryption'), 'credentialsKeyVaultResourceId', parameters('credentialsKeyVaultResourceId'), 'dataCollectionEndpointResourceId', parameters('dataCollectionEndpointResourceId'), 'dedicatedHostGroupResourceId', parameters('dedicatedHostGroupResourceId'), 'dedicatedHostGroupZones', parameters('dedicatedHostGroupZones'), 'dedicatedHostResourceId', parameters('dedicatedHostResourceId'), 'diskSizeGB', parameters('diskSizeGB'), 'diskSku', parameters('diskSku'), 'domainName', parameters('domainName'), 'enableAcceleratedNetworking', parameters('enableAcceleratedNetworking'), 'encryptionAtHost', parameters('encryptionAtHost'), 'existingDiskAccessResourceId', parameters('existingDiskAccessResourceId'), 'existingDiskEncryptionSetResourceId', parameters('existingDiskEncryptionSetResourceId'), 'fslogixConfigureSessionHosts', parameters('fslogixConfigureSessionHosts'), 'fslogixContainerType', parameters('fslogixContainerType'), 'fslogixFileShareNames', parameters('fslogixFileShareNames'), 'fslogixLocalNetAppVolumeResourceIds', parameters('fslogixLocalNetAppVolumeResourceIds'), 'fslogixLocalStorageAccountResourceIds', parameters('fslogixLocalStorageAccountResourceIds'), 'fslogixOSSGroups', parameters('fslogixOSSGroups'), 'fslogixRemoteNetAppVolumeResourceIds', parameters('fslogixRemoteNetAppVolumeResourceIds'), 'fslogixRemoteStorageAccountResourceIds', parameters('fslogixRemoteStorageAccountResourceIds'), 'fslogixSizeInMBs', parameters('fslogixSizeInMBs'), 'fslogixStorageService', parameters('fslogixStorageService'), 'hostPoolResourceId', parameters('hostPoolResourceId'), 'identitySolution', parameters('identitySolution'), 'imageReference', if(empty(parameters('customImageResourceId')), createObject('publisher', parameters('imagePublisher'), 'offer', parameters('imageOffer'), 'sku', parameters('imageSku')), createObject('id', parameters('customImageResourceId'))), 'integrityMonitoring', parameters('integrityMonitoring'), 'intuneEnrollment', parameters('intuneEnrollment'), 'location', reference(parameters('virtualMachinesResourceGroupId'), '2021-04-01', 'Full').location, 'enableMonitoring', parameters('enableMonitoring'), 'networkInterfaceNameConv', variables('networkInterfaceNameConv'), 'osDiskNameConv', variables('diskNameConv'), 'ouPath', parameters('ouPath'), 'secureBootEnabled', parameters('secureBootEnabled'), 'securityDataCollectionRulesResourceId', parameters('securityDataCollectionRulesResourceId'), 'securityType', parameters('securityType'), 'sessionHostCustomizations', parameters('sessionHostCustomizations'), 'vmNameIndexLength', parameters('vmNameIndexLength'), 'subnetResourceId', parameters('virtualMachineSubnetResourceId'), 'tags', parameters('tags'), 'timeZone', parameters('timeZone'), 'virtualMachineNameConv', variables('virtualMachineNameConv'), 'virtualMachineNamePrefix', parameters('virtualMachineNamePrefix'), 'virtualMachineSize', parameters('virtualMachineSize'), 'vmInsightsDataCollectionRulesResourceId', parameters('vmInsightsDataCollectionRulesResourceId'), 'vTpmEnabled', parameters('vTpmEnabled')))]"
              },
              {
                "name": "WEBSITE_TIME_ZONE",
                "value": "[parameters('timeZone')]"
              },
              {
                "name": "RemoveEntraDevice",
                "value": "[string(parameters('removeEntraDevice'))]"
              },
              {
                "name": "RemoveIntuneDevice",
                "value": "[string(parameters('removeIntuneDevice'))]"
              },
              {
                "name": "EnableProgressiveScaleUp",
                "value": "[string(parameters('enableProgressiveScaleUp'))]"
              },
              {
                "name": "InitialDeploymentPercentage",
                "value": "[string(parameters('initialDeploymentPercentage'))]"
              },
              {
                "name": "ScaleUpIncrementPercentage",
                "value": "[string(parameters('scaleUpIncrementPercentage'))]"
              },
              {
                "name": "MaxDeploymentBatchSize",
                "value": "[string(parameters('maxDeploymentBatchSize'))]"
              },
              {
                "name": "SubscriptionId",
                "value": "[subscription().subscriptionId]"
              },
              {
                "name": "SuccessfulRunsBeforeScaleUp",
                "value": "[string(parameters('successfulRunsBeforeScaleUp'))]"
              }
            ]
          },
          "functionAppDelegatedSubnetResourceId": {
            "value": "[parameters('functionAppDelegatedSubnetResourceId')]"
          },
          "functionAppName": {
            "value": "[variables('functionAppName')]"
          },
          "functionAppUserAssignedIdentityResourceId": {
            "value": "[parameters('sessionHostReplacerUserAssignedIdentityResourceId')]"
          },
          "hostPoolResourceId": {
            "value": "[parameters('hostPoolResourceId')]"
          },
          "keyManagementStorageAccounts": {
            "value": "[parameters('keyManagementStorageAccounts')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
          },
          "privateEndpoint": {
            "value": "[parameters('privateEndpoint')]"
          },
          "privateEndpointNameConv": {
            "value": "[variables('privateEndpointNameConv')]"
          },
          "privateEndpointNICNameConv": {
            "value": "[variables('privateEndpointNICNameConv')]"
          },
          "privateEndpointSubnetResourceId": {
            "value": "[parameters('privateEndpointSubnetResourceId')]"
          },
          "privateLinkScopeResourceId": {
            "value": "[parameters('privateLinkScopeResourceId')]"
          },
          "roleAssignments": {
            "value": [
              {
                "roleDefinitionId": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
                "scope": "[format('/subscriptions/{0}', variables('virtualMachinesSubscriptionId'))]"
              },
              {
                "roleDefinitionId": "e307426c-f9b6-4e81-87de-d99efb3c32bc",
                "scope": "[format('/subscriptions/{0}/resourceGroups/{1}', variables('hostPoolSubscriptionId'), variables('hostPoolResourceGroupName'))]"
              },
              {
                "roleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
                "scope": "[variables('templateSpecResourceGroupId')]"
              }
            ]
          },
          "serverFarmId": "[if(not(empty(parameters('appServicePlanResourceId'))), createObject('value', parameters('appServicePlanResourceId')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('FunctionAppHostingPlan-{0}', variables('deploymentSuffix'))), '2025-04-01').outputs.hostingPlanId.value))]",
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7468054776090440961"
            }
          },
          "parameters": {
            "applicationInsightsName": {
              "type": "string"
            },
            "azureBlobPrivateDnsZoneResourceId": {
              "type": "string"
            },
            "azureFilePrivateDnsZoneResourceId": {
              "type": "string"
            },
            "azureFunctionAppPrivateDnsZoneResourceId": {
              "type": "string"
            },
            "azureQueuePrivateDnsZoneResourceId": {
              "type": "string"
            },
            "azureTablePrivateDnsZoneResourceId": {
              "type": "string"
            },
            "deploymentSuffix": {
              "type": "string"
            },
            "enableApplicationInsights": {
              "type": "bool"
            },
            "encryptionKeyName": {
              "type": "string"
            },
            "encryptionKeyVaultResourceId": {
              "type": "string"
            },
            "functionAppDelegatedSubnetResourceId": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "functionAppAppSettings": {
              "type": "array"
            },
            "functionAppUserAssignedIdentityResourceId": {
              "type": "string",
              "defaultValue": ""
            },
            "hostPoolResourceId": {
              "type": "string"
            },
            "keyManagementStorageAccounts": {
              "type": "string",
              "allowedValues": [
                "MicrosoftManaged",
                "CustomerManaged",
                "CustomerManagedHSM"
              ]
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "privateEndpoint": {
              "type": "bool"
            },
            "privateEndpointNameConv": {
              "type": "string"
            },
            "privateEndpointNICNameConv": {
              "type": "string"
            },
            "privateEndpointSubnetResourceId": {
              "type": "string"
            },
            "privateLinkScopeResourceId": {
              "type": "string"
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": []
            },
            "serverFarmId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.', ''), '/', '')]",
            "privateEndpointVnetName": "[if(and(not(empty(parameters('privateEndpointSubnetResourceId'))), parameters('privateEndpoint')), split(parameters('privateEndpointSubnetResourceId'), '/')[8], '')]",
            "peVnetId": "[if(less(length(variables('privateEndpointVnetName')), 37), variables('privateEndpointVnetName'), uniqueString(variables('privateEndpointVnetName')))]",
            "azureStoragePrivateDnsZoneResourceIds": [
              "[parameters('azureBlobPrivateDnsZoneResourceId')]",
              "[parameters('azureFilePrivateDnsZoneResourceId')]",
              "[parameters('azureQueuePrivateDnsZoneResourceId')]",
              "[parameters('azureTablePrivateDnsZoneResourceId')]"
            ],
            "storageSubResources": [
              "blob",
              "file",
              "queue",
              "table"
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2024-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject()))]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "identity": "[if(not(equals(parameters('keyManagementStorageAccounts'), 'MicrosoftManaged')), createObject('type', 'SystemAssigned'), null())]",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowCrossTenantReplication": false,
                "allowedCopyScope": "[if(parameters('privateEndpoint'), 'PrivateLink', 'AAD')]",
                "allowSharedKeyAccess": false,
                "azureFilesIdentityBasedAuthentication": {
                  "directoryServiceOptions": "None"
                },
                "defaultToOAuthAuthentication": false,
                "dnsEndpointType": "Standard",
                "encryption": {
                  "keySource": "Microsoft.Storage",
                  "requireInfrastructureEncryption": true,
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "table": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "queue": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  }
                },
                "largeFileSharesState": "Disabled",
                "minimumTlsVersion": "TLS1_2",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "[if(parameters('privateEndpoint'), 'Deny', 'Allow')]"
                },
                "publicNetworkAccess": "[if(parameters('privateEndpoint'), 'Disabled', 'Enabled')]",
                "sasPolicy": {
                  "expirationAction": "Log",
                  "sasExpirationPeriod": "180.00:00:00"
                },
                "supportsHttpsTrafficOnly": true
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateEndpoints_storage",
                "count": "[length(variables('storageSubResources'))]"
              },
              "condition": "[parameters('privateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-04-01",
              "name": "[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', variables('storageSubResources')[copyIndex()]), 'RESOURCE', parameters('storageAccountName')), 'VNETID', variables('peVnetId'))]",
              "location": "[parameters('location')]",
              "properties": {
                "customNetworkInterfaceName": "[replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', variables('storageSubResources')[copyIndex()]), 'RESOURCE', parameters('storageAccountName')), 'VNETID', variables('peVnetId'))]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', variables('storageSubResources')[copyIndex()]), 'RESOURCE', parameters('storageAccountName')), 'VNETID', variables('peVnetId'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                      "groupIds": [
                        "[variables('storageSubResources')[copyIndex()]]"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetResourceId')]"
                }
              },
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateDnsZoneGroups_storage",
                "count": "[length(range(0, sub(length(variables('azureStoragePrivateDnsZoneResourceIds')), 1)))]"
              },
              "condition": "[and(parameters('privateEndpoint'), not(empty(variables('azureStoragePrivateDnsZoneResourceIds')[range(0, sub(length(variables('azureStoragePrivateDnsZoneResourceIds')), 1))[copyIndex()]])))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/{1}', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', variables('storageSubResources')[range(0, sub(length(variables('azureStoragePrivateDnsZoneResourceIds')), 1))[copyIndex()]]), 'RESOURCE', parameters('storageAccountName')), 'VNETID', variables('peVnetId')), parameters('storageAccountName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateDnsZoneId": "[variables('azureStoragePrivateDnsZoneResourceIds')[range(0, sub(length(variables('azureStoragePrivateDnsZoneResourceIds')), 1))[copyIndex()]]]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', variables('storageSubResources')[range(0, sub(length(variables('azureStoragePrivateDnsZoneResourceIds')), 1))[copyIndex()]]), 'RESOURCE', parameters('storageAccountName')), 'VNETID', variables('peVnetId')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "condition": "[parameters('enableApplicationInsights')]",
              "type": "microsoft.insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', parameters('storageAccountName'), 'default')]",
              "name": "[format('{0}-blob-diagnosticSettings', parameters('storageAccountName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('enableApplicationInsights')]",
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Insights/components'), createObject()))]",
              "properties": {
                "Application_Type": "web",
                "publicNetworkAccessForIngestion": "[if(parameters('privateEndpoint'), 'Disabled', null())]",
                "publicNetworkAccessForQuery": "[if(parameters('privateEndpoint'), 'Disabled', null())]",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
              },
              "kind": "web"
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Web/sites'), createObject()))]",
              "kind": "functionapp",
              "identity": "[if(not(empty(parameters('functionAppUserAssignedIdentityResourceId'))), createObject('type', 'SystemAssigned, UserAssigned', 'userAssignedIdentities', createObject(format('{0}', parameters('functionAppUserAssignedIdentityResourceId')), createObject())), createObject('type', 'SystemAssigned'))]",
              "properties": {
                "clientAffinityEnabled": false,
                "httpsOnly": true,
                "publicNetworkAccess": "[if(parameters('privateEndpoint'), 'Disabled', null())]",
                "serverFarmId": "[parameters('serverFarmId')]",
                "siteConfig": {
                  "alwaysOn": true,
                  "appSettings": "[union(createArray(createObject('name', 'AzureWebJobsStorage__blobServiceUri', 'value', format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage)), createObject('name', 'AzureWebJobsStorage__credential', 'value', 'managedidentity'), createObject('name', 'AzureWebJobsStorage__queueServiceUri', 'value', format('https://{0}.queue.{1}', parameters('storageAccountName'), environment().suffixes.storage)), createObject('name', 'AzureWebJobsStorage__tableServiceUri', 'value', format('https://{0}.table.{1}', parameters('storageAccountName'), environment().suffixes.storage)), createObject('name', 'FUNCTIONS_EXTENSION_VERSION', 'value', '~4'), createObject('name', 'FUNCTIONS_WORKER_RUNTIME', 'value', 'powershell'), createObject('name', 'WEBSITE_LOAD_USER_PROFILE', 'value', '1'), createObject('name', 'EnvironmentName', 'value', environment().name), createObject('name', 'ResourceManagerUrl', 'value', if(endsWith(environment().resourceManager, '/'), environment().resourceManager, format('{0}/', environment().resourceManager))), createObject('name', 'StorageSuffix', 'value', environment().suffixes.storage), createObject('name', 'TenantId', 'value', subscription().tenantId), createObject('name', 'UserAssignedIdentityClientId', 'value', if(not(empty(parameters('functionAppUserAssignedIdentityResourceId'))), reference(parameters('functionAppUserAssignedIdentityResourceId'), '2023-01-31').clientId, ''))), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString)), createArray()), parameters('functionAppAppSettings'))]",
                  "cors": {
                    "allowedOrigins": [
                      "[format('{0}', environment().portal)]",
                      "[format('https://functions-next.{0}', variables('cloudSuffix'))]",
                      "[format('https://functions-staging.{0}', variables('cloudSuffix'))]",
                      "[format('https://functions.{0}', variables('cloudSuffix'))]"
                    ]
                  },
                  "ftpsState": "Disabled",
                  "functionAppScaleLimit": 200,
                  "minimumElasticInstanceCount": 0,
                  "netFrameworkVersion": "v6.0",
                  "powerShellVersion": "7.4",
                  "publicNetworkAccess": "[if(parameters('privateEndpoint'), 'Disabled', 'Enabled')]",
                  "use32BitWorkerProcess": false
                },
                "virtualNetworkSubnetId": "[if(not(empty(parameters('functionAppDelegatedSubnetResourceId'))), parameters('functionAppDelegatedSubnetResourceId'), null())]",
                "vnetContentShareEnabled": false,
                "vnetRouteAllEnabled": "[if(not(empty(parameters('functionAppDelegatedSubnetResourceId'))), true(), false())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "condition": "[parameters('privateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-04-01",
              "name": "[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'sites'), 'RESOURCE', parameters('functionAppName')), 'VNETID', variables('peVnetId'))]",
              "location": "[parameters('location')]",
              "properties": {
                "customNetworkInterfaceName": "[replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', 'sites'), 'RESOURCE', parameters('functionAppName')), 'VNETID', variables('peVnetId'))]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'sites'), 'RESOURCE', parameters('functionAppName')), 'VNETID', variables('peVnetId'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetResourceId')]"
                }
              },
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "condition": "[and(parameters('privateEndpoint'), not(empty(parameters('azureFunctionAppPrivateDnsZoneResourceId'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/{1}', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'sites'), 'RESOURCE', parameters('functionAppName')), 'VNETID', variables('peVnetId')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateDnsZoneId": "[parameters('azureFunctionAppPrivateDnsZoneResourceId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'sites'), 'RESOURCE', parameters('functionAppName')), 'VNETID', variables('peVnetId')))]"
              ]
            },
            {
              "condition": "[not(equals(parameters('keyManagementStorageAccounts'), 'MicrosoftManaged'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('cmk-storageAccount-{0}', parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "encryptionKeyName": {
                    "value": "[parameters('encryptionKeyName')]"
                  },
                  "hostPoolResourceId": {
                    "value": "[parameters('hostPoolResourceId')]"
                  },
                  "deploymentSuffix": {
                    "value": "[parameters('deploymentSuffix')]"
                  },
                  "keyManagementStorageAccounts": {
                    "value": "[parameters('keyManagementStorageAccounts')]"
                  },
                  "keyVaultResourceId": {
                    "value": "[parameters('encryptionKeyVaultResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17935676370415003581"
                    }
                  },
                  "parameters": {
                    "hostPoolResourceId": {
                      "type": "string"
                    },
                    "keyManagementStorageAccounts": {
                      "type": "string"
                    },
                    "keyVaultResourceId": {
                      "type": "string"
                    },
                    "keyExpirationInDays": {
                      "type": "int",
                      "defaultValue": 180
                    },
                    "storageAccountName": {
                      "type": "string"
                    },
                    "encryptionKeyName": {
                      "type": "string"
                    },
                    "deploymentSuffix": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "keyVaultName": "[last(split(parameters('keyVaultResourceId'), '/'))]",
                    "keyVaultSubscriptionId": "[split(parameters('keyVaultResourceId'), '/')[2]]",
                    "keyVaultResourceGroup": "[split(parameters('keyVaultResourceId'), '/')[4]]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2024-01-01",
                      "name": "[parameters('storageAccountName')]",
                      "properties": {
                        "encryption": {
                          "keySource": "Microsoft.KeyVault",
                          "keyvaultproperties": {
                            "keyname": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('StorageEncryptionKey-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.name.value]",
                            "keyvaulturi": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('keyVaultSubscriptionId'), variables('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', variables('keyVaultName')), '2024-11-01').vaultUri]"
                          },
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "table": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "queue": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "blob": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('RA-Encryption-Key-{0}', parameters('deploymentSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('StorageEncryptionKey-{0}', parameters('deploymentSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('StorageEncryptionKey-{0}', parameters('deploymentSuffix'))]",
                      "resourceGroup": "[variables('keyVaultResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "attributesExportable": {
                            "value": false
                          },
                          "keySize": {
                            "value": 4096
                          },
                          "keyVaultName": {
                            "value": "[variables('keyVaultName')]"
                          },
                          "kty": "[if(contains(parameters('keyManagementStorageAccounts'), 'HSM'), createObject('value', 'RSA-HSM'), createObject('value', 'RSA'))]",
                          "name": {
                            "value": "[parameters('encryptionKeyName')]"
                          },
                          "rotationPolicy": {
                            "value": {
                              "attributes": {
                                "expiryTime": "[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                              },
                              "lifetimeActions": [
                                {
                                  "action": {
                                    "type": "Notify"
                                  },
                                  "trigger": {
                                    "timeBeforeExpiry": "P10D"
                                  }
                                },
                                {
                                  "action": {
                                    "type": "Rotate"
                                  },
                                  "trigger": {
                                    "timeAfterCreate": "[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                                  }
                                }
                              ]
                            }
                          },
                          "tags": {
                            "value": {
                              "cm-resource-parent": "[parameters('hostPoolResourceId')]"
                            }
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "3718319161044008822"
                            }
                          },
                          "parameters": {
                            "keyVaultName": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "attributesEnabled": {
                              "type": "bool",
                              "defaultValue": true
                            },
                            "attributesExp": {
                              "type": "int",
                              "defaultValue": -1
                            },
                            "attributesNbf": {
                              "type": "int",
                              "defaultValue": -1
                            },
                            "curveName": {
                              "type": "string",
                              "defaultValue": "P-256"
                            },
                            "attributesExportable": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "keyOps": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "keySize": {
                              "type": "int",
                              "defaultValue": -1
                            },
                            "kty": {
                              "type": "string",
                              "defaultValue": "EC"
                            },
                            "release_policy": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "rotationPolicy": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.KeyVault/vaults/keys",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('name'))]",
                              "tags": "[if(empty(parameters('tags')), null(), parameters('tags'))]",
                              "properties": {
                                "attributes": {
                                  "enabled": "[parameters('attributesEnabled')]",
                                  "exportable": "[parameters('attributesExportable')]",
                                  "exp": "[if(not(equals(parameters('attributesExp'), -1)), parameters('attributesExp'), null())]",
                                  "nbf": "[if(not(equals(parameters('attributesNbf'), -1)), parameters('attributesNbf'), null())]"
                                },
                                "curveName": "[parameters('curveName')]",
                                "keyOps": "[parameters('keyOps')]",
                                "keySize": "[if(not(equals(parameters('keySize'), -1)), parameters('keySize'), null())]",
                                "kty": "[parameters('kty')]",
                                "release_policy": "[if(empty(parameters('release_policy')), null(), parameters('release_policy'))]",
                                "rotationPolicy": "[if(empty(parameters('rotationPolicy')), null(), parameters('rotationPolicy'))]"
                              }
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('RA-Encryption-Key-{0}', parameters('deploymentSuffix'))]",
                      "resourceGroup": "[variables('keyVaultResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "keyName": {
                            "value": "[parameters('encryptionKeyName')]"
                          },
                          "keyVaultName": {
                            "value": "[variables('keyVaultName')]"
                          },
                          "principalId": {
                            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2024-01-01', 'full').identity.principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          },
                          "roleDefinitionId": {
                            "value": "e147488a-f6f5-4113-8e2d-b22465e65bf6"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10428209994367129507"
                            }
                          },
                          "parameters": {
                            "keyVaultName": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                              "name": "[guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId'))]",
                              "properties": {
                                "principalId": "[parameters('principalId')]",
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignmentId": {
                              "type": "string",
                              "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId')))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default'), 'microsoft.insights/diagnosticSettings', format('{0}-blob-diagnosticSettings', parameters('storageAccountName')))]",
                "privateDnsZoneGroups_storage",
                "privateEndpoints_storage",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "condition": "[and(parameters('enableApplicationInsights'), not(empty(parameters('privateLinkScopeResourceId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('PrivateLlinkScope-{0}', parameters('deploymentSuffix'))]",
              "subscriptionId": "[subscription().subscriptionId]",
              "location": "[resourceGroup().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateLinkScopeResourceId": {
                    "value": "[parameters('privateLinkScopeResourceId')]"
                  },
                  "scopedResourceIds": {
                    "value": [
                      "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
                    ]
                  },
                  "deploymentSuffix": {
                    "value": "[parameters('deploymentSuffix')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17290229534485454366"
                    }
                  },
                  "parameters": {
                    "privateLinkScopeResourceId": {
                      "type": "string"
                    },
                    "scopedResourceIds": {
                      "type": "array"
                    },
                    "deploymentSuffix": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('addScopedResources-{0}', parameters('deploymentSuffix'))]",
                      "subscriptionId": "[split(parameters('privateLinkScopeResourceId'), '/')[2]]",
                      "resourceGroup": "[split(parameters('privateLinkScopeResourceId'), '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "privateLinkScopeResourceId": {
                            "value": "[parameters('privateLinkScopeResourceId')]"
                          },
                          "scopedResourceIds": {
                            "value": "[parameters('scopedResourceIds')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "5758136482480486201"
                            }
                          },
                          "parameters": {
                            "scopedResourceIds": {
                              "type": "array"
                            },
                            "privateLinkScopeResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "scopedResources",
                                "count": "[length(parameters('scopedResourceIds'))]"
                              },
                              "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                              "apiVersion": "2021-07-01-preview",
                              "name": "[format('{0}/{1}', last(split(parameters('privateLinkScopeResourceId'), '/')), uniqueString(parameters('scopedResourceIds')[copyIndex()]))]",
                              "properties": {
                                "linkedResourceId": "[parameters('scopedResourceIds')[copyIndex()]]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignments_resourceGroups",
                "count": "[length(range(0, length(parameters('roleAssignments'))))]"
              },
              "condition": "[greater(length(split(parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].scope, '/')), 3)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('set-role-assignment-rg-{0}-{1}', range(0, length(parameters('roleAssignments')))[copyIndex()], parameters('deploymentSuffix'))]",
              "subscriptionId": "[split(parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].scope, '/')[2]]",
              "resourceGroup": "[last(split(parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].scope, '/'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalId": "[if(not(empty(parameters('functionAppUserAssignedIdentityResourceId'))), createObject('value', reference(parameters('functionAppUserAssignedIdentityResourceId'), '2023-01-31', 'Full').properties.principalId), createObject('value', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId))]",
                  "principalType": {
                    "value": "ServicePrincipal"
                  },
                  "roleDefinitionId": {
                    "value": "[parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].roleDefinitionId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17889000177953870600"
                    }
                  },
                  "parameters": {
                    "roleDefinitionId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. You can provide either the role definition GUID or its fully qualified ID in the following format: \\'/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11\\'.\nYou can find the GUIDs in the ID column on the table at https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles.\n"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The Principal or Object ID of the Security Principal (User, Group, Service Principal, Managed Identity)."
                      }
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Optional. Name of the Resource Group to assign the RBAC role to. If not provided, will use the current scope for deployment."
                      }
                    },
                    "subscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Optional. Subscription ID of the subscription to assign the RBAC role to. If not provided, will use the current scope for deployment."
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": "",
                      "allowedValues": [
                        "ServicePrincipal",
                        "Group",
                        "User",
                        "ForeignGroup",
                        "Device",
                        ""
                      ],
                      "metadata": {
                        "description": "Optional. The principal type of the assigned principal ID."
                      }
                    }
                  },
                  "variables": {
                    "roleDefinitionIdVar": "[if(contains(parameters('roleDefinitionId'), '/providers/Microsoft.Authorization/roleDefinitions/'), parameters('roleDefinitionId'), format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleDefinitionId')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('roleDefinitionIdVar')]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]"
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignments_subscriptions",
                "count": "[length(range(0, length(parameters('roleAssignments'))))]"
              },
              "condition": "[equals(length(split(parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].scope, '/')), 3)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('set-role-assignment-sub-{0}-{1}', range(0, length(parameters('roleAssignments')))[copyIndex()], parameters('deploymentSuffix'))]",
              "subscriptionId": "[split(parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].scope, '/')[2]]",
              "location": "[resourceGroup().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalId": "[if(not(empty(parameters('functionAppUserAssignedIdentityResourceId'))), createObject('value', reference(parameters('functionAppUserAssignedIdentityResourceId'), '2023-01-31', 'Full').properties.principalId), createObject('value', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId))]",
                  "principalType": {
                    "value": "ServicePrincipal"
                  },
                  "roleDefinitionId": {
                    "value": "[parameters('roleAssignments')[range(0, length(parameters('roleAssignments')))[copyIndex()]].roleDefinitionId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "7334988505119235113"
                    },
                    "name": "Role Assignments (Subscription scope)",
                    "description": "This module deploys a Role Assignment at a Subscription scope.",
                    "owner": "Azure/module-maintainers"
                  },
                  "parameters": {
                    "roleDefinitionId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. You can provide either the role definition GUID or its fully qualified ID in the following format: \\'/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11\\'.\nYou can find the GUIDs in the ID column on the table at https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles.\n"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The Principal or Object ID of the Security Principal (User, Group, Service Principal, Managed Identity)."
                      }
                    },
                    "subscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Optional. Subscription ID of the subscription to assign the RBAC role to. If not provided, will use the current scope for deployment."
                      }
                    },
                    "description": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The description of the role assignment."
                      }
                    },
                    "delegatedManagedIdentityResourceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. ID of the delegated managed identity resource."
                      }
                    },
                    "condition": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to."
                      }
                    },
                    "conditionVersion": {
                      "type": "string",
                      "defaultValue": "2.0",
                      "allowedValues": [
                        "2.0"
                      ],
                      "metadata": {
                        "description": "Optional. Version of the condition. Currently accepted value is \"2.0\"."
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": "",
                      "allowedValues": [
                        "ServicePrincipal",
                        "Group",
                        "User",
                        "ForeignGroup",
                        "Device",
                        ""
                      ],
                      "metadata": {
                        "description": "Optional. The principal type of the assigned principal ID."
                      }
                    }
                  },
                  "variables": {
                    "roleDefinitionIdVar": "[if(contains(parameters('roleDefinitionId'), '/providers/Microsoft.Authorization/roleDefinitions/'), parameters('roleDefinitionId'), format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleDefinitionId')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('subscriptionId'), variables('roleDefinitionIdVar'), parameters('principalId'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('roleDefinitionIdVar')]",
                        "principalId": "[parameters('principalId')]",
                        "description": "[if(not(empty(parameters('description'))), parameters('description'), null())]",
                        "principalType": "[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]",
                        "delegatedManagedIdentityResourceId": "[if(not(empty(parameters('delegatedManagedIdentityResourceId'))), parameters('delegatedManagedIdentityResourceId'), null())]",
                        "conditionVersion": "[if(and(not(empty(parameters('conditionVersion'))), not(empty(parameters('condition')))), parameters('conditionVersion'), null())]",
                        "condition": "[if(not(empty(parameters('condition'))), parameters('condition'), null())]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The GUID of the Role Assignment."
                      },
                      "value": "[guid(parameters('subscriptionId'), variables('roleDefinitionIdVar'), parameters('principalId'))]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Role Assignment."
                      },
                      "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(parameters('subscriptionId'), variables('roleDefinitionIdVar'), parameters('principalId')))]"
                    },
                    "scope": {
                      "type": "string",
                      "metadata": {
                        "description": "The scope this Role Assignment applies to."
                      },
                      "value": "[subscription().id]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('set-role-assignment-storage-{0}', parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalIds": {
                    "value": [
                      "[if(not(empty(parameters('functionAppUserAssignedIdentityResourceId'))), reference(parameters('functionAppUserAssignedIdentityResourceId'), '2023-01-31', 'Full').properties.principalId, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId)]"
                    ]
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  },
                  "roleDefinitionId": {
                    "value": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
                  },
                  "storageAccountResourceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "11571141747549419835"
                    }
                  },
                  "parameters": {
                    "principalIds": {
                      "type": "array"
                    },
                    "principalType": {
                      "type": "string"
                    },
                    "storageAccountResourceId": {
                      "type": "string"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "roleAssignments",
                        "count": "[length(range(0, length(parameters('principalIds'))))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountResourceId'), '/')))]",
                      "name": "[guid(parameters('principalIds')[range(0, length(parameters('principalIds')))[copyIndex()]], parameters('roleDefinitionId'), parameters('storageAccountResourceId'))]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                        "principalId": "[parameters('principalIds')[range(0, length(parameters('principalIds')))[copyIndex()]]]",
                        "principalType": "[parameters('principalType')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "functionAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('FunctionAppHostingPlan-{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('SessionHostTemplateSpec-{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('SessionHostReplacerFunction-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "files": {
            "value": {
              "requirements.psd1": "[variables('$fxv#2')]",
              "run.ps1": "[variables('$fxv#3')]",
              "../profile.ps1": "[variables('$fxv#4')]"
            }
          },
          "functionAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('SessionHostReplacerFunctionApp-{0}', variables('deploymentSuffix'))), '2025-04-01').outputs.functionAppName.value]"
          },
          "functionName": {
            "value": "session-host-replacer"
          },
          "schedule": {
            "value": "[parameters('timerSchedule')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9941449007602364002"
            }
          },
          "parameters": {
            "files": {
              "type": "object"
            },
            "functionAppName": {
              "type": "string"
            },
            "functionName": {
              "type": "string"
            },
            "schedule": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/functions",
              "apiVersion": "2020-12-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), parameters('functionName'))]",
              "properties": {
                "config": {
                  "disabled": false,
                  "bindings": [
                    {
                      "name": "Timer",
                      "type": "timerTrigger",
                      "direction": "in",
                      "schedule": "[parameters('schedule')]"
                    }
                  ]
                },
                "files": "[parameters('files')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('SessionHostReplacerFunctionApp-{0}', variables('deploymentSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "functionAppName": {
      "type": "string",
      "metadata": {
        "description": "The name of the deployed function app."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('SessionHostReplacerFunctionApp-{0}', variables('deploymentSuffix'))), '2025-04-01').outputs.functionAppName.value]"
    }
  }
}