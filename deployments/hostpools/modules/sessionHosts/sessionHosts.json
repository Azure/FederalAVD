{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15370779627089004566"
    }
  },
  "parameters": {
    "deploymentType": {
      "type": "string"
    },
    "appGroupSecurityGroups": {
      "type": "array"
    },
    "artifactsContainerUri": {
      "type": "string"
    },
    "artifactsUserAssignedIdentityResourceId": {
      "type": "string"
    },
    "availability": {
      "type": "string"
    },
    "availabilitySetNameConv": {
      "type": "string"
    },
    "availabilitySetsCount": {
      "type": "int"
    },
    "availabilitySetsIndex": {
      "type": "int"
    },
    "availabilityZones": {
      "type": "array"
    },
    "avdInsightsDataCollectionRulesResourceId": {
      "type": "string"
    },
    "azureBackupPrivateDnsZoneResourceId": {
      "type": "string"
    },
    "azureBlobPrivateDnsZoneResourceId": {
      "type": "string"
    },
    "azureQueuePrivateDnsZoneResourceId": {
      "type": "string"
    },
    "confidentialVMOrchestratorObjectId": {
      "type": "string"
    },
    "confidentialVMOSDiskEncryption": {
      "type": "bool"
    },
    "customImageResourceId": {
      "type": "string"
    },
    "dataCollectionEndpointResourceId": {
      "type": "string"
    },
    "dedicatedHostGroupResourceId": {
      "type": "string"
    },
    "dedicatedHostResourceId": {
      "type": "string"
    },
    "deployDiskAccessPolicy": {
      "type": "bool"
    },
    "deployDiskAccessResource": {
      "type": "bool"
    },
    "deploymentUserAssignedIdentityClientId": {
      "type": "string"
    },
    "deploymentVirtualMachineName": {
      "type": "string"
    },
    "domainJoinUserPassword": {
      "type": "securestring"
    },
    "domainJoinUserPrincipalName": {
      "type": "securestring"
    },
    "diskEncryptionSetNames": {
      "type": "object"
    },
    "diskAccessName": {
      "type": "string"
    },
    "diskSizeGB": {
      "type": "int"
    },
    "diskSku": {
      "type": "string"
    },
    "divisionRemainderValue": {
      "type": "int"
    },
    "domainName": {
      "type": "string"
    },
    "enableAcceleratedNetworking": {
      "type": "bool"
    },
    "enableIPv6": {
      "type": "bool"
    },
    "encryptionAtHost": {
      "type": "bool"
    },
    "encryptionKeyName": {
      "type": "string"
    },
    "encryptionKeyVaultResourceId": {
      "type": "string"
    },
    "encryptionKeyVaultUri": {
      "type": "string"
    },
    "existingDiskAccessResourceId": {
      "type": "string"
    },
    "existingDiskEncryptionSetResourceId": {
      "type": "string"
    },
    "existingRecoveryServicesVaultResourceId": {
      "type": "string"
    },
    "fslogixFileShareNames": {
      "type": "array"
    },
    "fslogixConfigureSessionHosts": {
      "type": "bool"
    },
    "fslogixContainerType": {
      "type": "string"
    },
    "fslogixLocalNetAppVolumeResourceIds": {
      "type": "array"
    },
    "fslogixLocalStorageAccountResourceIds": {
      "type": "array"
    },
    "fslogixOSSGroups": {
      "type": "array"
    },
    "fslogixRemoteNetAppVolumeResourceIds": {
      "type": "array"
    },
    "fslogixRemoteStorageAccountResourceIds": {
      "type": "array"
    },
    "fslogixSizeInMBs": {
      "type": "int"
    },
    "fslogixStorageService": {
      "type": "string"
    },
    "hibernationEnabled": {
      "type": "bool"
    },
    "hostPoolResourceId": {
      "type": "string"
    },
    "identitySolution": {
      "type": "string"
    },
    "imageOffer": {
      "type": "string"
    },
    "imagePublisher": {
      "type": "string"
    },
    "imageSku": {
      "type": "string"
    },
    "integrityMonitoring": {
      "type": "bool"
    },
    "intuneEnrollment": {
      "type": "bool"
    },
    "keyExpirationInDays": {
      "type": "int"
    },
    "keyManagementDisks": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string"
    },
    "maxVMsPerDeployment": {
      "type": "int"
    },
    "privateEndpoint": {
      "type": "bool"
    },
    "privateEndpointNameConv": {
      "type": "string"
    },
    "privateEndpointNICNameConv": {
      "type": "string"
    },
    "privateEndpointSubnetResourceId": {
      "type": "string"
    },
    "enableMonitoring": {
      "type": "bool"
    },
    "networkInterfaceNameConv": {
      "type": "string"
    },
    "osDiskNameConv": {
      "type": "string"
    },
    "ouPath": {
      "type": "string"
    },
    "pooledHostPool": {
      "type": "bool"
    },
    "recoveryServices": {
      "type": "bool"
    },
    "recoveryServicesVaultName": {
      "type": "string"
    },
    "resourceGroupDeployment": {
      "type": "string"
    },
    "resourceGroupHosts": {
      "type": "string"
    },
    "secureBootEnabled": {
      "type": "bool"
    },
    "securityDataCollectionRulesResourceId": {
      "type": "string"
    },
    "securityType": {
      "type": "string"
    },
    "sessionHostBatchCount": {
      "type": "int"
    },
    "sessionHostCustomizations": {
      "type": "array"
    },
    "sessionHostRegistrationDSCUrl": {
      "type": "string"
    },
    "sessionHostIndex": {
      "type": "int"
    },
    "vmNameIndexLength": {
      "type": "int"
    },
    "storageSuffix": {
      "type": "string"
    },
    "subnetResourceId": {
      "type": "string"
    },
    "tags": {
      "type": "object"
    },
    "deploymentSuffix": {
      "type": "string"
    },
    "timeZone": {
      "type": "string"
    },
    "useAgentDownloadEndpoint": {
      "type": "bool"
    },
    "virtualMachineNameConv": {
      "type": "string"
    },
    "virtualMachineNamePrefix": {
      "type": "string"
    },
    "virtualMachineSize": {
      "type": "string"
    },
    "virtualMachineAdminPassword": {
      "type": "securestring"
    },
    "virtualMachineAdminUserName": {
      "type": "securestring"
    },
    "vTpmEnabled": {
      "type": "bool"
    },
    "vmInsightsDataCollectionRulesResourceId": {
      "type": "string"
    }
  },
  "variables": {
    "backupPolicyName": "AvdPolicyVm",
    "confidentialVMOSDiskEncryptionType": "[if(parameters('confidentialVMOSDiskEncryption'), 'DiskWithVMGuestState', 'VMGuestStateOnly')]",
    "backupPrivateDNSZoneResourceIds": [
      "[parameters('azureBackupPrivateDnsZoneResourceId')]",
      "[parameters('azureBlobPrivateDnsZoneResourceId')]",
      "[parameters('azureQueuePrivateDnsZoneResourceId')]"
    ],
    "dedicatedHostGroupName": "[if(not(empty(parameters('dedicatedHostResourceId'))), split(parameters('dedicatedHostResourceId'), '/')[8], if(not(empty(parameters('dedicatedHostGroupResourceId'))), last(split(parameters('dedicatedHostGroupResourceId'), '/')), ''))]",
    "dedicatedHostSub": "[if(not(empty(parameters('dedicatedHostResourceId'))), split(parameters('dedicatedHostResourceId'), '/')[2], if(not(empty(parameters('dedicatedHostGroupResourceId'))), split(parameters('dedicatedHostGroupResourceId'), '/')[2], ''))]",
    "dedicatedHostRG": "[if(not(empty(parameters('dedicatedHostResourceId'))), split(parameters('dedicatedHostResourceId'), '/')[4], if(not(empty(parameters('dedicatedHostGroupResourceId'))), split(parameters('dedicatedHostGroupResourceId'), '/')[4], ''))]",
    "nonEmptyBackupPrivateDNSZoneResourceIds": "[filter(variables('backupPrivateDNSZoneResourceIds'), lambda('zone', not(empty(lambdaVariables('zone')))))]"
  },
  "resources": [
    {
      "copy": {
        "name": "roleAssignment_VirtualMachineUserLogin",
        "count": "[length(range(0, length(parameters('appGroupSecurityGroups'))))]"
      },
      "condition": "[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(contains(parameters('identitySolution'), 'DomainServices')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('RA-Hosts-VMLoginUser-{0}-{1}', range(0, length(parameters('appGroupSecurityGroups')))[copyIndex()], parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[parameters('appGroupSecurityGroups')[range(0, length(parameters('appGroupSecurityGroups')))[copyIndex()]]]"
          },
          "principalType": {
            "value": "Group"
          },
          "roleDefinitionId": {
            "value": "fb879df8-f326-4884-b1cf-06f3ad86be52"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17889000177953870600"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Required. You can provide either the role definition GUID or its fully qualified ID in the following format: \\'/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11\\'.\nYou can find the GUIDs in the ID column on the table at https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles.\n"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Required. The Principal or Object ID of the Security Principal (User, Group, Service Principal, Managed Identity)."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "Optional. Name of the Resource Group to assign the RBAC role to. If not provided, will use the current scope for deployment."
              }
            },
            "subscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "Optional. Subscription ID of the subscription to assign the RBAC role to. If not provided, will use the current scope for deployment."
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "",
              "allowedValues": [
                "ServicePrincipal",
                "Group",
                "User",
                "ForeignGroup",
                "Device",
                ""
              ],
              "metadata": {
                "description": "Optional. The principal type of the assigned principal ID."
              }
            }
          },
          "variables": {
            "roleDefinitionIdVar": "[if(contains(parameters('roleDefinitionId'), '/providers/Microsoft.Authorization/roleDefinitions/'), parameters('roleDefinitionId'), format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleDefinitionId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitionIdVar')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]"
              }
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(parameters('subscriptionId'), parameters('resourceGroupName'), variables('roleDefinitionIdVar'), parameters('principalId')))]"
            }
          }
        }
      }
    },
    {
      "condition": "[equals(parameters('deploymentType'), 'SessionHostsOnly')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix'))]",
      "subscriptionId": "[split(parameters('hostPoolResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('hostPoolResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hostPoolType": "[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').hostPoolType), createObject('value', ''))]",
          "loadBalancerType": "[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').loadBalancerType), createObject('value', ''))]",
          "location": "[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05', 'full').location), createObject('value', parameters('location')))]",
          "name": "[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', last(split(parameters('hostPoolResourceId'), '/'))), createObject('value', ''))]",
          "preferredAppGroupType": "[if(equals(parameters('deploymentType'), 'SessionHostsOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').preferredAppGroupType), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8593275479235695745"
            }
          },
          "parameters": {
            "hostPoolType": {
              "type": "string"
            },
            "loadBalancerType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "preferredAppGroupType": {
              "type": "string"
            },
            "time": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2024-04-03",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "hostPoolType": "[parameters('hostPoolType')]",
                "loadBalancerType": "[parameters('loadBalancerType')]",
                "preferredAppGroupType": "[parameters('preferredAppGroupType')]",
                "registrationInfo": {
                  "expirationTime": "[dateTimeAdd(parameters('time'), 'PT2H')]",
                  "registrationTokenOperation": "Update"
                }
              }
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('deployDiskAccessResource'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('DiskAccess-{0}', parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('diskAccessName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "privateEndpoints": {
            "value": [
              {
                "customNetworkInterfaceName": "[replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', 'disks'), 'RESOURCE', parameters('diskAccessName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8]))]",
                "name": "[replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'disks'), 'RESOURCE', parameters('diskAccessName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8]))]",
                "privateDnsZoneGroup": "[if(empty(parameters('azureBlobPrivateDnsZoneResourceId')), null(), createObject('privateDNSResourceIds', createArray(parameters('azureBlobPrivateDnsZoneResourceId'))))]",
                "service": "disks",
                "subnetResourceId": "[parameters('privateEndpointSubnetResourceId')]",
                "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject())]"
              }
            ]
          },
          "tags": {
            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskAccesses'), createObject()))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12211048938195293438"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "privateEndpoints": {
              "type": "array"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/diskAccesses",
              "apiVersion": "2021-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {}
            },
            {
              "copy": {
                "name": "diskAccess_privateEndpoints",
                "count": "[length(parameters('privateEndpoints'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('DiskAccess-PrivateEndpoint-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "groupIds": {
                    "value": [
                      "[parameters('privateEndpoints')[copyIndex()].service]"
                    ]
                  },
                  "name": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'name'), format('pe-{0}-{1}-{2}', last(split(resourceId('Microsoft.Compute/diskAccesses', parameters('name')), '/')), parameters('privateEndpoints')[copyIndex()].service, copyIndex()))]"
                  },
                  "serviceResourceId": {
                    "value": "[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('privateEndpoints')[copyIndex()].subnetResourceId]"
                  },
                  "location": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'location'), reference(split(parameters('privateEndpoints')[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                  },
                  "privateDnsZoneGroup": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'privateDnsZoneGroup'), createObject())]"
                  },
                  "tags": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'tags'), createObject())]"
                  },
                  "manualPrivateLinkServiceConnections": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'manualPrivateLinkServiceConnections'), createArray())]"
                  },
                  "customDnsConfigs": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customDnsConfigs'), createArray())]"
                  },
                  "ipConfigurations": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'ipConfigurations'), createArray())]"
                  },
                  "applicationSecurityGroups": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'applicationSecurityGroups'), createArray())]"
                  },
                  "customNetworkInterfaceName": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customNetworkInterfaceName'), '')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "13574490579232233940"
                    },
                    "name": "Private Endpoints"
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the private endpoint resource to create."
                      }
                    },
                    "subnetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                      }
                    },
                    "serviceResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Resource ID of the resource that needs to be connected to the network."
                      }
                    },
                    "applicationSecurityGroups": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                      }
                    },
                    "customNetworkInterfaceName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The custom name of the network interface attached to the private endpoint."
                      }
                    },
                    "ipConfigurations": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Required. Subtype(s) of the connection to be created. The allowed values depend on the type serviceResourceId refers to."
                      }
                    },
                    "privateDnsZoneGroup": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. The private DNS zone group configuration used to associate the private endpoint with one or multiple private DNS zones. A DNS zone group can support up to 5 DNS zones."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all Resources."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                      }
                    },
                    "customDnsConfigs": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Custom DNS configurations."
                      }
                    },
                    "manualPrivateLinkServiceConnections": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Manual PrivateLink Service Connections."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-04-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "applicationSecurityGroups": "[parameters('applicationSecurityGroups')]",
                        "customDnsConfigs": "[parameters('customDnsConfigs')]",
                        "customNetworkInterfaceName": "[parameters('customNetworkInterfaceName')]",
                        "ipConfigurations": "[parameters('ipConfigurations')]",
                        "manualPrivateLinkServiceConnections": "[parameters('manualPrivateLinkServiceConnections')]",
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('name')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ],
                        "subnet": {
                          "id": "[parameters('subnetResourceId')]"
                        }
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('PE-PrivateDnsZoneGroup-{0}', uniqueString(deployment().name))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "privateDNSResourceIds": {
                            "value": "[parameters('privateDnsZoneGroup').privateDNSResourceIds]"
                          },
                          "privateEndpointName": {
                            "value": "[parameters('name')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10522840417060554620"
                            }
                          },
                          "parameters": {
                            "privateEndpointName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                              }
                            },
                            "privateDNSResourceIds": {
                              "type": "array",
                              "minLength": 1,
                              "maxLength": 5,
                              "metadata": {
                                "description": "Required. Array of private DNS zone resource IDs. A DNS zone group can support up to 5 DNS zones."
                              }
                            },
                            "name": {
                              "type": "string",
                              "defaultValue": "default",
                              "metadata": {
                                "description": "Optional. The name of the private DNS zone group."
                              }
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "privateDnsZoneConfigs",
                                "count": "[length(parameters('privateDNSResourceIds'))]",
                                "input": {
                                  "name": "[last(split(parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                                  "properties": {
                                    "privateDnsZoneId": "[parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')]]"
                                  }
                                }
                              }
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-04-01",
                              "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                              "properties": {
                                "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigs')]"
                              }
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the private endpoint DNS zone group."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the private endpoint DNS zone group."
                              },
                              "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the private endpoint was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the private endpoint."
                      },
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint."
                      },
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location the resource was deployed into."
                      },
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01', 'full').location]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/diskAccesses', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('deployDiskAccessPolicy'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('ManagedDisks-NetworkAccess-Policy-{0}', parameters('deploymentSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diskAccessId": "[if(parameters('deployDiskAccessResource'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value), createObject('value', ''))]",
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceGroupName": {
            "value": "[parameters('resourceGroupHosts')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16147463376755190877"
            }
          },
          "parameters": {
            "diskAccessId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "resourceGroupName": {
              "type": "string"
            }
          },
          "variables": {
            "parameters": "[if(not(empty(parameters('diskAccessId'))), createObject('diskAccessId', createObject('type', 'String', 'metadata', createObject('displayName', 'Disk Access Resource Id', 'description', 'The resource Id of the Disk Access to associate to the managed disks.'))), createObject())]",
            "operations": "[if(not(empty(parameters('diskAccessId'))), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'AllowPrivate'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/diskAccessId', 'value', '[parameters(''diskAccessId'')]')), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'DenyAll'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled')))]",
            "policyName": "[if(not(empty(parameters('diskAccessId'))), 'DisableDisksPublicNetworkAccess', 'DisableDisksAllNetworkAccess')]",
            "policyDescription": "[if(not(empty(parameters('diskAccessId'))), 'Disable public network access to managed disks', 'Disable public network access to managed disks, but allow private network access.')]",
            "policyDisplayName": "[if(not(empty(parameters('diskAccessId'))), 'Disable public network access to managed disks', 'Disable all network access to managed disks')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2021-06-01",
              "name": "[variables('policyName')]",
              "properties": {
                "description": "[variables('policyDescription')]",
                "displayName": "[variables('policyDisplayName')]",
                "mode": "All",
                "parameters": "[variables('parameters')]",
                "policyRule": {
                  "if": {
                    "field": "type",
                    "equals": "Microsoft.Compute/disks"
                  },
                  "then": {
                    "effect": "modify",
                    "details": {
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/60fc6e62-5479-42d4-8bf4-67625fcc2840"
                      ],
                      "operations": "[variables('operations')]"
                    }
                  }
                },
                "policyType": "Custom"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "DiskNetworkAccess",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "diskAccessId": {
                    "value": "[parameters('diskAccessId')]"
                  },
                  "policyDefinitionId": {
                    "value": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName'))]"
                  },
                  "policyDisplayName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName')), '2021-06-01').displayName]"
                  },
                  "policyName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName')), '2021-06-01').displayName]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "386624604173233219"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "diskAccessId": {
                      "type": "string"
                    },
                    "policyDefinitionId": {
                      "type": "string"
                    },
                    "policyDisplayName": {
                      "type": "string"
                    },
                    "policyName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/policyAssignments",
                      "apiVersion": "2022-06-01",
                      "name": "[parameters('policyName')]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "displayName": "[parameters('policyDisplayName')]",
                        "policyDefinitionId": "[parameters('policyDefinitionId')]",
                        "parameters": "[if(not(empty(parameters('diskAccessId'))), createObject('diskAccessId', createObject('value', parameters('diskAccessId'))), createObject())]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(equals(parameters('keyManagementDisks'), 'PlatformManaged')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "confidentialVMOrchestratorObjectId": {
            "value": "[parameters('confidentialVMOrchestratorObjectId')]"
          },
          "confidentialVMOSDiskEncryption": {
            "value": "[parameters('confidentialVMOSDiskEncryption')]"
          },
          "deploymentUserAssignedIdentityClientId": {
            "value": "[parameters('deploymentUserAssignedIdentityClientId')]"
          },
          "deploymentVirtualMachineName": {
            "value": "[parameters('deploymentVirtualMachineName')]"
          },
          "diskEncryptionSetNames": {
            "value": "[parameters('diskEncryptionSetNames')]"
          },
          "hostPoolResourceId": {
            "value": "[parameters('hostPoolResourceId')]"
          },
          "keyExpirationInDays": {
            "value": "[parameters('keyExpirationInDays')]"
          },
          "keyManagementDisks": {
            "value": "[parameters('keyManagementDisks')]"
          },
          "keyName": {
            "value": "[parameters('encryptionKeyName')]"
          },
          "keyVaultResourceId": {
            "value": "[parameters('encryptionKeyVaultResourceId')]"
          },
          "keyVaultUri": {
            "value": "[parameters('encryptionKeyVaultUri')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "deploymentResourceGroupName": {
            "value": "[parameters('resourceGroupDeployment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "deploymentSuffix": {
            "value": "[parameters('deploymentSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13941907654962239870"
            }
          },
          "parameters": {
            "confidentialVMOSDiskEncryption": {
              "type": "bool"
            },
            "confidentialVMOrchestratorObjectId": {
              "type": "string"
            },
            "deploymentUserAssignedIdentityClientId": {
              "type": "string"
            },
            "keyName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "diskEncryptionSetNames": {
              "type": "object"
            },
            "hostPoolResourceId": {
              "type": "string"
            },
            "keyExpirationInDays": {
              "type": "int",
              "defaultValue": 180
            },
            "keyManagementDisks": {
              "type": "string"
            },
            "keyVaultResourceId": {
              "type": "string"
            },
            "keyVaultUri": {
              "type": "string"
            },
            "deploymentVirtualMachineName": {
              "type": "string"
            },
            "deploymentResourceGroupName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "deploymentSuffix": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": "[CmdletBinding()]\r\nparam (\r\n    [string]$KeyName,\r\n    [string]$Tags,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VaultUri\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the Vault URI since only AzureCloud contains a trailing slash\r\n$VaultUriFixed = if($VaultUri[-1] -eq '/'){$VaultUri.Substring(0,$VaultUri.Length - 1)} else {$VaultUri}\r\n\r\n$PolicyContentJson = @\"\r\n{\"version\":\"1.0.0\",\"anyOf\":[{\"authority\":\"https://sharedeus.eus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedwus.wus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedneu.neu.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedweu.weu.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedsasia.sasia.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeasia.easia.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedjpe.jpe.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedswn.swn.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareditn.itn.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeus2.eus2.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeus2e.eus2e.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedscus.scus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcuse.cuse.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcus.cus.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedeau.eau.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedsau.sau.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedcin.cin.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareduaen.uaen.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://shareddewc.dewc.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]},{\"authority\":\"https://sharedwus3.wus3.attest.azure.net/\",\"allOf\":[{\"claim\":\"x-ms-compliance-status\",\"equals\":\"azure-compliant-cvm\"},{\"anyOf\":[{\"claim\":\"x-ms-attestation-type\",\"equals\":\"tdxvm\"},{\"claim\":\"x-ms-attestation-type\",\"equals\":\"sevsnpvm\"}]}]}]}\r\n\"@\r\nIf ($Tags -ne '{}') {\r\n    [PSCustomObject]$TagsObject = $Tags | ConvertFrom-Json\r\n}\r\ntry \r\n{\r\n    # Get an access token for Azure resources\r\n    $AzureKeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata=\"true\"} `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $VaultUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureKeyVaultHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureKeyVaultAccessToken\r\n    }\r\n\r\n    $Key = (Invoke-RestMethod `\r\n        -Headers $AzureKeyVaultHeader `\r\n        -Method 'GET' `\r\n        -Uri $($VaultUriFixed + '/keys?api-version=7.4')).value | Where-Object { $_.kid -eq \"$VaultUriFixed/keys/$KeyName\" }\r\n        \r\n    If (!$Key) {\r\n        #$PolicyContentJson | ConvertFrom-Json | ConvertTo-Json -Depth 100\r\n        $Release_Policy_Data = [Convert]::ToBase64String([char[]]$PolicyContentJson)\r\n        $Body = (@{\r\n            attributes = @{\r\n                enabled = $true\r\n                exportable = $true\r\n            }\r\n            kty='RSA-HSM'\r\n            key_size=4096\r\n            key_ops=@('encrypt', 'decrypt', 'sign', 'verify', 'wrapKey', 'unwrapKey')\r\n            release_policy=@{\r\n                data=$Release_Policy_Data\r\n            }\r\n        })\r\n        If($TagsObject) {\r\n            $Body.tags = $TagsObject\r\n        }\r\n        $Body = $Body | ConvertTo-Json -Depth 100 -Compress\r\n\r\n        Invoke-RestMethod `\r\n            -Headers $AzureKeyVaultHeader `\r\n            -Method 'POST' `\r\n            -Uri $($VaultUriFixed + '/keys/' + $KeyName + '/create?api-version=7.4') `\r\n            -Body $Body\r\n    }\r\n}\r\ncatch \r\n{\r\n    Write-Error -Message \"Failed to create or retrieve the key from the Key Vault. $_\"\r\n    throw\r\n}",
            "keyVaultName": "[last(split(parameters('keyVaultResourceId'), '/'))]",
            "keyVaultResourceGroup": "[split(parameters('keyVaultResourceId'), '/')[4]]",
            "roleKeyVaultCryptoUser": "e147488a-f6f5-4113-8e2d-b22465e65bf6",
            "roleKeyVaultCryptoReleaseUser": "08bbd89e-9f13-488c-ac41-acfcb10c90ab",
            "diskEncryptionSetEncryptionType": "[if(parameters('confidentialVMOSDiskEncryption'), 'ConfidentialVmEncryptedWithCustomerKey', if(not(contains(parameters('keyManagementDisks'), 'Platform')), 'EncryptionAtRestWithCustomerKey', 'EncryptionAtRestWithPlatformAndCustomerKeys'))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('confidentialVMOSDiskEncryption'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('Encryption-Key-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[variables('keyVaultResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "attributesEnabled": {
                    "value": true
                  },
                  "attributesExportable": {
                    "value": false
                  },
                  "keySize": {
                    "value": 4096
                  },
                  "keyVaultName": {
                    "value": "[variables('keyVaultName')]"
                  },
                  "kty": "[if(contains(parameters('keyManagementDisks'), 'HSM'), createObject('value', 'RSA-HSM'), createObject('value', 'RSA'))]",
                  "name": {
                    "value": "[parameters('keyName')]"
                  },
                  "rotationPolicy": {
                    "value": {
                      "attributes": {
                        "expiryTime": "[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                      },
                      "lifetimeActions": [
                        {
                          "action": {
                            "type": "Notify"
                          },
                          "trigger": {
                            "timeBeforeExpiry": "P10D"
                          }
                        },
                        {
                          "action": {
                            "type": "Rotate"
                          },
                          "trigger": {
                            "timeAfterCreate": "[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                          }
                        }
                      ]
                    }
                  },
                  "tags": {
                    "value": {
                      "cm-resource-parent": "[parameters('hostPoolResourceId')]"
                    }
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "3718319161044008822"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "attributesEnabled": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "attributesExp": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "attributesNbf": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "curveName": {
                      "type": "string",
                      "defaultValue": "P-256"
                    },
                    "attributesExportable": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "keyOps": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "keySize": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "kty": {
                      "type": "string",
                      "defaultValue": "EC"
                    },
                    "release_policy": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "rotationPolicy": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/keys",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('name'))]",
                      "tags": "[if(empty(parameters('tags')), null(), parameters('tags'))]",
                      "properties": {
                        "attributes": {
                          "enabled": "[parameters('attributesEnabled')]",
                          "exportable": "[parameters('attributesExportable')]",
                          "exp": "[if(not(equals(parameters('attributesExp'), -1)), parameters('attributesExp'), null())]",
                          "nbf": "[if(not(equals(parameters('attributesNbf'), -1)), parameters('attributesNbf'), null())]"
                        },
                        "curveName": "[parameters('curveName')]",
                        "keyOps": "[parameters('keyOps')]",
                        "keySize": "[if(not(equals(parameters('keySize'), -1)), parameters('keySize'), null())]",
                        "kty": "[parameters('kty')]",
                        "release_policy": "[if(empty(parameters('release_policy')), null(), parameters('release_policy'))]",
                        "rotationPolicy": "[if(empty(parameters('rotationPolicy')), null(), parameters('rotationPolicy'))]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('name'))]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('confidentialVMOSDiskEncryption')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[parameters('deploymentResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "Set-ConfidentialVM-Key-Disks"
                  },
                  "parameters": {
                    "value": [
                      {
                        "name": "KeyName",
                        "value": "[parameters('keyName')]"
                      },
                      {
                        "name": "Tags",
                        "value": "[string(createObject('cm-resource-parent', parameters('hostPoolResourceId')))]"
                      },
                      {
                        "name": "UserAssignedIdentityClientId",
                        "value": "[parameters('deploymentUserAssignedIdentityClientId')]"
                      },
                      {
                        "name": "VaultUri",
                        "value": "[parameters('keyVaultUri')]"
                      }
                    ]
                  },
                  "script": {
                    "value": "[variables('$fxv#0')]"
                  },
                  "treatFailureAsDeploymentFailure": {
                    "value": true
                  },
                  "virtualMachineName": {
                    "value": "[parameters('deploymentVirtualMachineName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "8433848325792194852"
                    },
                    "name": "Virtual Machine RunCommand",
                    "description": "This module deploys a Virtual Machine Run Command.",
                    "owner": "shawn.meyer@microsoft.com"
                  },
                  "parameters": {
                    "virtualMachineName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent virtual machine that extension is provisioned for. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the virtual machine extension."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. The location the extension is deployed to."
                      }
                    },
                    "asyncExecution": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional.  If set to true, provisioning will complete as soon as the script starts and will not wait for script to complete."
                      }
                    },
                    "errorBlobManagedIdentity": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. User-assigned managed identity that has access to errorBlobContainerUri storage blob container.\nUse an empty object in case of system-assigned identity. Make sure managed identity has been given access to blob\\'s container with \\'Storage Blob Data Contributor\\' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged"
                      }
                    },
                    "errorBlobContainerUri": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. \tSpecifies the Azure storage blob where script error stream will be uploaded.\nUse a SAS URI with read, append, create, write access OR use managed identity to provide the VM access to the blob.\nRefer errorBlobManagedIdentity parameter."
                      }
                    },
                    "outputBlobManagedIdentity": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. User-assigned managed identity that has access to outputBlobContainerUri storage blob container.\nUse an empty object in case of system-assigned identity. Make sure managed identity has been given access to blob\\'s container with \\'Storage Blob Data Contributor\\' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged"
                      }
                    },
                    "outputBlobContainerUri": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. \tSpecifies the Azure storage blob where script error stream will be uploaded.\nUse a SAS URI with read, append, create, write access OR use managed identity to provide the VM access to the blob.\nRefer errorBlobManagedIdentity parameter."
                      }
                    },
                    "parameters": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Parameters used by the script."
                      }
                    },
                    "protectedParameters": {
                      "type": "secureObject",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Protected parameters used by the script. These parameters will not show up in deployment data.\nFormat the object as follows:\n{\n  SecureParameterName1: { value: 'secureParameterValue1'}\n  SecureParameterName2: { value: 'secureParameterValue2'}\n}    \n"
                      }
                    },
                    "runAsPassword": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Specifies the user account password on the VM when executing the run command."
                      }
                    },
                    "runAsUser": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Specifies the user account on the VM when executing the run command."
                      }
                    },
                    "commandId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Conditional. Specifies a commandId of predefined built-in script. Do not use with [script] or [scriptUri] parameters."
                      }
                    },
                    "script": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Specifies the script content to be executed on the VM. Do not use with [commandId] or [scriptUri] parameters."
                      }
                    },
                    "scriptUri": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Specifies the script download location. It can be either SAS URI of an Azure storage blob with read access or public URI.\nDo not use with [commandId] or [script] parameters."
                      }
                    },
                    "scriptUriManagedIdentity": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. User-assigned managed identity that has access to scriptUri in case of Azure storage blob.\nUse an empty object in case of system-assigned identity.\nMake sure the Azure storage blob exists, and managed identity has been given access to blob's container with 'Storage Blob Data Reader' role assignment.\nIn case of user-assigned identity, make sure you add it under VM's identity.\nFor more info on managed identity and Run Command, refer https://aka.ms/ManagedIdentity and https://aka.ms/RunCommandManaged."
                      }
                    },
                    "timeoutInSeconds": {
                      "type": "int",
                      "defaultValue": -1,
                      "metadata": {
                        "description": "Optional. The timeout in seconds to execute the run command."
                      }
                    },
                    "treatFailureAsDeploymentFailure": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Optional. If set to true, any failure in the script will fail the deployment and ProvisioningState will be marked as Failed.\nIf set to false, ProvisioningState would only reflect whether the run command was run or not by the extensions platform, it would not indicate whether script failed in case of script failures.\nSee instance view of run command in case of script failures to see executionMessage, output, error: https://aka.ms/runcommandmanaged#get-execution-status-and-results"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Tags of the resource."
                      }
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "protectedParametersArray",
                        "count": "[length(items(parameters('protectedParameters')))]",
                        "input": {
                          "name": "[items(parameters('protectedParameters'))[copyIndex('protectedParametersArray')].key]",
                          "value": "[items(parameters('protectedParameters'))[copyIndex('protectedParametersArray')].value.value]"
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "asyncExecution": "[parameters('asyncExecution')]",
                        "errorBlobManagedIdentity": "[if(not(empty(parameters('errorBlobManagedIdentity'))), parameters('errorBlobManagedIdentity'), null())]",
                        "errorBlobUri": "[if(not(empty(parameters('errorBlobContainerUri'))), format('{0}{1}-error.log', toLower(parameters('errorBlobContainerUri')), parameters('name')), null())]",
                        "outputBlobManagedIdentity": "[if(not(empty(parameters('outputBlobManagedIdentity'))), parameters('outputBlobManagedIdentity'), null())]",
                        "outputBlobUri": "[if(not(empty(parameters('outputBlobContainerUri'))), format('{0}{1}-output.log', toLower(parameters('outputBlobContainerUri')), parameters('name')), null())]",
                        "parameters": "[if(not(empty(parameters('parameters'))), parameters('parameters'), null())]",
                        "protectedParameters": "[variables('protectedParametersArray')]",
                        "runAsPassword": "[if(not(empty(parameters('runAsPassword'))), parameters('runAsPassword'), null())]",
                        "runAsUser": "[if(not(empty(parameters('runAsUser'))), parameters('runAsUser'), null())]",
                        "source": {
                          "commandId": "[if(not(empty(parameters('commandId'))), parameters('commandId'), null())]",
                          "script": "[if(not(empty(parameters('script'))), parameters('script'), null())]",
                          "scriptUri": "[if(not(empty(parameters('scriptUri'))), parameters('scriptUri'), null())]",
                          "scriptUriManagedIdentity": "[if(not(empty(parameters('scriptUriManagedIdentity'))), parameters('scriptUriManagedIdentity'), null())]"
                        },
                        "timeoutInSeconds": "[if(not(equals(parameters('timeoutInSeconds'), -1)), parameters('timeoutInSeconds'), null())]",
                        "treatFailureAsDeploymentFailure": "[parameters('treatFailureAsDeploymentFailure')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('confidentialVMOSDiskEncryption')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('RoleAssignment-ConfVMOrchestrator-ReleaseUser-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[variables('keyVaultResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyName": {
                    "value": "[parameters('keyName')]"
                  },
                  "keyVaultName": {
                    "value": "[variables('keyVaultName')]"
                  },
                  "principalId": {
                    "value": "[parameters('confidentialVMOrchestratorObjectId')]"
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  },
                  "roleDefinitionId": {
                    "value": "[variables('roleKeyVaultCryptoReleaseUser')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "10428209994367129507"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    },
                    "principalType": {
                      "type": "string"
                    },
                    "keyName": {
                      "type": "string"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                      "name": "[guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId'))]",
                      "properties": {
                        "principalId": "[parameters('principalId')]",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                        "principalType": "[parameters('principalType')]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleAssignmentId": {
                      "type": "string",
                      "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('deploymentResourceGroupName')), 'Microsoft.Resources/deployments', format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "rotationToLatestKeyVersionEnabled": "[if(parameters('confidentialVMOSDiskEncryption'), createObject('value', false()), createObject('value', true()))]",
                  "name": "[if(parameters('confidentialVMOSDiskEncryption'), createObject('value', parameters('diskEncryptionSetNames').confidentialVMs), if(equals(variables('diskEncryptionSetEncryptionType'), 'EncryptionAtRestWithCustomerKey'), createObject('value', parameters('diskEncryptionSetNames').customerManaged), createObject('value', parameters('diskEncryptionSetNames').platformAndCustomerManaged)))]",
                  "encryptionType": {
                    "value": "[variables('diskEncryptionSetEncryptionType')]"
                  },
                  "keyName": {
                    "value": "[parameters('keyName')]"
                  },
                  "keyVaultResourceId": {
                    "value": "[parameters('keyVaultResourceId')]"
                  },
                  "systemAssignedIdentity": {
                    "value": true
                  },
                  "tags": {
                    "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskEncryptionSets'), createObject()))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "2742474656852420824"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the disk encryption set that is being created."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Resource location."
                      }
                    },
                    "keyVaultResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Resource ID of the KeyVault containing the key or secret."
                      }
                    },
                    "keyName": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Key URL (with version) pointing to a key or secret in KeyVault."
                      }
                    },
                    "keyVersion": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, the latest key version is used."
                      }
                    },
                    "encryptionType": {
                      "type": "string",
                      "defaultValue": "EncryptionAtRestWithPlatformAndCustomerKeys",
                      "allowedValues": [
                        "ConfidentialVmEncryptedWithCustomerKey",
                        "EncryptionAtRestWithCustomerKey",
                        "EncryptionAtRestWithPlatformAndCustomerKeys"
                      ],
                      "metadata": {
                        "description": "Optional. The type of key used to encrypt the data of the disk. For security reasons, it is recommended to set encryptionType to EncryptionAtRestWithPlatformAndCustomerKeys."
                      }
                    },
                    "federatedClientId": {
                      "type": "string",
                      "defaultValue": "None",
                      "metadata": {
                        "description": "Optional. Multi-tenant application client ID to access key vault in a different tenant. Setting the value to \"None\" will clear the property."
                      }
                    },
                    "rotationToLatestKeyVersionEnabled": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Set this flag to true to enable auto-updating of this disk encryption set to the latest key version."
                      }
                    },
                    "systemAssignedIdentity": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Conditional. Enables system assigned managed identity on the resource. Required if userAssignedIdentities is empty."
                      }
                    },
                    "userAssignedIdentities": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Conditional. The ID(s) to assign to the resource. Required if systemAssignedIdentity is set to \"false\"."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Tags of the disk encryption resource."
                      }
                    }
                  },
                  "variables": {
                    "identityType": "[if(parameters('systemAssignedIdentity'), if(not(empty(parameters('userAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), 'UserAssigned')]",
                    "identity": {
                      "type": "[variables('identityType')]",
                      "userAssignedIdentities": "[if(not(empty(parameters('userAssignedIdentities'))), parameters('userAssignedIdentities'), null())]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/diskEncryptionSets",
                      "apiVersion": "2023-10-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": "[variables('identity')]",
                      "properties": {
                        "activeKey": {
                          "sourceVault": {
                            "id": "[parameters('keyVaultResourceId')]"
                          },
                          "keyUrl": "[if(not(empty(parameters('keyVersion'))), format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), '2023-07-01').keyUri, parameters('keyVersion')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), '2023-07-01').keyUriWithVersion)]"
                        },
                        "encryptionType": "[parameters('encryptionType')]",
                        "federatedClientId": "[parameters('federatedClientId')]",
                        "rotationToLatestKeyVersionEnabled": "[parameters('rotationToLatestKeyVersionEnabled')]"
                      },
                      "dependsOn": [
                        "keyVaultPermissions"
                      ]
                    },
                    {
                      "copy": {
                        "name": "keyVaultPermissions",
                        "count": "[length(items(parameters('userAssignedIdentities')))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('DiskEncrSet-KVPermissions-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                      "subscriptionId": "[split(parameters('keyVaultResourceId'), '/')[2]]",
                      "resourceGroup": "[split(parameters('keyVaultResourceId'), '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "keyName": {
                            "value": "[parameters('keyName')]"
                          },
                          "keyVaultResourceId": {
                            "value": "[parameters('keyVaultResourceId')]"
                          },
                          "userAssignedIdentityResourceId": {
                            "value": "[items(parameters('userAssignedIdentities'))[copyIndex()].key]"
                          },
                          "rbacAuthorizationEnabled": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('keyVaultResourceId'), '/')[2], split(parameters('keyVaultResourceId'), '/')[4]), 'Microsoft.KeyVault/vaults', last(split(parameters('keyVaultResourceId'), '/'))), '2023-07-01').enableRbacAuthorization]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "17596545792008830237"
                            }
                          },
                          "parameters": {
                            "rbacAuthorizationEnabled": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Required. A boolean to specify whether or not the used Key Vault has RBAC authentication enabled or not."
                              }
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The resourceID of the User Assigned Identity to assign permissions to."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Resource location."
                              }
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Resource ID of the KeyVault containing the key or secret."
                              }
                            },
                            "keyName": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Key URL (with version) pointing to a key or secret in KeyVault."
                              }
                            }
                          },
                          "resources": [
                            {
                              "condition": "[equals(parameters('rbacAuthorizationEnabled'), true())]",
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName'))]",
                              "name": "[guid(format('msi-{0}-{1}-{2}-Key-Reader-RoleAssignment', resourceId('Microsoft.KeyVault/vaults/keys', last(split(parameters('keyVaultResourceId'), '/')), parameters('keyName')), parameters('location'), parameters('userAssignedIdentityResourceId')))]",
                              "properties": {
                                "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location')))), '2025-04-01').outputs.principalId.value]",
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('userAssignedIdentityResourceId'), '/')[2], split(parameters('userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location'))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('UAI-Reference-{0}', uniqueString(deployment().name, parameters('location')))]",
                              "subscriptionId": "[split(parameters('userAssignedIdentityResourceId'), '/')[2]]",
                              "resourceGroup": "[split(parameters('userAssignedIdentityResourceId'), '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "userAssignedIdentityName": {
                                    "value": "[last(split(parameters('userAssignedIdentityResourceId'), '/'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "14177805491320207633"
                                    }
                                  },
                                  "parameters": {
                                    "userAssignedIdentityName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the User Assigned Identity to fetch the principal ID from."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Resource location."
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                      "apiVersion": "2018-11-30",
                                      "name": "[parameters('userAssignedIdentityName')]",
                                      "location": "[parameters('location')]"
                                    }
                                  ],
                                  "outputs": {
                                    "principalId": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2018-11-30').principalId]"
                                    }
                                  }
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the disk encryption set."
                      },
                      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the disk encryption set."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the disk encryption set was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "The principal ID of the disk encryption set."
                      },
                      "value": "[if(equals(parameters('systemAssignedIdentity'), true()), reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').identity.principalId, '')]"
                    },
                    "identities": {
                      "type": "object",
                      "metadata": {
                        "description": "The idenities of the disk encryption set."
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').identity]"
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the key vault with the disk encryption key."
                      },
                      "value": "[last(split(parameters('keyVaultResourceId'), '/'))]"
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location the resource was deployed into."
                      },
                      "value": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('name')), '2023-10-02', 'full').location]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('deploymentResourceGroupName')), 'Microsoft.Resources/deployments', format('Set-EncryptionKey-ConfidentialVMOSDisk-{0}', parameters('deploymentSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('Encryption-Key-{0}', parameters('deploymentSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('RA-DiskEncryptionSet-CryptoServiceEncryptionUser-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[variables('keyVaultResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyName": {
                    "value": "[parameters('keyName')]"
                  },
                  "keyVaultName": {
                    "value": "[variables('keyVaultName')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.principalId.value]"
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  },
                  "roleDefinitionId": {
                    "value": "[variables('roleKeyVaultCryptoUser')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "10428209994367129507"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    },
                    "principalType": {
                      "type": "string"
                    },
                    "keyName": {
                      "type": "string"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                      "name": "[guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId'))]",
                      "properties": {
                        "principalId": "[parameters('principalId')]",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                        "principalType": "[parameters('principalType')]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleAssignmentId": {
                      "type": "string",
                      "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), parameters('principalId'), parameters('roleDefinitionId')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('Get-DiskEncryptionSet-Crypto-User-RoleAssignment-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[parameters('deploymentResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.principalId.value]"
                  },
                  "resourceIds": {
                    "value": [
                      "[format('{0}/keys/{1}', parameters('keyVaultResourceId'), parameters('keyName'))]"
                    ]
                  },
                  "roleDefinitionId": {
                    "value": "[variables('roleKeyVaultCryptoUser')]"
                  },
                  "runCommandName": {
                    "value": "Get-DiskEncryptionSetCryptoUserRoleAssignment"
                  },
                  "userAssignedIdentityClientId": {
                    "value": "[parameters('deploymentUserAssignedIdentityClientId')]"
                  },
                  "virtualMachineName": {
                    "value": "[parameters('deploymentVirtualMachineName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "1881876003492702290"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "runCommandName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    },
                    "resourceIds": {
                      "type": "array"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    },
                    "userAssignedIdentityClientId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "virtualMachineName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "param(\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$ResourceManagerUri,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string[]]$ResourceIds,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$UserAssignedIdentityClientId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$PrincipalId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$RoleDefinitionId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n[array]$ResIds = $ResourceIds.replace('\\\"', '\"') | ConvertFrom-Json\r\n\r\nTry {\r\n    # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n    $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n    # Get an access token for Azure resources\r\n    $AzureManagementAccessToken = (Invoke-RestMethod -Headers @{Metadata=\"true\"} -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureManagementHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n    }\r\n\r\n    # Loop through each resource ID to find the role assignment\r\n    Write-Output \"Searching for role assignment for Principal '$PrincipalId' with Role '$RoleDefinitionId' across $($ResIds.Count) resource(s)\"\r\n    \r\n    $StartTime = Get-Date\r\n    $TimeoutSeconds = 120\r\n    $FoundRoleAssignments = @{}\r\n    $Attempt = 1\r\n\r\n    do {\r\n        Write-Output \"Attempt $Attempt - Checking for role assignment across all resources...\"\r\n        \r\n        foreach ($ResourceId in $ResIds) {\r\n            # Skip if we already found the role assignment for this resource\r\n            if ($FoundRoleAssignments.ContainsKey($ResourceId)) {\r\n                continue\r\n            }\r\n            \r\n            Write-Output \"  Checking resource id: $ResourceId\"\r\n            \r\n            # Construct the API URL for role assignments for the specific resource\r\n            $RoleAssignmentsUri = $ResourceManagerUriFixed + $ResourceId + '/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01'\r\n            \r\n            try {\r\n                # Query role assignments for the resource\r\n                $RoleAssignments = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'GET' -Uri $RoleAssignmentsUri\r\n\r\n                # Look for the specific role assignment matching both PrincipalId and RoleDefinitionId\r\n                $TargetRoleAssignment = $RoleAssignments.value.properties | Where-Object { \r\n                    $_.principalId -eq $PrincipalId -and \r\n                    $_.roleDefinitionId -eq $RoleDefinitionId \r\n                }\r\n\r\n                if ($TargetRoleAssignment) {\r\n                    $FoundRoleAssignments[$ResourceId] = $TargetRoleAssignment\r\n                    Write-Output \"  Role assignment found on resource id '$ResourceId'\"\r\n                } else {\r\n                    Write-Output \"  Role assignment not found on resource id '$ResourceId'\"\r\n                }\r\n            }\r\n            catch {\r\n                Write-Warning \"  Failed to query role assignments for resource id '$ResourceId': $($_.Exception.Message)\"\r\n                continue\r\n            }\r\n        }\r\n        $ElapsedTime = (Get-Date) - $StartTime\r\n        # Check if we found role assignments for all resources\r\n        $AllResourcesHaveAssignment = $FoundRoleAssignments.Count -eq $ResIds.Count\r\n        \r\n        if ($AllResourcesHaveAssignment) {\r\n            Write-Output \"Role assignment found on all $($ResIds.Count) resources after $($ElapsedTime.TotalSeconds) seconds.\"\r\n            break\r\n        }\r\n\r\n        if ($ElapsedTime.TotalSeconds -ge $TimeoutSeconds) {\r\n            break\r\n        }\r\n\r\n        $MissingCount = $ResIds.Count - $FoundRoleAssignments.Count\r\n        Write-Output \"Role assignment found on $($FoundRoleAssignments.Count)/$($ResIds.Count) resources. Still missing $MissingCount. Waiting 5 seconds before retry...\"\r\n        Start-Sleep -Seconds 5\r\n        $Attempt++\r\n    } while ($ElapsedTime.TotalSeconds -lt $TimeoutSeconds)\r\n\r\n    if ($FoundRoleAssignments.Count -eq 0) {\r\n        Write-Warning \"Role assignment not found on any resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId', Resources checked: $($ResIds -join ', ')\"\r\n    } elseif ($FoundRoleAssignments.Count -lt $ResIds.Count) {\r\n        $MissingResources = $ResIds | Where-Object { -not $FoundRoleAssignments.ContainsKey($_) }\r\n        Write-Warning \"Role assignment not found on all resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId'. Missing on resources: $($MissingResources -join ', ')\"\r\n    }\r\n}\r\ncatch {\r\n    Write-Error \"Error querying role assignments: $($_.Exception.Message)\"\r\n    throw $($_.Exception.Message)\r\n}\r\n"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('runCommandName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "asyncExecution": false,
                        "parameters": [
                          {
                            "name": "ResourceManagerUri",
                            "value": "[environment().resourceManager]"
                          },
                          {
                            "name": "ResourceIds",
                            "value": "[string(parameters('resourceIds'))]"
                          },
                          {
                            "name": "UserAssignedIdentityClientId",
                            "value": "[parameters('userAssignedIdentityClientId')]"
                          },
                          {
                            "name": "PrincipalId",
                            "value": "[parameters('principalId')]"
                          },
                          {
                            "name": "RoleDefinitionId",
                            "value": "[subscriptionResourceId('microsoft.authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#0')]"
                        },
                        "timeoutInSeconds": 180,
                        "treatFailureAsDeploymentFailure": false
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('RA-DiskEncryptionSet-CryptoServiceEncryptionUser-{0}', parameters('deploymentSuffix')))]"
              ]
            },
            {
              "condition": "[parameters('confidentialVMOSDiskEncryption')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('Get-DiskEncryptionSet-CryptoReleaseUser-RoleAssignment-{0}', parameters('deploymentSuffix'))]",
              "resourceGroup": "[parameters('deploymentResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "principalId": {
                    "value": "[parameters('confidentialVMOrchestratorObjectId')]"
                  },
                  "resourceIds": {
                    "value": [
                      "[format('{0}/keys/{1}', parameters('keyVaultResourceId'), parameters('keyName'))]"
                    ]
                  },
                  "roleDefinitionId": {
                    "value": "[variables('roleKeyVaultCryptoReleaseUser')]"
                  },
                  "runCommandName": {
                    "value": "Get-DiskEncryptionSetCryptoReleaseUserRoleAssignment"
                  },
                  "userAssignedIdentityClientId": {
                    "value": "[parameters('deploymentUserAssignedIdentityClientId')]"
                  },
                  "virtualMachineName": {
                    "value": "[parameters('deploymentVirtualMachineName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "1881876003492702290"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "runCommandName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    },
                    "resourceIds": {
                      "type": "array"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    },
                    "userAssignedIdentityClientId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "virtualMachineName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "param(\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$ResourceManagerUri,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string[]]$ResourceIds,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$UserAssignedIdentityClientId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$PrincipalId,\r\n\r\n    [Parameter(Mandatory=$true)]\r\n    [string]$RoleDefinitionId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n[array]$ResIds = $ResourceIds.replace('\\\"', '\"') | ConvertFrom-Json\r\n\r\nTry {\r\n    # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n    $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n    # Get an access token for Azure resources\r\n    $AzureManagementAccessToken = (Invoke-RestMethod -Headers @{Metadata=\"true\"} -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $AzureManagementHeader = @{\r\n        'Content-Type'='application/json'\r\n        'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n    }\r\n\r\n    # Loop through each resource ID to find the role assignment\r\n    Write-Output \"Searching for role assignment for Principal '$PrincipalId' with Role '$RoleDefinitionId' across $($ResIds.Count) resource(s)\"\r\n    \r\n    $StartTime = Get-Date\r\n    $TimeoutSeconds = 120\r\n    $FoundRoleAssignments = @{}\r\n    $Attempt = 1\r\n\r\n    do {\r\n        Write-Output \"Attempt $Attempt - Checking for role assignment across all resources...\"\r\n        \r\n        foreach ($ResourceId in $ResIds) {\r\n            # Skip if we already found the role assignment for this resource\r\n            if ($FoundRoleAssignments.ContainsKey($ResourceId)) {\r\n                continue\r\n            }\r\n            \r\n            Write-Output \"  Checking resource id: $ResourceId\"\r\n            \r\n            # Construct the API URL for role assignments for the specific resource\r\n            $RoleAssignmentsUri = $ResourceManagerUriFixed + $ResourceId + '/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01'\r\n            \r\n            try {\r\n                # Query role assignments for the resource\r\n                $RoleAssignments = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'GET' -Uri $RoleAssignmentsUri\r\n\r\n                # Look for the specific role assignment matching both PrincipalId and RoleDefinitionId\r\n                $TargetRoleAssignment = $RoleAssignments.value.properties | Where-Object { \r\n                    $_.principalId -eq $PrincipalId -and \r\n                    $_.roleDefinitionId -eq $RoleDefinitionId \r\n                }\r\n\r\n                if ($TargetRoleAssignment) {\r\n                    $FoundRoleAssignments[$ResourceId] = $TargetRoleAssignment\r\n                    Write-Output \"  Role assignment found on resource id '$ResourceId'\"\r\n                } else {\r\n                    Write-Output \"  Role assignment not found on resource id '$ResourceId'\"\r\n                }\r\n            }\r\n            catch {\r\n                Write-Warning \"  Failed to query role assignments for resource id '$ResourceId': $($_.Exception.Message)\"\r\n                continue\r\n            }\r\n        }\r\n        $ElapsedTime = (Get-Date) - $StartTime\r\n        # Check if we found role assignments for all resources\r\n        $AllResourcesHaveAssignment = $FoundRoleAssignments.Count -eq $ResIds.Count\r\n        \r\n        if ($AllResourcesHaveAssignment) {\r\n            Write-Output \"Role assignment found on all $($ResIds.Count) resources after $($ElapsedTime.TotalSeconds) seconds.\"\r\n            break\r\n        }\r\n\r\n        if ($ElapsedTime.TotalSeconds -ge $TimeoutSeconds) {\r\n            break\r\n        }\r\n\r\n        $MissingCount = $ResIds.Count - $FoundRoleAssignments.Count\r\n        Write-Output \"Role assignment found on $($FoundRoleAssignments.Count)/$($ResIds.Count) resources. Still missing $MissingCount. Waiting 5 seconds before retry...\"\r\n        Start-Sleep -Seconds 5\r\n        $Attempt++\r\n    } while ($ElapsedTime.TotalSeconds -lt $TimeoutSeconds)\r\n\r\n    if ($FoundRoleAssignments.Count -eq 0) {\r\n        Write-Warning \"Role assignment not found on any resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId', Resources checked: $($ResIds -join ', ')\"\r\n    } elseif ($FoundRoleAssignments.Count -lt $ResIds.Count) {\r\n        $MissingResources = $ResIds | Where-Object { -not $FoundRoleAssignments.ContainsKey($_) }\r\n        Write-Warning \"Role assignment not found on all resources after $TimeoutSeconds seconds. Principal ID: '$PrincipalId', Role Definition ID: '$RoleDefinitionId'. Missing on resources: $($MissingResources -join ', ')\"\r\n    }\r\n}\r\ncatch {\r\n    Write-Error \"Error querying role assignments: $($_.Exception.Message)\"\r\n    throw $($_.Exception.Message)\r\n}\r\n"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('runCommandName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "asyncExecution": false,
                        "parameters": [
                          {
                            "name": "ResourceManagerUri",
                            "value": "[environment().resourceManager]"
                          },
                          {
                            "name": "ResourceIds",
                            "value": "[string(parameters('resourceIds'))]"
                          },
                          {
                            "name": "UserAssignedIdentityClientId",
                            "value": "[parameters('userAssignedIdentityClientId')]"
                          },
                          {
                            "name": "PrincipalId",
                            "value": "[parameters('principalId')]"
                          },
                          {
                            "name": "RoleDefinitionId",
                            "value": "[subscriptionResourceId('microsoft.authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#0')]"
                        },
                        "timeoutInSeconds": 180,
                        "treatFailureAsDeploymentFailure": false
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', format('RoleAssignment-ConfVMOrchestrator-ReleaseUser-{0}', parameters('deploymentSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "diskEncryptionSetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DiskEncryptionSet-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "availabilitySets",
        "count": "[length(range(0, parameters('availabilitySetsCount')))]"
      },
      "condition": "[and(parameters('pooledHostPool'), equals(parameters('availability'), 'AvailabilitySets'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-{1}', replace(parameters('availabilitySetNameConv'), '##', padLeft(add(add(range(0, parameters('availabilitySetsCount'))[copyIndex()], parameters('availabilitySetsIndex')), 1), 2, '0')), parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[replace(parameters('availabilitySetNameConv'), '##', padLeft(add(add(range(0, parameters('availabilitySetsCount'))[copyIndex()], parameters('availabilitySetsIndex')), 1), 2, '0'))]"
          },
          "platformFaultDomainCount": {
            "value": 2
          },
          "platformUpdateDomainCount": {
            "value": 5
          },
          "proximityPlacementGroupResourceId": {
            "value": ""
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "skuName": {
            "value": "Aligned"
          },
          "tags": {
            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/availabilitySets'), createObject()))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3553316518590342751"
            },
            "name": "Availability Sets",
            "description": "This module deploys an Availability Set.",
            "owner": "Azure/module-maintainers"
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the availability set that is being created."
              }
            },
            "platformFaultDomainCount": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Optional. The number of fault domains to use."
              }
            },
            "platformUpdateDomainCount": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Optional. The number of update domains to use."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Aligned",
              "metadata": {
                "description": "Optional. SKU of the availability set.</p>- Use 'Aligned' for virtual machines with managed disks.</p>- Use 'Classic' for virtual machines with unmanaged disks."
              }
            },
            "proximityPlacementGroupResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Resource ID of a proximity placement group."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. Resource location."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Tags of the availability set resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2022-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "platformFaultDomainCount": "[parameters('platformFaultDomainCount')]",
                "platformUpdateDomainCount": "[parameters('platformUpdateDomainCount')]",
                "proximityPlacementGroup": "[if(not(empty(parameters('proximityPlacementGroupResourceId'))), createObject('id', parameters('proximityPlacementGroupResourceId')), null())]"
              },
              "sku": {
                "name": "[parameters('skuName')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set."
              },
              "value": "[parameters('name')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the availability set."
              },
              "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the availability set was deployed into."
              },
              "value": "[resourceGroup().name]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location the resource was deployed into."
              },
              "value": "[reference(resourceId('Microsoft.Compute/availabilitySets', parameters('name')), '2022-11-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(parameters('fslogixConfigureSessionHosts'), or(not(empty(parameters('fslogixLocalNetAppVolumeResourceIds'))), not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds')))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('NetAppVolumeFqdns-{0}', parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "localNetAppVolumeResourceIds": {
            "value": "[parameters('fslogixLocalNetAppVolumeResourceIds')]"
          },
          "remoteNetAppVolumeResourceIds": {
            "value": "[parameters('fslogixRemoteNetAppVolumeResourceIds')]"
          },
          "shareNames": {
            "value": "[parameters('fslogixFileShareNames')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11609031045672993663"
            }
          },
          "parameters": {
            "localNetAppVolumeResourceIds": {
              "type": "array"
            },
            "remoteNetAppVolumeResourceIds": {
              "type": "array"
            },
            "shareNames": {
              "type": "array"
            }
          },
          "variables": {
            "localNetAppProfileContainerVolumeResourceIds": "[if(not(empty(parameters('localNetAppVolumeResourceIds'))), filter(parameters('localNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('shareNames')[0]))), createArray())]",
            "localNetAppOfficeContainerVolumeResourceIds": "[if(and(not(empty(parameters('localNetAppVolumeResourceIds'))), greater(length(parameters('shareNames')), 1)), filter(parameters('localNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('shareNames')[1]))), createArray())]",
            "sortedLocalNetAppResourceIds": "[union(variables('localNetAppProfileContainerVolumeResourceIds'), variables('localNetAppOfficeContainerVolumeResourceIds'))]",
            "remoteNetAppProfileContainerVolumeResourceIds": "[if(not(empty(parameters('remoteNetAppVolumeResourceIds'))), filter(parameters('remoteNetAppVolumeResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('shareNames')[0]))), createArray())]",
            "remoteNetAppOfficeContainerVolumeResourceIds": "[if(and(not(empty(parameters('remoteNetAppVolumeResourceIds'))), greater(length(parameters('shareNames')), 1)), filter(parameters('remoteNetAppVolumeResourceIds'), lambda('id', not(contains(lambdaVariables('id'), parameters('shareNames')[0])))), createArray())]",
            "sortedRemoteNetAppResourceIds": "[union(variables('remoteNetAppProfileContainerVolumeResourceIds'), variables('remoteNetAppOfficeContainerVolumeResourceIds'))]"
          },
          "resources": [],
          "outputs": {
            "localNetAppVolumeSmbServerFqdns": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(variables('sortedLocalNetAppResourceIds'))))]",
                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]], '/')[2], split(variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]], '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(last(split(variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]], '/')), '/')[0], split(last(split(variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]], '/')), '/')[1], split(last(split(variables('sortedLocalNetAppResourceIds')[range(0, length(variables('sortedLocalNetAppResourceIds')))[range(0, length(variables('sortedLocalNetAppResourceIds')))[copyIndex()]]], '/')), '/')[2]), '2023-11-01').mountTargets[0].smbServerFqdn]"
              }
            },
            "remoteNetAppVolumeSmbServerFqdns": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(variables('sortedRemoteNetAppResourceIds'))))]",
                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]], '/')[2], split(variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]], '/')[4]), 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', split(last(split(variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]], '/')), '/')[0], split(last(split(variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]], '/')), '/')[1], split(last(split(variables('sortedRemoteNetAppResourceIds')[range(0, length(variables('sortedRemoteNetAppResourceIds')))[range(0, length(variables('sortedRemoteNetAppResourceIds')))[copyIndex()]]], '/')), '/')[2]), '2023-11-01').mountTargets[0].smbServerFqdn]"
              }
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "virtualMachines",
        "count": "[length(range(1, parameters('sessionHostBatchCount')))]",
        "mode": "serial",
        "batchSize": 5
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('VirtualMachines-Batch-{0}-{1}', sub(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsContainerUri": {
            "value": "[parameters('artifactsContainerUri')]"
          },
          "artifactsUserAssignedIdentityResourceId": {
            "value": "[parameters('artifactsUserAssignedIdentityResourceId')]"
          },
          "artifactsUserAssignedIdentityClientId": "[if(empty(parameters('artifactsUserAssignedIdentityResourceId')), createObject('value', ''), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('artifactsUserAssignedIdentityResourceId'), '/')[2], split(parameters('artifactsUserAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(parameters('artifactsUserAssignedIdentityResourceId'), '/'))), '2018-11-30').clientId))]",
          "availability": {
            "value": "[parameters('availability')]"
          },
          "availabilityZones": {
            "value": "[parameters('availabilityZones')]"
          },
          "availabilitySetNameConv": {
            "value": "[parameters('availabilitySetNameConv')]"
          },
          "avdInsightsDataCollectionRulesResourceId": {
            "value": "[parameters('avdInsightsDataCollectionRulesResourceId')]"
          },
          "confidentialVMOSDiskEncryptionType": {
            "value": "[variables('confidentialVMOSDiskEncryptionType')]"
          },
          "customImageResourceId": {
            "value": "[parameters('customImageResourceId')]"
          },
          "dataCollectionEndpointResourceId": {
            "value": "[parameters('dataCollectionEndpointResourceId')]"
          },
          "dedicatedHostGroupResourceId": {
            "value": "[parameters('dedicatedHostGroupResourceId')]"
          },
          "dedicatedHostGroupZones": "[if(not(empty(variables('dedicatedHostGroupName'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('dedicatedHostSub'), variables('dedicatedHostRG')), 'Microsoft.Compute/hostGroups', variables('dedicatedHostGroupName')), '2024-11-01', 'full').zones), createObject('value', createArray()))]",
          "dedicatedHostResourceId": {
            "value": "[parameters('dedicatedHostResourceId')]"
          },
          "diskAccessId": "[if(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), if(parameters('deployDiskAccessResource'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value), createObject('value', '')), createObject('value', parameters('existingDiskAccessResourceId')))]",
          "diskEncryptionSetResourceId": "[if(and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), not(equals(parameters('keyManagementDisks'), 'PlatformManaged'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value), if(not(empty(parameters('existingDiskEncryptionSetResourceId'))), createObject('value', parameters('existingDiskEncryptionSetResourceId')), createObject('value', '')))]",
          "diskSizeGB": {
            "value": "[parameters('diskSizeGB')]"
          },
          "diskSku": {
            "value": "[parameters('diskSku')]"
          },
          "domainJoinUserPassword": {
            "value": "[parameters('domainJoinUserPassword')]"
          },
          "domainJoinUserPrincipalName": {
            "value": "[parameters('domainJoinUserPrincipalName')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "enableAcceleratedNetworking": {
            "value": "[parameters('enableAcceleratedNetworking')]"
          },
          "enableIPv6": {
            "value": "[parameters('enableIPv6')]"
          },
          "enableMonitoring": {
            "value": "[parameters('enableMonitoring')]"
          },
          "encryptionAtHost": {
            "value": "[parameters('encryptionAtHost')]"
          },
          "fslogixConfigureSessionHosts": {
            "value": "[parameters('fslogixConfigureSessionHosts')]"
          },
          "fslogixContainerType": {
            "value": "[parameters('fslogixContainerType')]"
          },
          "fslogixFileShareNames": {
            "value": "[parameters('fslogixFileShareNames')]"
          },
          "fslogixOSSGroups": {
            "value": "[parameters('fslogixOSSGroups')]"
          },
          "fslogixLocalNetAppServerFqdns": "[if(and(parameters('fslogixConfigureSessionHosts'), not(empty(parameters('fslogixLocalNetAppVolumeResourceIds')))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('NetAppVolumeFqdns-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.localNetAppVolumeSmbServerFqdns.value), createObject('value', createArray()))]",
          "fslogixLocalStorageAccountResourceIds": {
            "value": "[parameters('fslogixLocalStorageAccountResourceIds')]"
          },
          "fslogixRemoteNetAppServerFqdns": "[if(and(parameters('fslogixConfigureSessionHosts'), not(empty(parameters('fslogixRemoteNetAppVolumeResourceIds')))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('NetAppVolumeFqdns-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.remoteNetAppVolumeSmbServerFqdns.value), createObject('value', createArray()))]",
          "fslogixRemoteStorageAccountResourceIds": {
            "value": "[parameters('fslogixRemoteStorageAccountResourceIds')]"
          },
          "fslogixSizeInMBs": {
            "value": "[parameters('fslogixSizeInMBs')]"
          },
          "fslogixStorageService": {
            "value": "[parameters('fslogixStorageService')]"
          },
          "hibernationEnabled": {
            "value": "[parameters('hibernationEnabled')]"
          },
          "hostPoolResourceId": "[if(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), createObject('value', parameters('hostPoolResourceId')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.resourceId.value))]",
          "identitySolution": {
            "value": "[parameters('identitySolution')]"
          },
          "imageOffer": {
            "value": "[parameters('imageOffer')]"
          },
          "imagePublisher": {
            "value": "[parameters('imagePublisher')]"
          },
          "imageSku": {
            "value": "[parameters('imageSku')]"
          },
          "integrityMonitoring": {
            "value": "[parameters('integrityMonitoring')]"
          },
          "intuneEnrollment": {
            "value": "[parameters('intuneEnrollment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "networkInterfaceNameConv": {
            "value": "[parameters('networkInterfaceNameConv')]"
          },
          "osDiskNameConv": {
            "value": "[parameters('osDiskNameConv')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "sessionHostCustomizations": {
            "value": "[parameters('sessionHostCustomizations')]"
          },
          "securityDataCollectionRulesResourceId": {
            "value": "[parameters('securityDataCollectionRulesResourceId')]"
          },
          "secureBootEnabled": {
            "value": "[parameters('secureBootEnabled')]"
          },
          "securityType": {
            "value": "[parameters('securityType')]"
          },
          "sessionHostCount": "[if(and(equals(range(1, parameters('sessionHostBatchCount'))[copyIndex()], parameters('sessionHostBatchCount')), greater(parameters('divisionRemainderValue'), 0)), createObject('value', parameters('divisionRemainderValue')), createObject('value', parameters('maxVMsPerDeployment')))]",
          "sessionHostIndex": "[if(equals(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), createObject('value', parameters('sessionHostIndex')), createObject('value', add(mul(sub(range(1, parameters('sessionHostBatchCount'))[copyIndex()], 1), parameters('maxVMsPerDeployment')), parameters('sessionHostIndex'))))]",
          "vmNameIndexLength": {
            "value": "[parameters('vmNameIndexLength')]"
          },
          "sessionHostRegistrationDSCUrl": {
            "value": "[parameters('sessionHostRegistrationDSCUrl')]"
          },
          "storageSuffix": {
            "value": "[parameters('storageSuffix')]"
          },
          "subnetResourceId": {
            "value": "[parameters('subnetResourceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "deploymentSuffix": {
            "value": "[parameters('deploymentSuffix')]"
          },
          "timeZone": {
            "value": "[parameters('timeZone')]"
          },
          "useAgentDownloadEndpoint": {
            "value": "[parameters('useAgentDownloadEndpoint')]"
          },
          "virtualMachineAdminPassword": {
            "value": "[parameters('virtualMachineAdminPassword')]"
          },
          "virtualMachineAdminUserName": {
            "value": "[parameters('virtualMachineAdminUserName')]"
          },
          "virtualMachineNameConv": {
            "value": "[parameters('virtualMachineNameConv')]"
          },
          "virtualMachineNamePrefix": {
            "value": "[parameters('virtualMachineNamePrefix')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('virtualMachineSize')]"
          },
          "vmInsightsDataCollectionRulesResourceId": {
            "value": "[parameters('vmInsightsDataCollectionRulesResourceId')]"
          },
          "vTpmEnabled": {
            "value": "[parameters('vTpmEnabled')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5535385841635305185"
            }
          },
          "parameters": {
            "artifactsContainerUri": {
              "type": "string"
            },
            "artifactsUserAssignedIdentityClientId": {
              "type": "string"
            },
            "artifactsUserAssignedIdentityResourceId": {
              "type": "string"
            },
            "availability": {
              "type": "string"
            },
            "availabilitySetNameConv": {
              "type": "string"
            },
            "availabilityZones": {
              "type": "array"
            },
            "avdInsightsDataCollectionRulesResourceId": {
              "type": "string"
            },
            "confidentialVMOSDiskEncryptionType": {
              "type": "string"
            },
            "customImageResourceId": {
              "type": "string"
            },
            "dataCollectionEndpointResourceId": {
              "type": "string"
            },
            "dedicatedHostGroupResourceId": {
              "type": "string"
            },
            "dedicatedHostGroupZones": {
              "type": "array"
            },
            "dedicatedHostResourceId": {
              "type": "string"
            },
            "diskAccessId": {
              "type": "string"
            },
            "diskEncryptionSetResourceId": {
              "type": "string"
            },
            "diskSizeGB": {
              "type": "int"
            },
            "diskSku": {
              "type": "string"
            },
            "domainJoinUserPassword": {
              "type": "securestring"
            },
            "domainJoinUserPrincipalName": {
              "type": "securestring"
            },
            "domainName": {
              "type": "string"
            },
            "enableAcceleratedNetworking": {
              "type": "bool"
            },
            "enableIPv6": {
              "type": "bool"
            },
            "enableMonitoring": {
              "type": "bool"
            },
            "encryptionAtHost": {
              "type": "bool"
            },
            "fslogixConfigureSessionHosts": {
              "type": "bool"
            },
            "fslogixContainerType": {
              "type": "string"
            },
            "fslogixFileShareNames": {
              "type": "array"
            },
            "fslogixLocalNetAppServerFqdns": {
              "type": "array"
            },
            "fslogixLocalStorageAccountResourceIds": {
              "type": "array"
            },
            "fslogixOSSGroups": {
              "type": "array"
            },
            "fslogixRemoteNetAppServerFqdns": {
              "type": "array"
            },
            "fslogixRemoteStorageAccountResourceIds": {
              "type": "array"
            },
            "fslogixSizeInMBs": {
              "type": "int"
            },
            "fslogixStorageService": {
              "type": "string"
            },
            "hibernationEnabled": {
              "type": "bool"
            },
            "hostPoolResourceId": {
              "type": "string"
            },
            "identitySolution": {
              "type": "string"
            },
            "imageOffer": {
              "type": "string"
            },
            "imagePublisher": {
              "type": "string"
            },
            "imageSku": {
              "type": "string"
            },
            "integrityMonitoring": {
              "type": "bool"
            },
            "intuneEnrollment": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "networkInterfaceNameConv": {
              "type": "string"
            },
            "osDiskNameConv": {
              "type": "string"
            },
            "ouPath": {
              "type": "string"
            },
            "sessionHostCustomizations": {
              "type": "array"
            },
            "sessionHostCount": {
              "type": "int"
            },
            "sessionHostIndex": {
              "type": "int"
            },
            "vmNameIndexLength": {
              "type": "int"
            },
            "sessionHostRegistrationDSCUrl": {
              "type": "string"
            },
            "securityDataCollectionRulesResourceId": {
              "type": "string"
            },
            "securityType": {
              "type": "string"
            },
            "secureBootEnabled": {
              "type": "bool"
            },
            "storageSuffix": {
              "type": "string"
            },
            "subnetResourceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "deploymentSuffix": {
              "type": "string"
            },
            "timeZone": {
              "type": "string"
            },
            "useAgentDownloadEndpoint": {
              "type": "bool"
            },
            "virtualMachineAdminPassword": {
              "type": "securestring"
            },
            "virtualMachineAdminUserName": {
              "type": "securestring"
            },
            "virtualMachineNameConv": {
              "type": "string"
            },
            "virtualMachineNamePrefix": {
              "type": "string"
            },
            "virtualMachineSize": {
              "type": "string"
            },
            "vmInsightsDataCollectionRulesResourceId": {
              "type": "string"
            },
            "vTpmEnabled": {
              "type": "bool"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "fslogixLocalStorageAccountNames",
                "count": "[length(parameters('fslogixLocalStorageAccountResourceIds'))]",
                "input": "[last(split(parameters('fslogixLocalStorageAccountResourceIds')[copyIndex('fslogixLocalStorageAccountNames')], '/'))]"
              },
              {
                "name": "fslogixRemoteStorageAccountNames",
                "count": "[length(parameters('fslogixRemoteStorageAccountResourceIds'))]",
                "input": "[last(split(parameters('fslogixRemoteStorageAccountResourceIds')[copyIndex('fslogixRemoteStorageAccountNames')], '/'))]"
              },
              {
                "name": "fslogixLocalSANameMinus2",
                "count": "[length(variables('fslogixLocalStorageAccountNames'))]",
                "input": "[take(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')], sub(length(variables('fslogixLocalStorageAccountNames')[copyIndex('fslogixLocalSANameMinus2')]), 2))]"
              },
              {
                "name": "fslogixRemoteSANameMinus2",
                "count": "[length(variables('fslogixRemoteStorageAccountNames'))]",
                "input": "[take(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')], sub(length(variables('fslogixRemoteStorageAccountNames')[copyIndex('fslogixRemoteSANameMinus2')]), 2))]"
              },
              {
                "name": "fslogixExclusionsOfficeArray",
                "count": "[length(variables('fslogixOfficeVHDXs'))]",
                "input": "[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')], variables('fslogixOfficeVHDXs')[copyIndex('fslogixExclusionsOfficeArray')])]"
              },
              {
                "name": "fslogixExclusionProfileArray",
                "count": "[length(variables('fslogixProfileVHDXs'))]",
                "input": "[format('{0};{1}.lock;{2}.meta;{3}.metadata', variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')], variables('fslogixProfileVHDXs')[copyIndex('fslogixExclusionProfileArray')])]"
              }
            ],
            "$fxv#0": "[CmdletBinding(SupportsShouldProcess = $true)]\r\nparam (\r\n    [string]$AmdVmSize,\r\n    [string]$NvidiaVmSize,\r\n    [string]$DisableUpdates,\r\n    [string]$ConfigureFSLogix,\r\n    [string]$CloudCache = 'false',\r\n    [string]$IdentitySolution,\r\n    [string]$LocalNetAppServers,\r\n    [string]$LocalStorageAccountNames,\r\n    [string]$LocalStorageAccountKeys,\r\n    [string]$OSSGroups,\r\n    [string]$RemoteNetAppServers,\r\n    [string]$RemoteStorageAccountNames,\r\n    [string]$RemoteStorageAccountKeys,\r\n    [string]$Shares,\r\n    [string]$SizeInMBs,\r\n    [string]$StorageAccountDNSSuffix,\r\n    [string]$StorageService,\r\n    [string]$TimeZone\r\n)\r\n\r\n#region Functions\r\n\r\nfunction New-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $true, Position = 0)]\r\n        [string] $Path\r\n    )\r\n\r\n    $date = Get-Date -UFormat \"%Y-%m-%d %H-%M-%S\"\r\n    Set-Variable logFile -Scope Script\r\n    $script:logFile = \"$Script:Name-$date.log\"\r\n\r\n    if ((Test-Path $path ) -eq $false) {\r\n        $null = New-Item -Path $path -type directory\r\n    }\r\n\r\n    $script:Log = Join-Path $path $logfile\r\n\r\n    Add-Content $script:Log \"Date`t`t`tCategory`t`tDetails\"\r\n}\r\n\r\nfunction Write-Log {\r\n    Param (\r\n        [Parameter(Mandatory = $false, Position = 0)]\r\n        [ValidateSet(\"Info\", \"Warning\", \"Error\")]\r\n        $Category = 'Info',\r\n        [Parameter(Mandatory = $true, Position = 1)]\r\n        $Message\r\n    )\r\n\r\n    $Date = get-date\r\n    $Content = \"[$Date]`t$Category`t`t$Message`n\" \r\n    Add-Content $Script:Log $content -ErrorAction Stop\r\n    If ($Verbose) {\r\n        Write-Verbose $Content\r\n    }\r\n    Else {\r\n        Switch ($Category) {\r\n            'Info' { Write-Host $content }\r\n            'Error' { Write-Error $Content }\r\n            'Warning' { Write-Warning $Content }\r\n        }\r\n    }\r\n}\r\n\r\nFunction ConvertFrom-JsonString {\r\n    [CmdletBinding()]\r\n    param (\r\n        [string]$JsonString,\r\n        [string]$Name,\r\n        [switch]$SensitiveValues      \r\n    )\r\n    If ($JsonString -ne '[]' -and $JsonString -ne $null) {\r\n        [array]$Array = $JsonString.replace('\\', '') | ConvertFrom-Json\r\n        If ($Array.Length -gt 0) {\r\n            If ($SensitiveValues) { Write-Log -message \"Array '$Name' has $($Array.Length) members\" } Else { Write-Log -message \"$($Name): '$($Array -join \"', '\")'\" }\r\n            Return $Array\r\n        }\r\n        Else {\r\n            Return $null\r\n        }            \r\n    }\r\n    Else {\r\n        Return $null\r\n    }    \r\n}\r\n\r\nFunction Convert-GroupToSID {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$DomainName,\r\n\r\n        [Parameter(Mandatory = $true)]\r\n        [string]$GroupName\r\n    )\r\n    Begin {\r\n        [string]$groupSID = ''\r\n    }\r\n    Process {\r\n        Try {\r\n            $groupSID = (New-Object System.Security.Principal.NTAccount(\"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n        }\r\n        Catch {\r\n            Try {\r\n                $groupSID = (New-Object System.Security.Principal.NTAccount($DomainName, \"$GroupName\")).Translate([System.Security.Principal.SecurityIdentifier]).Value\r\n            }\r\n            Catch {\r\n                Write-Error -Message \"Failed to convert group name '$GroupName' to SID.\"\r\n            }\r\n        }\r\n        Write-Output -InputObject $groupSID\r\n    }\r\n}\r\n\r\nFunction Get-InstalledApplication {\r\n    [CmdletBinding()]\r\n    Param (\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string[]]$Name,\r\n        [Parameter(Mandatory = $false)]\r\n        [ValidateNotNullorEmpty()]\r\n        [string]$ProductCode\r\n    )\r\n\r\n    Begin {\r\n        [string[]]$regKeyApplications = 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall', 'Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall'\r\n    }\r\n    Process { \r\n        ## Enumerate the installed applications from the registry for applications that have the \"DisplayName\" property\r\n        [psobject[]]$regKeyApplication = @()\r\n        ForEach ($regKey in $regKeyApplications) {\r\n            If (Test-Path -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath') {\r\n                [psobject[]]$UninstallKeyApps = Get-ChildItem -LiteralPath $regKey -ErrorAction 'SilentlyContinue' -ErrorVariable '+ErrorUninstallKeyPath'\r\n                ForEach ($UninstallKeyApp in $UninstallKeyApps) {\r\n                    Try {\r\n                        [psobject]$regKeyApplicationProps = Get-ItemProperty -LiteralPath $UninstallKeyApp.PSPath -ErrorAction 'Stop'\r\n                        If ($regKeyApplicationProps.DisplayName) { [psobject[]]$regKeyApplication += $regKeyApplicationProps }\r\n                    }\r\n                    Catch {\r\n                        Continue\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ## Create a custom object with the desired properties for the installed applications and sanitize property details\r\n        [psobject[]]$installedApplication = @()\r\n        ForEach ($regKeyApp in $regKeyApplication) {\r\n            Try {\r\n                [string]$appDisplayName = ''\r\n                [string]$appDisplayVersion = ''\r\n                [string]$appPublisher = ''\r\n\r\n                ## Bypass any updates or hotfixes\r\n                If (($regKeyApp.DisplayName -match '(?i)kb\\d+') -or ($regKeyApp.DisplayName -match 'Cumulative Update') -or ($regKeyApp.DisplayName -match 'Security Update') -or ($regKeyApp.DisplayName -match 'Hotfix')) {\r\n                    Continue\r\n                }\r\n\r\n                ## Remove any control characters which may interfere with logging and creating file path names from these variables\r\n                $appDisplayName = $regKeyApp.DisplayName -replace '[^\\u001F-\\u007F]', ''\r\n                $appDisplayVersion = $regKeyApp.DisplayVersion -replace '[^\\u001F-\\u007F]', ''\r\n                $appPublisher = $regKeyApp.Publisher -replace '[^\\u001F-\\u007F]', ''\r\n\r\n                ## Determine if application is a 64-bit application\r\n                [boolean]$Is64BitApp = If (($is64Bit) -and ($regKeyApp.PSPath -notmatch '^Microsoft\\.PowerShell\\.Core\\\\Registry::HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Wow6432Node')) { $true } Else { $false }\r\n\r\n                If ($ProductCode) {\r\n                    ## Verify if there is a match with the product code passed to the script\r\n                    If ($regKeyApp.PSChildName -match [regex]::Escape($productCode)) {\r\n                        $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                            UninstallSubkey    = $regKeyApp.PSChildName\r\n                            ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                            DisplayName        = $appDisplayName\r\n                            DisplayVersion     = $appDisplayVersion\r\n                            UninstallString    = $regKeyApp.UninstallString\r\n                            InstallSource      = $regKeyApp.InstallSource\r\n                            InstallLocation    = $regKeyApp.InstallLocation\r\n                            InstallDate        = $regKeyApp.InstallDate\r\n                            Publisher          = $appPublisher\r\n                            Is64BitApplication = $Is64BitApp\r\n                        }\r\n                    }\r\n                }\r\n\r\n                If ($name) {\r\n                    ## Verify if there is a match with the application name(s) passed to the script\r\n                    ForEach ($application in $Name) {\r\n                        $applicationMatched = $false\r\n                        #  Check for a contains application name match\r\n                        If ($regKeyApp.DisplayName -match [regex]::Escape($application)) {\r\n                            $applicationMatched = $true\r\n                        }\r\n\r\n                        If ($applicationMatched) {\r\n                            $installedApplication += New-Object -TypeName 'PSObject' -Property @{\r\n                                UninstallSubkey    = $regKeyApp.PSChildName\r\n                                ProductCode        = If ($regKeyApp.PSChildName -match $MSIProductCodeRegExPattern) { $regKeyApp.PSChildName } Else { [string]::Empty }\r\n                                DisplayName        = $appDisplayName\r\n                                DisplayVersion     = $appDisplayVersion\r\n                                UninstallString    = $regKeyApp.UninstallString\r\n                                InstallSource      = $regKeyApp.InstallSource\r\n                                InstallLocation    = $regKeyApp.InstallLocation\r\n                                InstallDate        = $regKeyApp.InstallDate\r\n                                Publisher          = $appPublisher\r\n                                Is64BitApplication = $Is64BitApp\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Catch {\r\n                Continue\r\n            }\r\n        }\r\n        Write-Output -InputObject $installedApplication\r\n    }\r\n}\r\n\r\nFunction Set-RegistryValue {\r\n    [CmdletBinding()]\r\n    param (\r\n        [Parameter()]\r\n        [string]\r\n        $Name,\r\n        [Parameter()]\r\n        [string]\r\n        $Path,\r\n        [Parameter()]\r\n        [string]$PropertyType,\r\n        [Parameter()]\r\n        $Value\r\n    )\r\n    Begin {\r\n        Write-Log -message \"[Set-RegistryValue]: Setting Registry Value: $Name\"\r\n    }\r\n    Process {\r\n        # Create the registry Key(s) if necessary.\r\n        If (!(Test-Path -Path $Path)) {\r\n            Write-Log -message \"[Set-RegistryValue]: Creating Registry Key: $Path\"\r\n            New-Item -Path $Path -Force | Out-Null\r\n        }\r\n        # Check for existing registry setting\r\n        $RemoteValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue\r\n        If ($RemoteValue) {\r\n            # Get current Value\r\n            $CurrentValue = Get-ItemPropertyValue -Path $Path -Name $Name\r\n            Write-Log -message \"[Set-RegistryValue]: Current Value of $($Path)\\$($Name) : $CurrentValue\"\r\n            If ($Value -ne $CurrentValue) {\r\n                Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n                Set-ItemProperty -Path $Path -Name $Name -Value $Value -Force | Out-Null\r\n            }\r\n            Else {\r\n                Write-Log -message \"[Set-RegistryValue]: Value of $($Path)\\$($Name) is already set to $Value\"\r\n            }           \r\n        }\r\n        Else {\r\n            Write-Log -message \"[Set-RegistryValue]: Setting Value of $($Path)\\$($Name) : $Value\"\r\n            New-ItemProperty -Path $Path -Name $Name -PropertyType $PropertyType -Value $Value -Force | Out-Null\r\n        }\r\n        Start-Sleep -Milliseconds 500\r\n    }\r\n    End {\r\n    }\r\n}\r\n\r\n#endregion Functions\r\n$Script:Name = 'Set-SessionHostConfiguration'\r\n# from https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#recommended-for-exclusion\r\n# only specifying the folders that do not affect performance per article\r\n$redirectionsXMLStart = @'\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<FrxProfileFolderRedirection ExcludeCommonFolders=\"0\">\r\n<Excludes>\r\n'@\r\n$redirectionsXMLExcludesTeams = @'\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\Logs</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\PerfLog</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\MSTeams_8wekyb3d8bbwe\\LocalCache\\Microsoft\\MSTeams\\EBWebView\\WV2Profile_tfw\\GPUCache</Exclude>\r\n<Exclude Copy=\"0\">AppData\\Local\\Packages\\Microsoft.Windows.StartMenuExperienceHost_cw5n1h2txyewy\\TempState</Exclude>\r\n'@\r\n$redirectionsXMLExcludesAzCLI = @'\r\n<Exclude Copy=\"0\">.Azure</Exclude>\r\n'@\r\n$redirectionsXMLEnd = @'\r\n</Excludes>\r\n<Includes>\r\n</Includes>\r\n</FrxProfileFolderRedirection>\r\n'@\r\n\r\nNew-Log -Path (Join-Path -Path $env:SystemRoot -ChildPath 'Logs')\r\nwrite-log -message \"*** Parameter Values ***\"\r\nWrite-Log -message \"AmdVmSize: $AmdVmSize\"\r\nWrite-Log -message \"NvidiaVmSize: $NvidiaVmSize\"\r\nWrite-Log -message \"DisableUpdates: $DisableUpdates\"\r\n[bool]$ConfigureFSLogix = [System.Convert]::ToBoolean($ConfigureFSLogix)\r\nWrite-Log -message \"ConfigureFSLogix: $ConfigureFSLogix\"\r\nif ($ConfigureFSLogix) {\r\n    Write-Log -message \"IdentitySolution: $IdentitySolution\" \r\n    #Convert CloudCache to Boolean\r\n    $CloudCache = [System.Convert]::ToBoolean($CloudCache)\r\n    Write-Log -message \"CloudCache: $CloudCache\"\r\n    #Convert Shares to Array\r\n    [array]$Shares = ConvertFrom-JsonString -JsonString $Shares -Name 'Shares'\r\n    $ProfileShareName = $Shares[0]\r\n    if ($Shares.Count -gt 1) {\r\n        $OfficeShareName = $Shares[1]\r\n    }\r\n    Else {\r\n        $OfficeShareName = $null\r\n    }\r\n\r\n    Write-Log -message \"ProfileShareName: $ProfileShareName\"\r\n    Write-Log -message \"OfficeShareName: $OfficeShareName\"\r\n    Write-Log -message \"StorageService: $StorageService\"\r\n    if ($SizeInMBs -ne '' -and $null -ne $SizeInMBs) {\r\n        [int]$SizeInMBs = $SizeInMBs\r\n        Write-Log -message \"SizeInMBs: $SizeInMBs\"\r\n    }\r\n    Else {\r\n        [int]$SizeInMBs = 30000\r\n        Write-Log -message \"SizeInMBs not specified. Defaulting to: $SizeInMBs\"\r\n    } \r\n}\r\n\r\nWrite-Log -message \"TimeZone: $TimeZone\"\r\n\r\nWrite-Log -message \"Configuring Time Zone to: $TimeZone\"\r\nSet-TimeZone -Id \"$TimeZone\"\r\n\r\nWrite-Log -message \"*** Building Array of Registry Settings ***\"\r\n$RegSettings = New-Object System.Collections.ArrayList\r\nIf ($DisableUpdates -eq 'true') {\r\n    # Disable Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-automatic-updates\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU'; Name = 'NoAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Disable Edge Updates : https://learn.microsoft.com/en-us/deployedge/microsoft-edge-update-policies#updatedefault\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\EdgeUpdate'; Name = 'UpdateDefault'; PropertyType = 'DWORD'; Value = 0 })\r\n    # Set the OneDrive Update Ring to Deferred: https://learn.microsoft.com/en-us/sharepoint/use-group-policy#set-the-sync-app-update-ring\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\OneDrive'; Name = 'GPOSetUpdateRing'; PropertyType = 'DWORD'; Value = 0 })\r\n    If (Get-InstalledApplication -Name 'Microsoft 365 Apps') {\r\n        # Disable Office Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-office-automatic-updates\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideupdatenotifications'; PropertyType = 'DWORD'; Value = 1 })\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\office\\16.0\\common\\officeupdate'; Name = 'hideenabledisableupdates'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n    If ($TeamsInstalled) {\r\n        # Disable Teams Auto-Update: https://learn.microsoft.com/en-us/microsoftteams/new-teams-vdi-requirements-deploy#disable-new-teams-autoupdate-in-non-persistent-vdi\r\n        $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Microsoft\\Teams'; Name = 'disableAutoUpdate'; PropertyType = 'DWORD'; Value = 1 })\r\n    }\r\n}\r\n# Enable Time Zone Redirection: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#set-up-time-zone-redirection\r\n$RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'fEnableTimeZoneRedirection'; PropertyType = 'DWORD'; Value = 1 })\r\n\r\n##############################################################\r\n#  Add GPU Settings\r\n##############################################################\r\n# This setting applies to the VM Size's recommended for AVD with a GPU\r\nif ($AmdVmSize -eq 'true' -or $NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding GPU Settings\"\r\n    # Configure GPU-accelerated app rendering: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-app-rendering\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'bEnumerateHWBeforeSW'; PropertyType = 'DWORD'; Value = 1 })\r\n    # Configure fullscreen video encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-fullscreen-video-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVC444ModePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\n# This setting applies only to VM Size's recommended for AVD with a Nvidia GPU\r\nif ($NvidiaVmSize -eq 'true') {\r\n    Write-Log -message \"Adding Nvidia GPU Settings\"\r\n    # Configure GPU-accelerated frame encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-frame-encoding\r\n    $RegSettings.Add(@{Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'; Name = 'AVChardwareEncodePreferred'; PropertyType = 'DWORD'; Value = 1 })\r\n}\r\n\r\nIf ($ConfigureFSLogix) {\r\n    $AzCLIInstalled = Get-InstalledApplication -Name 'Azure CLI'\r\n    $TeamsInstalled = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -eq 'MSTeams' }\r\n    # Create Array Lists so it is easy to add them\r\n    [System.Collections.ArrayList]$LocalProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$LocalCloudCacheOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheProfileContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteOfficeContainerPaths = @()\r\n    [System.Collections.ArrayList]$RemoteCloudCacheOfficeContainerPaths = @()\r\n\r\n    switch ($StorageService) {\r\n        'AzureFiles' {\r\n            Write-Log -message \"Gathering Azure Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$OSSGroups = ConvertFrom-JsonString -JsonString $OSSGroups -Name 'OSSGroups'\r\n            [array]$LocalStorageAccountNames = ConvertFrom-JsonString -JsonString $LocalStorageAccountNames -Name 'LocalStorageAccountNames'\r\n            [array]$LocalStorageAccountKeys = ConvertFrom-JsonString -JsonString $LocalStorageAccountKeys -Name 'LocalStorageAccountKeys' -SensitiveValues\r\n            [array]$RemoteStorageAccountNames = ConvertFrom-JsonString -JsonString $RemoteStorageAccountNames -Name 'RemoteStorageAccountNames'\r\n            [array]$RemoteStorageAccountKeys = ConvertFrom-JsonString -JsonString $RemoteStorageAccountKeys -Name 'RemoteStorageAccountKeys' -SensitiveValues\r\n            \r\n            Write-Log -message \"*** Begin Processing Storage Accounts ***\"\r\n            # Local Storage Accounts\r\n            Write-Log -message \"Processing Local Storage Accounts\"\r\n            For ($i = 0; $i -lt $LocalStorageAccountNames.Count; $i++) {\r\n                $SAFQDN = \"$($LocalStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                Write-Log -message \"LocalStorageAccountFQDN: '$SAFQDN'\"\r\n                If ($LocalStorageAccountKeys.Count -gt 0) {\r\n                    If ($LocalStorageAccountKeys[$i]) {\r\n                        Write-Log -message \"Adding Local Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                        Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$SAFQDN /user:localhost\\$($LocalStorageAccountNames[$i]) /pass:$($LocalStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                    }\r\n                }\r\n                If ($OfficeShareName) {\r\n                    $LocalOfficeContainerPaths.Add(\"\\\\$SAFQDN\\$OfficeShareName\")\r\n                    Write-Log -message \"LocalOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"                \r\n                    $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                    Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                }\r\n                $LocalProfileContainerPaths.Add(\"\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalProfileContainerPath: \\\\$($SAFQDN)\\$($ProfileShareName)\"\r\n                $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n            }\r\n            # Remote / Existing Storage Accounts\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                Write-Log Info \"Processing Remote Storage Accounts\"\r\n                For ($i = 0; $i -lt $RemoteStorageAccountNames.Count; $i++) {\r\n                    $SAFQDN = \"$($RemoteStorageAccountNames[$i]).file.$StorageAccountDNSSuffix\"\r\n                    Write-Log -message \"RemoteStorageAccountFQDN: '$SAFQDN'\"\r\n                    If ($RemoteStorageAccountKeys.Count -gt 0) {\r\n                        If ($RemoteStorageAccountKeys[$i]) {\r\n                            Write-Log -message \"Adding Remote Storage Account Key for '$SAFQDN' to Credential Manager\"\r\n                            Start-Process -FilePath 'cmdkey.exe' -ArgumentList \"/add:$($SAFQDN) /user:localhost\\$($RemoteStorageAccountNames[$i]) /pass:$($RemoteStorageAccountKeys[$i])\" -NoNewWindow -Wait\r\n                        }\r\n                    }\r\n                    If ($OfficeShareName) {\r\n                        $RemoteOfficeContainerPaths.Add(\"\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($SAFQDN)\\$($OfficeShareName)'\"\r\n                        $RemoteCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\")\r\n                        Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($OfficeShareName)\"\r\n                    }\r\n                    $RemoteProfileContainerPaths.Add(\"\\\\$(SAFQDN)\\$(ProfileShareName)\")\r\n                    Write-Log -message \"RemoteProfileContainerPath: '\\\\$($SAFQDN)\\$(ProfileShareName)'\"\r\n                    $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($SAFQDN)\\$($ProfileShareName)'\"\r\n                }\r\n            }\r\n            Write-Log -message \"Done Adding UNC Paths to arrays.\"\r\n        }\r\n        'AzureNetAppFiles' {\r\n            Write-Log -message \"Gathering Azure NetApp Files Storage Account Parameters\"\r\n            # Convert escaped JSON strings to arrays\r\n            [array]$LocalNetAppServers = ConvertFrom-JsonString -JsonString $LocalNetAppServers -Name 'LocalNetAppServers'\r\n            [array]$RemoteNetAppServers = ConvertFrom-JsonString -JsonString $RemoteNetAppServers -Name 'RemoteNetAppServers' \r\n            Write-Log -message \"Processing Local Azure NetApp Servers\"        \r\n            $LocalProfileContainerPaths.Add(\"\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalProfileContainerPath: '\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            $LocalCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)\")\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[0])\\$($ProfileShareName)'\"\r\n            If ($LocalNetAppServers.Length -gt 1 -and $OfficeShareName) {            \r\n                $LocalOfficeContainerPaths.Add(\"\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalOfficeContainerPath: \\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\"\r\n                $LocalCloudCacheOfficeContainerPaths.Add(\"type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)\")\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($LocalNetAppServers[1])\\$($OfficeShareName)'\"\r\n            }\r\n            \r\n            If ($RemoteNetAppServers.Count -gt 0) {\r\n                Write-Log -message \"Processing Remote Azure NetApp Servers\"\r\n                $RemoteProfileContainerPaths.Add(\"\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteProfileContainerPath: '\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)'\"\r\n                $RemoteCloudCacheProfileContainerPaths.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\")\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[0])\\$($ProfileShareName)\"\r\n                If ($RemoteNetAppShares.Length -gt 1 -and $OfficeShareName) {\r\n                    $RemoteOfficeContainerPaths.Add(\"\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                    $RemoteCloudCacheOfficeContainers.Add(\"type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)\")\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: 'type=smb,connectionString=\\\\$($RemoteNetAppServers[1])\\$($OfficeShareName)'\"\r\n                }        \r\n            }\r\n        }\r\n    }\r\n\r\n    Write-Log -message \"Adding Common FSLogix Settings\"\r\n    # Cleans up an invalid sessions to enable a successful sign-in: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#cleanupinvalidsessions\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'CleanupInvalidSessions'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Apps'; PropertyType = 'DWord'; Value = 1 })\r\n    # Enables Fslogix profile containers: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#enabled\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Fslogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Deletes a local profile if it exists and matches the profile being loaded from VHD: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#deletelocalprofilewhenvhdshouldapply\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'DeleteLocalProfileWhenVHDShouldApply'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#flipflopprofiledirectoryname\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithfailure\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Prevent Login with a temporary profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#preventloginwithtempprofile\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachintervalseconds\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 15 })\r\n    # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#reattachretrycount\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 3 })\r\n    # Specifies the maximum size of the user's container in megabytes. Newly created VHD(x) containers are of this size: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#sizeinmbs\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n    # Specifies the file extension for the profile containers: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=profiles#volumetype\r\n    $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'String'; Value = 'VHDX' })\r\n\r\n    If ($LocalStorageAccountKeys.Count -gt 0) {\r\n        Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n        # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#accessnetworkascomputerobject\r\n        $RegSettings.Add([PSCustomObject]@{Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    if ($CloudCache -eq $True) {\r\n        Write-Log -message \"Adding Cloud Cache Settings\"\r\n        # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'DWord'; Value = 1 })\r\n    }\r\n\r\n    If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n        Write-Log -message \"Adding Office Container Settings\"    \r\n        # Enables Fslogix office containers: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#enabled-1   \r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'Enabled'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })   \r\n        # The folder created in the Fslogix fileshare will begin with the username instead of the SID: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#flipflopprofiledirectoryname-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'FlipFlopProfileDirectoryName'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Specifies the number of retries attempted when a VHD(x) file is locked: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the number of seconds to wait between retries: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#lockedretryinterval\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'LockedRetryInterval'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Prevent Login with a failure: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithfailure-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithFailure'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        # Prevent Login with Temporary Profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#preventloginwithtempprofile-1\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'PreventLoginWithTempProfile'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })    \r\n        # Specifies the number of seconds to wait between retries when attempting to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachintervalseconds\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachIntervalSeconds'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 15 })\r\n        # Specifies the number of times the system should attempt to reattach the VHD(x) container if it's disconnected unexpectedly: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#reattachretrycount\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'ReAttachRetryCount'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 3 })\r\n        # Specifies the maximum size of the user's container in megabytes: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#sizeinmbs\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'SizeInMBs'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = $SizeInMBs })\r\n        # Specifies the type of container: https://learn.microsoft.com/fslogix/reference-configuration-settings?tabs=odfc#volumetype\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'VolumeType'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'String'; Value = 'VHDX' })\r\n        If ($LocalStorageAccountKeys.Count -gt 0) {\r\n            Write-Log -message \"Adding AccessNetworkAsComputerObject for cloud only identities.\"\r\n            # Attach the users VHD(x) as the computer: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#accessnetworkascomputerobject-1\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'AccessNetworkAsComputerObject'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Settings\"\r\n            # Clear the cloud cache on logoff: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#clearcacheonlogoff\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'ClearCacheOnLogoff'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'DWord'; Value = 1 })\r\n        }   \r\n    }\r\n\r\n    If ($OSSGroups.Count -gt 0) {\r\n        Write-Log -message \"Adding Object Specific Settings\"\r\n        # Object Specific Settings\r\n        $DomainName = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object -ExpandProperty Domain\r\n        Write-Log -message \"DomainName: $DomainName\"\r\n        For ($i = 0; $i -lt $OSSGroups.Count; $i++) {\r\n            # Get Domain information\r\n            Write-Log -message \"Getting SID for $($OSSGroups[$i])\"        \r\n            $OSSGroupSID = Convert-GroupToSID -DomainName $DomainName -GroupName $OSSGroups[$i]\r\n            [string]$LocalProfileContainerPath = $LocalProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalProfileContainerPath: '$LocalProfileContainerPath'\"\r\n            [string]$LocalCloudCacheProfileContainerPath = $LocalCloudCacheProfileContainerPaths[$i]\r\n            Write-Log -message \"LocalCloudCacheProfileContainerPath: '$LocalCloudCacheProfileContainerPath'\"\r\n\r\n            If ($RemoteStorageAccountNames) {\r\n                [string]$RemoteProfileContainerPath = $RemoteProfileContainerPaths[$i]\r\n                Write-Log -message \"RemoteProfileContainerPath: '$RemoteProfileContainerPath'\"\r\n                [string]$RemoteCloudCacheProfileContainerPath = $RemoteCloudCacheProfilePaths[$i]\r\n                Write-Log -message \"RemoteCloudCacheProfileContainerPath: '$RemoteCloudCacheProfileContainerPath'\"\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath + $RemoteProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath + $RemoteCloudCacheProfileContainerPath)\r\n            }\r\n            Else {\r\n                [array]$ProfileContainerPaths = @($LocalProfileContainerPath)\r\n                [array]$CloudCacheProfileContainerPaths = @($LocalCloudCacheProfileContainerPath)\r\n            }\r\n\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Profile Container Settings: $OSSGroupSID : '$($CloudCacheProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Profile Container Settings: $OSSGroupSID : '$($ProfileContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\FSLogix\\Profiles\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n            }   \r\n\r\n            If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n                [string]$LocalOfficeContainerPath = $LocalOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalOfficeContainerPath: '$LocalOfficeContainerPath'\"\r\n                [string]$LocalCloudCacheOfficeContainerPath = $LocalCloudCacheOfficeContainerPaths[$i]\r\n                Write-Log -message \"LocalCloudCacheOfficeContainerPath: '$LocalCloudCacheOfficeContainerPath'\"\r\n                If ($RemoteStorageAccountNames) {\r\n                    [string]$RemoteOfficeContainerPath = $RemoteOfficeContainerPaths[$i]\r\n                    Write-Log -message \"RemoteOfficeContainerPath: '$RemoteOfficeContainerPath'\"\r\n                    [string]$RemoteCloudCacheOfficeContainerPath = $RemoteCloudCacheOfficePaths[$i]\r\n                    Write-Log -message \"RemoteCloudCacheOfficeContainerPath: '$RemoteCloudCacheOfficeContainerPath'\"\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath + $RemoteOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath + $RemoteCloudCacheOfficeContainerPath)\r\n                }\r\n                Else {\r\n                    [array]$OfficeContainerPaths = @($LocalOfficeContainerPath)\r\n                    [array]$CloudCacheOfficeContainerPaths = @($LocalCloudCacheOfficeContainerPath)\r\n                }\r\n                If ($CloudCache -eq $True) {\r\n                    Write-Log -message \"Adding Cloud Cache Office Container Settings: $OSSGroupSID : '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n                }\r\n                Else {\r\n                    Write-Log -message \"Adding Office Container Settings: $OSSGroupSID : '$($OfficeContainerPaths -join \"', '\")'\"\r\n                    # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                    $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = \"HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC\\ObjectSpecific\\$OSSGroupSID\"; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n                }\r\n            }  \r\n        }          \r\n    }\r\n    Else {\r\n        If ($RemoteStorageAccountNames.Count -gt 0) {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths + $RemoteProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths + $RemoteCloudCacheProfileContainerPaths\r\n        }\r\n        Else {\r\n            $ProfileContainerPaths = $LocalProfileContainerPaths\r\n            $CloudCacheProfileContainerPaths = $LocalCloudCacheProfileContainerPaths\r\n        }\r\n        If ($CloudCache -eq $True) {\r\n            Write-Log -message \"Adding Cloud Cache Profile Container Settings: '$($CloudCacheProfileContainerPaths -join \"', '\")'\"   \r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations \r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $CloudCacheProfileContainerPaths })             \r\n        }\r\n        Else {\r\n            Write-Log -message \"Adding Profile Container Settings: '$($ProfileContainerPaths -join \"', '\")'\"\r\n            # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/fslogix/profile-container-configuration-reference#vhdlocations\r\n            $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'; PropertyType = 'MultiString'; Value = $ProfileContainerPaths })\r\n        }\r\n        If ($LocalOfficeContainerPaths.Count -gt 0) {\r\n            If ($RemoteStorageAccountNames.Count -gt 0) {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths + $RemoteOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths + $RemoteCloudCacheOfficeContainerPaths\r\n            }\r\n            Else {\r\n                $OfficeContainerPaths = $LocalOfficeContainerPaths\r\n                $CloudCacheOfficeContainerPaths = $LocalCloudCacheOfficeContainerPaths\r\n            }\r\n            If ($CloudCache -eq $True) {\r\n                Write-Log -message \"Adding Cloud Cache Office Container Settings: '$($CloudCacheOfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=ccd#ccdlocations\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'CCDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $CloudCacheOfficeContainerPaths })\r\n            }\r\n            Else {\r\n                Write-Log -message \"Adding Office Container Settings: '$($OfficeContainerPaths -join \"', '\")'\"\r\n                # List of file system locations to search for the user's profile VHD(X) file: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=odfc#vhdlocations-1\r\n                $RegSettings.Add([PSCustomObject]@{ Name = 'VHDLocations'; Path = 'HKLM:\\SOFTWARE\\Policies\\FSLogix\\ODFC'; PropertyType = 'MultiString'; Value = $OfficeContainerPaths })\r\n            }\r\n        }    \r\n    }\r\n    If ($TeamsInstalled -or $AzCLIInstalled) {\r\n        $customRedirFolder = \"$env:ProgramData\\FSLogix_CustomRedirections\"\r\n        Write-Log -message \"Creating custom redirections.xml file in $customRedirFolder\"\r\n        If (-not (Test-Path $customRedirFolder )) {\r\n            New-Item -Path $customRedirFolder -ItemType Directory -Force\r\n        }\r\n        $customRedirFilePath = \"$customRedirFolder\\redirections.xml\"\r\n        $redirectionsXMLContent = $redirectionsXMLStart\r\n        if ($AzCLIInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesAzCLI\r\n        }\r\n        if ($TeamsInstalled) {\r\n            $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLExcludesTeams\r\n        }\r\n        $redirectionsXMLContent = $redirectionsXMLContent + \"`n\" + $redirectionsXMLEnd\r\n        $redirectionsXMLContent | Out-File -FilePath $customRedirFilePath -Encoding unicode\r\n        # Path where FSLogix looks for the redirections.xml file to copy from and into the user's profile: https://learn.microsoft.com/en-us/fslogix/reference-configuration-settings?tabs=profiles#redirxmlsourcefolder\r\n        \r\n        $RegSettings.Add(\r\n            [PSCustomObject]@{\r\n                Name         = 'RedirXMLSourceFolder'\r\n                Path         = 'HKLM:\\SOFTWARE\\FSLogix\\Profiles'\r\n                PropertyType = 'String'\r\n                Value        = $customRedirFolder\r\n            }\r\n        )\r\n    }\r\n    If ($IdentitySolution -match 'EntraKerberos') {\r\n        $RegSettings.Add([PSCustomObject]@{ Name = 'CloudKerberosTicketRetrievalEnabled'; Path = 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Kerberos\\Parameters'; PropertyType = 'DWord'; Value = 1})\r\n    }\r\n\r\n    $LocalAdministrator = (Get-LocalUser | Where-Object { $_.SID -like '*-500' }).Name\r\n    $LocalGroups = 'FSLogix Profile Exclude List', 'FSLogix ODFC Exclude List'\r\n    ForEach ($Group in $LocalGroups) {\r\n        If (-not (Get-LocalGroupMember -Group $Group | Where-Object { $_.Name -like \"*$LocalAdministrator\" })) {\r\n            Add-LocalGroupMember -Group $Group -Member $LocalAdministrator\r\n        }\r\n    }\r\n}\r\n\r\nWrite-Log -message \"*** Setting Registry Values ***\"\r\nForEach ($Setting in $RegSettings) {\r\n    Set-RegistryValue -Name $Setting.Name -Path $Setting.Path -PropertyType $Setting.PropertyType -Value $Setting.Value -Verbose\r\n}\r\n\r\n# Resize OS Disk\r\nWrite-Log -message \"Resizing OS Disk\"\r\n$driveLetter = $env:SystemDrive.Substring(0, 1)\r\n$size = Get-PartitionSupportedSize -DriveLetter $driveLetter\r\nResize-Partition -DriveLetter $driveLetter -Size $size.SizeMax\r\nWrite-Log -message \"OS Disk Resized\"\r\nClear-EventLog \"Windows PowerShell\" -ErrorAction SilentlyContinue\r\nWrite-Log -message \"Done\"",
            "amdVmSize": "[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), 'as_v4'), endsWith(parameters('virtualMachineSize'), '_V710_v5')))]",
            "nvidiaVmSize": "[and(contains(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), '_v3'), endsWith(parameters('virtualMachineSize'), '_A10_v5')))]",
            "profileShareName": "[parameters('fslogixFileShareNames')[0]]",
            "officeShareName": "[if(greater(length(parameters('fslogixFileShareNames')), 1), parameters('fslogixFileShareNames')[1], '')]",
            "fslogixLocalNetAppProfileShare": "[if(not(empty(parameters('fslogixLocalNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[0], variables('profileShareName')), '')]",
            "fslogixLocalNetAppOfficeShare": "[if(greater(length(parameters('fslogixLocalNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixLocalNetAppServerFqdns')[1], variables('officeShareName')), '')]",
            "fslogixRemoteNetAppProfileShare": "[if(not(empty(parameters('fslogixRemoteNetAppServerFqdns'))), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[0], variables('profileShareName')), '')]",
            "fslogixRemoteNetAppOfficeShare": "[if(greater(length(parameters('fslogixRemoteNetAppServerFqdns')), 1), format('\\\\{0}\\{1}', parameters('fslogixRemoteNetAppServerFqdns')[1], variables('officeShareName')), '')]",
            "vhdxPath": "\\*\\*.VHDX",
            "fslogixExclusionsCloudCache": "[if(contains(parameters('fslogixContainerType'), 'CloudCache'), '%ProgramData%\\FSLogix\\Cache\\*;%ProgramData%\\FSLogix\\Proxy\\*', '')]",
            "fslogixLocalDedupedSANames": "[union(variables('fslogixLocalSANameMinus2'), variables('fslogixLocalSANameMinus2'))]",
            "fslogixLocalMatchPrefix": "[if(equals(length(variables('fslogixLocalDedupedSANames')), 1), true(), false())]",
            "fslogixLocalOfficeSharesPrefixMatch": "[if(and(not(empty(variables('fslogixLocalDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixLocalProfileSharesPrefixMatch": "[if(not(empty(variables('fslogixLocalDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixLocalDedupedSANames')[0], parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixLocalOfficeSharesNoMatch": "[if(and(not(empty(variables('fslogixLocalStorageAccountNames'))), not(empty(variables('officeShareName')))), map(variables('fslogixLocalStorageAccountNames'), lambda('name', format('\\\\{0}.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath')))), createArray())]",
            "fslogixLocalProfileSharesNoMatch": "[if(not(empty(variables('fslogixLocalStorageAccountNames'))), map(variables('fslogixLocalStorageAccountNames'), lambda('name', format('\\\\{0}.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath')))), createArray())]",
            "fslogixLocalOfficeVHDXs": "[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalOfficeSharesPrefixMatch'), variables('fslogixLocalOfficeSharesNoMatch'))]",
            "fslogixLocalProfileVHDXs": "[if(variables('fslogixLocalMatchPrefix'), variables('fslogixLocalProfileSharesPrefixMatch'), variables('fslogixLocalProfileSharesNoMatch'))]",
            "fslogixRemoteDedupedSANames": "[union(variables('fslogixRemoteSANameMinus2'), variables('fslogixRemoteSANameMinus2'))]",
            "fslogixRemoteMatchPrefix": "[if(equals(length(variables('fslogixRemoteDedupedSANames')), 1), true(), false())]",
            "fslogixRemoteOfficeSharesPrefixMatch": "[if(and(not(empty(variables('fslogixRemoteDedupedSANames'))), not(empty(variables('officeShareName')))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixRemoteProfileSharesPrefixMatch": "[if(not(empty(variables('fslogixRemoteDedupedSANames'))), createArray(format('\\\\{0}??.file.{1}\\{2}{3}', variables('fslogixRemoteDedupedSANames')[0], parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath'))), createArray())]",
            "fslogixRemoteOfficeSharesNoMatch": "[if(and(not(empty(variables('fslogixRemoteStorageAccountNames'))), not(empty(variables('officeShareName')))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', format('\\\\{0}.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('officeShareName'), variables('vhdxPath')))), createArray())]",
            "fslogixRemoteProfileSharesNoMatch": "[if(not(empty(variables('fslogixRemoteStorageAccountNames'))), map(variables('fslogixRemoteStorageAccountNames'), lambda('name', format('\\\\{0}.file.{1}\\{2}{3}', lambdaVariables('name'), parameters('storageSuffix'), variables('profileShareName'), variables('vhdxPath')))), createArray())]",
            "fslogixRemoteOfficeVHDXs": "[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteOfficeSharesPrefixMatch'), variables('fslogixRemoteOfficeSharesNoMatch'))]",
            "fslogixRemoteProfileVHDXs": "[if(variables('fslogixRemoteMatchPrefix'), variables('fslogixRemoteProfileSharesPrefixMatch'), variables('fslogixRemoteProfileSharesNoMatch'))]",
            "fslogixOfficeVHDXs": "[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalOfficeVHDXs'), variables('fslogixRemoteOfficeVHDXs')), if(empty(variables('fslogixLocalNetAppOfficeShare')), createArray(), if(empty(variables('fslogixRemoteNetAppOfficeShare')), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppOfficeShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppOfficeShare'), variables('vhdxPath'))))))]",
            "fslogixProfileVHDXs": "[if(equals(parameters('fslogixStorageService'), 'AzureFiles'), union(variables('fslogixLocalProfileVHDXs'), variables('fslogixRemoteProfileVHDXs')), if(empty(variables('fslogixLocalNetAppProfileShare')), createArray(), if(empty(variables('fslogixRemoteNetAppProfileShare')), createArray(format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))), createArray(format('{0}{1}', variables('fslogixLocalNetAppProfileShare'), variables('vhdxPath')), format('{0}{1}', variables('fslogixRemoteNetAppProfileShare'), variables('vhdxPath'))))))]",
            "fslogixExclusionsOfficeString": "[if(contains(parameters('fslogixContainerType'), 'Office'), join(variables('fslogixExclusionsOfficeArray'), ';'), '')]",
            "fslogixExclusionsProfileString": "[join(variables('fslogixExclusionProfileArray'), ';')]",
            "fslogixExclusionsArray": [
              "[format('$TEMP%{0}', variables('vhdxPath'))]",
              "[format('%WinDir%\\TEMP{0}', variables('vhdxPath'))]",
              "[variables('fslogixExclusionsCloudCache')]",
              "[variables('fslogixExclusionsProfileString')]",
              "[variables('fslogixExclusionsOfficeString')]"
            ],
            "fslogixPathExclusions": "[join(filter(variables('fslogixExclusionsArray'), lambda('exclusion', not(empty(lambdaVariables('exclusion'))))), ';')]",
            "identityType": "[if(if(or(not(contains(parameters('identitySolution'), 'DomainServices')), parameters('enableMonitoring')), true(), false()), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'SystemAssigned, UserAssigned', 'SystemAssigned'), if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), 'UserAssigned', 'None'))]",
            "userAssignedIdentities": "[if(not(empty(parameters('artifactsUserAssignedIdentityResourceId'))), createObject(format('{0}', parameters('artifactsUserAssignedIdentityResourceId')), createObject()), createObject())]",
            "identity": "[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(variables('userAssignedIdentities'))), variables('userAssignedIdentities'), null())), null())]",
            "ImageReference": "[if(empty(parameters('customImageResourceId')), createObject('publisher', parameters('imagePublisher'), 'offer', parameters('imageOffer'), 'sku', parameters('imageSku'), 'version', 'latest'), createObject('id', parameters('customImageResourceId')))]"
          },
          "resources": [
            {
              "copy": {
                "name": "networkInterface",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2020-05-01",
              "name": "[replace(parameters('networkInterfaceNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()))]",
              "properties": {
                "ipConfigurations": "[union(createArray(createObject('name', 'ipv4config', 'properties', createObject('privateIPAllocationMethod', 'Dynamic', 'subnet', createObject('id', parameters('subnetResourceId')), 'primary', true(), 'privateIPAddressVersion', 'IPv4'))), if(parameters('enableIPv6'), createArray(createObject('name', 'ipv6config', 'properties', createObject('privateIPAllocationMethod', 'Dynamic', 'subnet', createObject('id', parameters('subnetResourceId')), 'primary', false(), 'privateIPAddressVersion', 'IPv6'))), createArray()))]",
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "enableIPForwarding": false
              }
            },
            {
              "copy": {
                "name": "virtualMachine",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2024-03-01",
              "name": "[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()))]",
              "zones": "[if(or(not(empty(parameters('dedicatedHostResourceId'))), not(empty(parameters('dedicatedHostGroupResourceId')))), parameters('dedicatedHostGroupZones'), if(and(equals(parameters('availability'), 'AvailabilityZones'), not(empty(parameters('availabilityZones')))), createArray(parameters('availabilityZones')[mod(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), length(parameters('availabilityZones')))]), null()))]",
              "identity": "[variables('identity')]",
              "properties": {
                "additionalCapabilities": {
                  "hibernationEnabled": "[parameters('hibernationEnabled')]"
                },
                "availabilitySet": "[if(equals(parameters('availability'), 'AvailabilitySets'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', replace(parameters('availabilitySetNameConv'), '##', padLeft(add(div(sub(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), 1), 200), 1), 2, '0')))), null())]",
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": true
                  }
                },
                "hardwareProfile": {
                  "vmSize": "[parameters('virtualMachineSize')]"
                },
                "host": "[if(not(empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostResourceId')), null())]",
                "hostGroup": "[if(and(not(empty(parameters('dedicatedHostGroupResourceId'))), empty(parameters('dedicatedHostResourceId'))), createObject('id', parameters('dedicatedHostGroupResourceId')), null())]",
                "storageProfile": {
                  "imageReference": "[variables('ImageReference')]",
                  "osDisk": {
                    "diskSizeGB": "[if(not(equals(parameters('diskSizeGB'), 0)), parameters('diskSizeGB'), null())]",
                    "name": "[replace(parameters('osDiskNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                    "osType": "Windows",
                    "createOption": "FromImage",
                    "caching": "ReadWrite",
                    "deleteOption": "Delete",
                    "managedDisk": {
                      "diskEncryptionSet": "[if(and(not(equals(parameters('securityType'), 'ConfidentialVM')), not(empty(parameters('diskEncryptionSetResourceId')))), createObject('id', parameters('diskEncryptionSetResourceId')), null())]",
                      "securityProfile": "[if(equals(parameters('securityType'), 'ConfidentialVM'), createObject('diskEncryptionSet', if(not(empty(parameters('diskEncryptionSetResourceId'))), createObject('id', parameters('diskEncryptionSetResourceId')), null()), 'securityEncryptionType', parameters('confidentialVMOSDiskEncryptionType')), null())]",
                      "storageAccountType": "[parameters('diskSku')]"
                    }
                  },
                  "dataDisks": []
                },
                "osProfile": {
                  "computerName": "[format('{0}{1}', parameters('virtualMachineNamePrefix'), padLeft(add(range(0, parameters('sessionHostCount'))[copyIndex()], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]",
                  "adminUsername": "[parameters('virtualMachineAdminUserName')]",
                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": false
                  },
                  "secrets": [],
                  "allowExtensionOperations": true
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('networkInterfaceNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "securityProfile": {
                  "encryptionAtHost": "[if(parameters('encryptionAtHost'), true(), null())]",
                  "securityType": "[if(not(equals(parameters('securityType'), 'Standard')), parameters('securityType'), null())]",
                  "uefiSettings": "[if(not(equals(parameters('securityType'), 'Standard')), createObject('secureBootEnabled', parameters('secureBootEnabled'), 'vTpmEnabled', parameters('vTpmEnabled')), null())]"
                },
                "licenseType": "[if(or(equals(parameters('imagePublisher'), 'MicrosoftWindowsDesktop'), not(empty(parameters('customImageResourceId')))), 'Windows_Client', 'Windows_Server')]"
              },
              "dependsOn": [
                "networkInterface"
              ]
            },
            {
              "copy": {
                "name": "extension_JsonADDomainExtension",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[contains(parameters('identitySolution'), 'DomainServices')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'JsonADDomainExtension')]",
              "location": "[parameters('location')]",
              "properties": {
                "forceUpdateTag": "[parameters('deploymentSuffix')]",
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "Name": "[parameters('domainName')]",
                  "User": "[parameters('domainJoinUserPrincipalName')]",
                  "Restart": "true",
                  "Options": "3",
                  "OUPath": "[parameters('ouPath')]"
                },
                "protectedSettings": {
                  "Password": "[parameters('domainJoinUserPassword')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AADLoginForWindows",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[or(startsWith(parameters('identitySolution'), 'EntraKerberos'), equals(parameters('identitySolution'), 'EntraId'))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AADLoginForWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": "[if(parameters('intuneEnrollment'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_IaasAntimalware",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[not(startsWith(environment().name, 'USN'))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'IaaSAntimalware')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Security",
                "type": "IaaSAntimalware",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "AntimalwareEnabled": true,
                  "RealtimeProtectionEnabled": "true",
                  "ScheduledScanSettings": {
                    "isEnabled": "true",
                    "day": "7",
                    "time": "120",
                    "scanType": "Quick"
                  },
                  "Exclusions": {
                    "Paths": "[variables('fslogixPathExclusions')]"
                  }
                }
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AzureMonitorWindowsAgent",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[parameters('enableMonitoring')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AzureMonitorWindowsAgent')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Monitor",
                "type": "AzureMonitorWindowsAgent",
                "typeHandlerVersion": "1.1",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "dataCollectionEndpointAssociation",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('dataCollectionEndpointResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "name": "configurationAccessEndpoint",
              "properties": {
                "dataCollectionEndpointId": "[parameters('dataCollectionEndpointResourceId')]",
                "description": "Data Collection Endpoint Association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "avdInsightsDataCollectionRuleAssociation",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('avdInsightsDataCollectionRulesResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "name": "[format('{0}-avdInsights-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('avdInsightsDataCollectionRulesResourceId')]",
                "description": "AVD Insights data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "vmInsightsDataCollectionRuleAssociation",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[and(parameters('enableMonitoring'), not(empty(parameters('vmInsightsDataCollectionRulesResourceId'))))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "name": "[format('{0}-vmInsights-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('vmInsightsDataCollectionRulesResourceId')]",
                "description": "VM Insights data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "securityDataCollectionRuleAssociation",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[not(empty(parameters('securityDataCollectionRulesResourceId')))]",
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "name": "[format('{0}-security-data-coll-rule-assoc', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('securityDataCollectionRulesResourceId')]",
                "description": "Security Events data collection rule association"
              },
              "dependsOn": [
                "extension_AzureMonitorWindowsAgent",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_GuestAttestation",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[parameters('integrityMonitoring')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'GuestAttestation')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Security.WindowsAttestation",
                "type": "GuestAttestation",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "AttestationConfig": {
                    "MaaSettings": {
                      "maaEndpoint": "",
                      "maaTenantName": "GuestAttestation"
                    },
                    "AscSettings": {
                      "ascReportingEndpoint": "",
                      "ascReportingFrequency": ""
                    },
                    "useCustomToken": "false",
                    "disableAlerts": "false"
                  }
                }
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_AmdGpuDriverWindows",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[variables('amdVmSize')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AmdGpuDriverWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.HpcCompute",
                "type": "AmdGpuDriverWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {}
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_NvidiaGpuDriverWindows",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[variables('nvidiaVmSize')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'NvidiaGpuDriverWindows')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.HpcCompute",
                "type": "NvidiaGpuDriverWindows",
                "typeHandlerVersion": "1.2",
                "autoUpgradeMinorVersion": true,
                "settings": {}
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_JsonADDomainExtension",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "runCommand_ConfigureSessionHost",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'configureSessionHost')]",
              "location": "[parameters('location')]",
              "properties": {
                "parameters": [
                  {
                    "name": "AmdVmSize",
                    "value": "[if(variables('amdVmSize'), 'true', 'false')]"
                  },
                  {
                    "name": "NvidiaVmSize",
                    "value": "[if(variables('nvidiaVmSize'), 'true', 'false')]"
                  },
                  {
                    "name": "DisableUpdates",
                    "value": "false"
                  },
                  {
                    "name": "ConfigureFSLogix",
                    "value": "[if(parameters('fslogixConfigureSessionHosts'), 'true', 'false')]"
                  },
                  {
                    "name": "CloudCache",
                    "value": "[if(contains(parameters('fslogixContainerType'), 'CloudCache'), 'true', 'false')]"
                  },
                  {
                    "name": "IdentitySolution",
                    "value": "[parameters('identitySolution')]"
                  },
                  {
                    "name": "LocalNetAppServers",
                    "value": "[string(parameters('fslogixLocalNetAppServerFqdns'))]"
                  },
                  {
                    "name": "LocalStorageAccountNames",
                    "value": "[string(variables('fslogixLocalStorageAccountNames'))]"
                  },
                  {
                    "name": "OSSGroups",
                    "value": "[string(parameters('fslogixOSSGroups'))]"
                  },
                  {
                    "name": "RemoteNetAppServers",
                    "value": "[string(parameters('fslogixRemoteNetAppServerFqdns'))]"
                  },
                  {
                    "name": "RemoteStorageAccountNames",
                    "value": "[string(variables('fslogixRemoteStorageAccountNames'))]"
                  },
                  {
                    "name": "Shares",
                    "value": "[string(parameters('fslogixFileShareNames'))]"
                  },
                  {
                    "name": "SizeInMBs",
                    "value": "[string(parameters('fslogixSizeInMBs'))]"
                  },
                  {
                    "name": "StorageAccountDNSSuffix",
                    "value": "[parameters('storageSuffix')]"
                  },
                  {
                    "name": "StorageService",
                    "value": "[parameters('fslogixStorageService')]"
                  },
                  {
                    "name": "TimeZone",
                    "value": "[parameters('timeZone')]"
                  }
                ],
                "protectedParameters": "[if(parameters('fslogixConfigureSessionHosts'), createArray(createObject('name', 'LocalStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixLocalStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixLocalStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixLocalStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray())))), createObject('name', 'RemoteStorageAccountKeys', 'value', string(union(if(and(equals(parameters('identitySolution'), 'EntraId'), not(empty(parameters('fslogixRemoteStorageAccountResourceIds')))), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[0], '/'))), '2023-01-01').keys[0].value), createArray()), if(and(equals(parameters('identitySolution'), 'EntraId'), greater(length(parameters('fslogixRemoteStorageAccountResourceIds')), 1)), createArray(listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[2], split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('fslogixRemoteStorageAccountResourceIds')[1], '/'))), '2023-01-01').keys[0].value), createArray()))))), null())]",
                "source": {
                  "script": "[variables('$fxv#0')]"
                },
                "treatFailureAsDeploymentFailure": true,
                "timeoutInSeconds": 600
              },
              "dependsOn": [
                "extension_AADLoginForWindows",
                "extension_AmdGpuDriverWindows",
                "extension_AzureMonitorWindowsAgent",
                "extension_GuestAttestation",
                "extension_IaasAntimalware",
                "extension_JsonADDomainExtension",
                "extension_NvidiaGpuDriverWindows",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "extension_DSC_installAvdAgents",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), 'AVDAgentInstallandConfig')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('sessionHostRegistrationDSCUrl')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[last(split(parameters('hostPoolResourceId'), '/'))]",
                    "registrationInfoTokenCredential": {
                      "UserName": "PLACEHOLDER_DO_NOT_USE",
                      "Password": "PrivateSettingsRef:RegistrationInfoToken"
                    },
                    "aadJoin": "[not(contains(parameters('identitySolution'), 'DomainServices'))]",
                    "UseAgentDownloadEndpoint": "[parameters('useAgentDownloadEndpoint')]",
                    "mdmId": "[if(parameters('intuneEnrollment'), '0000000a-0000-0000-c000-000000000000', '')]"
                  }
                },
                "protectedSettings": {
                  "Items": {
                    "RegistrationInfoToken": "[listRegistrationTokens(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', last(split(parameters('hostPoolResourceId'), '/'))), '2023-09-05').value[0].token]"
                  }
                }
              },
              "dependsOn": [
                "postDeploymentScripts",
                "runCommand_ConfigureSessionHost",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "postDeploymentScripts",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "condition": "[not(empty(parameters('sessionHostCustomizations')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-Customizations-{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "artifactsContainerUri": {
                    "value": "[parameters('artifactsContainerUri')]"
                  },
                  "customizations": {
                    "value": "[parameters('sessionHostCustomizations')]"
                  },
                  "userAssignedIdentityClientId": {
                    "value": "[parameters('artifactsUserAssignedIdentityClientId')]"
                  },
                  "virtualMachineName": {
                    "value": "[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "6032795963718933388"
                    }
                  },
                  "parameters": {
                    "artifactsContainerUri": {
                      "type": "string"
                    },
                    "customizations": {
                      "type": "array"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "userAssignedIdentityClientId": {
                      "type": "string"
                    },
                    "virtualMachineName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "customizers",
                        "count": "[length(parameters('customizations'))]",
                        "input": {
                          "name": "[replace(parameters('customizations')[copyIndex('customizers')].name, ' ', '-')]",
                          "uri": "[if(or(startsWith(parameters('customizations')[copyIndex('customizers')].blobNameOrUri, 'https://'), startsWith(parameters('customizations')[copyIndex('customizers')].blobNameorUri, 'http://')), parameters('customizations')[copyIndex('customizers')].blobNameOrUri, format('{0}/{1}', parameters('artifactsContainerUri'), parameters('customizations')[copyIndex('customizers')].blobNameOrUri))]",
                          "arguments": "[coalesce(tryGet(parameters('customizations')[copyIndex('customizers')], 'arguments'), '')]"
                        }
                      }
                    ],
                    "$fxv#0": "param(\r\n  [string]$APIVersion,\r\n  [string]$Arguments='',\r\n  [string]$BlobStorageSuffix,\r\n  [string]$BuildDir='',\r\n  [string]$Name,\r\n  [string]$Uri,\r\n  [string]$UserAssignedIdentityClientId\r\n)\r\n\r\nfunction Write-OutputWithTimeStamp {\r\n  param(\r\n      [string]$Message\r\n  )    \r\n  $Timestamp = Get-Date -Format 'MM/dd/yyyy HH:mm:ss'\r\n  $Entry = '[' + $Timestamp + '] ' + $Message\r\n  Write-Output $Entry\r\n}\r\n\r\nFunction Split-ArgumentString {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @()\r\n    }\r\n\r\n    # For PowerShell execution with &, we want individual arguments, not combined ones\r\n    $arguments = @()\r\n    $currentArg = \"\"\r\n    $inQuotes = $false\r\n    \r\n    for ($i = 0; $i -lt $ArgumentString.Length; $i++) {\r\n        $char = $ArgumentString[$i]\r\n        \r\n        if ($char -eq '\"' -and ($i -eq 0 -or $ArgumentString[$i-1] -ne '\\')) {\r\n            $inQuotes = !$inQuotes\r\n            $currentArg += $char\r\n        }\r\n        elseif ($char -eq ' ' -and !$inQuotes) {\r\n            if ($currentArg.Length -gt 0) {\r\n                # Handle boolean conversion\r\n                $value = $currentArg.Trim('\"')\r\n                if ($value -eq 'true') {\r\n                    $arguments += '$true'\r\n                }\r\n                elseif ($value -eq 'false') {\r\n                    $arguments += '$false'\r\n                }\r\n                else {\r\n                    $arguments += $value\r\n                }\r\n                $currentArg = \"\"\r\n            }\r\n        }\r\n        else {\r\n            $currentArg += $char\r\n        }\r\n    }\r\n    \r\n    # Add the last argument\r\n    if ($currentArg.Length -gt 0) {\r\n        $value = $currentArg.Trim('\"')\r\n        if ($value -eq 'true') {\r\n            $arguments += '$true'\r\n        }\r\n        elseif ($value -eq 'false') {\r\n            $arguments += '$false'\r\n        }\r\n        else {\r\n            $arguments += $value\r\n        }\r\n    }\r\n    \r\n    return $arguments\r\n}\r\n\r\nFunction ConvertTo-ParametersSplat {\r\n    param (\r\n        [string]$ArgumentString\r\n    )\r\n\r\n    if ([string]::IsNullOrWhiteSpace($ArgumentString)) {\r\n        return @{}\r\n    }\r\n\r\n    $tokens = Split-ArgumentString -ArgumentString $ArgumentString\r\n    $parameters = @{}\r\n    \r\n    $i = 0\r\n    while ($i -lt $tokens.Count) {\r\n        $token = $tokens[$i]\r\n        \r\n        # If this is a parameter (starts with -)\r\n        if ($token -match '^-(\\w+)$') {\r\n            $paramName = $matches[1]  # Remove the dash\r\n            \r\n            # Check if there's a value following this parameter\r\n            if (($i + 1) -lt $tokens.Count -and $tokens[$i + 1] -notmatch '^-\\w+$') {\r\n                # Parameter with value\r\n                $i++  # Move to the value\r\n                $value = $tokens[$i]\r\n                \r\n                # Handle PowerShell booleans\r\n                if ($value -eq '$true') {\r\n                    $parameters[$paramName] = $true\r\n                }\r\n                elseif ($value -eq '$false') {\r\n                    $parameters[$paramName] = $false\r\n                }\r\n                else {\r\n                    # Remove quotes if present\r\n                    $cleanValue = $value.Trim('\"')\r\n                    $parameters[$paramName] = $cleanValue\r\n                }\r\n            }\r\n            else {\r\n                # This is a switch parameter (no value)\r\n                $parameters[$paramName] = $true\r\n            }\r\n        }\r\n        else {\r\n            # Handle positional arguments (rare in this context)\r\n            # You could add logic here if needed\r\n        }\r\n        \r\n        $i++\r\n    }\r\n    \r\n    return $parameters\r\n}\r\n\r\nStart-Transcript -Path \"$env:SystemRoot\\Logs\\$Name.log\" -Force\r\nWrite-OutputWithTimeStamp \"Starting '$Name' script with the following parameters.\"\r\nWrite-Output ( $PSBoundParameters | Format-Table -AutoSize )\r\nIf ($Arguments -eq '') { $Arguments = $null }\r\nIf ($BuildDir -ne '') {\r\n  $TempDir = Join-Path $BuildDir -ChildPath $Name\r\n} Else {\r\n  $TempDir = Join-Path $Env:TEMP -ChildPath $Name\r\n}\r\nNew-Item -Path $TempDir -ItemType Directory -Force | Out-Null\r\n$WebClient = New-Object System.Net.WebClient\r\nIf ($Uri -match $BlobStorageSuffix -and $UserAssignedIdentityClientId -ne '') {\r\n  Write-OutputWithTimeStamp \"Getting access token for '$Uri' using User Assigned Identity.\"\r\n  $StorageEndpoint = ($Uri -split \"://\")[0] + \"://\" + ($Uri -split \"/\")[2] + \"/\"\r\n  $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=$APIVersion&resource=$StorageEndpoint&client_id=$UserAssignedIdentityClientId\"\r\n  $AccessToken = ((Invoke-WebRequest -Headers @{Metadata = $true } -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n  $WebClient.Headers.Add('x-ms-version', '2017-11-09')\r\n  $webClient.Headers.Add(\"Authorization\", \"Bearer $AccessToken\")\r\n}\r\n$SourceFileName = ($Uri -Split \"/\")[-1]\r\nWrite-OutputWithTimeStamp \"Downloading '$Uri' to '$TempDir'.\"\r\n$DestFile = Join-Path -Path $TempDir -ChildPath $SourceFileName\r\n$webClient.DownloadFile(\"$Uri\", \"$DestFile\")\r\nStart-Sleep -Seconds 10\r\nIf (!(Test-Path -Path $DestFile)) { Write-Error \"Failed to download $SourceFileName\"; Exit 1 }\r\nWrite-OutputWithTimeStamp 'Finished downloading'\r\nSet-Location -Path $TempDir\r\n$Ext = [System.IO.Path]::GetExtension($DestFile).ToLower().Replace('.','')\r\nswitch ($Ext) {\r\n  'exe' {\r\n      If ($Arguments) {\r\n        Write-OutputWithTimeStamp \"Executing '`\"$DestFile`\" $Arguments'\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -ArgumentList (Split-ArgumentString -ArgumentString $Arguments) -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }\r\n      Else {\r\n        Write-OutputWithTimeStamp \"Executing `\"$DestFile`\"\"\r\n        $Install = Start-Process -FilePath \"$DestFile\" -NoNewWindow -Wait -PassThru\r\n        Write-OutputWithTimeStamp \"Installation ended with exit code $($Install.ExitCode).\"\r\n      }      \r\n    }\r\n  'msi' {\r\n    If ($Arguments) {\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $InstallArg = \"/i $DestFile\"\r\n        $Arguments = @($InstallArg) + $Arguments\r\n      }\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe $Arguments'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList $Arguments -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'msiexec.exe /i $DestFile /qn'\"\r\n      $MsiExec = Start-Process -FilePath msiexec.exe -ArgumentList \"/i $DestFile /qn\" -Wait -PassThru\r\n      Write-OutputWithTimeStamp \"Installation ended with exit code $($MsiExec.ExitCode).\"\r\n    }    \r\n  }\r\n  'bat' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\" $Arguments'\"\r\n      $Arguments = Split-ArgumentString -ArgumentString $Arguments\r\n      If ($Arguments -notcontains $DestFile) {\r\n        $Arguments = @(\"$DestFile\") + $Arguments\r\n      }\r\n      Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Executing 'cmd.exe `\"$DestFile`\"'\"\r\n      Start-Process -FilePath cmd.exe -ArgumentList \"`\"$DestFile`\"\" -Wait\r\n    }\r\n  }\r\n  'ps1' {\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $DestFile @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile'\"\r\n      & $DestFile\r\n    }\r\n  }\r\n  'zip' {\r\n    $DestinationPath = Join-Path -Path \"$TempDir\" -ChildPath $([System.IO.Path]::GetFileNameWithoutExtension($SourceFileName))\r\n    Write-OutputWithTimeStamp \"Extracting '$DestFile' to '$DestinationPath'.\"\r\n    Expand-Archive -Path $DestFile -DestinationPath $DestinationPath -Force\r\n    Write-OutputWithTimeStamp \"Finding PowerShell script in root of '$DestinationPath'.\"\r\n    $PSScript = (Get-ChildItem -Path $DestinationPath -filter '*.ps1').FullName\r\n    If ($PSScript.count -gt 1) { $PSScript = $PSScript[0] }\r\n    If ($Arguments) {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$DestFile' with arguments '$Arguments'\"\r\n      $parameterSplat = ConvertTo-ParametersSplat -ArgumentString $Arguments\r\n      & $PSScript @parameterSplat\r\n    }\r\n    Else {\r\n      Write-OutputWithTimeStamp \"Calling PowerShell Script '$PSScript'\"         \r\n      & $PSScript\r\n    }\r\n  }\r\n}\r\nIf ((Split-Path $TempDir -Parent) -eq $Env:Temp) {Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue}\r\nStop-Transcript",
                    "apiVersion": "[if(startsWith(environment().name, 'USN'), '2017-08-01', '2018-02-01')]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "runCommands",
                        "count": "[length(variables('customizers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), variables('customizers')[copyIndex()].name)]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "APIVersion",
                            "value": "[variables('apiVersion')]"
                          },
                          {
                            "name": "BlobStorageSuffix",
                            "value": "[format('blob.{0}', environment().suffixes.storage)]"
                          },
                          {
                            "name": "UserAssignedIdentityClientId",
                            "value": "[parameters('userAssignedIdentityClientId')]"
                          },
                          {
                            "name": "Name",
                            "value": "[variables('customizers')[copyIndex()].name]"
                          },
                          {
                            "name": "Uri",
                            "value": "[variables('customizers')[copyIndex()].uri]"
                          },
                          {
                            "name": "Arguments",
                            "value": "[variables('customizers')[copyIndex()].arguments]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#0')]"
                        },
                        "treatFailureAsDeploymentFailure": true
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "runCommand_ConfigureSessionHost",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            },
            {
              "copy": {
                "name": "updateOSDiskNetworkAccess",
                "count": "[length(range(0, parameters('sessionHostCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-disable-osDisk-PublicAccess-{1}', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "diskAccessId": {
                    "value": "[parameters('diskAccessId')]"
                  },
                  "diskName": {
                    "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))), '2024-03-01').storageProfile.osDisk.name]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "deploymentSuffix": {
                    "value": "[parameters('deploymentSuffix')]"
                  },
                  "vmName": {
                    "value": "[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "16266284306868602023"
                    }
                  },
                  "parameters": {
                    "diskAccessId": {
                      "type": "string"
                    },
                    "diskName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "deploymentSuffix": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('Update-OSDisk-{0}-Stage2-{1}', parameters('vmName'), parameters('deploymentSuffix'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diskName": {
                            "value": "[parameters('diskName')]"
                          },
                          "creationData": {
                            "value": "[reference(resourceId('Microsoft.Compute/disks', parameters('diskName')), '2023-10-02').creationData]"
                          },
                          "diskAccessId": {
                            "value": "[parameters('diskAccessId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "17290095301135652436"
                            }
                          },
                          "parameters": {
                            "creationData": {
                              "type": "object"
                            },
                            "diskName": {
                              "type": "string"
                            },
                            "diskAccessId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/disks",
                              "apiVersion": "2023-10-02",
                              "name": "[parameters('diskName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "diskAccessId": "[if(empty(parameters('diskAccessId')), null(), parameters('diskAccessId'))]",
                                "creationData": "[parameters('creationData')]",
                                "networkAccessPolicy": "[if(empty(parameters('diskAccessId')), 'DenyAll', 'AllowPrivate')]",
                                "publicNetworkAccess": "Disabled"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0')))]"
              ]
            }
          ],
          "outputs": {
            "virtualMachineNames": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('sessionHostCount')))]",
                "input": "[replace(parameters('virtualMachineNameConv'), '###', padLeft(add(range(0, parameters('sessionHostCount'))[range(0, parameters('sessionHostCount'))[copyIndex()]], parameters('sessionHostIndex')), parameters('vmNameIndexLength'), '0'))]"
              }
            },
            "fslogixPathExclusions": {
              "type": "string",
              "value": "[variables('fslogixPathExclusions')]"
            },
            "fslogixStorageAccounts": {
              "type": "array",
              "value": "[union(variables('fslogixLocalStorageAccountNames'), variables('fslogixRemoteStorageAccountNames'))]"
            },
            "fslogixNetAppServers": {
              "type": "array",
              "value": "[union(parameters('fslogixLocalNetAppServerFqdns'), parameters('fslogixRemoteNetAppServerFqdns'))]"
            }
          }
        }
      },
      "dependsOn": [
        "availabilitySets",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('Customer-Managed-Keys-{0}', parameters('deploymentSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('DiskAccess-{0}', parameters('deploymentSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('HostPoolRegistrationTokenUpdate-{0}', parameters('deploymentSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('NetAppVolumeFqdns-{0}', parameters('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[and(not(equals(parameters('deploymentType'), 'SessionHostsOnly')), parameters('recoveryServices'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('RecoveryServicesVault-VirtualMachines-{0}', parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('recoveryServicesVaultName')]"
          },
          "backupPolicies": {
            "value": [
              {
                "name": "[variables('backupPolicyName')]",
                "properties": {
                  "backupManagementType": "AzureIaasVM",
                  "instantRpRetentionRangeInDays": 2,
                  "policyType": "V2",
                  "retentionPolicy": {
                    "retentionPolicyType": "LongTermRetentionPolicy",
                    "dailySchedule": {
                      "retentionDuration": {
                        "count": 30,
                        "durationType": "Days"
                      },
                      "retentionTimes": [
                        "23:00"
                      ]
                    }
                  },
                  "schedulePolicy": {
                    "schedulePolicyType": "SimpleSchedulePolicyV2",
                    "scheduleRunFrequency": "Daily",
                    "dailySchedule": {
                      "scheduleRunTimes": [
                        "23:00"
                      ]
                    }
                  },
                  "timeZone": "[parameters('timeZone')]"
                }
              }
            ]
          },
          "privateEndpoints": "[if(and(and(and(and(parameters('privateEndpoint'), not(empty(parameters('privateEndpointSubnetResourceId')))), not(empty(parameters('azureBackupPrivateDnsZoneResourceId')))), not(empty(parameters('azureBlobPrivateDnsZoneResourceId')))), not(empty(parameters('azureQueuePrivateDnsZoneResourceId')))), createObject('value', createArray(createObject('customNetworkInterfaceName', replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SUBRESOURCE', 'AzureBackup'), 'RESOURCE', parameters('recoveryServicesVaultName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8])), 'name', replace(replace(replace(parameters('privateEndpointNameConv'), 'SUBRESOURCE', 'AzureBackup'), 'RESOURCE', parameters('recoveryServicesVaultName')), 'VNETID', format('{0}', split(parameters('privateEndpointSubnetResourceId'), '/')[8])), 'privateDnsZoneGroup', if(empty(variables('nonEmptyBackupPrivateDNSZoneResourceIds')), null(), createObject('privateDNSResourceIds', variables('nonEmptyBackupPrivateDNSZoneResourceIds'))), 'service', 'AzureBackup', 'subnetResourceId', parameters('privateEndpointSubnetResourceId'), 'tags', union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()))))), createObject('value', null()))]",
          "diagnosticWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
          },
          "tags": {
            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.recoveryServices/vaults'), createObject()))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1183717082371637162"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. Name of the Azure Recovery Service Vault."
              }
            },
            "backupStorageConfig": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. The storage configuration for the Azure Recovery Service Vault."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. Location for all resources."
              }
            },
            "backupPolicies": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional. List of all backup policies."
              }
            },
            "backupConfig": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. The backup configuration."
              }
            },
            "protectionContainers": {
              "type": "array",
              "defaultValue": [],
              "minLength": 0,
              "metadata": {
                "description": "Optional. List of all protection containers."
              }
            },
            "replicationFabrics": {
              "type": "array",
              "defaultValue": [],
              "minLength": 0,
              "metadata": {
                "description": "Optional. List of all replication fabrics."
              }
            },
            "replicationPolicies": {
              "type": "array",
              "defaultValue": [],
              "minLength": 0,
              "metadata": {
                "description": "Optional. List of all replication policies."
              }
            },
            "replicationAlertSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Replication alert settings."
              }
            },
            "diagnosticStorageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Resource ID of the diagnostic storage account."
              }
            },
            "diagnosticWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Resource ID of the diagnostic log analytics workspace."
              }
            },
            "diagnosticEventHubAuthorizationRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
              }
            },
            "diagnosticEventHubName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category."
              }
            },
            "systemAssignedIdentity": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Enables system assigned managed identity on the resource."
              }
            },
            "userAssignedIdentities": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. The ID(s) to assign to the resource."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Tags of the Recovery Service Vault resource."
              }
            },
            "diagnosticLogCategoriesToEnable": {
              "type": "array",
              "defaultValue": [
                "allLogs"
              ],
              "allowedValues": [
                "",
                "allLogs",
                "AzureBackupReport",
                "CoreAzureBackup",
                "AddonAzureBackupJobs",
                "AddonAzureBackupAlerts",
                "AddonAzureBackupPolicy",
                "AddonAzureBackupStorage",
                "AddonAzureBackupProtectedInstance",
                "AzureSiteRecoveryJobs",
                "AzureSiteRecoveryEvents",
                "AzureSiteRecoveryReplicatedItems",
                "AzureSiteRecoveryReplicationStats",
                "AzureSiteRecoveryRecoveryPoints",
                "AzureSiteRecoveryReplicationDataUploadRate",
                "AzureSiteRecoveryProtectedDiskDataChurn"
              ],
              "metadata": {
                "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to '' to disable log collection."
              }
            },
            "diagnosticMetricsToEnable": {
              "type": "array",
              "defaultValue": [
                "AllMetrics"
              ],
              "allowedValues": [
                "AllMetrics"
              ],
              "metadata": {
                "description": "Optional. The name of metrics that will be streamed."
              }
            },
            "diagnosticSettingsName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. The name of the diagnostic setting, if deployed. If left empty, it defaults to \"<resourceName>-diagnosticSettings\"."
              }
            },
            "privateEndpoints": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
              }
            },
            "monitoringSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Monitoring Settings of the vault."
              }
            },
            "securitySettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Security Settings of the vault."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "diagnosticsLogsSpecified",
                "count": "[length(filter(parameters('diagnosticLogCategoriesToEnable'), lambda('item', and(not(equals(lambdaVariables('item'), 'allLogs')), not(equals(lambdaVariables('item'), ''))))))]",
                "input": {
                  "category": "[filter(parameters('diagnosticLogCategoriesToEnable'), lambda('item', and(not(equals(lambdaVariables('item'), 'allLogs')), not(equals(lambdaVariables('item'), '')))))[copyIndex('diagnosticsLogsSpecified')]]",
                  "enabled": true
                }
              },
              {
                "name": "diagnosticsMetrics",
                "count": "[length(parameters('diagnosticMetricsToEnable'))]",
                "input": {
                  "category": "[parameters('diagnosticMetricsToEnable')[copyIndex('diagnosticsMetrics')]]",
                  "timeGrain": null,
                  "enabled": true
                }
              }
            ],
            "diagnosticsLogs": "[if(contains(parameters('diagnosticLogCategoriesToEnable'), 'allLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true())), if(contains(parameters('diagnosticLogCategoriesToEnable'), ''), createArray(), variables('diagnosticsLogsSpecified')))]",
            "identityType": "[if(parameters('systemAssignedIdentity'), if(not(empty(parameters('userAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(parameters('userAssignedIdentities'))), 'UserAssigned', 'None'))]",
            "identity": "[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(parameters('userAssignedIdentities'))), parameters('userAssignedIdentities'), null())), null())]"
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": "[variables('identity')]",
              "sku": {
                "name": "RS0",
                "tier": "Standard"
              },
              "properties": {
                "monitoringSettings": "[if(not(empty(parameters('monitoringSettings'))), parameters('monitoringSettings'), null())]",
                "securitySettings": "[if(not(empty(parameters('securitySettings'))), parameters('securitySettings'), null())]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]"
              }
            },
            {
              "condition": "[or(or(or(not(empty(parameters('diagnosticStorageAccountId'))), not(empty(parameters('diagnosticWorkspaceId')))), not(empty(parameters('diagnosticEventHubAuthorizationRuleId')))), not(empty(parameters('diagnosticEventHubName'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.RecoveryServices/vaults/{0}', parameters('name'))]",
              "name": "[if(not(empty(parameters('diagnosticSettingsName'))), parameters('diagnosticSettingsName'), format('{0}-diagnosticSettings', parameters('name')))]",
              "properties": {
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "workspaceId": "[if(not(empty(parameters('diagnosticWorkspaceId'))), parameters('diagnosticWorkspaceId'), null())]",
                "eventHubAuthorizationRuleId": "[if(not(empty(parameters('diagnosticEventHubAuthorizationRuleId'))), parameters('diagnosticEventHubAuthorizationRuleId'), null())]",
                "eventHubName": "[if(not(empty(parameters('diagnosticEventHubName'))), parameters('diagnosticEventHubName'), null())]",
                "metrics": "[if(equals(environment().name, 'AzureCloud'), variables('diagnosticsMetrics'), null())]",
                "logs": "[variables('diagnosticsLogs')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "rsv_replicationFabrics",
                "count": "[length(parameters('replicationFabrics'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-Fabric-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[coalesce(tryGet(parameters('replicationFabrics')[copyIndex()], 'name'), parameters('replicationFabrics')[copyIndex()].location)]"
                  },
                  "location": {
                    "value": "[parameters('replicationFabrics')[copyIndex()].location]"
                  },
                  "replicationContainers": {
                    "value": "[coalesce(tryGet(parameters('replicationFabrics')[copyIndex()], 'replicationContainers'), createArray())]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "9020517797192270065"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Required. The recovery location the fabric represents."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "[parameters('location')]",
                      "metadata": {
                        "description": "Optional. The name of the fabric."
                      }
                    },
                    "replicationContainers": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Replication containers to create."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/replicationFabrics",
                      "apiVersion": "2022-10-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "customDetails": {
                          "instanceType": "Azure",
                          "location": "[parameters('location')]"
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "fabric_replicationContainers",
                        "count": "[length(parameters('replicationContainers'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('RCont-{0}-{1}', copyIndex(), deployment().name)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('replicationContainers')[copyIndex()].name]"
                          },
                          "recoveryVaultName": {
                            "value": "[parameters('recoveryVaultName')]"
                          },
                          "replicationFabricName": {
                            "value": "[parameters('name')]"
                          },
                          "replicationContainerMappings": {
                            "value": "[coalesce(tryGet(parameters('replicationContainers')[copyIndex()], 'replicationContainerMappings'), createArray())]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7589503989052678595"
                            },
                            "name": "Recovery Services Vault Replication Fabric Replication Protection Containers",
                            "description": "This module deploys a Recovery Services Vault Replication Protection Container.\r\n\r\n> **Note**: this version of the module only supports the `instanceType: 'A2A'` scenario.",
                            "owner": "Azure/module-maintainers"
                          },
                          "parameters": {
                            "recoveryVaultName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                              }
                            },
                            "replicationFabricName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent Replication Fabric. Required if the template is used in a standalone deployment."
                              }
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the replication container."
                              }
                            },
                            "replicationContainerMappings": {
                              "type": "array",
                              "defaultValue": [],
                              "metadata": {
                                "description": "Optional. Replication containers mappings to create."
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers",
                              "apiVersion": "2022-10-01",
                              "name": "[format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name'))]",
                              "properties": {
                                "providerSpecificInput": [
                                  {
                                    "instanceType": "A2A"
                                  }
                                ]
                              }
                            },
                            {
                              "copy": {
                                "name": "fabric_container_containerMappings",
                                "count": "[length(parameters('replicationContainerMappings'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('Map-{0}-{1}', copyIndex(), deployment().name)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'name'), '')]"
                                  },
                                  "policyId": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'policyId'), '')]"
                                  },
                                  "policyName": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'policyName'), '')]"
                                  },
                                  "recoveryVaultName": {
                                    "value": "[parameters('recoveryVaultName')]"
                                  },
                                  "replicationFabricName": {
                                    "value": "[parameters('replicationFabricName')]"
                                  },
                                  "sourceProtectionContainerName": {
                                    "value": "[parameters('name')]"
                                  },
                                  "targetProtectionContainerId": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetProtectionContainerId'), '')]"
                                  },
                                  "targetContainerFabricName": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetContainerFabricName'), parameters('replicationFabricName'))]"
                                  },
                                  "targetContainerName": {
                                    "value": "[coalesce(tryGet(parameters('replicationContainerMappings')[copyIndex()], 'targetContainerName'), '')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "10236435086576278421"
                                    },
                                    "name": "Recovery Services Vault Replication Fabric Replication Protection Container Replication Protection Container Mappings",
                                    "description": "This module deploys a Recovery Services Vault (RSV) Replication Protection Container Mapping.\r\n\r\n> **Note**: this version of the module only supports the `instanceType: 'A2A'` scenario.",
                                    "owner": "Azure/module-maintainers"
                                  },
                                  "parameters": {
                                    "recoveryVaultName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "replicationFabricName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Conditional. The name of the parent Replication Fabric. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "sourceProtectionContainerName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Conditional. The name of the parent source Replication container. Required if the template is used in a standalone deployment."
                                      }
                                    },
                                    "targetProtectionContainerId": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. Resource ID of the target Replication container. Must be specified if targetContainerName is not. If specified, targetContainerFabricName and targetContainerName will be ignored."
                                      }
                                    },
                                    "targetContainerFabricName": {
                                      "type": "string",
                                      "defaultValue": "[parameters('replicationFabricName')]",
                                      "metadata": {
                                        "description": "Optional. Name of the fabric containing the target container. If targetProtectionContainerId is specified, this parameter will be ignored."
                                      }
                                    },
                                    "targetContainerName": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. Name of the target container. Must be specified if targetProtectionContainerId is not. If targetProtectionContainerId is specified, this parameter will be ignored."
                                      }
                                    },
                                    "policyId": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. Resource ID of the replication policy. If defined, policyName will be ignored."
                                      }
                                    },
                                    "policyName": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. Name of the replication policy. Will be ignored if policyId is also specified."
                                      }
                                    },
                                    "name": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. The name of the replication container mapping. If not provided, it will be automatically generated as `<source_container_name>-<target_container_name>`."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "policyResourceId": "[if(not(equals(parameters('policyId'), '')), parameters('policyId'), subscriptionResourceId('Microsoft.RecoveryServices/vaults/replicationPolicies', parameters('recoveryVaultName'), parameters('policyName')))]",
                                    "targetProtectionContainerResourceId": "[if(not(equals(parameters('targetProtectionContainerId'), '')), parameters('targetProtectionContainerId'), subscriptionResourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', parameters('recoveryVaultName'), parameters('targetContainerFabricName'), parameters('targetContainerName')))]",
                                    "mappingName": "[if(not(empty(parameters('name'))), parameters('name'), format('{0}-{1}', parameters('sourceProtectionContainerName'), split(variables('targetProtectionContainerResourceId'), '/')[10]))]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectionContainerMappings",
                                      "apiVersion": "2022-10-01",
                                      "name": "[format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName'))]",
                                      "properties": {
                                        "targetProtectionContainerId": "[variables('targetProtectionContainerResourceId')]",
                                        "policyId": "[variables('policyResourceId')]",
                                        "providerSpecificInput": {
                                          "instanceType": "A2A"
                                        }
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the replication container."
                                      },
                                      "value": "[format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName'))]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the replication container."
                                      },
                                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectionContainerMappings', split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[0], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[1], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[2], split(format('{0}/{1}/{2}/{3}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('sourceProtectionContainerName'), variables('mappingName')), '/')[3])]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the resource group the replication container was created in."
                                      },
                                      "value": "[resourceGroup().name]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[0], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[1], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[2])]"
                              ]
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the replication container."
                              },
                              "value": "[format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name'))]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the replication container."
                              },
                              "value": "[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers', split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[0], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[1], split(format('{0}/{1}/{2}', parameters('recoveryVaultName'), parameters('replicationFabricName'), parameters('name')), '/')[2])]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the resource group the replication container was created in."
                              },
                              "value": "[resourceGroup().name]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the replication fabric."
                      },
                      "value": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the replication fabric."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/replicationFabrics', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the resource group the replication fabric was created in."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]",
                "rsv_replicationPolicies"
              ]
            },
            {
              "copy": {
                "name": "rsv_replicationPolicies",
                "count": "[length(parameters('replicationPolicies'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-Policy-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('replicationPolicies')[copyIndex()].name]"
                  },
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "appConsistentFrequencyInMinutes": {
                    "value": "[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'appConsistentFrequencyInMinutes'), 60)]"
                  },
                  "crashConsistentFrequencyInMinutes": {
                    "value": "[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'crashConsistentFrequencyInMinutes'), 5)]"
                  },
                  "multiVmSyncStatus": {
                    "value": "[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'multiVmSyncStatus'), 'Enable')]"
                  },
                  "recoveryPointHistory": {
                    "value": "[coalesce(tryGet(parameters('replicationPolicies')[copyIndex()], 'recoveryPointHistory'), 1440)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "6687773637167043684"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the replication policy."
                      }
                    },
                    "appConsistentFrequencyInMinutes": {
                      "type": "int",
                      "defaultValue": 60,
                      "metadata": {
                        "description": "Optional. The app consistent snapshot frequency (in minutes)."
                      }
                    },
                    "crashConsistentFrequencyInMinutes": {
                      "type": "int",
                      "defaultValue": 5,
                      "metadata": {
                        "description": "Optional. The crash consistent snapshot frequency (in minutes)."
                      }
                    },
                    "multiVmSyncStatus": {
                      "type": "string",
                      "defaultValue": "Enable",
                      "allowedValues": [
                        "Enable",
                        "Disable"
                      ],
                      "metadata": {
                        "description": "Optional. A value indicating whether multi-VM sync has to be enabled."
                      }
                    },
                    "recoveryPointHistory": {
                      "type": "int",
                      "defaultValue": 1440,
                      "metadata": {
                        "description": "Optional. The duration in minutes until which the recovery points need to be stored."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/replicationPolicies",
                      "apiVersion": "2022-10-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "providerSpecificInput": {
                          "instanceType": "A2A",
                          "appConsistentFrequencyInMinutes": "[parameters('appConsistentFrequencyInMinutes')]",
                          "crashConsistentFrequencyInMinutes": "[parameters('crashConsistentFrequencyInMinutes')]",
                          "multiVmSyncStatus": "[parameters('multiVmSyncStatus')]",
                          "recoveryPointHistory": "[parameters('recoveryPointHistory')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the replication policy."
                      },
                      "value": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the replication policy."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/replicationPolicies', split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1])]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the resource group the replication policy was created in."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('backupStorageConfig')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-BackupStorageConfig', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "storageModelType": {
                    "value": "[parameters('backupStorageConfig').storageModelType]"
                  },
                  "crossRegionRestoreFlag": {
                    "value": "[parameters('backupStorageConfig').crossRegionRestoreFlag]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "13450726873363153760"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "vaultstorageconfig",
                      "metadata": {
                        "description": "Optional. The name of the backup storage config."
                      }
                    },
                    "storageModelType": {
                      "type": "string",
                      "defaultValue": "GeoRedundant",
                      "allowedValues": [
                        "GeoRedundant",
                        "LocallyRedundant",
                        "ReadAccessGeoZoneRedundant",
                        "ZoneRedundant"
                      ],
                      "metadata": {
                        "description": "Optional. Change Vault Storage Type (Works if vault has not registered any backup instance)."
                      }
                    },
                    "crossRegionRestoreFlag": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Optional. Opt in details of Cross Region Restore feature."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/backupstorageconfig",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "storageModelType": "[parameters('storageModelType')]",
                        "crossRegionRestoreFlag": "[parameters('crossRegionRestoreFlag')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the backup storage config."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the backup storage config."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupstorageconfig', parameters('recoveryVaultName'), parameters('name'))]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Resource Group the backup storage configuration was created in."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "rsv_backupFabric_protectionContainers",
                "count": "[length(parameters('protectionContainers'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-ProtectionContainers-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[parameters('protectionContainers')[copyIndex()].name]"
                  },
                  "sourceResourceId": {
                    "value": "[parameters('protectionContainers')[copyIndex()].sourceResourceId]"
                  },
                  "friendlyName": {
                    "value": "[parameters('protectionContainers')[copyIndex()].friendlyName]"
                  },
                  "backupManagementType": {
                    "value": "[parameters('protectionContainers')[copyIndex()].backupManagementType]"
                  },
                  "containerType": {
                    "value": "[parameters('protectionContainers')[copyIndex()].containerType]"
                  },
                  "protectedItems": {
                    "value": "[coalesce(tryGet(parameters('protectionContainers')[copyIndex()], 'protectedItems'), createArray())]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15595070997508437554"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the Azure Recovery Service Vault Protection Container."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all resources."
                      }
                    },
                    "backupManagementType": {
                      "type": "string",
                      "defaultValue": "",
                      "allowedValues": [
                        "AzureBackupServer",
                        "AzureIaasVM",
                        "AzureSql",
                        "AzureStorage",
                        "AzureWorkload",
                        "DPM",
                        "DefaultBackup",
                        "Invalid",
                        "MAB",
                        ""
                      ],
                      "metadata": {
                        "description": "Optional. Backup management type to execute the current Protection Container job."
                      }
                    },
                    "sourceResourceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Resource ID of the target resource for the Protection Container."
                      }
                    },
                    "friendlyName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Friendly name of the Protection Container."
                      }
                    },
                    "protectedItems": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Protected items to register in the container."
                      }
                    },
                    "containerType": {
                      "type": "string",
                      "defaultValue": "",
                      "allowedValues": [
                        "AzureBackupServerContainer",
                        "AzureSqlContainer",
                        "GenericContainer",
                        "Microsoft.ClassicCompute/virtualMachines",
                        "Microsoft.Compute/virtualMachines",
                        "SQLAGWorkLoadContainer",
                        "StorageContainer",
                        "VMAppContainer",
                        "Windows",
                        ""
                      ],
                      "metadata": {
                        "description": "Optional. Type of the container."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "sourceResourceId": "[if(not(empty(parameters('sourceResourceId'))), parameters('sourceResourceId'), null())]",
                        "friendlyName": "[if(not(empty(parameters('friendlyName'))), parameters('friendlyName'), null())]",
                        "backupManagementType": "[if(not(empty(parameters('backupManagementType'))), parameters('backupManagementType'), null())]",
                        "containerType": "[if(not(empty(parameters('containerType'))), parameters('containerType'), null())]"
                      }
                    },
                    {
                      "copy": {
                        "name": "protectionContainer_protectedItems",
                        "count": "[length(parameters('protectedItems'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('ProtectedItem-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "policyId": {
                            "value": "[parameters('protectedItems')[copyIndex()].policyId]"
                          },
                          "name": {
                            "value": "[parameters('protectedItems')[copyIndex()].name]"
                          },
                          "protectedItemType": {
                            "value": "[parameters('protectedItems')[copyIndex()].protectedItemType]"
                          },
                          "protectionContainerName": {
                            "value": "[parameters('name')]"
                          },
                          "recoveryVaultName": {
                            "value": "[parameters('recoveryVaultName')]"
                          },
                          "sourceResourceId": {
                            "value": "[parameters('protectedItems')[copyIndex()].sourceResourceId]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7228594859436149519"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Name of the resource."
                              }
                            },
                            "protectionContainerName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. Name of the Azure Recovery Service Vault Protection Container. Required if the template is used in a standalone deployment."
                              }
                            },
                            "recoveryVaultName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Location for all resources."
                              }
                            },
                            "protectedItemType": {
                              "type": "string",
                              "allowedValues": [
                                "AzureFileShareProtectedItem",
                                "AzureVmWorkloadSAPAseDatabase",
                                "AzureVmWorkloadSAPHanaDatabase",
                                "AzureVmWorkloadSQLDatabase",
                                "DPMProtectedItem",
                                "GenericProtectedItem",
                                "MabFileFolderProtectedItem",
                                "Microsoft.ClassicCompute/virtualMachines",
                                "Microsoft.Compute/virtualMachines",
                                "Microsoft.Sql/servers/databases"
                              ],
                              "metadata": {
                                "description": "Required. The backup item type."
                              }
                            },
                            "policyId": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. ID of the backup policy with which this item is backed up."
                              }
                            },
                            "sourceResourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Resource ID of the resource to back up."
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                              "apiVersion": "2023-01-01",
                              "name": "[format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "protectedItemType": "[parameters('protectedItemType')]",
                                "policyId": "[parameters('policyId')]",
                                "sourceResourceId": "[parameters('sourceResourceId')]"
                              }
                            }
                          ],
                          "outputs": {
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the Resource Group the protected item was created in."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the protected item."
                              },
                              "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems', split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[2], split(format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name')), '/')[3])]"
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The Name of the protected item."
                              },
                              "value": "[format('{0}/Azure/{1}/{2}', parameters('recoveryVaultName'), parameters('protectionContainerName'), parameters('name'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[2])]"
                      ]
                    }
                  ],
                  "outputs": {
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Resource Group the Protection Container was created in."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Protection Container."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[0], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[1], split(format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name')), '/')[2])]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The Name of the Protection Container."
                      },
                      "value": "[format('{0}/Azure/{1}', parameters('recoveryVaultName'), parameters('name'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "rsv_backupPolicies",
                "count": "[length(parameters('backupPolicies'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-BackupPolicy-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[parameters('backupPolicies')[copyIndex()].name]"
                  },
                  "properties": {
                    "value": "[parameters('backupPolicies')[copyIndex()].properties]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "3466374396884104128"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the Azure Recovery Service Vault Backup Policy."
                      }
                    },
                    "properties": {
                      "type": "object",
                      "metadata": {
                        "description": "Required. Configuration of the Azure Recovery Service Vault Backup Policy."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": "[parameters('properties')]"
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the backup policy."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the backup policy."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('recoveryVaultName'), parameters('name'))]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the resource group the backup policy was created in."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('backupConfig')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-RSV-BackupConfig', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'name'), 'vaultconfig')]"
                  },
                  "enhancedSecurityState": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'enhancedSecurityState'), 'Enabled')]"
                  },
                  "resourceGuardOperationRequests": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'resourceGuardOperationRequests'), createArray())]"
                  },
                  "softDeleteFeatureState": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'softDeleteFeatureState'), 'Enabled')]"
                  },
                  "storageModelType": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'storageModelType'), 'GeoRedundant')]"
                  },
                  "storageType": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'storageType'), 'GeoRedundant')]"
                  },
                  "storageTypeState": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'storageTypeState'), 'Locked')]"
                  },
                  "isSoftDeleteFeatureStateEditable": {
                    "value": "[coalesce(tryGet(parameters('backupConfig'), 'isSoftDeleteFeatureStateEditable'), true())]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "12731956892465777278"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "vaultconfig",
                      "metadata": {
                        "description": "Optional. Name of the Azure Recovery Service Vault Backup Policy."
                      }
                    },
                    "enhancedSecurityState": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Disabled",
                        "Enabled"
                      ],
                      "metadata": {
                        "description": "Optional. Enable this setting to protect hybrid backups against accidental deletes and add additional layer of authentication for critical operations."
                      }
                    },
                    "resourceGuardOperationRequests": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. ResourceGuard Operation Requests."
                      }
                    },
                    "softDeleteFeatureState": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Disabled",
                        "Enabled"
                      ],
                      "metadata": {
                        "description": "Optional. Enable this setting to protect backup data for Azure VM, SQL Server in Azure VM and SAP HANA in Azure VM from accidental deletes."
                      }
                    },
                    "storageModelType": {
                      "type": "string",
                      "defaultValue": "GeoRedundant",
                      "allowedValues": [
                        "GeoRedundant",
                        "LocallyRedundant",
                        "ReadAccessGeoZoneRedundant",
                        "ZoneRedundant"
                      ],
                      "metadata": {
                        "description": "Optional. Storage type."
                      }
                    },
                    "storageType": {
                      "type": "string",
                      "defaultValue": "GeoRedundant",
                      "allowedValues": [
                        "GeoRedundant",
                        "LocallyRedundant",
                        "ReadAccessGeoZoneRedundant",
                        "ZoneRedundant"
                      ],
                      "metadata": {
                        "description": "Optional. Storage type."
                      }
                    },
                    "storageTypeState": {
                      "type": "string",
                      "defaultValue": "Locked",
                      "allowedValues": [
                        "Locked",
                        "Unlocked"
                      ],
                      "metadata": {
                        "description": "Optional. Once a machine is registered against a resource, the storageTypeState is always Locked."
                      }
                    },
                    "isSoftDeleteFeatureStateEditable": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Optional. Is soft delete feature state editable."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/backupconfig",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "enhancedSecurityState": "[parameters('enhancedSecurityState')]",
                        "resourceGuardOperationRequests": "[parameters('resourceGuardOperationRequests')]",
                        "softDeleteFeatureState": "[parameters('softDeleteFeatureState')]",
                        "storageModelType": "[parameters('storageModelType')]",
                        "storageType": "[parameters('storageType')]",
                        "storageTypeState": "[parameters('storageTypeState')]",
                        "isSoftDeleteFeatureStateEditable": "[parameters('isSoftDeleteFeatureStateEditable')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the backup config."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the backup config."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupconfig', parameters('recoveryVaultName'), parameters('name'))]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the resource group the backup config was created in."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('replicationAlertSettings')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('RSV-replicationAlertSettings-{0}', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "defaultAlertSetting"
                  },
                  "recoveryVaultName": {
                    "value": "[parameters('name')]"
                  },
                  "customEmailAddresses": {
                    "value": "[coalesce(tryGet(parameters('replicationAlertSettings'), 'customEmailAddresses'), createArray())]"
                  },
                  "locale": {
                    "value": "[coalesce(tryGet(parameters('replicationAlertSettings'), 'locale'), '')]"
                  },
                  "sendToOwners": {
                    "value": "[coalesce(tryGet(parameters('replicationAlertSettings'), 'sendToOwners'), 'Send')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "2041586627371120882"
                    }
                  },
                  "parameters": {
                    "recoveryVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Azure Recovery Service Vault. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "defaultAlertSetting",
                      "metadata": {
                        "description": "Optional. The name of the replication Alert Setting."
                      }
                    },
                    "customEmailAddresses": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Comma separated list of custom email address for sending alert emails."
                      }
                    },
                    "locale": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The locale for the email notification."
                      }
                    },
                    "sendToOwners": {
                      "type": "string",
                      "defaultValue": "Send",
                      "allowedValues": [
                        "DoNotSend",
                        "Send"
                      ],
                      "metadata": {
                        "description": "Optional. The value indicating whether to send email to subscription administrator."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.RecoveryServices/vaults/replicationAlertSettings",
                      "apiVersion": "2022-10-01",
                      "name": "[format('{0}/{1}', parameters('recoveryVaultName'), parameters('name'))]",
                      "properties": {
                        "customEmailAddresses": "[if(not(empty(parameters('customEmailAddresses'))), parameters('customEmailAddresses'), null())]",
                        "locale": "[parameters('locale')]",
                        "sendToOwners": "[parameters('sendToOwners')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the replication Alert Setting."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the resource group the replication alert setting was created."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the replication alert setting."
                      },
                      "value": "[resourceId('Microsoft.RecoveryServices/vaults/replicationAlertSettings', parameters('recoveryVaultName'), parameters('name'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "rsv_privateEndpoints",
                "count": "[length(parameters('privateEndpoints'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('RSV-PrivateEndpoint-{0}-{1}', copyIndex(), uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "groupIds": {
                    "value": [
                      "[parameters('privateEndpoints')[copyIndex()].service]"
                    ]
                  },
                  "name": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'name'), format('pe-{0}-{1}-{2}', last(split(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '/')), parameters('privateEndpoints')[copyIndex()].service, copyIndex()))]"
                  },
                  "serviceResourceId": {
                    "value": "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('privateEndpoints')[copyIndex()].subnetResourceId]"
                  },
                  "location": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'location'), reference(split(parameters('privateEndpoints')[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                  },
                  "privateDnsZoneGroup": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'privateDnsZoneGroup'), createObject())]"
                  },
                  "tags": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'tags'), createObject())]"
                  },
                  "manualPrivateLinkServiceConnections": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'manualPrivateLinkServiceConnections'), createArray())]"
                  },
                  "customDnsConfigs": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customDnsConfigs'), createArray())]"
                  },
                  "ipConfigurations": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'ipConfigurations'), createArray())]"
                  },
                  "applicationSecurityGroups": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'applicationSecurityGroups'), createArray())]"
                  },
                  "customNetworkInterfaceName": {
                    "value": "[coalesce(tryGet(parameters('privateEndpoints')[copyIndex()], 'customNetworkInterfaceName'), '')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "13574490579232233940"
                    },
                    "name": "Private Endpoints"
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the private endpoint resource to create."
                      }
                    },
                    "subnetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                      }
                    },
                    "serviceResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Resource ID of the resource that needs to be connected to the network."
                      }
                    },
                    "applicationSecurityGroups": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                      }
                    },
                    "customNetworkInterfaceName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The custom name of the network interface attached to the private endpoint."
                      }
                    },
                    "ipConfigurations": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Required. Subtype(s) of the connection to be created. The allowed values depend on the type serviceResourceId refers to."
                      }
                    },
                    "privateDnsZoneGroup": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. The private DNS zone group configuration used to associate the private endpoint with one or multiple private DNS zones. A DNS zone group can support up to 5 DNS zones."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all Resources."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                      }
                    },
                    "customDnsConfigs": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Custom DNS configurations."
                      }
                    },
                    "manualPrivateLinkServiceConnections": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Manual PrivateLink Service Connections."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-04-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "applicationSecurityGroups": "[parameters('applicationSecurityGroups')]",
                        "customDnsConfigs": "[parameters('customDnsConfigs')]",
                        "customNetworkInterfaceName": "[parameters('customNetworkInterfaceName')]",
                        "ipConfigurations": "[parameters('ipConfigurations')]",
                        "manualPrivateLinkServiceConnections": "[parameters('manualPrivateLinkServiceConnections')]",
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('name')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ],
                        "subnet": {
                          "id": "[parameters('subnetResourceId')]"
                        }
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('PE-PrivateDnsZoneGroup-{0}', uniqueString(deployment().name))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "privateDNSResourceIds": {
                            "value": "[parameters('privateDnsZoneGroup').privateDNSResourceIds]"
                          },
                          "privateEndpointName": {
                            "value": "[parameters('name')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10522840417060554620"
                            }
                          },
                          "parameters": {
                            "privateEndpointName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                              }
                            },
                            "privateDNSResourceIds": {
                              "type": "array",
                              "minLength": 1,
                              "maxLength": 5,
                              "metadata": {
                                "description": "Required. Array of private DNS zone resource IDs. A DNS zone group can support up to 5 DNS zones."
                              }
                            },
                            "name": {
                              "type": "string",
                              "defaultValue": "default",
                              "metadata": {
                                "description": "Optional. The name of the private DNS zone group."
                              }
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "privateDnsZoneConfigs",
                                "count": "[length(parameters('privateDNSResourceIds'))]",
                                "input": {
                                  "name": "[last(split(parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                                  "properties": {
                                    "privateDnsZoneId": "[parameters('privateDNSResourceIds')[copyIndex('privateDnsZoneConfigs')]]"
                                  }
                                }
                              }
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-04-01",
                              "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                              "properties": {
                                "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigs')]"
                              }
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the private endpoint DNS zone group."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the private endpoint DNS zone group."
                              },
                              "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the private endpoint was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the private endpoint."
                      },
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint."
                      },
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location the resource was deployed into."
                      },
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01', 'full').location]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the recovery services vault."
              },
              "value": "[resourceId('Microsoft.RecoveryServices/vaults', parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the resource group the recovery services vault was created in."
              },
              "value": "[resourceGroup().name]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The Name of the recovery services vault."
              },
              "value": "[parameters('name')]"
            },
            "systemAssignedPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the system assigned identity."
              },
              "value": "[if(and(parameters('systemAssignedIdentity'), contains(reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').identity, 'principalId')), reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').identity.principalId, '')]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location the resource was deployed into."
              },
              "value": "[reference(resourceId('Microsoft.RecoveryServices/vaults', parameters('name')), '2023-01-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('FlattenVirtualMachineNames-{0}', parameters('deploymentSuffix'))]",
      "resourceGroup": "[parameters('resourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineNamesPerBatch": {
            "copy": [
              {
                "name": "value",
                "count": "[length(range(1, parameters('sessionHostBatchCount')))]",
                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('VirtualMachines-Batch-{0}-{1}', sub(range(1, parameters('sessionHostBatchCount'))[sub(range(1, parameters('sessionHostBatchCount'))[copyIndex('value')], 1)], 1), parameters('deploymentSuffix'))), '2025-04-01').outputs.virtualMachineNames.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11447244983080427176"
            }
          },
          "parameters": {
            "virtualMachineNamesPerBatch": {
              "type": "array"
            }
          },
          "resources": [],
          "outputs": {
            "virtualMachineNames": {
              "type": "array",
              "value": "[flatten(parameters('virtualMachineNamesPerBatch'))]"
            }
          }
        }
      },
      "dependsOn": [
        "virtualMachines"
      ]
    }
  ],
  "outputs": {
    "virtualMachineNames": {
      "type": "array",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupHosts')), 'Microsoft.Resources/deployments', format('FlattenVirtualMachineNames-{0}', parameters('deploymentSuffix'))), '2025-04-01').outputs.virtualMachineNames.value]"
    }
  }
}